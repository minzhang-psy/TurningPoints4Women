---
title: "Telephone Assessment Data Cleanning Script"
author: "Min Zhang"
date: ""
output: html_document
---

```{r setup, include=FALSE}
# loading Library 
library(tidyverse)
library(dplyr)
library(here)
library(lubridate)
# import raw survey items
# this is input file "tpw_measure.csv" 
# update this before archival
tpw_raw <- read.csv(here("do_not_push", "tpw_measure.csv")) %>%
  select(-X) %>%
  filter(start_date != "Start Date")

source(here("functions", "codebook_fun.R"))

# Scientific Notation 
options(scipen = 2)

tpw_archive_id <- tpw_raw %>%
  select(id)
```

## Min's TODO/Note 
add prompt for each measure in codebook.
check missing rules in codebook 

cleanning todo: 
check pct_miss_fun have right numbers 
check all pct_miss_fun has   mutate(across(-c(id), as.numeric))%>%.  # done checking through cintsubstance 
check multiple choices questions shouldn't be changed to as.numeric 

Missing data rule should apply to all missing numbers 
note if a question was skipped for incarerated TC. 

convert text to number 
reverse score column 
create sub-scale 
-use his out put file 
-sum/avg 
! data order: original items; reverse coded items; total/subscales

question: for NA/None answer option, should I recode them to -55 (e.g. ibq9/ cint63)
There are answer options which are excluded from analysis, it will be NA, is there ways that we can identify NA is actually shows because they choose NA answer options (SOCINF General)

question about missing value, I feel like there are item shouldn't be counted when calculate the missing percentage, ie: there are columns for text entry when TC choose other, if TC choose other answer option, this shouldn't be counted when count missing percentage? 
cint_socio won't have any data after applying missing data 
## Min, note from MSC here -- I think we should only include -77 or -99 in the missing data; if something was skipped due to skip rule it is not missing; likewise, if TC said "NA" and it is -55 it is not truly missing, but also can't be included in the scoring, so for scoring purposes, -55 shouldn't really affect calculations. Is this correct? In a different time, I might have now (in hindsight) used a skip rule missing value versus when a TC said "NA" but for analysis purposes, these two things are equivalent. 

which( colnames(df)=="b" )
# Find NA values in the data frame
na_positions <- which(is.na(df), arr.ind = TRUE)

Min: need work on Missing data and calculation for measure after sex history 

## BSI
### BSI Select Variables and Recode 
```{r bsi}
# Select bsi questions and recede
bsi <-
  tpw_raw %>%
  select(
    id,
    matches(
      '^bsi'
    ),
    -bsi20, # these are part of scale CIQ
    -bsi21,
    -bsi22
  ) %>%
  mutate(across(-id, as.factor)) %>%
    mutate(
      across(
        .cols = c(bsi1:bsi19),
        .fns = ~case_when(
         .x == "Not at all" ~ "0",
         .x == "A little bit" ~ "1",
         .x == "Moderately" ~ "2",
         .x == "Quite a bit" ~ "3",
         .x == "Very much" ~ "4",
         .x == "Decline to Answer" ~ "-77",
         TRUE ~ .x
        )
      )
    ) 
  
```

### BSI Missing Data 
There are missing data in BSI, but missing rule does not apply. 
```{r bsi_missing }
# correct missing value: Not Applicable = -55 = The subject was never asked a question due to a skip rule (conditional question)
bsi <- bsi %>% 
  mutate(
    bsi4 = case_when(
      # for participants who are incarcerated, bsi4 wasn't shown 
      id %in% c("HR211", "HR181", "P819") & is.na(bsi4) ~ "-55",
      TRUE ~ bsi4
    )
  )
  
bsi %>%
  mutate(across(-c(id), as.numeric))%>%
  pct_miss_fun(
    id = 'id',
    n_items = 19
  )%>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'BSI Missing Data',
    subtitle = 'By Participant')
```

### BSI Calculations & Subscale
```{r bsi_calculations}
# Below is the code that treats -77, -55 values as NA
bsi_calc <-
  bsi %>%
  mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x == -77 ~ NA_real_,
        .x == -55 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# BSI Subscale Score Creation 

  # Define the subscale items
scale1 <- c('bsi2', 'bsi3', 'bsi10', 'bsi11', 'bsi12', 'bsi13', 'bsi15')
scale2 <- c('bsi1', 'bsi5', 'bsi9', 'bsi16', 'bsi17', 'bsi18')
scale3 <- c('bsi4', 'bsi6', 'bsi7', 'bsi8', 'bsi14', 'bsi19')


bsi_complete <-
  bsi_calc %>%
  mutate(scale1_avg = round(rowMeans(select(., all_of(scale1)), na.rm = TRUE), 2),
         scale2_avg = round(rowMeans(select(., all_of(scale2)), na.rm = TRUE), 2),
         scale3_avg = round(rowMeans(select(., all_of(scale3)), na.rm = TRUE), 2)) %>%
  rename(
    bsi_soma = scale1_avg,
    bsi_anx = scale2_avg,
    bsi_dep = scale3_avg
  ) 

bsi_complete <- bsi_complete %>%
  select(id, bsi_soma, bsi_anx, bsi_dep) %>%
  merge(bsi, by="id") %>%
  relocate(bsi_soma:bsi_dep, .after = "bsi19")
```


## CESD 
### CESD Select Variables and Recode 
```{r cesd creation, warning = FALSE, message = FALSE}
cesd <-
tpw_raw %>%
  select(
    id,
    matches(
      '^c\\d'
    )
  ) %>%
mutate(
    across(
      .cols = c(c1:c20),
      .fns = ~case_when(
        .x == "Rarely or none of the time (0-1 day)" ~ "0",
        .x == "Some or a little of the time (1-2 days)" ~ "1",
        .x == "Occasionally or a moderate amount of time (3-4 days)" ~ "2",
        .x == "Most or all of the time (5-7 days)" ~ "3",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(c21:c24),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(c4, c8, c12, c16),
      .fns = ~case_when(
        .x == "0" ~ "3",
        .x == "1" ~ "2",
        .x == "2" ~ "1",
        .x == "3" ~ "0",
        .x == "-77" ~ "-77",
      TRUE ~ .x
      ),
      .names = '{.col}_r'
      )
)

```

### CESD Missing Data
There are missing data in CESD but the missing rule is not applied due to being below the threshold.
```{r CESD_missing }
# correct missing value: Not Applicable = -55 = The subject was never asked a question for skip rule (conditional question)
# if response is No to item c21, then TC moved on to item c24
cesd <- cesd %>%
  mutate(c22 = ifelse((c21 == 0 |c21 ==  "-77"), "-55", c22),
         c23 = ifelse((c21 == 0 |c21 ==  "-77"), "-55", c23),
         # for incarcerated TC, c21-c24 wasn't shown 
         c21 = case_when( id %in% c("HR211", "HR181", "P819") & is.na(c21) ~ "-55",TRUE ~ c21),
         c22 = case_when( id %in% c("HR211", "HR181", "P819") & is.na(c22) ~ "-55",TRUE ~ c22),
         c23 = case_when( id %in% c("HR211", "HR181", "P819") & is.na(c23) ~ "-55",TRUE ~ c23),
         c24 = case_when( id %in% c("HR211", "HR181", "P819") & is.na(c24) ~ "-55",TRUE ~ c24)
      )


cesd_missing <- cesd %>%
  mutate(across(-c(id), as.numeric))%>%
  select(id,
         c1:c24, # reverse scored are not included so that missing percent only involves original items (each item only represented one time)
         ) %>% 
  pct_miss_fun(
    id = 'id',
    n_items = 24
  ) 
  
cesd_missing  %>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'CESD Missing Data',
    subtitle = 'By Participant')
```


### CESD Calculations & Subscale
```{r cesd_calculation}

# Below is the code that treats negative values (-77, -55) as NA
cesd_calc <-
  cesd %>%
  mutate(across(-id, as.numeric)) %>%
    mutate(
      across(
        .cols = -id,
        .fns = ~case_when(
          .x < 0 ~ NA_real_,
          TRUE ~ .x
        )
      )
    )

# CESD Composite & Subscale Score Creation 
cesd_items <- c('c1', 'c2', 'c3', 'c4_r', 'c5',  
                'c6', 'c7', 'c8_r', 'c9', 'c10', 'c11',
                'c12_r', 'c13', 'c14', 'c15', 'c16_r', 'c17',
                'c18', 'c19', 'c20')
cesd_complete <-
  cesd_calc %>%
  mutate(cesd_dep_symp = rowSums(select(., cesd_items), na.rm = TRUE)) %>%
  relocate(id, .before = c1) %>%
  relocate(c4, .after = c3) %>%
  relocate(c8, .after = c7) %>%
  relocate(c12, .after = c11) %>%
  relocate(c16, .after = c15) %>%
  relocate(c21:c24, .after = c20)


# Merge _calc and _complete 
cesd_complete <- cesd_complete %>%
  select(id, cesd_dep_symp) %>%
  merge(cesd, by = "id") %>% 
  relocate(cesd_dep_symp, .after = c16_r)
```


## CIQ
### CIQ Select Variables and Recode 
```{r ciq}
## items originally labelled as "bsiXX" as this was administered together with the BSI due to it being a related construct
ciq <- 
	tpw_raw %>%
	select(
	  id,
	  bsi20,
	  bsi21,
	  bsi22
	) %>% 
  rename(
    ciq1 = bsi20,
    ciq2 = bsi21,
    ciq3 = bsi22
  ) %>%
  mutate(
    across(
        .cols = c(ciq1, ciq2, ciq3),
        .fns = ~case_when(
          .x == "1 = not true of me at all" ~ "1",
          .x == "2" ~ "2",
          .x == "3" ~ "3",
          .x == "4" ~ "4",
          .x == "5" ~ "5",
          .x == "6" ~ "6",
          .x == "7 = very true of me" ~ "7",
          .x == "Decline to Answer" ~ "-77",
          TRUE ~ .x
        )
      ),
	  ciq3_r = case_when(
          ciq3 == "1" ~ "7",
          ciq3 == "2" ~ "6",
          ciq3 == "3" ~ "5",
          ciq3 == "4" ~ "4",
          ciq3 == "5" ~ "3",
          ciq3 == "6" ~ "2",
          ciq3 == "7" ~ "1",
          ciq3 == "-77" ~ "-77",
          TRUE ~ ciq3
        )
    ) %>%
    relocate(
      ciq3_r, .before = ciq3
    )
```



### CIQ Missing Data 
No missing data exist in the CIQ measure. 
```{r, warning = FALSE, message = FALSE}
ciq %>%
    mutate(across(-id, as.numeric)) %>%
  select(id,
         ciq1:ciq3_r) %>%
  pct_miss_fun(
    id = 'id',
    n_items = 3
  )%>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'CIQ Missing Data',
    subtitle = 'By Participant')

```


### CIQ Calculations & Subscale
```{r ciq_calculations}
# Below is the code that treat -77 as NA
ciq_calc <-
  ciq %>%
  mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )


# CIQ Psychological Impacts Subscale Score Creation 

ciq_calc <- ciq_calc %>%
  mutate(ciq_psych_total = rowMeans(select(., starts_with("ciq"), -ciq3), na.rm = TRUE), ## average vs sum based on other publications; no missing data
         ciq_psych_total = round(ciq_psych_total, 2))

# Reorder the columns and make complete data set
ciq_complete <- ciq_calc %>%
  select(id, ciq_psych_total) %>%
  merge(ciq, by="id") %>%
  relocate(ciq_psych_total, .after = "ciq3")

```

## DAST
### DAST Select Variables and Recode 
```{r dast}
# Select DAST questions and recode
dast <-
  tpw_raw %>%
  select(
    id,
    matches('^d\\d')
    ) %>%
  mutate(
    across(
      .cols = c(d00:d20),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    # reverse score 4 and 5
    # Min, should we save these as d4_r and d5_r to be consistent with other measures?
        across(
      .cols = c(d4, d5),
      .fns = ~case_when(
        .x == "1" ~ "0",
        .x == "0" ~ "1",
        .x == "-77" ~ "-77",
        TRUE ~ .x
      ),
      .names = '{.col}_r'
    )
  ) %>%
  rename( dast_screen =d00)

```

### DAST Missing Data 
There are missing data in DAST and missing rule applied. All but one instance of missing data is due to the skip logic; even still, those participants cannot get scored on the DAST 
```{r dast_missing }
# correct missing value: Not Applicable = -55 = The subject was never asked a question for skip logic (conditional question)
# if dast_screen is Yes-1, rest column should be NA(-55)
# if D1A is No-0, or Decline to Answer(-77), d2a should be NA(-55)
# if 2b is No-0 or Decline to Answer (-77), rest column should be NA(-55)


# correct missing value: Not Applicable = -55 = The subject was never asked a question for some reason (conditional question)
dast <- dast %>% 
  # participants who were incarcerated at the time of survey completion were not administered this survey
  mutate_at(vars(dast_screen:d20,d4_r, d5_r), ~case_when(id %in% c("HR211", "HR181", "P819") & is.na(.) ~ "-55", TRUE ~ .)) %>%
  # Skip rule: if dast_screen == 1 (TC is pregnant) the rest survey are skipped
  mutate_at(vars(d1a:d20,d4_r, d5_r), ~case_when(dast_screen == 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if d1a != 1, d2a should be NA(-55)
  mutate_at(vars(d2a), ~case_when(d1a != 1 ~ "-55", TRUE ~ . )) %>%
  # Skip rule: if d2b == 0 or -77, rest question were skipped 
  mutate_at(vars(d3:d20,d4_r, d5_r), ~case_when(d2b == 0 | d2b == "-77" ~ "-55", TRUE ~ . )) %>%
  # skip rule: if d2a is 1,0,-77, D2b should be spiked 
  mutate_at(vars(d2b), ~case_when(d2a == 0 | d2a == 1 |d2a == "-77" ~ "-55", TRUE ~ . )) 

# Combine d2a and d2b answer options to d2
dast$d2 <- apply(dast[, c("d2a", "d2b")], 1, function(x) {
  if(all(x == -55)) {
    result <- -55
  } else {
    filtered_values <- x[x != -55 & !is.na(x)]
    result <- paste(filtered_values, collapse = ";")
  }
  result
})

# Organize column order 
dast <- dast %>%
  relocate(d2, .after = d1a) %>%
  select(-c(d2a, d2b)) 


dast %>%
    mutate(across(-id, as.numeric)) %>%
  select(-dast_screen,
         -d4,
         -d5) %>%
  pct_miss_fun(
    id = 'id',
    n_items = 22
  ) %>% 
  gt::gt() %>% 
  gt::tab_header(
    title = 'DAST Missing Data',
    subtitle = 'By Participant'
  )
```

### DAST Calculations & Subscale
```{r dast_calculations}
# Below is the code that treat negative values (-77, -55) as NA
# Apply NA rule
dast_calc <-
  dast %>% 
  mutate(across(-id, as.numeric)) %>%
  select(-dast_screen,
         -d4,
         -d5) %>%
  pct_miss_fun(
    id = 'id',
    n_items = 22
  ) %>%
  full_join(dast, by = 'id') %>% 
  mutate(across(-id, as.numeric)) %>%
    filter(
    is.na(miss_pct) |
      miss_pct < 20
         ) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

### DAST Composite & Subscale Score Creation 
dast_complete <-
  dast_calc %>%
  select(-missing_n,
         -miss_pct) %>%
  index_total_fun(
    id = c('id',
           'dast_screen',
           'd4', # removed these because we are using the reverse scored
           'd5')
  ) %>%
  rename(
    dast_total = sum_values 
  )


```

### DAST recode total 
```{r dast recode }
# re-code total score 
# RECODE  (0 = 0) (1 THRU 5 = 1) (6 THRU 10 = 2) (11 THRU 15 = 3) (16 THRU 20 = 4) 
# VALUE LABELS
# 0 'None'
# 1 'Low'
# 2 'Intermediate (likely meets DSM criteria)'
# 3 'Substantial'
# 4 'Severe'.

dast_complete <- dast_complete %>%
  mutate(dast_total_r = case_when(
    dast_total == 0 ~ 0,
    dast_total %in% 1:5 ~ 1,
    dast_total %in% 6:10 ~ 2,
    dast_total %in% 11:15 ~ 3,
    dast_total %in% 16:20 ~ 4,
    TRUE ~ NA_integer_
  ))

## Adding in missing values and rename prefix
dast_complete <- dast_complete %>%
  select(id, dast_total, dast_total_r) %>%
  merge(dast, by = "id", all.y = TRUE) %>%
  relocate(dast_total, dast_total_r, .after = "d5_r") %>%
  relocate(d4_r, .after = "d4") %>%
  relocate(d5_r, .after = "d5") %>%
    # input missing values for the scored variables
  #mutate_at(vars(dast_total), ~case_when(is.na(dast_total) ~ -99, TRUE ~.x)) %>%
  mutate_at(vars(dast_total, dast_total_r), ~case_when(
  dast_screen == 1 | dast_screen == -55 ~ "-99",
  TRUE ~ as.character(.)
)) %>%
mutate_at(vars(dast_total, dast_total_r), ~case_when(
  d1a == 0 & d2 == 0 | d1a == -77 ~ "-99",
  TRUE ~ as.character(.)
)) %>%
  # rename prefix to dast
  rename_with(~ paste0("dast", str_extract(., "\\d{1,2}")), 
              matches("^d\\d{1,2}$")) %>%
  rename_with(~ str_replace(., "d1a", "dast1"), starts_with("d1a")) %>%
  rename(dast4_r = d4_r, dast5_r = d5_r)
 
```

## CTS - Partner
### CTS Select Variables and Recode 
```{r cts}
# Select cts questions and recede
cts <-
  tpw_raw %>%
  select(
    id,
    matches(
      '^ct'
    ),
    -cts_parent_screen # removed because part of the CTS parent-child
  ) %>%
  mutate(across(-id, as.factor)) %>%
  mutate(
    across(
      .cols = c(ct1:ct20),
      .fns = ~case_when(
        # Keeping "this has never happened" as 8 to fit with historical longitudinal data
        .x == "Once in the past year" ~ "1",
        .x == "Twice in the past year" ~ "2",
        .x == "3-5 times in the past year" ~ "3",
        .x == "6-10 times in the past year" ~ "4",
        .x == "11-20 times in the past year" ~ "5",
        .x == "More than 20 times in the past year" ~ "6",
        .x == "Not in the past year, but it did happen before" ~ "7",
        .x == "This has never happened" ~ "8",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .col = cts_screen,
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0", 
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
      )
  ) 

```

### CTS Missing Data 
There are missing data in CTS and missing rule applied. 
```{r cts_missing}
cts <- cts %>%
  # if answered no for screening question, the entire survey is skipped.
  mutate_at(vars(ct1:ct20), ~case_when(cts_screen == 0  ~ "-55", TRUE ~ . )) %>%
  # participants who were incarcerated at the time of participation were not administered this survey
  mutate_at(vars(cts_screen, ct1:ct20), ~ ifelse(id %in% c("HR211", "HR181", "P819"), "-55", .))

cts %>%
  mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = c('id', 'cts_screen'),
    n_items = 20
  ) %>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'CTS2S Missing Data',
    subtitle = 'By Participant'
  )
```

### CTS Calculations & Subscale 
```{r cts_calculations }
cts_calc <-
  cts %>%
  pct_miss_fun(
    id = c('id', 'cts_screen'),
    n_items = 20
  ) %>%
  full_join(cts,
            by = 'id') %>%
  mutate(across(-id, as.numeric)) %>%
  filter(
    is.na(miss_pct) |
      miss_pct < 20
         ) %>%
  mutate(
    across(
      .cols = c(ct1:ct20),
      .fns = ~case_when(
        .x == -77 ~ NA_real_,
        .x == -55 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

cts_calc <- 
  cts_calc %>% 
  mutate(
    across(
      .cols = c(ct1, ct2, ct7, ct8),
      .fns = ~case_when(
        .x == 1 ~ 1,
        .x == 2 ~ 2,
        .x == 3 ~ 4,
        .x == 4 ~ 8,
        .x == 5 ~ 15.5, # midpoint between 11-20
        .x == 6 ~ 20,
        .x == 7 ~ 0,
        .x == 8 ~ 0,
        TRUE ~ NA_real_
      ),
      .names = '{col}_midpoint'
    )
  )




cts_complete <-
  cts_calc %>%
  select(
    -missing_n,
    -miss_pct
  ) %>%
    mutate(
      across(
          .cols = c(ct1:ct20),
          .fns = ~case_when(
            .x %in% c(1, 2, 3, 4, 5, 6) ~ 1,
            .x %in% c(7, 8) ~ 0,
            TRUE ~ NA_real_
          ),
          .names = '{col}_dum'
        )
    )

# ind = the participant's behaviors
# part = the participant's partner's behaviors
cts_complete <-
  cts_complete %>%
    subscale_create(
      total_only = TRUE,
      scale1 = c('ct3_dum', 'ct13_dum'),
      scale2 = c('ct4_dum', 'ct14_dum'),
      scale3 = c('ct5_dum', 'ct15_dum'),
      scale4 = c('ct6_dum', 'ct16_dum'),
      scale5 = c('ct9_dum', 'ct11_dum'),
      scale6 = c('ct10_dum', 'ct12_dum'),
      scale7 = c('ct17_dum', 'ct19_dum'),
      scale8 = c('ct18_dum', 'ct20_dum'),
      scale9 = c('ct1_midpoint', 'ct7_midpoint'),
      scale10 = c('ct2_midpoint', 'ct8_midpoint')
    ) %>%
    rename(
      # past year severity only
      cts_psy_agg_ind_sev = total1,
      cts_psy_agg_part_sev = total2,
      cts_injury_ind_sev = total3,
      cts_injury_part_sev = total4,
      cts_assault_ind_sev = total5,
      cts_assault_part_sev = total6,
      cts_sex_ind_sev = total7,
      cts_sex_part_sev = total8,
      cts_negotiate_ind = total9,
      cts_negotiate_part = total10
    )

cts_complete <-
  cts_complete %>%
    mutate(
      cts_psy_agg_ind_prev = if_else(cts_psy_agg_ind_sev == 0, 0, 1),
      cts_psy_agg_part_prev = if_else(cts_psy_agg_part_sev == 0, 0, 1),
      cts_injury_ind_prev = if_else(cts_injury_ind_sev == 0, 0, 1),
      cts_injury_part_prev = if_else(cts_injury_part_sev == 0, 0, 1),
      cts_assault_ind_prev = if_else(cts_assault_ind_sev == 0, 0, 1),
      cts_assault_part_prev = if_else(cts_assault_part_sev == 0, 0, 1),
      cts_sex_ind_prev = if_else(cts_sex_ind_sev == 0, 0, 1),
      cts_sex_part_prev = if_else(cts_sex_part_sev == 0, 0, 1),
      cts_psy_agg_mutual = case_when(
        (cts_psy_agg_ind_prev == 1 &
          cts_psy_agg_part_prev == 1) ~ 3,
        (cts_psy_agg_ind_prev == 0 &
           cts_psy_agg_part_prev == 1) ~ 1,
        (cts_psy_agg_ind_prev == 1 &
           cts_psy_agg_part_prev == 0) ~ 2,
        (cts_psy_agg_ind_prev == 0 &
           cts_psy_agg_part_prev == 0) ~ -99
      ),
      cts_injury_mutual = case_when(
        (cts_injury_ind_prev == 1 &
           cts_injury_part_prev == 1) ~ 3,
        (cts_injury_ind_prev == 0 &
           cts_injury_part_prev == 1) ~ 1,
        (cts_injury_ind_prev == 1 &
           cts_injury_part_prev == 0) ~ 2,
        (cts_injury_ind_prev == 0 &
           cts_injury_part_prev == 0) ~ -99
      ),
      cts_assault_mutual = case_when(
        (cts_assault_ind_prev == 1 &
           cts_assault_part_prev == 1) ~ 3,
        (cts_assault_ind_prev == 0 &
           cts_assault_part_prev == 1) ~ 1,
        (cts_assault_ind_prev == 1 &
           cts_assault_part_prev == 0) ~ 2,
        (cts_assault_ind_prev == 0 &
           cts_assault_part_prev == 0) ~ -99
      ),
      cts_sex_mutual = case_when(
        (cts_sex_ind_prev == 1 &
           cts_sex_part_prev == 1) ~ 3,
        (cts_sex_ind_prev == 0 &
           cts_sex_part_prev == 1) ~ 1,
        (cts_sex_ind_prev == 1 &
           cts_sex_part_prev == 0) ~ 2,
        (cts_sex_ind_prev == 0 &
           cts_sex_part_prev == 0) ~ -99
      )
    )
# Dropping dummy-coded variables for archive
# pulling in original items with missing data code
cts_complete <- cts_complete %>%
  select(-ct1_dum:-ct20_dum) %>%
  select(id, ct1_midpoint:cts_sex_mutual) %>%
  merge(cts, by="id") %>%
  # reorder dataset 
  relocate(ct1_midpoint:cts_sex_mutual, .after = "ct20") %>%
  # add in -99 for midpoint ranges that cannot be computed due to -55 codes
   mutate(
    ct1_midpoint = if_else(is.na(ct1_midpoint), -99, ct1_midpoint),
    ct2_midpoint = if_else(is.na(ct2_midpoint), -99, ct2_midpoint),
    ct7_midpoint = if_else(is.na(ct7_midpoint), -99, ct7_midpoint),
    ct8_midpoint = if_else(is.na(ct8_midpoint), -99, ct8_midpoint)
  ) %>%
  rename_with(~ ifelse(substr(., 1, 2) == "ct" & substr(., 1, 3) != "cts", paste0("cts", substr(., 3, nchar(.))), .), starts_with("ct"))
  
  

```

## BCAP
### BCAP Select Variables and Recode
```{r bcap}
# Select BCAP questions and recode
# Maria TO DO check on reverse scoring
# Maria to check in AM for the original CAP to match items if possible
bcap <-
  tpw_raw %>%
  select(id, matches('^q\\d'), -q1461) %>%
 mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x == "Agree" ~ 1,
        .x == "Disagree" ~ 0,
        .x == "Decline to Answer" ~ -77
        # TRUE ~ NA_real_
      )
    ),
    across(
      .cols = c(q1, q2, q23, q29),
      .fns = ~case_when(
        .x == 1 ~ 0,
        .x == 0 ~ 1,
        TRUE ~ .x
      ),
      .names = '{.col}_r'
    )
  )
```


### BCAP Calculations & Subscale
```{r bcap_calculations}

# Please refer to code book for cite the scoring info 


## changing prefix for measure
bcap_complete <- bcap %>%
  # select(id, bcap_risk:bcap_random) %>%
  # full_join(bcap, by="id") %>%
  # relocate(bcap_risk:bcap_random, .after = "q29_r") %>%
    # change q prefix to bcap 
  rename(
    bcap1 = q1,
    bcap2 = q2,
    bcap3 = q3,
    bcap4 = q4,
    bcap5 = q5,
    bcap6 = q6,
    bcap7 = q7,
    bcap8 = q8,
    bcap9 = q9,
    bcap10 = q10,
    bcap11 = q11,
    bcap12 = q12,
    bcap13 = q13,
    bcap14 = q14,
    bcap15 = q15,
    bcap16 = q16,
    bcap17 = q17,
    bcap18 = q18,
    bcap19 = q19,
    bcap20 = q20,
    bcap21 = q21,
    bcap22 = q22,
    bcap23 = q23,
    bcap24 = q24,
    bcap25 = q25,
    bcap26 = q26,
    bcap27 = q27,
    bcap28 = q28,
    bcap29 = q29,
    bcap30 = q30,
    bcap31 = q31,
    bcap32 = q32,
    bcap33 = q33,
    bcap34 = q34,
    bcap1_r = q1_r,
    bcap2_r = q2_r,
    bcap23_r = q23_r,
    bcap29_r = q29_r
  ) 
```

## DAS 
### DAS Select Variables and Recode 
```{r dyadc}
# Referred to as dyadc in coding, but this is the DAS. 
# Min can you please pull in the dyad screener variable and we will add it to the binary table; I think it is called this `DYADC Screener`; please rename for consistency with codebook to dyadc_screener
dyadc <-
  tpw_raw %>% 
  select(
    id,
    dyadc_screener,
    matches(
      '^e\\d'
      )
    ) %>%
  #mutate(across(-id, as.factor)) %>%
  mutate(
    across(
      .cols = c(dyadc_screener),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(e1:e15),
      .fns = ~case_when(
        .x == "Always Disagree" ~ "0",
        .x == "Almost always Disagree" ~ "1", 
        .x == "Almost Always Disagree" ~ "1", # Need both because one survey including this title case
        .x == "Frequently Disagree" ~ "2",
        .x == "Occasionally Disagree" ~ "3",
        .x == "Almost always Agree" ~ "4",
        .x == "Always Agree" ~ "5",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~.x
      )
    ),
    across(
      .cols = c(e16, e17, e20:e22), 
      .fns = ~case_when(
        .x == "All the time" ~ "0",
        .x == "Most of the time" ~ "1",
        .x == "More often than not" ~ "2",
        .x == "Occasionally" ~ "3",
        .x == "Rarely" ~ "4",
        .x == "Never" ~ '5',
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    # Min, make the reversed (_r) and then create unreversed variables for 18 and 19
    across(
      .cols = c(e18,e19), 
      .fns = ~case_when(
        .x == "All the time" ~ "5",
        .x == "Most of the time" ~ "4",
        .x == "More often than not" ~ "3",
        .x == "Occasionally" ~ "2",
        .x == "Rarely" ~ "1",
        .x == "Never" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(e23:e24),
      .fns = ~case_when(
        .x == "Never" ~ "0",
        .x == "Rarely" ~ "1",
        .x == "Occasionally" ~ "2",
        .x == "Almost every day" ~ "3",
        .x == "Every day" ~ "4",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(e25:e28),
      .fns = ~case_when(
        .x == "Never" ~ '0',
        .x == "Less than once a month" ~ "1",
        .x == "Once or twice a month" ~ "2",
        .x == "Once or twice a week" ~ "3",
        .x == "Once a day" ~ "4",
        .x == "More often" ~ "5",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(e29, e30),
      .fns = ~case_when(
        .x == "Yes" ~ "0",
        .x == "No" ~ "1",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    e31 = case_when(
      e31 == "0 - Extremely Unhappy" ~ "0",
      e31 == "1 - Fairly Unhappy" ~ "1",
      e31 == "2 - A little Unhappy" ~ "2",
      e31 == "3 - Happy" ~ "3",
      e31 == "4 - Very Happy" ~ "4",
      e31 == "5 - Extremely Happy" ~ "5",
      e31 == "6 - Perfect" ~ "6",
      e31 == "Decline to Answer" ~ "-77",
        TRUE ~ e31
    ),
    e32 = case_when(
      e32 == "5 - I want desperately for my relationship to succeed, and would go to almost any length to see that it does." ~ "5",
      e32 == "4 - I want very much for my relationship to succeed, and will do all I can to see that it does." ~ "4",
      e32 == "3 - I want very much for my relationship to succeed, and will do my fair share to see that it does." ~ "3",
      e32 == "2 - It would be nice if my relationship succeeded, but I can’t do much more than I’m doing now to help it succeed." ~ "2",
      e32 == "1 - It would be nice if it succeeded, but I refuse to do any more than I am doing now to keep the relationship going." ~ "1",
      e32 ==  "0 - My relationship can never succeed, and there is no more that I can do to keep the relationship going." ~ "0",
      e32 == "Decline to Answer" ~ "-77",
      TRUE ~ e32
    )
  )

```

### DAS Missing Data
There are missing data in DAS and missing rule applied through the unique "COUNT" code below. 
```{r dyadc_missing}
dyadc <- dyadc %>%
  # if answered no for screening question, the entire survey is skipped.
  mutate_at(vars(e1:e32), ~case_when(dyadc_screener == 0  ~ "-55", TRUE ~ . )) %>%
    # Participants who were incarcerated at the time of assessment where not administered this survey
  mutate_at(vars(dyadc_screener, e1:e32), ~ ifelse(id %in% c("HR211", "HR181", "P819"), "-55", .)) 

dyadc %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = c('id', 'dyadc_screener'),
    n_items = 32
  ) %>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'DYADC Missing Data',
    subtitle = 'By Participant'
  )
```

### DAS Calculations & Subscale
```{r dyadc_calculations}
# recode to das prefix

dyadc_calc <- dyadc %>%
  rename_with(~sub("^e", "das", .), starts_with("e"))


## create variables to check for missing data thresholds to be used in subscale creation
## these will not be archived, only used for creation of other data

dyadc_calc <- dyadc_calc %>%
  mutate(
    COUNTA = ifelse(dyadc_screener == 1, 
                    rowSums(as.matrix(dyadc_calc[, c("das1", "das2", "das3", "das5", "das7", "das8", "das9", "das10", "das11", "das12", "das13", "das14", "das15")]) == -77),
                    NA),
    COUNTB = ifelse(dyadc_screener == 1, 
                    rowSums(as.matrix(dyadc_calc[, c("das4", "das6", "das29", "das30")]) == -77),
                    NA),
    COUNTB1 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, c("das29", "das30")]) == -77),
                     NA),
    COUNTB5 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, c("das4", "das6")]) == -77),
                     NA),
    COUNTC = ifelse(dyadc_screener == 1, 
                    rowSums(as.matrix(dyadc_calc[, c("das16", "das17", "das18", "das19", "das20", "das21", "das22", "das23", "das31", "das32")]) == -77),
                    NA),
    COUNTC4 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, "das23"]) == -77),
                     NA),
    COUNTC5 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, c("das16", "das17", "das18", "das19", "das20", "das21", "das22", "das32")]) == -77),
                     NA),
    COUNTC6 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, "das31"]) == -77),
                     NA),
    COUNTD = ifelse(dyadc_screener == 1, 
                    rowSums(as.matrix(dyadc_calc[, c("das24", "das25", "das26", "das27", "das28")]) == -77),
                    NA),
    COUNTD4 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, "das24"]) == -77),
                     NA),
    COUNTD5 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, c("das25", "das26", "das27", "das28")]) == -77),
                     NA)
  )


## creating subscales here 

## Total = all 32 items

## Dyadic Consensus - 1, 2, 3, 5, 7, 8, 9, 10, 11, 12, 13, 14, 15 (65 points possible)

## Affectional Expression - 4, 6, 29, 30 (12 points possible)

## Dyadic Satisfaction - 16, 17, 18, 19, 20, 21, 22, 23, 31, 32 (50 points possible)

## Dyadic Cohesion - 24, 25, 26, 27, 28 (24 points possible) 

dyadc_complete <- dyadc_calc %>%
  rowwise() %>%
 mutate_at(vars(dyadc_screener :COUNTD5), as.numeric) %>%
    mutate(
    das1 = replace(das1, das1 %in% c(-55, -77), NA_real_),
    das2 = replace(das2, das2 %in% c(-55, -77), NA_real_),
    das3 = replace(das3, das3 %in% c(-55, -77), NA_real_),
    das4 = replace(das4, das4 %in% c(-55, -77), NA_real_),
    das5 = replace(das5, das5 %in% c(-55, -77), NA_real_),
    das6 = replace(das6, das6 %in% c(-55, -77), NA_real_),
    das7 = replace(das7, das7 %in% c(-55, -77), NA_real_),
    das8 = replace(das8, das8 %in% c(-55, -77), NA_real_),
    das9 = replace(das9, das9 %in% c(-55, -77), NA_real_),
    das10 = replace(das10, das10 %in% c(-55, -77), NA_real_),
    das11 = replace(das11, das11 %in% c(-55, -77), NA_real_),
    das12 = replace(das12, das12 %in% c(-55, -77), NA_real_),
    das13 = replace(das13, das13 %in% c(-55, -77), NA_real_),
    das14 = replace(das14, das14 %in% c(-55, -77), NA_real_),
    das15 = replace(das15, das15 %in% c(-55, -77), NA_real_),
    das16 = replace(das16, das16 %in% c(-55, -77), NA_real_),
    das17 = replace(das17, das17 %in% c(-55, -77), NA_real_),
    das18 = replace(das18, das18 %in% c(-55, -77), NA_real_),
    das19 = replace(das19, das19 %in% c(-55, -77), NA_real_),
    das20 = replace(das20, das20 %in% c(-55, -77), NA_real_),
    das21 = replace(das21, das21 %in% c(-55, -77), NA_real_),
    das22 = replace(das22, das22 %in% c(-55, -77), NA_real_),
    das23 = replace(das23, das23 %in% c(-55, -77), NA_real_),
    das24 = replace(das24, das24 %in% c(-55, -77), NA_real_),
    das25 = replace(das25, das25 %in% c(-55, -77), NA_real_),
    das26 = replace(das26, das26 %in% c(-55, -77), NA_real_),
    das27 = replace(das27, das27 %in% c(-55, -77), NA_real_),
    das28 = replace(das28, das28 %in% c(-55, -77), NA_real_),
    das29 = replace(das29, das29 %in% c(-55, -77), NA_real_),
    das30 = replace(das30, das30 %in% c(-55, -77), NA_real_),
    das31 = replace(das31, das31 %in% c(-55, -77), NA_real_),
    das32 = replace(das32, das32 %in% c(-55, -77), NA_real_)
  ) %>%
  mutate(
    dyadc_con = das1+ das2+ das3+ das5+ das7+ das8+ das10+ das11+ das12+ das13+ das14+ das15,
    dyadc_aff_exp = case_when(
      COUNTB == 0 ~ das4 + das6 + das29 + das30,
      COUNTB == 1 & COUNTB1 == 1 ~ (das4 + das6 + das29 + das30) / 11 * 12,
      COUNTB == 1 & COUNTB5 == 1 ~ (das4 + das6 + das29 + das30) / 7 * 12,
      TRUE ~ NA_real_  # Add a default condition, return NA if none of the conditions are met
    ),
    dyadc_satis = case_when(
      COUNTC == 0 ~ das16 + das17 + das18 + das19 + das20 + das21 + das22 + das23 + das31 + das32,
      COUNTC == 1 & COUNTC4 == 1 ~ (das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 46 * 50,
      COUNTC == 1 & COUNTC5 == 1 ~(das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 45 * 50,
      COUNTC == 1 & COUNTC6 == 1 ~ (das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 44 * 50,
      COUNTC == 2 & COUNTC4 == 1 & COUNTC5 == 1 ~ (das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 41 * 50,
      COUNTC == 2 & COUNTC5 == 2 ~(das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 40 * 50,
      COUNTC == 2 & COUNTC5 == 1 & COUNTC6 == 1 ~ (das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 39 * 50,
      TRUE ~ NA_real_
    ),
    dyadc_cohes = case_when(
      COUNTD == 0 ~ das24 + das25+  das26 + das27 + das28,
      COUNTD == 1 & COUNTD4 == 1 ~ (das24 + das25+  das26 + das27 + das28) /20 * 24,
      COUNTD == 1 & COUNTD5 == 1 ~ (das24 + das25+  das26 + das27 + das28) /19 * 24,
      TRUE ~ NA_real_
    ),
  ) %>%
  mutate(dyadc_con = round(dyadc_con * 100)/100, 
         dyadc_aff_exp = round(dyadc_aff_exp * 100) / 100,
         dyadc_satis = round(dyadc_satis * 100) / 100,
         dyadc_cohes = round(dyadc_cohes * 100) / 100,
         dyadc_total = dyadc_con + dyadc_aff_exp + dyadc_satis + dyadc_cohes) %>%
  select(-starts_with("COUNT")) %>% # dropping count variables
  # add appropriate missing values back in
  # if answered no for screening question, the entire survey is skipped.
  # Incarcerated TC weren't administered for this survey
   mutate(dyadc_screener = ifelse(id %in% c("HR211", "HR181", "P819"), "-55", as.character(dyadc_screener)),
         across(starts_with("das"), ~case_when(dyadc_screener == 0 ~ "-55", TRUE ~ as.character(.))),
         dyadc_con = ifelse(is.na(dyadc_con), -99, dyadc_con),
         dyadc_aff_exp = ifelse(is.na(dyadc_aff_exp), -99, dyadc_aff_exp),
         dyadc_satis = ifelse(is.na(dyadc_satis), -99, dyadc_satis),
         dyadc_cohes = ifelse(is.na(dyadc_cohes), -99, dyadc_cohes),
         dyadc_total = ifelse(is.na(dyadc_total), -99, dyadc_total),
        across(where(is.character), ~replace(., is.na(.) | . == "", -77))) %>%
   mutate_at(vars(-id), as.numeric)


# DAS compute variable that will include in the archive 
dyadc_complete <- dyadc_complete %>%
  select(id, dyadc_con, dyadc_aff_exp, dyadc_satis, dyadc_cohes, dyadc_total)  

# DAS finalized data 
dyadc_complete <- dyadc %>%
  select(id, starts_with("e")) %>%
  rename_with(~sub("^e", "das", .), starts_with("e"))%>%
  merge(dyadc_complete, by = "id")
```

## ARQ
### ARQ Select Variables and Recode
```{r arq}
# Select ARQ questions and recode
arq <- tpw_raw %>%
  select(id, rq1:rqd) %>%
  mutate(
    across(
      .cols = -c(id, rq1),
      .fns = ~case_when(
        .x == "1- Disagree Strongly" ~ 1,
        .x == 2 ~ 2,
        .x == 3 ~ 3,
        .x == "4- Neutral/Mixed" ~ 4,
        .x == 5 ~ 5,
        .x == 6 ~ 6,
        .x == "7- Agree Strongly" ~ 7,
        .x == "Decline to Answer" ~ -77,
        TRUE ~ NA_real_
      )
    ),
    rq1 = case_when(
      rq1 == "A" ~ "Secure",
      rq1 == "B" ~ "Disorganized/Fearful",
      rq1 == "C" ~ "Ambivalent/Anxious-Preoccupied",
      rq1 == "D" ~ "Avoidant-Dismissive",
      TRUE ~ rq1  # Keep other values unchanged
    ),
    rq1 = factor(rq1, levels = c("Secure", "Disorganized/Fearful", "Ambivalent/Anxious-Preoccupied", "Avoidant-Dismissive"))
  )

  
```

### ARQ Missing Data 
There are missing data in ARQ and missing rule applied.
```{r arq_missing}
arq %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = c("id","rq1"), # does not include rq1, no missing data 
    n_items = 5
  )%>%
  gt::gt() %>%
  gt::tab_header(
    title = "ARQ Missing Data",
    subtitle = "By Participant"
  )
```

### ARQ Calculation & Subscale
```{r arq_calculations}
# Below is the code that treats -77, -55 values as NA

arq_calc <- arq %>%
  pct_miss_fun(
    id = c("id","rq1"),  
    n_items = 4
  )%>%
  full_join(arq, by = "id") %>%
  filter(
    is.na(miss_pct) |
      miss_pct < 33 # 33% for a 4-item subscale
  )%>%
  mutate(
    across(
    .cols = c(rqa:rqd),
    .fns = ~ case_when(
      .x < 0 ~ NA_real_,
      TRUE ~ .x
    )
    
    )
  )


# compute subscales
arq_complete <- arq_calc %>%
  select(
    -missing_n,
    -miss_pct
  ) %>%
  rowwise() %>%
  mutate(
    arq_group = ifelse(all(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)), "-55",
      case_when(
        rqa == max(rqa, rqb, rqc, rqd) & sum(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)) == 1 ~ "Secure",
        rqb == max(rqa, rqb, rqc, rqd) & sum(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)) == 1 ~ "Disorganized/Fearful",
        rqc == max(rqa, rqb, rqc, rqd) & sum(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)) == 1 ~ "Ambivalent/Anxious-Preoccupied",
        rqd == max(rqa, rqb, rqc, rqd) & sum(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)) == 1 ~ "Avoidant-Dismissive",
        TRUE ~ NA_character_
      )
    )
  ) %>%
  mutate(
      arq_group = factor(replace_na(arq_group, "-99"), levels = c("-99", "Secure", "Disorganized/Fearful", "Ambivalent/Anxious-Preoccupied", "Avoidant-Dismissive")),
    arq_model_self_attach_anxiety = (rqa + rqd) - (rqc + rqb),
    arq_model_other_attach_avoid = (rqa + rqc) - (rqd + rqb)
  ) 

## there is a NA that needs resolving for #P885 (all 7s)
# Pulling in missing data codes from two participants with missing data
# renaming variables with arq prefix
arq_complete <- arq_complete %>%
  select(id, arq_group, arq_model_self_attach_anxiety, arq_model_other_attach_avoid) %>%
  full_join(arq, by="id") %>% # pulling in two cases with missing data
  relocate(arq_group:arq_model_other_attach_avoid, .after = "rqd") %>%
  # rename with arq prefix
   rename_with(~ str_replace(., "^rq", "arq"), starts_with("rq")) %>%
  # update remaining missing values to -99 due to missing data rules and not being able to compute scores either due to a tie in arqa:arqd or due to missing values
  mutate_all(~ if_else(is.na(.), as.character(-99), as.character(.)))



# -99 when there is are two items with the same highest value, because missing due to not being able to determine a top score for arq_group
# more positive scores indicate more positive models, and more negative scores indicate more negative models
 
```


## Posttraumatic Risk-Seeking Scale (PRSS)
### PRSS Select Variables and Recode
```{r prss}
prss <- tpw_raw %>%
  select(
    id,
    ps9:ps13
  ) %>%
  mutate(
    across(
      .cols = -c(id),
      .fns = ~case_when(
        .x == "None of the time" ~ 0,
        .x == "A little of the time" ~ 1,
        .x == "Some of the time" ~ 2,
        .x == "Much of the time" ~ 3,
        .x == "Most of the time" ~ 4,
        .x == "Decline to Answer" ~ -77,
        is.na(.x) ~ -99 # if truly missing: This is for HR173
      )
    )
  )
```

### PRSS Missing Data 
There are missing data in PRSS and missing rule applied.
```{r prss_missing}
prss_miss <- prss %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 5
  )

prss_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'PRSS Missing Data',
    subtitle = 'By Participant'
  )
```

### PRSS Calculation 
```{r prss_calculation}
# converting missing data to NA for total scale computation
prss_calc <- prss %>%
  mutate(
    across(
    .cols = c(ps9:ps13),
    .fns = ~ case_when(
      .x < 0 ~ NA_real_,
      TRUE ~ .x
    )
    )
  )

# the total score is a sum of the five items
# the average is not needed

prss_complete <- prss_calc %>%
  composite_total_avg_fun(
    id = 'id',
    max_value = NULL,
    n_items = 5
  ) %>%
  distinct(
    across(
      .cols = everything()
    )
  ) %>%
  rename(
    prss_total = sum_values,
    prss_avg = mean_values
  ) %>%
  rowwise() %>%
  # if missing values in 5 items (< 33%), giving prss_total -99; this applies to two cases
  mutate(
    prss_total = if (all(is.na(c_across(starts_with("ps"))))) -99 else prss_total,
    prss_avg = if (all(is.na(c_across(starts_with("ps"))))) -99 else prss_avg
  ) %>%
  ungroup()




# merging to retain original values including appropriate missing values
prss_complete <- prss_complete %>%
  select(id, prss_total) %>%
  merge(prss, by = "id") %>%
  relocate(prss_total, .after = "ps13") %>%
  # renaming ps variables to prss and changing numbers to 1-5
  rename_with(~ paste0("prss", as.numeric(str_replace(., "^ps", "")) - 8), starts_with("ps"))
```

## Shame and Stigma Questionnaire (SSQ)
### SSQ Select Variables and Recode
```{r ssq}
ssq <- tpw_raw %>%
  # renaming ps variables to prss and changing numbers to 1-5
  select(
  id,
  ps1:ps8
) %>%
  mutate(across(-id, as.factor)) %>%
  mutate(
    across(
      .cols = c(ps1:ps8),
      .fns = ~case_when(
        .x == "None of the time" ~ 0,
        .x == "A little of the time" ~ 1,
        .x == "Some of the time" ~ 2,
        .x == "Much of the time" ~ 3,
        .x == "Most of the time" ~ 4,
        .x == "Decline to Answer"~ -77,
        is.na(.x) ~ -99, # if truly missing
        TRUE ~ NA_real_
      )
    )
  ) 
```

### SSQ Missing Data
Missing Rule applied. 
```{r ssq_missing}
# Missing data threshold for this 8-item score is < 30%

# this applies to 4 cases 
ssq_miss <- ssq %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 8
  )

ssq_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = "SSQ Missing Data",
    subtitle = "By Participant"
  )

ssq_remove <- ssq_miss %>% filter(miss_pct > 30) %>% pull(id)
```

### SSQ Calculation & Subscale
```{r ssq_calculation}
ssq_calc <-
  ssq %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# We compute one total score, a sum of the 8 items

# Original questionnaire included only the first four items, but to expand relevance for adult populations (as is the case in the current study), the additional four items were added 

# Original 8-item questionnaire was measured on a three-point scale (0,1,2) with a cut point of 6

# We administered the 8-item questionnaire on a 5-point scale (0-4) with a corresponding cut point of 12


ssq_complete <- ssq_calc %>%
  mutate(
    ssq_total = ps1 + ps2 + ps3 + ps4 + ps5 + ps6 + ps7 + ps8,
    across(
      .cols = -c(id),
      .fns = ~ case_when(
        id %in% ssq_remove ~ NA_real_,
        TRUE ~ .x
      )
    ),
    ssq_total_cutoff = case_when(
      ssq_total >= 12 ~ "high shame",
      ssq_total <= 11 ~ "low shame",
      TRUE ~ NA_character_  # Add default condition to handle other cases
    )
  ) %>%
    rowwise() %>%
  # if missing values in 5 items (< 33%), giving prss_total -99; this applies to four cases
  mutate(
  ssq_total = if_else(all(is.na(c_across(starts_with("ps")))), -99, ssq_total),
  ssq_total_cutoff = if_else(all(is.na(c_across(starts_with("ps")))), "-99", ssq_total_cutoff)
) %>%
  ungroup()



## add in missing values
ssq_complete <- ssq_complete %>%
  select(id, ssq_total:ssq_total_cutoff) %>%
  merge(ssq, by = "id") %>%
  relocate(ssq_total:ssq_total_cutoff, .after = "ps8") %>%
  ## rename from ps to ssq
  rename_with(~ paste0("ssq", as.numeric(str_replace(., "^ps", ""))), starts_with("ps"))

```

## EDS-F (Friend)
### EDS-F Select Variables and Recode

```{r eds df, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

# reverse scoring
eds <-
  tpw_raw %>%
  select(
    id,
    matches(
      "^elf"
    )
  )


```

```{r}
elf <-
  tpw_raw %>%
  select(
    id,
    matches(
      "^elf"
    )
  ) %>%
  mutate(
    across(
      -c(id, elf23),
      ~case_when(
        .x == "All" ~ "4",
        .x == "Most" ~ "3",
        .x == "Some" ~ "2",
        .x == "Very Few" ~ "1",
        .x == "None" ~ "0",
        .x == "Does not apply" ~ "-55",   #TODO: Min, this should be -55 it is the same as NA.I've updated but you need to update missing data section  
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    elf23 = case_when(
      elf23 == "Only threatened to hit" ~ "1",
      elf23 == "Tried but didn't succeed" ~ "2",
      elf23 == "Actually hit" ~ "3",
      elf23 == "Decline to Answer" ~"-77",
      TRUE ~ elf23
    )
  )
```

### EDS-F Missing Data 
```{r eds-f_missing}
elf <- elf %>%
  # partially finished TC who did not complete this questionnaire
  mutate(across(-id, ~ifelse(id == "HR173", -99, .))) %>%
  mutate_at(vars(elf23), ~case_when(elf20 < 1 | elf21 < 1 | elf22 < 1 ~ "-55", TRUE ~.))

elf_complete <- elf
```



## ELL (Self-Report)
### ELL Select Variables and Recode
```{r ell}
ell <-
  tpw_raw %>%
  select(
    id, ell1:ell39a
  )  %>%
  rename(
    ell35a  = x35a
  )  %>% 
  mutate(
    across(
      matches("a$"),
      ~case_when(
        .x == "Once a month" ~ "1",  #4
        .x == "Once every 2-3 weeks" ~ "2",  #
        .x == "Once a week" ~ "3",
        .x == "2-3 times a week" ~ "4",
        .x == "Once a day" ~ "5",
        .x == "2-3 times a day" ~ "6",   
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    ell23 = case_when(
      ell23 == "Actually hit" ~ "3",
      ell23 == "Tried but didn't succeed" ~"2",
      ell23 == "Only threatened to hit" ~ "1",
      ell23 == "Decline to Answer" ~ "-77",
      TRUE ~ ell23
    )
    ) %>%
  mutate(across(-id, as.numeric))


```

### ELL Missing Data 
```{r ell_missing}
ell <- ell %>%
  # partial finished TC
  mutate(across(-id, ~ifelse(id == "HR173", -99, .))) %>%
   # Incarcerated TC weren't administered for this survey
  mutate_at(vars(ell1:ell39a), ~ ifelse(id %in% c("HR211", "HR181", "P819"), -55, .)) %>%
  # if ell20, ell21, ell22 are all less than 0 then then ell23 wasn't shown
  mutate(ell23 = case_when(ell20 <= 0 & ell21 <=0 & ell22 <=0 ~ -55, TRUE ~ ell23)) 
  

# if ellX is below 10, then ellXa should be -55 (will need remove ell23a, because we don't have that question)
for (i in 1:39) {
    ell_col <- paste0("ell", i)
    ella_col <- paste0("ell", i, "a")
    
    # Check if the "ellX" column is between 0 and 10 (excluding 10)
    ell_col_values <- ell[[ell_col]]
    set_to_55 <- ell_col_values >= 0 & ell_col_values < 10
    
    # Check if the "ellX" column is -77
    set_to_77 <- ell_col_values == -77
    
    # Set the "ellXa" column to -55 or -77 
    ell[[ella_col]][set_to_55] <- -55
    ell[[ella_col]][set_to_77] <- -77
}

ell <- ell %>%
  select(-ell23a)

# ELL Count Missing Data
# most participants will respond to the first part of each item
# don't respond to anything on the scale
# TODO: Maria: we are only counting the ellx questions for missing percentage. (ellxa qusetions are not included.)
## Min, I do want to retain the other questions, but we aren't using them for any ssubscale or total scale computation right now.
ell_miss <- ell %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = c("id", matches("a$"), ell23), # we are not counting ell23 when we are calculating total score 
    n_items = 38
  )


ell_miss %>%
  gt::gt() %>%
  gt::tab_header(title = 'Missing Data',
                 subtitle = 'By Each Participant')

ell_remove <- ell_miss %>% filter(miss_pct >= 20) %>% pull(id)


# missing for total index offenses
# (9 items el 4 el 5; ell10 ; ell 16; ell 25; ell 29; ell 32; ell 38; ell 39)
ell_total_index_offenses_miss <- ell %>%
    mutate(across(-id, as.numeric)) %>%
  select(id, ell4, ell5, ell10 , ell16, ell25, ell29, ell32, ell38, ell39) %>%
  pct_miss_fun(
    id = c("id"), 
    n_items = 9
  )


ell_total_index_offenses_miss %>%
  gt::gt() %>%
  gt::tab_header(title = 'Missing Data',
                 subtitle = 'By Each Participant')

ell_total_index_offenses_remove <- ell_total_index_offenses_miss %>% filter(miss_pct >= 30) %>% pull(id)


# missing for total index of minor offenses 
# (29 items but not 23; 1, 2, 3, 6, 7, 8, 9, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 24, 26, 27, 28, 30, 31, 33, 34, 35, 36, 37) 
ell_total_index_minor_offenses_miss <- ell %>%
    mutate(across(-id, as.numeric)) %>%
  select(id, ell1, ell2, ell3, ell6, ell7, ell8, ell9, ell11, ell12, ell13, ell14, ell15, ell17, ell18, ell19, ell20, ell21, ell22, ell24, ell26, ell27, ell28, ell30, ell31, ell33, ell34, ell35, ell36, ell37) %>%
  pct_miss_fun(
    id = c("id"), 
    n_items = 29
  )


ell_total_index_minor_offenses_miss %>%
  gt::gt() %>%
  gt::tab_header(title = 'Missing Data',
                 subtitle = 'By Each Participant')

ell_total_index_minor_offenses_remove <- ell_total_index_minor_offenses_miss %>% filter(miss_pct >= 30) %>% pull(id)

```

### ELL Calculation & Subscale 

```{r ell_calculation}
## Min for this variable I want us to save the censorsed data only for internal uses so you can pull that script.
## next I want you to sum for the following items, removing item #23 from these scales
# total score of all items (38 items in total but not #23)
# Min, need to check if we need to apply missing data rule specifically for index offenses; if someone is missing more than 3 items specifically from index offenses we wouldn't compute
# total index offenses (9 items el 4 el 5; ell10 ; ell 16; ell 25; ell 29; ell 32; ell 38; ell 39)
# total index of minor offenses (29 items but not 23; 1, 2, 3, 6, 7, 8, 9, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 24, 26, 27, 28, 30, 31, 33, 34, 35, 36, 37)


ell_calc <-
  ell %>%
  select(id, matches("\\d+$")) %>%
  mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -c(
        id
      ),
      .fns = ~case_when(
        .x < 0 ~ NA,
        TRUE ~ .x
      )
    )
  )




ell_complete <- ell_calc %>%
  # total score of all items (38 items in total but not #23)
  mutate(ell_total = rowSums(select(., c(matches("\\d+$"), -ell23)), na.rm = T)) %>%
  # apply missing rule to total score 
  mutate_at(vars(ell_total), ~case_when(id %in% ell_remove ~ -99, TRUE ~ .x )) %>%
  # total index offenses (9 items ell4 ell5; ell10 ; ell16; ell25; ell29; ell32; ell38; ell39)
  mutate(ell_total_index_offenses = rowSums(select(., c(ell4, ell5, ell10 , ell16, ell25, ell29, ell32, ell38, ell39)), na.rm = T)) %>%
  # apply missing rule to ell_total_index_offenses
  mutate_at(vars(ell_total_index_offenses), ~case_when(id %in% ell_total_index_offenses_remove ~ -99, TRUE ~ .x )) %>%
  # total index of minor offenses (29 items but not 23; 1, 2, 3, 6, 7, 8, 9, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 24, 26, 27, 28, 30, 31, 33, 34, 35, 36, 37) 
  mutate(ell_total_index_minor_offenses = rowSums(select(., c(ell1, ell2, ell3, ell6, ell7, ell8, ell9, ell11, ell12, ell13, ell14, ell15, ell17, ell18, ell19, ell20, ell21, ell22, ell24, ell26, ell27, ell28, ell30, ell31, ell33, ell34, ell35, ell36, ell37)), na.rm = T)) %>%
  # apply missing rule to ell_total_index_minor_offenses
  mutate_at(vars(ell_total_index_minor_offenses), ~case_when(id %in% ell_total_index_minor_offenses_remove ~ -99, TRUE ~ .x )) 

  
ell_complete <- ell_complete%>%
  select(id, ell_total, ell_total_index_offenses, ell_total_index_minor_offenses) %>%
  merge (ell, by = "id", all.y = TRUE) %>%
  relocate(id, .before = "ell1") %>% 
  relocate(ell_total, ell_total_index_offenses,ell_total_index_minor_offenses, .after = "ell39a")

```

## MHC-SF
### MHC-SF Select Variables and Recode
```{r mhc-sf}
mhc <-
  tpw_raw %>%
  select(
    id,
    matches(
      "^h"
    )
  ) %>%
  mutate(across(-id)) %>%
  mutate(
    across(
      .cols = c(h1:h14),
      .fns = ~case_when(
        .x == "Never" ~ "0",
        .x == "Once or Twice" ~ "1",
        .x == "About Once A week" ~ "2",
        .x == "About 2 or 3 Times a Week" ~ "3",
        .x == "Almost Every Day" ~ "4",
        .x == "Every Day" ~ "5",
        .x == "Decline to Answer"~ "-77",
        TRUE ~ .x
      )
    )
  ) 

```

### MHC-SF Missing Data
There are missing data. The missing data rule applies for two participants for the swb subscale. 
```{r mhc-sf_missing}
###### Missing percentage for total 
mhc_miss <- mhc %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 14
  )

mhc_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'Missing Data',
    subtitle = 'By Each Participant'
  )


mhc_remove <- mhc_miss %>% filter(miss_pct >= 20) %>% pull(id) # No one need to be removed 

###### Missing percentage for mhc_pa
mhc_pa_miss <- mhc %>%
  select(id, "h1", "h2", "h3") %>%
  mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 3
  )

mhc_pa_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'mhc_pa Missing Data',
    subtitle = 'By Each Participant'
  )
 
mhc_pa_remove <- mhc_pa_miss %>% filter(miss_pct >= 33) %>% pull(id) # No one need to be removed 

###### Missing percentage for mhc_swb
mhc_swb_miss <- mhc %>%
  select(id, "h4", "h5", "h6", "h7", "h8") %>%
  mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 5
  )

mhc_swb_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'mhc_swb Missing Data',
    subtitle = 'By Each Participant'
  )
 
mhc_swb_remove <- mhc_swb_miss %>% filter(miss_pct >= 33) %>% pull(id) # P845; P854

###### Missing percentage for mhc_pwb
mhc_pwb_miss <- mhc %>%
  select(id, "h9", "h10", "h11", "h12", "h13", "h14") %>%
  mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 5
  )

mhc_pwb_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'mhc_swb Missing Data',
    subtitle = 'By Each Participant'
  )
 
mhc_pwb_remove <- mhc_pwb_miss %>% filter(miss_pct >= 33) %>% pull(id)  # No one need to be removed 

```

### MHC-SF Calculation & Subscale
```{r mhc-sf_calc}
mhc_calc <-
  mhc %>%
  mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x == -77 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )



mhc_complete <-
  mhc_calc %>%
  composite_total_avg_fun(
    id = 'id',
    max_value = 5,
    n_items = 14
  ) %>%
  distinct(
    across(
      .cols = everything()
    )
  ) %>%
  subscale_create(
    total_only = TRUE,
    scale1 = c("h1", "h2", "h3"), # mhc_pa
    scale1_nitems = 3,
    scale2 = c("h4", "h5", "h6", "h7", "h8"),# mhc_swb
    scale2_nitems = 5,
    scale3 = c("h9", "h10", "h11", "h12", "h13", "h14"), # mhc_pwb
    scale3_nitems = 6
  ) %>%
  rename(
    mhc_total = sum_values,  # all 14 items 
    #mhc_avg = mean_values,
    mhc_pa = total1,
    #mhc_pa_avg = avg1,
    mhc_swb = total2,
    #mhc_swb_avg = avg2,
    mhc_pwb = total3,
    #mhc_pwb_avg = avg3
  ) %>%
  # apply missing rule for mhc_total 
  mutate(across(c(mhc_total), ~case_when(id %in% mhc_remove ~ -99, TRUE ~ .x))) %>%
  # apply missing rule for mhc_pa 
  mutate(across(c(mhc_pa), ~case_when(id %in% mhc_pa_remove ~ -99, TRUE ~ .x))) %>%
  # apply missing rule for mhc_swb
  mutate(across(c(mhc_swb), ~case_when(id %in% mhc_swb_remove ~ -99, TRUE ~ .x))) %>%
  # apply missing rule for mhc_pwb
  mutate(across(c(mhc_pwb), ~case_when(id %in% mhc_pwb_remove ~ -99, TRUE ~ .x))) %>%
  select(-mean_values) %>%
  select(id, mhc_total, mhc_pa, mhc_swb, mhc_pwb)

mhc_complete <- mhc %>%
  merge(mhc_complete, by = "id") %>%
    #update prefix h to mhc
  rename_with(~ paste0("mhc", as.numeric(substring(., 2))), starts_with("h"))

## MARIA to do -- add note about diagnoses in codebook
  
```

## Flourishing Index (FI)
### FI Select Variable and Recode 
```{r fi}
flo <- tpw_raw %>%
  select(
    id,
    i1:i12
  ) %>%
    mutate(
    across(
      .cols = c(i1:i12),
      .fns = ~case_when(
        .x == "0 - Not Satisfied at all" ~ "0",
        .x == "0 - Strongly Disagree" ~ "0",
        .x == "0 - Worry all of the time" ~ "0",
        .x == "0 - Poor" ~ "0",
        .x == "0 - Not at all worthwhile" ~ "0",
        .x == "0 - Not true of me" ~ "0",
        .x == "0 - Extremely Unhappy" ~ "0",
        .x == "1" ~ "1",
        .x == "2" ~ "2",
        .x == "3" ~ "3",
        .x == "4" ~ "4",
        .x == "5" ~ "5",
        .x == "6"~ "6",
        .x == "7"~ "7",
        .x == "8"~ "8",
        .x == "9"~ "9",
        .x == "10 - Completely Satisfied"~ "10", 
        .x == "10 - Extremely Happy"~ "10", 
        .x == "10 - Excellent"~ "10",
        .x == "10 - Completely Worthwhile" ~ "10",
        .x == "10 - Strongly Agree" ~ "10", 
        .x == "10 - Completely true of me" ~ "10", 
        .x == "10 - Do not ever worry" ~ "10", 
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    )
  ) 
```

### FI Missing Data 
There are missing data in FI and missing rule applied for one participant 
```{r}
flo <- flo %>%
  # We don't know why these variable were missing for this TC
  mutate_at(vars(i8, i10, i12), ~case_when(id %in% c("P847") & is.na(.) ~ "-99", TRUE ~ .)) 
  

# missing percentage for total score (total score should only contain 1-10)
flo_miss <- flo %>%
  select(id, i1:i10) %>%
  mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 10
  )

flo_miss %>%
  gt::gt() %>%
  gt::tab_header(title = 'Missing Data',
                 subtitle = 'By Each Participant')


flo_remove <- flo_miss %>% filter(miss_pct >= 20) %>% pull(id) # p847


 
# missing percentage for "secure flourish": average of items i11 and i12
secure_flourish_miss <- flo %>%
  select(id, i11:i12) %>%
  mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 2
  )

secure_flourish_miss %>%
  gt::gt() %>%
  gt::tab_header(title = 'Missing Data',
                 subtitle = 'By Each Participant')

# If they are missing one items then we are not calculate this subscale 
secure_flourish_remove <- secure_flourish_miss %>% filter(miss_pct >= 50) %>% pull(id) # p847
```

### FI Calculation & Subscale 
```{r}
flo_calc <-
  flo %>%
  mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )


# calculate flo_total; Secure_flourish; And apply missing rule
flo_complete <- flo_calc %>%
  # total score should only contain 1-10
  mutate(flo_total = rowSums(select(., i1:i10), na.rm = T)) %>%
  # apply missing rule: replacing total score with -99 because due to 25% missing data this score isn't valid  
  mutate_at(vars(flo_total), ~case_when(id %in% flo_remove ~ -99, TRUE ~ .x )) %>%
  # "secure flourish": average of items i11 and i12
  mutate(Secure_flourish = rowMeans(select(., i11:i12), na.rm = T)) %>%
  # Apply missing rule: replacing total score with -99 because due to 50% missing data this score isn't valid  
  mutate_at(vars(Secure_flourish), ~case_when(id %in% secure_flourish_remove ~ -99, TRUE ~ .x )) 
  
# Create final flo df 
flo_complete <- flo_complete %>%
  select(id, flo_total, Secure_flourish) %>%
  merge(flo, by = "id") %>%
  relocate(flo_total, .after = "i12") %>%
  relocate(Secure_flourish, .after = "flo_total") %>%
  # changing prefix to align "i" to "flo"
  rename_with(~str_replace(., "^i", "flo"), matches("^i\\d"))
```

##ITQ
### ITQ Select Vartiable and Recode 
```{r itq}
itq <- tpw_raw %>% 
  select(
    id,
    matches(
      "^itq"
    )
  )  %>%
    mutate(
    across(
      .cols = c(itq1:itq9),
      .fns = ~case_when(
        .x == "Not at all" ~ "0",
        .x == "A little bit" ~ "1",
        .x == "Moderately" ~ "2",
        .x == "Quite a bit" ~ "3",
        .x == "Extremely" ~ "4",
        .x == "Decline to Answer" ~ "-55",
      #  is.na(.x) ~ -99, # if truly missing
        TRUE ~ .x
      )
    )
  ) 
```

### ITQ Missing Data 
There are missing data and missing rule applied. 
```{r itq_missing}
itq <- itq %>%
  # partially finished TC
  mutate(across(-id, ~ifelse(id == "HR173", -99, .))) 

itq_miss <- itq %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 9
  )

itq_miss %>%
  gt::gt() %>%
  gt::tab_header(title = 'Missing Data',
                 subtitle = 'By Each Participant')

itq_remove <- itq_miss %>% filter(miss_pct >= 20) %>% pull(id)
```

### ITQ Calculation & Subscale 
```{r itq_calc}
itq_calc <- itq %>% 
    mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# This code can be used to compute diagnoses based on participant endorsing at least one symptom in each cluster
itq_calc <- itq_calc %>%
  mutate(
    itq_re_dx = case_when(
      (itq1 >= 1 | itq2 >= 1) ~ "diagnosis_met",
      (itq1 < 1  & itq2 < 1) ~ "diagnosis_not_met",
      TRUE ~ "conditions_not_met"
    ),
    itq_av_dx = case_when(
      (itq3 >= 1 | itq4 >= 1)  ~ "diagnosis_met",
      (itq3 < 1 & itq4 < 1)  ~ "diagnosis_not_met",
      TRUE ~ "conditions_not_met"
    ),
    itq_th_dx = case_when(
      (itq5 >= 1 | itq6 >= 1) ~ "diagnosis_met",
      (itq5 < 1 & itq6 < 1) ~ "diagnosis_not_met",
      TRUE ~ "conditions_not_met"
    ),
    itq_fi_dx = case_when(
      (itq7 >= 1 | itq8 >= 1 | itq9 >= 1) ~ "diagnosis_met",
      (itq7 < 1 & itq8 < 1 & itq9 < 1) ~ "diagnosis_not_met",
      TRUE ~ "conditions_not_met"
    ),
    itq_pstd_dx = case_when(
      (itq_re_dx == "diagnosis_met" &
         itq_av_dx == "diagnosis_met" &
         itq_th_dx == "diagnosis_met" &
         itq_fi_dx == "diagnosis_met") ~ "diagnosis_met",
      TRUE ~ "diagnosis_not_met"
    )
  )

itq_complete <-
  itq_calc %>%
  subscale_create(
    total_only = TRUE,
    scale1 = c("itq1", "itq2"),
    scale2 = c("itq3", "itq4"),
    scale3 = c("itq5", "itq6")
  ) %>%
  rename(
    itq_re_total = total1,
    itq_av_total = total2,
    itq_th_total = total3
  ) %>%
  mutate(
    itq_ptsd_total = (itq_re_total + itq_av_total + itq_th_total)) %>%
  mutate_at(vars(itq8), ~ifelse(is.na(.), -77, .))#,
  #   across(
  #     -c(id
  #     ),
  #    ~case_when(
  #      id %in% itq_remove ~ NA,
  #        TRUE ~ .x
  #      )
  #   )
  # )

itq_complete <- itq_complete %>%
  select(id, itq_re_total, itq_av_total, itq_th_total) %>%
  merge(itq, by="id", all.y = TRUE) %>%
  relocate(itq_re_total, itq_av_total, itq_th_total, .after = "itq9")
```


## IBQ
### IBQ Select Variables and Recode
```{r ibq}
ibq <-
  tpw_raw %>%
  select(
    id,
    matches(
      '^ibq'
    )
  ) %>%
  mutate(across(-id, as.factor),
      across(
         .cols = c(ibq1:ibq9),
        .fns = ~case_when(
         .x == "Yes" ~ "1",
         .x == "No" ~ "0",
         .x == "Decline to Answer" ~ "-77",
         TRUE ~ .x
        )
      ),
      ibq10_77 = case_when(ibq10_77 == "Decline to Answer" ~ "-77", TRUE ~ "0"),
    across(
      .cols = c(ibq10_1:ibq10_9),
      .fns = ~if_else(!is.na(.x), "1", "0"))
    ) %>%
  mutate(ibq10_9 = ifelse(tolower(ibq10_9_text) %in% c("none", "no institutions selected"), "0", ibq10_9)
) %>%
  mutate(ibq9 = ifelse(ibq9 %in% c("N/A"), "-55", ibq9)) %>% 
  mutate(across(ibq10_1:ibq10_9, as.numeric))%>%
  #ibq10 is total number of systems selected 
  mutate(ibq10 = rowSums(select(., ibq10_1:ibq10_9), na.rm = TRUE))%>% 
# Min, we may consider ibq = 1 they selected systems; 0 none selected and then create a new variable that shows the total number of systems selected -> ibq10 is total number 
  # mutate(ibq10 = as.character(ibq10))%>% 
  mutate(ibq10_77 = as.numeric(ibq10_77))%>%
  mutate_at(vars(ibq10_1:ibq10_9, ibq10), ~case_when(ibq10_77 < 0  ~ -77, TRUE ~ . )) %>%
  mutate_at(vars(ibq10_9_text), ~case_when(is.na(ibq10_9_text) ~ "-55", TRUE ~ . )) %>%
  rename(ibq10_school = ibq10_1) %>%
  rename(ibq10_juvenile_justice = ibq10_2) %>%
  rename(ibq10_legal_system = ibq10_3) %>%
  rename(ibq10_police = ibq10_4) %>%
  rename(ibq10_medical = ibq10_5) %>%
  rename(ibq10_church = ibq10_6) %>%
  rename(ibq10_foster_care = ibq10_7) %>%
  rename(ibq10_child_welfare = ibq10_8) %>%
  rename(ibq10_other = ibq10_9) %>%
  rename(ibq10_other_text = ibq10_9_text) %>%
  relocate(ibq10, .after = ibq9) %>%
  relocate(ibq10_other_text, .after = ibq10_other)
```

### IBQ Missing Data 
There are missing data, however missing data rule not applied given this is a total sum of the number of systems endorsed; missing data only applied for individuals who did not complete any questions in this measure (n = 2) 
```{r ibq_missing }
# correct missing value: Not Applicable = -55 = The subject was never asked a question for some reason (conditional question)
ibq <- ibq %>%
  # partial finished TC
  mutate(across(-c(id,ibq10_other_text), ~ifelse(id == "HR173", "-99", .))) 

ibq_miss <- ibq %>%
  mutate(across(-c(id,ibq10_other_text), as.numeric))%>%
  select(id, ibq1:ibq7) %>%  # only ibq1:ibq7 was used to calculated ibq_total
  pct_miss_fun(
    id = c("id"),
    n_items = 10
  ) 

ibq_miss %>% 
  gt::gt() %>% 
  gt::tab_header(
    title = 'IBQ Missing Data',
    subtitle = 'By Participant')

ibq_remove <- ibq_miss %>% filter(miss_pct >= 30) %>% pull(id)
```

### IBQ Calculations & Subscale
```{r ibq_calculations}
# Below is the code that treats -77, -55 values as NA
ibq_calc <-
  ibq %>%
  mutate(across(-c(id,ibq10_other_text), as.numeric)) %>%
  mutate(
    across(
      .cols = -c(id,ibq10_other_text),
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# Here we drop the ibq10_text variables so we can later compute clean merge 
ibq <- ibq %>%
  select(id:ibq10)

# IBQ Total Sum Score creation
ibq_complete <-
  ibq_calc %>%
  mutate(ibq_total = rowSums(select(., ibq1:ibq7), na.rm = T)) %>%
  # Apply missing rule for ibq_total 
  mutate_at(vars(ibq_total), ~case_when(id %in% ibq_remove ~ -99, TRUE ~ .))


## Pull in missing values
# drop ibq10_77 as this is an empty value

ibq_complete <- ibq_complete %>%
  select(id, ibq10_school:ibq10_other_text, ibq_total) %>% # value in ibq10_77 is represented in other ibq10 items 
  merge(ibq, by="id") %>%
  relocate(ibq10_school:ibq10_other_text, .after = "ibq10") %>%
  relocate(ibq_total, .after = "ibq10_other_text")

## de-identify ibq10 open text
## update values when person endorsed a system already listed
## [   ] indicates the one word was removed to de-identify; otherwise, values were re-coded to be de-identified

## pull in internal code when creating external archive file 

# code goes here
# this code also handles missing data


```

## Sex History Survey
### SEX Select Variables and Recode
```{r sex}
sex <- tpw_raw%>% 
  select(
    id,
    s_pregnancy_screen:s48
  )%>%
  mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        # s_pregnancy_screen
        # sex_current_engage ~ s3
        # sex_current_live ~ s4
        # sex_current_marry ~s6
        # sex_other_safesex ~ s13
        # sex_std ~ s22
        # sex_check_out ~ s23
        # sex_bloodtest_hiv ~ s26
        # sex_sex_relation_justmet ~ s35
        # sex_sex_relation_w_injects ~ s38
        # sex_intercourse_male_partner ~ s39
        # sex_intercourse_male_nocondom ~ s40
        # sex_intercourse_female_partner ~ s44
        # sex_oralsex_female_partner ~ s45
        .x == "Yes" ~"1",
        .x == "No" ~"0",
        
        # sex_might_be_preg ~ s28
        .x == "1. Yes" ~ "1",
        .x == "2. No" ~ "0",
        .x == "4. I became pregnant prior to this last 6 months and knew that I was pregnant prior to this 6 month period" ~ "2",
        
        # sex_current_date ~ s1
        .x =="1          Yes" ~ "1", # space needed
        .x =="2 No" ~ "0",
        
        #sex_part_gender_id ~ s1a
        .x == "Cisgender female or woman" ~ "1",
        .x == "Female/Woman" ~"3",
        .x == "Cisgender male or man" ~ "2",
        .x == "Male/Man" ~ "4",
        .x == "Trans female/woman" ~ "7",
        .x == "Trans male/man" ~ "8",
        .x == "Non-binary"~ "5",
        .x == "Prefer to self-identify" ~ "6", 
        
        # sex_pressure_stress ~s9
        .x == "a great deal" ~ "5",
        .x == "quite a lot" ~ "4",
        .x == "some" ~"3",
        .x == "not much" ~ "2",
        .x == "very little" ~ "1",
        
        #sex_id_feeling ~ s10
        .x == "1 - heterosexual (attracted to the opposite sex)" ~ "1",
        .x == "2 - gay or lesbian (attracted to the same sex)" ~ "2",
        .x == "3 - bi-sexual (attracted to both males and females)" ~ "3",
        .x == "4 - Other: Please describe" ~"4",
        
        # sex_talk_safesex ~ s11
        # sex_talk_safesex_other_person ~ s16
        .x == "1 - Never" ~ "0",
        .x == "1 - never" ~ "0",
        .x == "2 - Rarely" ~ "1",
        .x == "2 - rarely" ~ "1",
        .x == "3 - Sometimes" ~ "2",
        .x == "3 - sometimes" ~ "2",
        .x == "4 - Often" ~ "3",
        .x == "4 - often" ~ "3",
        .x == "5 - Very Often" ~ "4",
        .x == "5 - very often" ~ "4",

        # sex_talk_comfort ~ s12
        # sex_talk_comfort_other_person ~ s17
        # sex_birthcontrol_sex_with ~ s18
        # sex_safesex_sex_with ~ s19
         .x == "very comfortable" ~ "5",
         .x == "1 - very comfortable" ~ "5",
         .x == "somewhat comfortable" ~ "4",
         .x == "2 - somewhat comfortable" ~ "4",
         .x == "neutral" ~ "3",
         .x == "3 - neutral" ~ "3",
         .x == "somewhat uncomfortable" ~ "2",
         .x == "4 - somewhat uncomfortable" ~ "2",
         .x == "very uncomfortable" ~ "1",
         .x == "5 - very uncomfortable" ~ "1",
        
        # sex_other_person_safesex ~ s14
        .x == "1 - friend" ~ "2",
        .x == "2 - romantic partner" ~ "6",
        .x == "3 - sister or brother" ~ "7",
        .x == "4 - other relative" ~ "4",
        .x == "5 - counselor, teacher, doctor" ~ "1",
        .x == "6 - parent/parent figure" ~ "5",
        .x == "7 - other (please describe:)" ~ "3",

        # sex_confident_condom ~ s20
        .x == "1 - Very Confident" ~ "3",
        .x == "2 - Somewhat Confident" ~ "2",
        .x == "3 - A little Confident" ~ "1",
        .x == "4 - Not at all Confident" ~ "0",
        
        # sex_further_sexually ~ s21
        # sex_safesex_prev_std ~ s33
        # sex_alcohol_sex_relation ~ s36
        # sex_cannabis_drugs_sex_relation ~ s37
        .x == "1 - Always or almost always" ~ "4",
        .x == "1.\tAlways or almost always" ~ "4",
        .x == "2 - Often" ~ "3",
        .x == "2.\tOften" ~ "3",
        .x == "3.\tAbout half the time" ~ "2",
        .x == "3 - About half the time" ~ "2",
        .x == "4 - Occasionally" ~ "1",
        .x == "4.\tOccasionally" ~ "1",
        .x == "5 - Never or almost never" ~ "0",
        .x == "5.\tNever or almost never" ~ "0",

        
        # sex_std_happen ~ s24
        .x == "Yes, I had a Sexually Transmitted Disease -STD  (positive diagnosis)" ~ "1",
        .x == "I did not have an STD (negative diagnosis)" ~ "0",
        .x == "I don't know yet; still waiting for the results" ~ "2", 
        
        # s25
        .x == "a. Genital herpes" ~ "1",
        .x == "b. Genital warts" ~ "2",
        .x == "c. AIDS/HIV" ~ "3",
        .x == "d. Hepatitis B" ~ "4",
        .x == "e.   Gonorrhea (clap)" ~ "5",
        .x == "f.    Syphilis" ~ "6",
        .x == "g.   Chlamydia" ~ "7",
        .x == "h.   Other: Specify" ~ "8",
        .x == "i. Don't Remember" ~ "9",
        
        # sex_preg_what_happen ~ s29
        .x == "1 - Went to doctor, Positive diagnosis" ~ "1",
        .x == "2 - Went to doctor, Negative diagnosis" ~ "2",
        .x == "3 - Went to doctor, Don't know" ~ "3",
        .x == "4 - Took a home test, positive" ~ "4",
        .x == "5 - Took a home test, negative" ~ "5",
        .x == "6 - Took a home test, don't know" ~ "6",
        .x == "7 - Did nothing, negative (period started)" ~ "7",
        .x == "8 - Did nothing, don't know" ~ "8",
        
        # s32
        .x == "1.\tMale, same age or younger" ~ "1",
        .x == "2.\tMale, 1-2 years older" ~ "2",
        .x == "3.\tMale, more than 2 years older" ~ "3",
        .x == "4.\tFemale, same age or younger" ~ "4",
        .x == "5.\tFemale, 1-2 years older" ~ "5",
        .x == "6. Female, more than 2 years older" ~ "6",
        .x == "7. Non-binary and/or Other Gender, same age or younger" ~ "7",
        .x == "8. 7. Non-binary and/or Other Gender, 1-2 years older" ~ "8",
        .x == "9. 7. Non-binary and/or Other Gender, more than 2 years older" ~ "9",
        .x == "" ~ "10",
        # sex_percent_sex_relation_safesex_prev_std ~ s34
        .x == "1  \tNever               \t0%" ~ "0",
        .x == "2  \tRarely             \t1 - 15%" ~ "1",
        .x == "3  \tOccasionally    \t15 - 40%" ~ "2",
        .x == "4  \tAbout half the time\t40 - 60%" ~ "3",
        .x == "5  \tUsually             \t60 - 85%" ~ "4",
        .x == "6  \tMost of the time   \t85 -99%" ~ "5",
        .x == "7  \tEvery single time  \t100%" ~ "6",
        # sex_percent_w_male_use_birthcontrol ~ s43
        .x == "Don't know" ~ "-66",
        .x == "10       Not using birth control because I am currently pregnant" ~ "7",
        # sex_oralsex_dentaldam_female_partner ~ s46
        .x == "Yes, had oral sex without a dental dam" ~ "1",
        .x == "No, oral sex and always used dental dam (stop here, you are finished)" ~ "0",
        
        .x == "Decline to Answer" ~ "-77",
        .x == "decline to answer" ~ "-77",
        .x == "Decline to answer" ~ "-77",
        .x == "6 - Decline to Answer" ~ "-77",
        .x == "6 - decline to answer" ~ "-77",
        .x == "6 - Decline to answer" ~ "-77",
        .x == "5 - decline to answer" ~ "-77",
        .x == "5 - Decline to answer" ~ "-77",
        .x == "3. Decline to answer" ~ "-77",
        .x == "9 - Decline to answer" ~ "-77",
        .x == "10. Decline to answer" ~ "-77",
         
        TRUE ~ .x
      )
    )
  )


# Combine sex25 answer options to sex25 but retain these variables to make dichotomous
sex$s25 <- apply(sex[, c("s25_1","s25_2","s25_3","s25_4","s25_5","s25_6","s25_7","s25_8","s25_9","s25_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sex32 answer options to sex32 but retain these variables to make dichotomous
sex$s32 <- apply(sex[, c("s32_1","s32_2","s32_3","s32_4","s32_5","s32_6","s32_7","s32_8","s32_9","s32_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

## renaming the multiple choice variables to be dichotomous (s25)
sex <- sex %>%
  mutate(
    s25_genitalherpes = case_when(
      s25_1 %in% c("1", "-77") ~ as.integer(s25_1),
      TRUE ~ 0
    ),
    s25_genitalWarts = case_when(
      s25_2 %in% c("2", "-77") ~ ifelse(s25_2 == "2", 1, -77),
      TRUE ~ 0
    ),
    s25_aidsHIV = case_when(
      s25_3 %in% c("3", "-77") ~ ifelse(s25_3 == "3", 1, -77),
      TRUE ~ 0
    ),
    s25_hepB = case_when(
      s25_4 %in% c("4", "-77") ~ ifelse(s25_4 == "4", 1, -77),
      TRUE ~ 0
    ),
    s25_gon = case_when(
      s25_5 %in% c("5", "-77") ~ ifelse(s25_5 == "5", 1, -77),
      TRUE ~ 0
    ),
    s25_syph = case_when(
      s25_6 %in% c("6", "-77") ~ ifelse(s25_6 == "6", 1, -77),
      TRUE ~ 0
    ),
    s25_chlam = case_when(
      s25_7 %in% c("7", "-77") ~ ifelse(s25_7 == "7", 1, -77),
      TRUE ~ 0
    ),
    s25_other = case_when(
      s25_8 %in% c("8", "-77") ~ ifelse(s25_8 == "8", 1, -77),
      TRUE ~ 0
    ) 
  ) %>%
  select(-s25_1, -s25_2, -s25_3, -s25_4, -s25_5, -s25_6, -s25_7, -s25_8, -s25_9, -s25_77) # no values in _77 or _9 so removing

## renaming the multiple choice variables to be dichotomous (s32)

sex <- sex %>%
  mutate(
    s32_maleSame = case_when(
      s32_1 %in% c("1", "-77") ~ as.integer(s32_1),
      TRUE ~ 0
    ),
    s32_maleOlder1_2 = case_when(
      s32_2 %in% c("2", "-77") ~ ifelse(s32_2 == "2", 1, -77),
      TRUE ~ 0
    ),
    s32_maleOlder2 = case_when(
      s32_3 %in% c("3", "-77") ~ ifelse(s32_3 == "3", 1, -77),
      TRUE ~ 0
    ),
    s32_femaleSame = case_when(
      s32_4 %in% c("4", "-77") ~ ifelse(s32_4 == "4", 1, -77),
      TRUE ~ 0
    ),
    s32_femaleOlder1_2 = case_when(
      s32_5 %in% c("5", "-77") ~ ifelse(s32_5 == "5", 1, -77),
      TRUE ~ 0
    ),
    s32_femaleOlder2 = case_when(
      s32_6 %in% c("6", "-77") ~ ifelse(s32_6 == "6", 1, -77),
      TRUE ~ 0
    ),
    s32_NBSame = case_when(
      s32_7 %in% c("7", "-77") ~ ifelse(s32_7 == "7", 1, -77),
      TRUE ~ 0
    ),
    s32_NBOlder1_2 = case_when(
      s32_8 %in% c("8", "-77") ~ ifelse(s32_8 == "8", 1, -77),
      TRUE ~ 0
    ),
    s32_NBOlder2 = case_when(
      s32_9 %in% c("9", "-77") ~ ifelse(s32_8 == "9", 1, -77),
      TRUE ~ 0
    ) 
  ) %>%
  select(-s32_1, -s32_2, -s32_3, -s32_4, -s32_5, -s32_6, -s32_7, -s32_8, -s32_9, -s32_77) # removing -77 because no one endorsed


```

There are missing data and missing rule would be applied in future computations
```{r sex_missing}
sex <- sex %>% 
  # for incarcerated TC, this survey wasn't shown 
   mutate_at(vars(s_pregnancy_screen:s48), ~case_when(id %in% c("HR211", "HR181", "P819") & is.na(.)  ~ "-55", TRUE ~ .)) %>%
   # Skip rule: if s1 select no/Decline (0/-77), then skip s1a:s8
   mutate_at(vars(s1a:s8), ~case_when(s1 != 1 ~ "-55", TRUE ~ . )) %>%
  mutate_at(vars(s2a,s2b,s2c), ~case_when(is.na(.x) ~ "0", TRUE ~ . )) %>%
  # if s1a != 8, s1a_8_text should be -55 
  # mutate_at(vars(s1a_8_text), ~case_when(s1a != 8 ~ "-55", TRUE ~ . )) %>%
   # Skip rule: if s4 select no/Decline (0/-77), then skip s5:s5c
   mutate_at(vars(s5:s5c), ~case_when(s4 != 1 ~ "-55", TRUE ~ . )) %>%
    mutate_at(vars(s5a,s5b,s5c), ~case_when(is.na(.x) ~ "0", TRUE ~ . )) %>%
   # skip rule: if s3 is not Yes-1, s6is skipped  
   mutate_at(vars(s6), ~case_when(s3 == 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s3 is Yes-1 | s6 != 1 , s7 is skipped  
   mutate_at(vars(s7), ~case_when(s3 == 1 | s6 != 1 ~ "-55", TRUE ~ . )) %>%
    # if s10 != 4, s10_4_text should be -55 
  mutate_at(vars(s10_4_text), ~case_when(s10 != 4 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s11 is Never(0) | s11 == -77 , s12 is skipped  
   mutate_at(vars(s12), ~case_when(s11 == 0 | s11 == -77 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s13 is not Yes-1, s14:s17 is skipped  
   mutate_at(vars(s14:s17), ~case_when(s13 != 1 ~ "-55", TRUE ~ . )) %>%
      # if s14 != 3, s14_8_text should be -55 
  mutate_at(vars(s14_8_text), ~case_when(s14 != 3 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s22 is not Yes-1, s23:s25 is skipped  
   mutate_at(vars(s23:s25), ~case_when(s22 != 1 ~ "-55", TRUE ~ . )) %>%
   # skip rule: if s23 is not Yes-1, s24:s25 is skipped 
   mutate_at(vars(s24:s25), ~case_when(s23 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s24 is not Yes-1, s25 is skipped  
   mutate_at(vars(s25), ~case_when(s24 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s26 is not Yes-1, s27 is skipped  
   mutate_at(vars(s27), ~case_when(s26 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s28 is not Yes-1, s29 is skipped  
   mutate_at(vars(s29), ~case_when(s28 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s30 <=0, s31:s35, s39, s40, s43, s44 is skipped  
   mutate_at(vars(s31:s35, s39, s40, s43, s44), ~case_when(s30 <= 0 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s_pregnancy_Screen is not No (0) | s30 <=0, s36:s38 is skipped
   mutate_at(vars(s36:s38), ~case_when(s_pregnancy_screen != 0 | s30 <= 0 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s39 is not Yes-1, s40:s43 is skipped  
   mutate_at(vars(s40:s43), ~case_when(s39 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s40 is not Yes-1, s40:s42 is skipped  
   mutate_at(vars(s40:s42), ~case_when(s40 != 1 ~ "-55", TRUE ~ . )) %>%
    # skip rule: if s40 is not Yes (1) | s30 <=0, s41:s42 is skipped  
   mutate_at(vars(s41:s42), ~case_when(s40 != 1 | s30 <= 0 ~ "-55", TRUE ~ . )) %>%
   # skip rule: if s44 is not Yes (1), s45:s48 is skipped  
   mutate_at(vars(s45:s48), ~case_when(s44 != 1 ~ "-55", TRUE ~ . )) %>%
   # skip rule: if s44 is not Yes (1) | s30 <=0, s45 is skipped  
   mutate_at(vars(s45), ~case_when(s44 != 1 | s30 <= 0 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s45 is not Yes (1), s46:s48 is skipped
   mutate_at(vars(s46:s48), ~case_when(s45 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s45 is not Yes (1) | s30 <=0, s45, s47 is skipped  
   mutate_at(vars(s46:s48), ~case_when(s45 != 1 | s30 <= 0 ~ "-55", TRUE ~ . )) %>%
  # s1_8_text NAs to -55 
  mutate(s1a_8_text = ifelse(is.na(s1a_8_text) | s1a_8_text == "NA", -55, s1a_8_text)) %>%
  # catching NAs that weren't caught because s25 was endorsed
  mutate(s25_8_text = ifelse(is.na(s25_8_text) | s25_8_text == "NA", -55, s25_8_text)) %>%
   # skip rule: if s46 is not Yes (1), s47:s48 is skipped  
  mutate_at(vars(s47:s48), ~case_when(s46 != 1 ~ "-55", TRUE ~ . )) %>%
  # p813 for s12 changed to -99 because truly missing. 
  mutate_at(vars(s12), ~case_when(id == "P813" ~ "-55", TRUE ~ . )) %>%
  relocate(s25, .before = s25_8_text) %>%
  relocate(s32, .before = s33) %>%
  relocate(62:69, .after = 37) %>%
  relocate(70:78, .after = 53 ) 


# before next steps, editing dates so only mm/dddd and DD 01 for s2, s5, and s7

## Function to convert character to date with day to 01

convert_to_date <- function(x) {
  parsed_date <- tryCatch({
    # Try parsing as "MM/YYYY" format
    parsed_date <- ifelse(grepl("^\\d{2}/\\d{4}$", x),
                          as.character(as.Date(paste0("01/", x), format = "%d/%m/%Y")),
                          NA)
    # Try parsing as "DD/MM/YYYY" format if previous parsing failed
    parsed_date[is.na(parsed_date)] <- ifelse(grepl("^\\d{2}/\\d{2}/\\d{4}$", x),
                                             as.character(as.Date(x, format = "%d/%m/%Y")),
                                             NA)
    # Set day values to the start of the month (01)
    parsed_date <- ifelse(!is.na(parsed_date),
                          format(as.Date(parsed_date), "%Y-%m-01"),
                          NA)
    parsed_date
  }, error = function(e) NA)
  return(parsed_date)
}




# Apply the function to the 's2' and 's5' and 's7' columns
sex$s2 <- convert_to_date(sex$s2)
sex$s5 <- convert_to_date(sex$s5)
sex$s7 <- convert_to_date(sex$s7)


```

### Sex Calculation and Finalize Data (no scales)
```{r sex_calc}
# We do not apply the missing data rule due to how items are used currently: there are no scales
# updating dates to NA = -55
sex_complete <- sex %>%
  mutate(
    s2 = ifelse(is.na(s2), -55, as.character(s2)),
    s5 = ifelse(is.na(s5), -55, as.character(s5)),
    s7 = ifelse(is.na(s7), -55, as.character(s7))
  )
```

## CINT
### CINT-SOCIODEMS Select Variable & Recode
```{r cint_soci}
cint_socio <- tpw_raw %>%
  select(id,cint_0:cint_income_support, cint_identity, cint_identity_8_text) %>%
  mutate(
    across(
      .cols = c(cint2:cint5),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    cint_0 = case_when(
      cint_0 == "1. 8th grade or less or working towards GED" ~ "1",
      cint_0 == "2. Completed GED/Alternative H.S. diploma" ~ "2",
      cint_0 == "3. Completed some high school, but did not graduate" ~ "3",
      cint_0 == "4. Graduated high school" ~ "4",
      cint_0 == "5. Taking/have taken community college classes or working toward Associates Degree" ~ "5",
      cint_0 == "6. Completed/obtained an Associate's Degree" ~ "6",
      cint_0 == "7. Taking/have taken vocational classes or working toward Vocational Training" ~ "7",
      cint_0 == "8. Completed Vocational Training" ~ "8",
      cint_0 == "9. Taking/have taken 4 yr college classes or working toward 4 year college degree" ~ "9",
      cint_0 == "10. Completed 4 year college degree" ~ "10",
      cint_0 == "11. Taking/have taken graduate classes or working toward post-college degree" ~ "11",
      cint_0 == "12. Completed post-college degree" ~ "12",
      cint_0 == "Decline to Answer" ~ "-77",
      TRUE ~ cint_0
    ),
    cint1_1 = case_when(cint1_1 == "1. Currently Working" ~ "1",),
    cint1_2 = case_when(cint1_2 == "2. Temporarily laid off" ~ "2"),
    cint1_3 = case_when(cint1_3 == "3. On Leave" ~ "3"),
    cint1_4 = case_when(cint1_4 == "4. Unemployed or looking for work" ~ "4"),
    cint1_5 = case_when(cint1_5 == "5. Retired" ~ "5"),
    cint1_6 = case_when(cint1_6 == "6. Disabled, permanently or temporarily" ~ "6"),
    cint1_7 = case_when(cint1_7 == "7. Student" ~ "7"),
    cint1_8 = case_when(cint1_8 == "8. Something else, please briefly describe" ~ "8"),
    cint1_77 = case_when(cint1_77 == "Decline to Answer" ~ "-77"),
    cint18 = case_when(
      cint18 == "1. Always or almost always" ~ "1",
      cint18 == "2. Often" ~ "2",
      cint18 == "3. About half the time" ~ "3",
      cint18 == "4. Occasionally" ~ "4",
      cint18 == "5. Never or almost never" ~ "5",
      cint18 == "8. N/A, no bills to pay" ~ "-55",
      cint18 == "Decline to Answer" ~ "-77",
      TRUE ~ cint18
    ),
    cint19 = case_when(
      cint19 == "1. Always or almost always" ~ "1",
      cint19 == "2. Often" ~ "2",
      cint19 == "3. About half the time" ~ "3",
      cint19 == "4. Occasionally" ~ "4",
      cint19 == "5. Never or almost never" ~ "5",
      cint19 == "Decline to Answer" ~ "-77",
      TRUE ~ cint19
    ),
    cint_identity = case_when(
      cint_identity == "Cisgender female or woman" ~ "1",
      cint_identity == "Cisgender male or man" ~ "2",
      cint_identity == "Female/Woman" ~ "3",
      cint_identity == "Male/Man" ~ "4",
      cint_identity == "Trans female/woman" ~ "5",
      cint_identity == "Trans male/man" ~ "6",
      cint_identity == "Non-binary" ~ "7",
      cint_identity == "Prefer to self-identify" ~ "8",
      cint_identity == "Decline to Answer" ~ "-77",
      TRUE ~ cint_identity
    )
    )

# Combine cint1 responses to cint1 
cint_socio$cint1 <- apply(cint_socio[, c("cint1_1", "cint1_2", "cint1_3", "cint1_4", "cint1_5", "cint1_6", "cint1_7", "cint1_8", "cint1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

#Although these were created from the above 9 variables, each participant only selected no more than two choices, so we recoded according to choice 1 and choice 2
# Maria this create warning, I wasn't sure if this matters
cint_socio <- cint_socio %>%
  separate(cint1, into = c("cint1_choice1", "cint1_choice2"), sep = ";", remove = FALSE) %>%
  mutate(
    cint1_choice1 = as.numeric(cint1_choice1),
    cint1_choice2 = as.numeric(cint1_choice2),
    cint1_choice1 = coalesce(cint1_choice1, -55),
    cint1_choice2 = coalesce(cint1_choice2, -55)
  ) %>%
  select(-cint1)

# Organize column order 
cint_socio <- cint_socio %>%
  relocate(cint1_choice1, cint1_choice2, .after = cint_0)

```

### CINT-SOCIODEMS Missing
```{r cint_soci_missing}

cint_socio_complete <-
  cint_socio 


```

### CINT-SSES Select Variable & Recode
```{r cint-SSES}
cint_ladder <- tpw_raw %>%
  select(id, cint_ladder1, cint_ladder2) %>% 
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        is.na(.x) ~ "-77",
        TRUE ~ .x
        )
      )
  )

# correct data type 
cint_ladder_complete <- cint_ladder %>%
  mutate(across(-c(id), as.numeric)) %>%
  # rename to match codebook
  rename(cint_sses1 = cint_ladder1,
         cint_sses2 = cint_ladder2)
```

### CINT-SSES Missing 
```{r cint-ladder-missing}
## we do not apply missing data rules because not a standardized questionnaire
# cint_ladder_missing <- cint_ladder %>%
#   mutate(across(-c(id), as.numeric)) %>%
#   pct_miss_fun(
#     id = c("id"),
#     n_items = 2
#   )
# 
# 
# cint_ladder_missing %>% gt::gt() %>% 
#   gt::tab_header(
#     title = 'CINT-LADDDER Missing Data',
#     subtitle = 'By Participant')
# 
# 
# # Below is the code that treats -77, -55 values as NA
# cint_ladder_complete <-
#   cint_ladder %>%
#   mutate(across(-c(id), as.numeric)) %>%
#   mutate(
#     across(
#       .cols = -c(id),
#       .fns = ~case_when(
#         .x < 0 ~ NA_real_,
#         TRUE ~ .x
#       )
#     )
#   ) 
```

### CINT-Romantic and friend relationships Select Variable & Recode
```{r}
cint_relation <- tpw_raw %>%
  select(id, cint20:cint37) %>%
  mutate(
    cintq3 = case_when(
        cintq3 == "1. Married" ~ "1",
        cintq3 == "2. Living together" ~ "2",
        cintq3 == "3. Dating or seeing each other, but not living together. This includes casual dating." ~ "3",
        cintq3 == "4. Married, but separated" ~ "4",
        cintq3 == "5. Decline to Answer" ~ "-77",
        TRUE ~ cintq3
      ),
    cint26 = case_when(
      cint26 == "1 - Not at all close" ~ "1",
      cint26 == "10 - Extremely Close" ~ "10",
      cint26 == "Decline to Answer" ~ "-77",
      TRUE ~ cint26
    ),
    cint27 = case_when(
      cint27 == "1 - Not at all well" ~ "1",
      cint27 == "10 - Very Well" ~ "10",
      cint27 == "Decline to Answer" ~ "-77",
      TRUE ~ cint27
    ),
    across(
      .cols = c(cint28, cint29, cint37),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Don't Know" ~ "-66",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
     cint30 = case_when(
      # Updated from original study coding to match our guideline which start from 0
      cint30 == "1. Never" ~ "0",
      cint30 == "2. Drank alcohol only a few times during the year" ~ "1",
      cint30 == "3. Drinks regularly for a few weeks or more, then doesn't for a few weeks or more or drinks, then stops drinking (ex: became clean and sober)" ~ "2",
      cint30 == "4. Drinks about once a month" ~ "3",
      cint30 == "5. Drinks on weekends or mostly on weekends" ~ "4",
      cint30 == "6. Drinks daily or almost daily" ~ "5",
      cint30 == "7. Other: (Specify)" ~ "6",
      cint30 == "8. Don't know" ~ "-66",
      cint30 == "Decline to Answer" ~ "-77",
      TRUE ~ cint30
    ),
     cint31 = case_when(
      # Updated from original study coding to match our guideline which start from 0
      cint31 == "1. Never" ~ "0",
      cint31 == "2. Smoked only a few times during the year" ~ "1",
      cint31 == "3. Smokes regularly for a few weeks or more, then doesn't for a few weeks or more or used, then stopped (ex: became clean and sober)" ~ "2",
      cint31 == "4. Smokes about once a month" ~ "3",
      cint31 == "5. Smokes on weekends or mostly on weekends or a few times a week" ~ "4",
      cint31 == "6. Smokes daily or almost daily" ~ "5",
      cint31 == "7. Other: (Specify)" ~ "6",
      cint31 == "8. Don't know" ~ "-66",
      cint31 == "Decline to Answer" ~ "-77",
      TRUE ~ cint31
    ),
     cint32 = case_when(
      # Updated from original study coding to match our guideline which start from 0
      cint32 == "1. Never" ~ "0",
      cint32 == "2. Used hard drugs a limited number of times" ~ "1",
      cint32 == "3. Uses drugs regularly for a few weeks or more, then don't for a few weeks or more, or used, then stopped (ex: became clean and sober)" ~ "2",
      cint32 == "4. Uses drugs about once a month" ~ "3",
      cint32 == "5. Uses hard drugs on weekends or mostly on weekends or a few times a week" ~ "4",
      cint32 == "6. Uses hard drugs daily or almost daily" ~ "5",
      cint32 == "7. Other: (Specify)" ~ "6",
      cint32 == "8. Don't know" ~ "-66",
      cint32 == "Decline to Answer" ~ "-77",
      TRUE ~ cint32
    ),
    cint33 = case_when(
      cint33 == "1. Any grade up to the 12th grade, but not having a High School Diploma/GED" ~ "1",
      cint33 == "2. GED or Equivalency" ~ "2",
      cint33 == "3. High School Diploma" ~ "3",
      cint33 == "4. Attended Community College but no A.A.(Associates) degree" ~ "4",
      cint33 == "5. Community College degree, (A.A.)" ~ "5",
      cint33 == "6. Attended 4 year University or College, but no degree" ~ "6",
      cint33 == "7. B.A., B.S., BSN degree" ~ "7",
      cint33 == "8. Graduate degree (MA, MS, PhD)" ~ "8",
      cint33 == "9. Other (Technical, Vocational school)" ~ "9",
      cint33 == "10. Don't know" ~ "-66",
      cint33 == "Decline to Answer" ~ "-77",
      TRUE ~ cint33
    ),
     cint34 = case_when(
      cint34 == "1 (Not at all Supportive)" ~ "1",
      cint34 == "10 (Very Supportive)" ~ "10",
      cint34 == "Decline to Answer" ~ "-77",
      TRUE ~ cint34
    ),
    cint35 = case_when(
      cint35 == "1. None" ~ "0",
      cint35 == "2. One" ~ "1",
      cint35 == "3. Two or three" ~ "2",
      cint35 == "4. Four or more" ~ "3",
      cint35 == "Decline to Answer" ~ "-77",
      TRUE ~ cint35
    ),
    cint36 = case_when(
      # Updated from original study coding to match our guideline which start from 0
      cint36 == "1. Never" ~ "0",
      cint36 == "2. Less than once a week" ~ "1",
      cint36 == "3. One" ~ "2",
      cint36 == "4. Two or three" ~ "3",
      cint36 == "5. Four or five" ~ "4",
      cint36 == "6. Six or seven" ~ "5",
      cint36 == "7. N/A, current living situation/setting provides no opportunity for socialization ( if says she is in a locked setting)" ~ "6",
      cint36 == "Decline to Answer" ~ "-77",
      TRUE ~ cint36
    )
    )
```

### CINT-Romantic & F Missing
```{r cint_relation_missing}
cint_relation <- cint_relation %>%
  # if cint20 <1 cintq2:cint35 was be asked 
   mutate_at(vars(cintq2:cint34), ~case_when(cint20 < 1 ~ "-55", TRUE ~ .)) %>%
  # if cint35 is none/0 or -77 cint36:cint37 was be asked 
   mutate_at(vars(cint36:cint37), ~case_when(cint35 == 0 |  cint35 == "-77" ~ "-55", TRUE ~ .)) %>% 
   mutate_at(vars(cint30_7_text), ~case_when(cint30 != 7 ~ "-55", TRUE ~ .)) %>% 
   mutate_at(vars(cint31_7_text), ~case_when(cint31 != 7 ~ "-55", TRUE ~ .)) %>% 
   mutate_at(vars(cint32_7_text), ~case_when(cint32 != 6 ~ "-55", TRUE ~ .))

# Correct data type and create _complet df 
cint_relation_complete <- cint_relation %>%
  mutate(across(-c(id, matches("text$")), as.numeric))


```

### CINT-Substance Use Select Variable & Recode
```{r}
cint_substance <- tpw_raw %>%
  select(id, cint_pregnancy_screen, cint39:cint84_77) %>%
    mutate(
    across(
      .cols = c(cint_pregnancy_screen,cint39, cint41, cint43, cint45, cint50, cint54, cint56, cint58, cint60, cint64, cint65, cint66, cint68, cint70, cint72, cint74, cint76, cint78, cint80, cint82),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
        across(
      .cols = c(cint63),
      .fns = ~case_when(
        .x == "1. Yes" ~ "1",
        .x == "2. No" ~ "0",
        .x == "3. NA -- not in school and not employed in last 6 months" ~ "-55", # this is for cint63
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(cint46),
      .fns = ~case_when(
        .x == "1. Not at all" ~ "0",
        .x == "2. A little drunk" ~ "1",
        .x == "3. Quite drunk" ~ "2",
        .x == "4. Very drunk" ~ "3",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(cint47),
      .fns = ~case_when(
        .x == "1. Drank alcohol only a few times during the past 6 months (up to 5 times)" ~ "1",
        .x == "2. Drink regularly for a few weeks or more, then don't for a few weeks or more or drank for a period and then stopped altogether" ~ "2",
        .x == "3. Drink about once a month" ~ "3",
        .x == "4. Drink on weekends or mostly weekends or a few times a week" ~ "4",
        .x == "5. Drink daily or almost daily" ~ "5",
        .x == "6. Other: Specify" ~ "6",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(cint61),
      .fns = ~case_when(
        .x == "1. A little high" ~ "1",
        .x == "2. Quite high" ~ "2",
        .x == "3. Very high" ~ "3",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(cint62),
      .fns = ~case_when(
        .x == "1. Smoked only a few times during the past 6 months" ~ "1",
        .x == "2. Smoked regularly for a few weeks or more, then didn't for a few weeks or more or smoked for some time and then stopped" ~ "2",
        .x == "3. Smoked about once a month" ~ "3",
        .x == "4. Smoked on weekends or mostly weekends or a few times a week" ~ "4",
        .x == "5. Smoked daily or almost daily" ~ "5",
        .x == "6. Other" ~ "6",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    cint84_1 = case_when(cint84_1 == "1. Stranger" ~ "1", TRUE ~ cint84_1),
    cint84_2 = case_when(cint84_2 == "2. Acquaintance" ~ "2",TRUE ~ cint84_2),
    cint84_3 = case_when(cint84_3 == "3. Friend" ~ "3", TRUE ~ cint84_3),
    cint84_4 = case_when(cint84_4 == "4. Family member" ~ "4", TRUE ~ cint84_4),
    cint84_5 = case_when(cint84_5 == "5. Romantic partner" ~ "5", TRUE ~ cint84_5),
    cint84_6 = case_when(cint84_6 == "6. Other" ~ "6", TRUE ~ cint84_6),
    cint84_77 = case_when(cint84_77 == "Decline to Answer" ~ "-77", TRUE ~ cint84_77)
) %>%
  # update data errors verified 
  mutate(cint40 = ifelse(id == "P844", 180, cint40)) %>%
  mutate(cint42 = ifelse(id == "HR163", 15, cint42)) %>%
  mutate(cint42 = ifelse(id == "P871", 10, cint42)) %>%
  mutate(cint42 = ifelse(id == "P893", 10, cint42)) %>%
  mutate(cint42 = ifelse(id == "HR128", 7, cint42)) %>%
  # to be consistent with 180 = 3 months
  mutate(cint40 = ifelse(id == "P835", 180, cint40))

# Combine cint1 answer options to cint1 due to skip rule 
cint_substance$cint84 <- apply(cint_substance[, c("cint84_1", "cint84_2", "cint84_3", "cint84_4", "cint84_5", "cint84_6", "cint84_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

```

### CINT-Substance Missing
```{r cint_subs_missing}
cint_substance <- cint_substance %>%
       # TCs who were incarcerated weren't administered this survey
  mutate_at(vars(cint39:cint84), ~ ifelse(id %in% c("HR211", "HR181", "P819"), -55, .)) %>%
  # if cint_pregnancy_screen is yes/1, cint40:cint43 were not asked 
   mutate_at(vars(cint39:cint84), ~case_when(cint_pregnancy_screen == 1 ~ "-55", TRUE ~ .)) %>%
  # if cint39 is 0/No or -77 cint40:cint42 were not asked 
   mutate_at(vars(cint40:cint42), ~case_when(cint39 == 0 |  cint39 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint41 is 0/No or -77 cint42 were not asked 
   mutate_at(vars(cint42), ~case_when(cint41 == 0 |  cint41 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint43 is 0/No or -77, cint44:cint57 were not asked
  mutate_at(vars(cint44:cint57), ~case_when(cint43 == 0 |  cint43 == "-77" ~ "-55", TRUE ~ .)) %>%
  mutate_at(vars(cint47_6_text), ~case_when(cint47 != 6 ~ "-55", TRUE ~ .)) %>%
  # if cint54 is 0/No or -77, cint55:cint57 were not asked
  mutate_at(vars(cint55:cint57), ~case_when(cint54 == 0 |  cint54 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint56 is 0/No or -77, cint57 were not asked
  mutate_at(vars(cint57), ~case_when(cint56 == 0 |  cint56 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint58 is 0/No or -77, cint57:cint65 were not asked
  mutate_at(vars(cint57:cint65), ~case_when(cint58 == 0 |  cint58 == "-77" |cint58 == "-55"~ "-55", TRUE ~ .)) %>%
  # if cint66 is 0/No or -77, cint67 were not asked
  mutate_at(vars(cint67), ~case_when(cint66 == 0 |  cint66 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint68 is 0/No or -77, cint69 were not asked
  mutate_at(vars(cint69), ~case_when(cint68 == 0 |  cint68 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint70 is 0/No or -77, cint71 were not asked
  mutate_at(vars(cint71), ~case_when(cint70 == 0 |  cint70 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint72 is 0/No or -77, cint73 were not asked
  mutate_at(vars(cint73), ~case_when(cint72 == 0 |  cint72 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint74 is 0/No or -77, cint75 were not asked
  mutate_at(vars(cint75), ~case_when(cint74 == 0 |  cint74 == "-77" ~ "-55", TRUE ~ .)) %>%
   # if cint76 is 0/No or -77, cint77 were not asked
  mutate_at(vars(cint77), ~case_when(cint76 == 0 |  cint76 == "-77" ~ "-55", TRUE ~ .)) %>%
   # if cint78 is 0/No or -77, cint79 were not asked
  mutate_at(vars(cint79), ~case_when(cint78 == 0 |  cint78 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint 82 is not Yes, CINT 83, and cint 84 was skiped 
  mutate_at(vars(cint83:cint84), ~case_when(cint82 != 1 ~ "-55", TRUE ~ .)) %>%
  # if cint80 is 0/No or -77, cint81:cint84_77 were not asked
  mutate_at(vars(cint81:cint84), ~case_when(cint80 == 0 |  cint80 == "-77" ~ "-55", TRUE ~ .)) %>% 
  # cint40 could choose not to answer 
  mutate(cint40 = ifelse(is.na(cint40), -77, cint40))%>%
  # cint44 could choose not to answer 
  mutate(cint44 = ifelse(is.na(cint44), -77, cint44))%>%
  # cint53 could choose not to answer 
  mutate(cint53 = ifelse(is.na(cint53), -77, cint53))%>%
  # cint83 could choose not to answer 
  mutate(cint83 = ifelse(is.na(cint83), -77, cint83))%>%
  mutate_at(vars(cint47_6_text), ~case_when(cint47 != 7 ~ "-55", TRUE ~ .)) %>% 
  mutate_at(vars(cint62_6_text), ~case_when(cint62 != 7 ~ "-55", TRUE ~ .)) %>%
 select(-c(cint84_1:cint84_77))

cint_substance_complete <- cint_substance 
 
# HR166 has cint84 missing; checked this and we are using code of -99   

## we do not apply missing data rules because not a standardized questionnaire
```

### CINT-COVID Select Variables and Recode 
```{r}
## Note made during cleaning process on 12/2023 -- there are no psychometrics or optimal scoring methods published. Please reach out to Dr. Damion Grasso dgrasso@uchc.edu with questions if you wish to use. 
 
cint_covid <- tpw_raw %>%
  select(id, starts_with("cintc")) %>%
    mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes (Me)" ~ "1",
        .x == "Yes (Person in home)" ~"2",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    )
  )


# Combine multiple choice columns into one for each question
for (i in 1:14) {
  # Define the columns to be combined for the current group
  group_columns <- paste0("cintc", i, "_", c(1, 2, 3, 77))
  # Apply the function to concatenate non-NA values for each row
  cint_covid[, paste0("cintc", i)] <- apply(cint_covid[, c(group_columns, paste0("cintc", i))], 1, function(x) paste(x[!is.na(x)], collapse = ";"))
}


cint_covid <- cint_covid %>%
  select(id, cintc1:cintc14)

# Replace all empty cells with -55 in the entire data frame
# cint_covid <- cint_covid %>%
#   replace(cint_covid, is.na(cint_covid) | cint_covid == "", -55)
cint_covid <- cint_covid %>%
  mutate_all(~ ifelse(is.na(.x) | .x == "", -55, .x))

## there will also be -77s

## now I am divided these into endorsing the item for participant's self or another person in the participant's home (other suffix)

# Function to process each cintc variable
process_cintc <- function(data, var_name) {
  data %>%
    mutate(
      !!paste0(var_name, "_self") := ifelse(grepl("1;2|1", !!sym(var_name)), 1, 
                                             ifelse(grepl("0", !!sym(var_name)), 0,
                                                      ifelse(!!sym(var_name) == -77, -77, -55))),
      !!paste0(var_name, "_other") := ifelse(grepl("1;2|2", !!sym(var_name)), 1, 
                                              ifelse(grepl("0", !!sym(var_name)), 0,
                                                       ifelse(!!sym(var_name) == -77, -77, -55)))
    ) %>%
    select(-{{ var_name }})
}

# Apply the function to each cintc variable using purrr::reduce
cint_covid <- purrr::reduce(paste0("cintc", 1:14), process_cintc, .init = cint_covid)

cint_covid_complete <- cint_covid
```

### CINT-COVID Missing 
```{r}
# We are NOT applying missing data rule given guidance from author of scale
```

## SOCINF Substances 
### SOCINF Substances Select Variable and recode 
```{r socinf_sub}
socinf_sub<- tpw_raw %>%
  select(id, starts_with("soc"), -socinf_screen) %>%
  rename(socinf_relationship_screener = socinf_screen_2) %>%
    mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        
        .x == "Never" ~ "0",
        .x == "Hardly ever" ~ "1",
        .x == "Hardly Ever" ~ "1",
        .x == "Sometimes" ~ "2",
        .x == "Often" ~ "3",
        
        .x == "Not at all" ~ "0",
        .x == "A little" ~ "1",
        .x == "Somewhat" ~ "2",
        .x == "A lot" ~ "3",
        
        .x == "Decline to Answer" ~ "-77",
        .x == "N/A" ~ "-55",
        TRUE ~ .x
      )
    )
  )
```

### SOCINF Substances Missing 
```{r socinf_sub_missing}
socinf_sub <- socinf_sub%>%
  # if socinf_relationship_screener is NO/0 (no partner), SOC1:SOC2d; soc4a:soc4h; socb1:socb2e; socb4a:socb4k; socc1; socc2a:socc2e; socc4a:socc4k; socd1 were not asked
  mutate_at(vars(soc1:soc2d, soc4a:soc4h, socb1:socb2e, socb4a:socb4k, socc1, socc2a:socc2e, socc4a:socc4k,socd1, socd2a:socd2d, socd4a:socd4k), ~case_when(socinf_relationship_screener == 0 ~ "-55", TRUE ~ .)) %>%
  # if soc1 is Yes/1, soc2a:soc2d were not asked
  mutate_at(vars(soc2a:soc2d), ~case_when(soc1 == 0 | soc1 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socinf_preg_screener is NO/0, SOC3 is not asked 
  mutate_at(vars(soc3, socb3, socc3, socd3), ~case_when(socinf_preg_screener == 1 ~ "-55", TRUE ~ .)) %>%
  # if SOC3 is NO/0, -77, soc4a:soc4h were not asked
  mutate_at(vars(soc4a: soc4h), ~case_when(soc3 == 0 |soc3 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socb1 is NO/0, -77 socb2a:socb2e were not asked
  mutate_at(vars(socb2a:socb2e), ~case_when(socb1 == 0 |socb1 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socb3 is No/0, -77, socb4a:socb4k were not asked 
  mutate_at(vars(socb4a:socb4k), ~case_when(socb3 == 0 |socb3 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socc1 is NO/0, -77, socc2a:socc2e were not asked
  mutate_at(vars(socc2a:socc2e), ~case_when(socc1 == 0 |socc1 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socc3 is NO/0, -77 socc4a:socc4k were not asked 
  mutate_at(vars(socc4a:socc4k), ~case_when(socc3 == 0 |socc3 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socd1 is NO/0, -77, socd2a:socd2d were not asked
  mutate_at(vars(socd2a:socd2e), ~case_when(socd1 == 0 |socd1 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socd3 is NO/0, -77, socd4a:socd4k were not asked
  mutate_at(vars(socd4a:socd4k), ~case_when(socd3 == 0 |socd3 < 0 ~ "-55", TRUE ~ .)) %>%
  # Incarcerated participants weren't administered for this survey
  mutate_at(vars(socinf_preg_screener:socd4k), ~case_when(id %in% c("HR211", "HR181", "P819") & is.na(.) ~ "-55", TRUE ~ .)) # they will therefore not have screener questions asked


```

### SOCINF Substances Calculations
```{r socinf_sub_calc}
# No calculations are needed 
# We do not apply missing data procedures
socinf_sub_complete <- socinf_sub %>%
  mutate(across(-id, as.numeric)) 
```


## SOCINF General 
### SOCINF General Select Variable and Recode 
```{r socinf_gen}
socinf_gen<- tpw_raw %>%
  select(id, socinf_screen,starts_with("sg")) %>%
  rename(socinf_general_screener = socinf_screen) %>%
    mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        
        .x == "Never or almost never true" ~ "0",
        .x == "Hardly ever true" ~ "1",
        .x == "Sometimes true" ~ "2",
        .x == "Often true" ~ "3",
        .x == "Always or almost always true" ~ "4",
        
        .x == "Not at all against" ~ "0", 
        .x == "A little against" ~ "1",
        .x == "Somewhat against" ~ "2",
        .x == "Very much against" ~ "3", 
        
        .x == "Decline to Answer" ~ "-77",
        .x == "Decline to answer" ~ "-77", # needed for anomaly
        .x == "NA" ~ "-55", 
        .x == "N/A" ~ "-55",
        TRUE ~ .x
      )
    )
  )
  
```

### SOCINF General Missing
```{r socinf_gen_missing}
# We do not apply missing data rules
# No scales or subscales 

socinf_gen <- socinf_gen%>%
  # if socinf_general_screener is NO/0, the entire questionnaire was not administered. 
  mutate_at(vars(sg1:sg13d), ~case_when(socinf_general_screener == 0 ~ "-55", TRUE ~ .)) %>%
  # Incarcerated participants weren't administered for this survey
  mutate_at(vars(sg1:sg13d, socinf_general_screener), ~case_when(id %in% c("HR211", "HR181", "P819") ~ "-55", TRUE ~ .)) %>%
  mutate_at(vars(sg1:sg13d), ~case_when(is.na(.) ~ "-55", TRUE ~ .))


```


```{r socinf_gen_calc}
# We do not apply missing data procedures
socinf_gen_complete <- socinf_gen %>%
   mutate(across(-c(id), as.numeric))
```


## CTS Parent Child 
### CTS-PC Select Variable and Recode 
```{r cts_pc}
cts_pc <- tpw_raw %>%
  select(id, cts_parent_screen:a23) %>%
  mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        
        .x == "None - has never happened" ~ "0",
        .x == "None" ~ "0",
        .x == "Once" ~ "1",
        .x == "Twice" ~ "2",
        .x == "3-5 times" ~ "3",
        .x == "6-10 times" ~ "4",
        .x == "11-20 times" ~ "5", 
        .x == "More than 20 times" ~ "6",
        .x == "Not in the past year, but it happened before" ~ "7", 
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    )
  )
  
```

### CTS-PC Missing
```{r}
cts_pc <- cts_pc%>%
  # if cts_parent_screen is NO/0, the entire questionnaire was not administered. 
  mutate_at(vars(a1:a23), ~case_when(cts_parent_screen == 0 ~ "-55", TRUE ~ .)) %>%
  mutate(
    across(
      .cols = -c(id, cts_parent_screen),
      .fns = ~case_when(
        .x == "3" ~ "4",
        .x == "4" ~ "8",
        .x == "5" ~ "15",
        .x == "6" ~ "25",
        .x == "7" ~ "-2",
      TRUE ~ .x
      ),
      .names = '{.col}_r'
      ))

cts_pc_miss <- cts_pc %>%
  mutate(across(-c(id), as.numeric))%>%
  select(id, a1:a23) %>% # Missing percentage should calculate using a1:a23
  pct_miss_fun(
    id = c("id"),
    n_items = 23 # updated to reflect the coding
  )

cts_pc_miss %>% 
  gt::gt() %>% 
  gt::tab_header(
    title = 'CTS PC Missing Data',
    subtitle = 'By Participant')

cts_pc_remove <- cts_pc_miss %>% filter(miss_pct >= 20) %>% pull(id)
```

### CTS_PC Calculations 
```{r cts-pc calculation & sbuscale}

cts_pc_calc <-
  cts_pc %>%
    mutate(across(-c(id), as.numeric)) %>%
  mutate(
    across(
      .cols = -c(id),
      .fns = ~case_when(
        .x < -10 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )
# missing data rule is not applied

cts_pc_complete <-
  cts_pc_calc %>%
  # NVD items: 1,2,5,12
  mutate(
  # Raw Scoring for Nonviolent Discipline - Past Year (Chronicity)
         cts_pc_NVDP = rowSums(select(., 'a1_r', 'a2_r', 'a5_r', 'a12_r') * (select(., 'a1_r', 'a2_r', 'a5_r', 'a12_r') > 0), na.rm = TRUE),
  # Count of Nonviolent Discipline Responses 
        cts_pc_NVDC = rowSums(select(., a1_r, a2_r, a5_r, a12_r) > 0, na.rm = TRUE),
  # # Raw Scoring for Nonviolent Discipline Past Year - Mean (Chronicity)
        cts_pc_NVDM = ifelse(cts_pc_NVDC == 0 & cts_pc_NVDP == 0, 0, round(cts_pc_NVDP / cts_pc_NVDC, 2)),
  # Raw Scoring for Nonviolent Discipline Past Year (Prevalence) 
         cts_pc_NVDPP= rowSums(select(., 'a1_r', 'a2_r', 'a5_r', 'a12_r') > 0, na.rm = T), 
  # Raw Scoring for Nonviolent Discipline - Lifetime (Greater than past year Prevalence)
         cts_pc_NVDL = rowSums(select(., 'a1_r', 'a2_r', 'a5_r', 'a12_r') == -2, na.rm = T),  
  # Raw Scoring for Nonviolent Discipline (Ever Prevalence)
         cts_pc_NVDEP = cts_pc_NVDL + cts_pc_NVDPP 
) %>% 
  # PSA items: 6,8,9,10,14
    # Raw Scoring for Psychological Aggression - Past Year (Chronicity)
    mutate(
      cts_pc_PSAP = rowSums(select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') * (select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') > 0), na.rm = TRUE),
  # Count of Psychological Aggression Responses
      cts_pc_PSAC = rowSums(select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') > 0, na.rm = TRUE),
  # Raw Scoring for Psychological Aggression Past Year - Mean (Chronicity)
     cts_pc_PSAM = ifelse(cts_pc_PSAC == 0 & cts_pc_PSAP == 0, 0, round(cts_pc_PSAP / cts_pc_PSAC, 2)),
  #  Raw Scoring for Psychological Aggression - Past Year (Prevalence)
      cts_pc_PSAPP = rowSums(select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') > 0, na.rm = T),
  # Raw Scoring for Psychological Aggression Discipline - Lifetime (Ever Prevalence greater than past year)
      cts_pc_PSAL = rowSums(select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') == -2, na.rm = T),
  # Raw Scoring for Psychological Aggression (Ever Prevalance)
      cts_pc_PSAEP = cts_pc_PSAL + cts_pc_PSAPP
    ) %>%
  # PHA Items: 3,4,7,11,13
  mutate(
  # Raw Scoring for Physical Assault - Past Year (Chronicity)
    cts_pc_PHAP = rowSums(select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') * (select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') > 0), na.rm = TRUE),
  # Count of Physical Assault Responses
    cts_pc_PHAC = rowSums(select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') > 0, na.rm = TRUE),
  # Raw Scoring for Physical Assault Past Year - Mean (Chronicity)
    cts_pc_PHAM = ifelse(cts_pc_PHAC == 0 & cts_pc_PHAP == 0, 0, round(cts_pc_PHAP / cts_pc_PHAC, 2)),
  # Raw Scoring for Physical Assault - Past Year (Prevalence)
    cts_pc_PHAPP =  rowSums(select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') > 0, na.rm = T),
  # Raw Scoring for Physical Assault - Lifetime (Ever Prevalence greater than 1 year)
    cts_pc_PHAL = rowSums(select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') == -2, na.rm = T),
  # Raw Scoring for Physical Assault (Ever Prevalence)
    cts_pc_PHAEP = cts_pc_PHAL + cts_pc_PHAPP
  ) %>%
  # WKD Items: 16, 17, 18
  # It is correct for 15_r to be checked but not included in computations
  mutate(
    # Raw Scoring for Weekly Discipline - Past Week (Chronicity)
    cts_pc_WKDP = if_else(!is.na(a15_r) & !is.na(a16_r) & !is.na(a17_r) & !is.na(a18_r), 0, NA),
    cts_pc_WKDP = cts_pc_WKDP + ifelse(a16_r > 0, a16_r, 0) + ifelse(a17_r > 0, a17_r, 0) + ifelse(a18_r > 0, a18_r, 0),
    # Count of Weekly Discipline Responses
    cts_pc_WKDC = if_else(!is.na(a15_r) & !is.na(a16_r) & !is.na(a17_r) & !is.na(a18_r), 0, NA),
    cts_pc_WKDC = cts_pc_WKDC + ifelse(!is.na(a16_r), 1, 0) + ifelse(!is.na(a17_r), 1, 0) + ifelse(!is.na(a18_r), 1, 0),
    # Raw Scoring for Weekly Discipline Past Week - Mean (Chronicity)
    cts_pc_WKDM = ifelse(cts_pc_WKDC == 0 & cts_pc_WKDP == 0, 0, round(cts_pc_WKDP / cts_pc_WKDC, 2)),
    # Raw Scoring for Weekly Discipline - Past Week (Prevalence)
    cts_pc_WKDPP = rowSums(select(., 'a16_r', 'a17_r', 'a18_r') > 0, na.rm = T)
  )%>%
    # NEG Items: 19 20 21 22 23
  mutate(
    # Raw Scoring for Neglect - Past Year (Chronicity)
    cts_pc_NEGP = rowSums(select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') * (select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') > 0), na.rm = TRUE),
    # Count of Neglect Responses
    cts_pc_NEGC = rowSums(select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') > 0, na.rm = TRUE),
    # Raw Scoring for Neglect Past Year - Mean (Chronicity)
    cts_pc_NEGM = ifelse(cts_pc_NEGC == 0 & cts_pc_NEGP == 0, 0, round(cts_pc_NEGP / cts_pc_NEGC, 2)),
    # Raw Scoring for Neglect - Past Year (Prevalence)
    cts_pc_NEGPP = rowSums(select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') > 0, na.rm = T),
    # Raw Scoring for Neglect - Lifetime (Ever Prevalence)
    cts_pc_NEGL = rowSums(select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') == -2, na.rm = T),
    # Raw Scoring for Neglect (Ever Prevalance)
    cts_pc_NEGEP = cts_pc_NEGL + cts_pc_NEGPP)


# finalize to add back in appropriate missing values
cts_pc_complete <- cts_pc_complete %>%
  select(id, cts_pc_NVDP:cts_pc_NEGEP) %>%
  rename_all(tolower) %>%
  merge(cts_pc, by="id") %>%
 # mutate(across(c(a1:a23, a1_r:a23_r), ~ifelse(cts_parent_screen == 0, -55, ifelse(is.na(.), -77, as.numeric(.))))) %>%
  mutate(across(c(cts_pc_nvdp:cts_pc_negep), ~ifelse(cts_parent_screen == 0, -99, ifelse(is.na(.), -77, as.numeric(.))))) %>%
  # update a prefix to cts_pc
  rename_with(~ sub("^a", "cts_pc", .), starts_with("a"))

```

## PCT - Pregnancy and Childbirth Trauma
### PCT Select Variable and Recode
```{r pct}
pct <- tpw_raw %>%
  select(id, p00a, starts_with("pct")) %>%
  mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    )
  )
```

### PCT Missing 
```{r pct_missing}
pct <- pct %>%  
  # if p00a is NO/0 or -77, the entire questionnaire was not administered because participant had no prior pregnancies
  mutate_at(vars(pct0), ~case_when(p00a == 0 | p00a == NA ~ "-55", TRUE ~ .)) %>%
  mutate_at(vars(pct1:pct3e), ~case_when(pct0 == "-55" ~ "-55", TRUE ~ .)) %>%
  # if pct1 is NO/0 or -77, the entire questionnaire was not administered because participant endorsed no prior traumatic pregnancies or childbirth experiences
   mutate_at(vars(pct2a:pct3e), ~case_when(pct1 == "0" ~ "-55", TRUE ~ .)) %>%
  # dropping pct2e and pct3e as all contain identifying child name and sometimes DOB; dropping pct0 as no new information from screener p00a; was only skip rule question
  select(-pct2e, -pct3e, -pct0) 


# primarily missing due to not having prior pregnancy (p00a) or due to not having a traumatic childbirth (pct1)
# missing rule for pct_preg_total 
pct_preg_total_miss <- pct %>%
  select(id, pct2a:pct2d) %>%
  mutate(across(-c(id), as.numeric)) %>%
  pct_miss_fun(
    id = c("id"),
    n_items = 4
  )

pct_preg_total_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'pct_preg_total Missing Data',
    subtitle = 'by Participant'
  )

pct_preg_total_remove <- pct_preg_total_miss %>% filter(miss_pct >= 33) %>% pull(id)

# missing rule for pct_childbirth_total
pct_childbirth_total_miss <- pct %>%
  select(id, pct3a:pct3d) %>%
  mutate(across(-c(id), as.numeric)) %>%
  pct_miss_fun(
    id = c("id"),
    n_items = 4
  )

pct_childbirth_total_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'pct_childbirth_total Missing Data',
    subtitle = 'by Participant'
  )

pct_childbirth_total_remove <- pct_childbirth_total_miss %>% filter(miss_pct >= 33) %>% pull(id)
```

PCT Calculation & Subscale 
```{r pct_calc}
# Below is the code that treats -77, -55 values as NA
pct_calc <-
  pct %>%
  mutate(across(-c(id), as.numeric)) %>%
  mutate(
    across(
      .cols = -c(id),
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# pct Composite & Subscale Score Creation 
pct_complete <- pct_calc %>%
  mutate(
    pct_preg_total = rowSums(select(., pct2a:pct2d), na.rm = TRUE),
    pct_childbirth_total = rowSums(select(., pct3a:pct3d), na.rm = TRUE)
  ) %>%
  # Apply missing rule for pct_preg_total 
  mutate_at(vars(pct_preg_total), ~case_when(id %in% pct_preg_total_remove ~ -99, TRUE ~ .)) %>%
  # Apply missing rule for pct_childbirth_total 
  mutate_at(vars(pct_childbirth_total), ~case_when(id %in% pct_childbirth_total_remove ~ -99, TRUE ~ .)) %>%
  # we can merge with pct so we have correct missing codes 
  select(id,pct_preg_total, pct_childbirth_total) %>%
  merge(pct, by = "id") %>%
  relocate(pct_preg_total, pct_childbirth_total, .after = pct3d)

```

## Service Utilization Survey
### SUS Select Variable and Recode 
```{r sus}
sus <- tpw_raw %>%
  select(id, starts_with("sus")) %>%
  mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        
        .x == "1. Hearing" ~ "1",
        .x == "2. Continuance" ~ "2",
        .x == "3. Court Monitoring" ~ "3",
        
        .x == "1. Yes, available and accessed" ~ "1",
        .x == "2. No, available but did not access" ~ "2",
        .x == "3. No, attempted to access but experienced a barrier" ~ "3",
        .x == "4. No, was not aware service was available" ~ "4",
        
        .x == "1. Physical" ~ "1",
        .x == "2. Mental/Psychological" ~ "2",
        .x == "3. Substance Use" ~ "3",
        
        .x == "Don't Know" ~ "-66",
        .x == "Decline to Answer" ~ "-77",
        .x == "5. Decline to answer" ~ "-77",
        TRUE ~ .x
      )
    )
  ) 


# Combine sus11b answer options to sus11b 
sus$sus11b <- apply(sus[, c("sus11b_1","sus11b_2","sus11b_3","sus11b_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus12b answer options to sus12b 
sus$sus12b <- apply(sus[, c("sus12b_1","sus12b_2","sus12b_3","sus12b_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14a answer options to sus14a 
sus$sus14a <- apply(sus[, c("sus14a_1","sus14a_2","sus14a_3","sus14a_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14b2 answer options to sus14b1 (this was labled wrong in Qualtric, it should be sus14b1) 
sus$sus14b1 <- apply(sus[, c("sus14b2_1","sus14b2_2","sus14b2_3","sus14b2_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14c1 answer options to sus14c1
sus$sus14c1 <- apply(sus[, c("sus14c1_1","sus14c1_2","sus14c1_3","sus14c1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14d1 answer options to sus14d1
sus$sus14d1 <- apply(sus[, c("sus14d1_1","sus14d1_2","sus14d1_3","sus14d1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14e1 answer options to sus14e1
sus$sus14e1 <- apply(sus[, c("sus14e1_1","sus14e1_2","sus14e1_3","sus14e1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14f1 answer options to sus14f1
sus$sus14f1 <- apply(sus[, c("sus14f1_1","sus14f1_2","sus14f1_3","sus14f1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14g1 answer options to sus14g1
sus$sus14g1 <- apply(sus[, c("sus14g1_1","sus14g1_2","sus14g1_3","sus14g1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14h1 answer options to sus14h1
sus$sus14h1 <- apply(sus[, c("sus14h1_1","sus14h1_2","sus14h1_3","sus14h1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14i1 answer options to sus14i1
sus$sus14i1 <- apply(sus[, c("sus14i1_1","sus14i1_2","sus14i1_3","sus14i1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14j1 answer options to sus14j1
sus$sus14j1 <- apply(sus[, c("sus14j1_1","sus14j1_2","sus14j1_3","sus14j1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14k1 answer options to sus14k1
sus$sus14k1 <- apply(sus[, c("sus14k1_1","sus14k1_2","sus14k1_3","sus14k1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14l1 answer options to sus14l1
sus$sus14l1 <- apply(sus[, c("sus14l1_1","sus14l1_2","sus14l1_3","sus14l1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14m1 answer options to sus14m1
sus$sus14m1 <- apply(sus[, c("sus14m1_1","sus14m1_2","sus14m1_3","sus14m1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14n1 answer options to sus14n1
sus$sus14n1 <- apply(sus[, c("sus14n1_1","sus14n1_2","sus14n1_3","sus14n1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14o1 answer options to sus14o1
sus$sus14o1 <- apply(sus[, c("sus14o1_1","sus14o1_2","sus14o1_3","sus14o1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus26b answer options to sus26b
sus$sus26b <- apply(sus[, c("sus26b_1","sus26b_2","sus26b_3","sus26b_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))




sus <- sus %>%
  relocate(sus11b, .after = "sus11a") %>%
  relocate(sus12b, .after = "sus12a") %>%
  relocate(sus14a, .after = "sus14") %>%
  relocate(sus14b1, .after = "sus14b") %>%
  relocate(sus14c1, .after = "sus14c") %>%
  relocate(sus14d1, .after = "sus14d") %>%
  relocate(sus14e1, .after = "sus14e") %>%
  relocate(sus14f1, .after = "sus14f") %>%
  relocate(sus14g1, .after = "sus14g") %>%
  relocate(sus14h1, .after = "sus14h") %>%
  relocate(sus14i1, .after = "sus14i") %>%
  relocate(sus14j1, .after = "sus14j") %>%
  relocate(sus14k1, .after = "sus14k") %>%
  relocate(sus14l1, .after = "sus14l") %>%
  relocate(sus14m1, .after = "sus14m") %>%
  relocate(sus14n1, .after = "sus14n") %>% 
  relocate(sus14o1, .after = "sus14o") %>%
  relocate(sus26b, .after = "sus26a") 
  
  
```

### SUS Missing
```{r sus_missing}
sus <- sus %>% 
  # sus-start; sus1:sus9 will not display if sus screen is not yes/1
  mutate_at(vars(sus_start, sus1:sus6, sus7:sus9), ~case_when(sus_screen != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus-start is 0/NA, sus1:sus7 were not asked.
  mutate_at(vars(sus1:sus7), ~case_when(sus_start == 0  ~ "-55", TRUE ~ .)) %>%
  
  # if sus6> 0, sus6a was not asked. 
  mutate_at(vars(sus6a), ~case_when(sus6 <=0 ~ "-55", TRUE ~ .)) %>%
  # if sus6> 1, sus6b was not asked. 
  mutate_at(vars(sus6b), ~case_when(sus6 <=1 ~ "-55", TRUE ~ .)) %>%
  # if sus6> 2, sus6c was not asked. 
  mutate_at(vars(sus6c), ~case_when(sus6 <=2 ~ "-55", TRUE ~ .)) %>%
  
  # if sus8 is not yes/1, sus9:sus10j weren't asked 
  mutate_at(vars(sus9:sus10j), ~case_when(sus8 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 0, sus10a is not asked 
  mutate_at(vars(sus10a), ~case_when(sus9 <= 0 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 1, sus10b is not asked 
  mutate_at(vars(sus10b), ~case_when(sus9 <= 1 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 2, sus10c is not asked 
  mutate_at(vars(sus10c), ~case_when(sus9 <= 2 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 3, sus10d is not asked 
  mutate_at(vars(sus10d), ~case_when(sus9 <= 3 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 4, sus10e is not asked 
  mutate_at(vars(sus10e), ~case_when(sus9 <= 4 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 5, sus10f is not asked 
  mutate_at(vars(sus10f), ~case_when(sus9 <= 5 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 6, sus10g is not asked 
  mutate_at(vars(sus10g), ~case_when(sus9 <= 6 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 7, sus10h is not asked 
  mutate_at(vars(sus10h), ~case_when(sus9 <= 7 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 8, sus10i is not asked 
  mutate_at(vars(sus10i), ~case_when(sus9 <= 8 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 9, sus10j is not asked 
  mutate_at(vars(sus10j), ~case_when(sus9 <= 9 ~ "-55", TRUE ~ .)) %>%
  # if sus11 is 2/4/5..  sus11a:sus11c weren't asked 
  mutate_at(vars(sus11a:sus11c), ~case_when(sus11 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus11 is 3..  sus11a:sus11b weren't asked 
  mutate_at(vars(sus11a:sus11c), ~case_when(sus11 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus11 is not 3, sus11c was not asked
  mutate_at(vars(sus11c), ~case_when(sus11 != 3 ~ "-55", TRUE ~ .)) %>%
  # if sus12 is 2,4,-77, sus12a:sus12c were not asked
  mutate_at(vars(sus12a:sus12c), ~case_when(sus12 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus12 is 3..  sus12a:sus12b weren't asked 
  mutate_at(vars(sus12a:sus12b_77), ~case_when(sus12 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus12 is not 3, sus12c was not asked
  mutate_at(vars(sus12c), ~case_when(sus12 != 3 ~ "-55", TRUE ~ .)) %>%
  #mutate(across(c(sus13a, sus13), as.numeric), TRUE ~ NA_real_) %>%
  # if sus13a is NA then it's TC decline to answer and should be -77
  mutate(across(
      .cols = sus13a,
      .fns = ~case_when(is.na(.x) ~ "-77", TRUE ~ .x)
  ))%>%

  # if sus13 is 2,4,-77, sus13a:sus14o2 were not asked
  mutate_at(vars(sus13a:sus14o2), ~case_when(sus13 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus13 is 3..  sus13a weren't asked 
  mutate_at(vars(sus13a), ~case_when(sus13 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus13 is not 3, sus13b was not asked
  mutate_at(vars(sus13b), ~case_when(sus13 != 3 ~ "-55", TRUE ~ .)) %>%
  # change sus13a to numeric for latter skip rule 
  mutate(sus13a = as.numeric(sus13a)) %>%
  # if sus13a is <=0 and sus13 != 1, sus14:sus14a1 were not asked 
  mutate_at(vars(sus14:sus14a1), ~case_when(sus13a <=0 | sus13 != 1 ~ "-55", TRUE ~ .)) %>% 
  # if sus13a is <=1 and sus13 != 1, sus14b:sus14b2  were not asked 
  mutate_at(vars(sus14b:sus14b2), ~case_when(sus13a <=1 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # TODO: Maria, sus14b2_1:sus14b2_77 is for question 14b1, do you want me correct this?
  # if sus13a is <=2 and sus13 != 1, sus14c:sus14c2 were not asked 
  mutate_at(vars(sus14c:sus14c2), ~case_when(sus13a <=2 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=3 and sus13 != 1, sus14d:sus14d2  were not asked 
  mutate_at(vars(sus14d:sus14d2), ~case_when(sus13a <=3 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=4 and sus13 != 1, sus14e:sus14e2  were not asked
  mutate_at(vars(sus14e:sus14e2), ~case_when(sus13a <=4 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=5 and sus13 != 1, sus14f:sus14f2  were not asked
  mutate_at(vars(sus14f:sus14f2), ~case_when(sus13a <=5 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=6 and sus13 != 1, sus14g:sus14g2  were not asked
  mutate_at(vars(sus14g:sus14g2), ~case_when(sus13a <=6 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=7 and sus13 != 1, sus14h:sus14h2  were not asked
  mutate_at(vars(sus14h:sus14h2), ~case_when(sus13a <=7 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=8 and sus13 != 1, sus14i:sus14i2  were not asked
  mutate_at(vars(sus14i:sus14i2), ~case_when(sus13a <=8 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=9 and sus13 != 1, sus14j:sus14j2  were not asked
  mutate_at(vars(sus14j:sus14j2), ~case_when(sus13a <=9 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=10 and sus13 != 1, sus14k:sus14k2  were not asked 
  #TODO: I can't figure out why from k : o doesn't work
  mutate_at(vars(sus14k:sus14k2), ~case_when(sus13a <=10 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=11 and sus13 != 1, sus14l:sus14l2  were not asked 
  mutate_at(vars(sus14l:sus14l2), ~case_when(sus13a <=11 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=12 and sus13 != 1, sus14m:sus14m2  were not asked 
  mutate_at(vars(sus14m:sus14m2), ~case_when(sus13a <=12 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=13 and sus13 != 1, sus14n:sus14n2  were not asked 
  mutate_at(vars(sus14n:sus14n2), ~case_when(sus13a <=13 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=14 and sus13 != 1, sus14o:sus14o2  were not asked 
  mutate_at(vars(sus14o:sus14o2), ~case_when(sus13a <=14 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%

  # if sus15 is 2,4,-77, sus15a:sus15b were not asked
  mutate_at(vars(sus15a:sus15), ~case_when(sus15 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus15 is 3..  sus15a weren't asked 
  mutate_at(vars(sus15a), ~case_when(sus15 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus15 is not 3, sus15b was not asked
  mutate_at(vars(sus15b), ~case_when(sus15 != 3 ~ "-55", TRUE ~ .)) %>%
  
  # if sus16 is 2,4,-77, sus16a:sus16b were not asked
  mutate_at(vars(sus16a:sus16b), ~case_when(sus16 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus16 is 3..  sus16a weren't asked 
  mutate_at(vars(sus16a), ~case_when(sus16 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus16 is not 3, sus16b was not asked
  mutate_at(vars(sus16b), ~case_when(sus16 != 3 ~ "-55", TRUE ~ .)) %>%
  
  # if sus17 is 2,4,-77, sus17a:sus17b were not asked
  mutate_at(vars(sus17a:sus17b), ~case_when(sus17 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus17 is 3..  sus17a weren't asked 
  mutate_at(vars(sus17a), ~case_when(sus17 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus17 is not 3, sus17b was not asked
  mutate_at(vars(sus17b), ~case_when(sus17 != 3 ~ "-55", TRUE ~ .)) %>%
  
  # NA in columns below are truly missing 
  mutate(sus18 = case_when(is.na(sus18) ~ "-99", TRUE ~ sus18)) %>%
  # if sus18 is 2,4,-77 sus18a:sus18b were not asked
  mutate_at(vars(sus18a:sus18b), ~case_when(sus18 %in%c(2,4,-77,-55, -99) ~ "-55", TRUE ~ .)) %>%
  # if sus18 is 3 sus18a was not asked 
  mutate_at(vars(sus18a), ~case_when(sus18 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus18 is 3 sus18b was not asked 
  mutate_at(vars(sus18b), ~case_when(sus18 != 3 ~ "-55", TRUE ~ .)) %>%
  
  # if sus19 is 2,4,-77, sus19a:sus19b were not asked
  mutate_at(vars(sus19a:sus19b), ~case_when(sus19 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus19 is 3..  sus19a weren't asked 
  mutate_at(vars(sus19a), ~case_when(sus19 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus19 is not 3, sus19b was not asked
  mutate_at(vars(sus19b), ~case_when(sus19 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus20 is 2,4,-77, sus20a:sus20b were not asked
  mutate_at(vars(sus20a:sus20b), ~case_when(sus20 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus20 is 3..  sus20a weren't asked 
  mutate_at(vars(sus20a), ~case_when(sus20 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus20 is not 3, sus20b was not asked
  mutate_at(vars(sus20b), ~case_when(sus20 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus21 is 2,4,-77, sus21a:sus21b were not asked
  mutate_at(vars(sus21a:sus21b), ~case_when(sus21 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus21 is 3..  sus21a weren't asked 
  mutate_at(vars(sus21a), ~case_when(sus21 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus21 is not 3, sus20b was not asked
  mutate_at(vars(sus21b), ~case_when(sus21 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus22 is 2,4,-77, sus22a:sus22b were not asked
  mutate_at(vars(sus22a:sus22b), ~case_when(sus22 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus22 is 3..  sus22a weren't asked 
  mutate_at(vars(sus22a), ~case_when(sus22 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus22 is not 3, sus20b was not asked
  mutate_at(vars(sus22b), ~case_when(sus22 != 3 ~ "-55", TRUE ~ .)) %>%

  #NA in columns below are truly missing 
  mutate(sus23 = case_when(is.na(sus23) ~ "-99", TRUE ~ sus23)) %>%
  # if sus23 is 2,4,-77, sus23a:sus23b were not asked
  mutate_at(vars(sus23a:sus23b), ~case_when(sus23 %in%c(2,4,-77,-55) ~ "-55", TRUE ~ .)) %>%
  # if sus23 is 3..  sus23a weren't asked 
  mutate_at(vars(sus23a), ~case_when(sus23 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus23 is not 3, sus23b was not asked
  mutate_at(vars(sus23b), ~case_when(sus23 != 3 ~ "-55", TRUE ~ .)) %>%
  
  # if sus24 is 2,4,-77, sus24a:sus24b were not asked
  mutate_at(vars(sus24a:sus24b), ~case_when(sus24 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus24 is 3..  sus24a weren't asked 
  mutate_at(vars(sus24a), ~case_when(sus24 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus24 is not 3, sus24b was not asked
  mutate_at(vars(sus24b), ~case_when(sus24 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus25 is 2,4,-77, sus25a:sus25b were not asked
  mutate_at(vars(sus25a:sus25b), ~case_when(sus25 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus25 is 3..  sus25a weren't asked 
  mutate_at(vars(sus25a), ~case_when(sus25 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus25 is not 3, sus25b was not asked
  mutate_at(vars(sus25b), ~case_when(sus25 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus26 is 2,4,-77, sus26a:sus26c were not asked
  mutate_at(vars(sus26a:sus26c), ~case_when(sus26 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus26 is 3..  sus26a:sus26b weren't asked 
  mutate_at(vars(sus26a:sus26b_77), ~case_when(sus26 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus26 is not 3, sus26c was not asked
  mutate_at(vars(sus26c), ~case_when(sus26 != 3 ~ "-55", TRUE ~ .)) %>%
  
    # we have missing due to partial finish
  mutate(across(-id, ~ifelse(id == "HR173", -99, .))) %>%
  # following question are not request to answer, so if NA it means TC refuse to answer -77 
  mutate(sus2 = case_when(is.na(sus2) ~ "-77", TRUE ~ sus2)) %>%
  mutate(sus14l = case_when(is.na(sus14l) ~ "-77", TRUE ~ sus14l)) %>%
  mutate(sus14l2 = case_when(is.na(sus14l2) ~ "-77", TRUE ~ sus14l2)) %>%
  mutate(sus14m = case_when(is.na(sus14m) ~ "-77", TRUE ~ sus14m)) %>%
  mutate(sus14m2 = case_when(is.na(sus14m2) ~ "-77", TRUE ~ sus14m2)) %>%
  mutate(sus18a = case_when(is.na(sus18a) ~ "-77", TRUE ~ sus18a)) %>%
  mutate(sus23a = case_when(is.na(sus23a) ~ "-77", TRUE ~ sus23a)) %>%
  
  
  select(-c("sus11b_1","sus11b_2","sus11b_3","sus11b_77")) %>%
  select(-c("sus12b_1","sus12b_2","sus12b_3","sus12b_77")) %>%
  select(-c("sus14a_1","sus14a_2","sus14a_3","sus14a_77")) %>%
  select(-c("sus14b2_1","sus14b2_2","sus14b2_3","sus14b2_77")) %>%
  select(-c("sus14c1_1","sus14c1_2","sus14c1_3","sus14c1_77")) %>%
  select(-c("sus14d1_1","sus14d1_2","sus14d1_3","sus14d1_77")) %>%
  select(-c("sus14e1_1","sus14e1_2","sus14e1_3","sus14e1_77")) %>%
  select(-c("sus14f1_1","sus14f1_2","sus14f1_3","sus14f1_77")) %>%
  select(-c("sus14g1_1","sus14g1_2","sus14g1_3","sus14g1_77")) %>%
  select(-c("sus14h1_1","sus14h1_2","sus14h1_3","sus14h1_77")) %>%
  select(-c("sus14i1_1","sus14i1_2","sus14i1_3","sus14i1_77")) %>%
  select(-c("sus14j1_1","sus14j1_2","sus14j1_3","sus14j1_77")) %>%
  select(-c("sus14k1_1","sus14k1_2","sus14k1_3","sus14k1_77")) %>%
  select(-c("sus14l1_1","sus14l1_2","sus14l1_3","sus14l1_77")) %>%
  select(-c("sus14m1_1","sus14m1_2","sus14m1_3","sus14m1_77")) %>%
  select(-c("sus14n1_1","sus14n1_2","sus14n1_3","sus14n1_77")) %>%
  select(-c("sus14o1_1","sus14o1_2","sus14o1_3","sus14o1_77")) %>%
  select(-c("sus26b_1","sus26b_2","sus26b_3","sus26b_77"))




## Note for Maria -- need to remove and recode 6a,6b, and 6c
## Maria export to csv and double code with Kaylee
## notes here
# P865 (add count of 2 to sus1)
# P856 (add count of 3 to sus 4)
# P887 (add count of 1 to sus 1)
# P849 (add count of 3 to sus 1)
# P854 (add count of 1 to new sus 7 variable should reflect contact for child in my care, not my own child another persons DHS coase)
# P882 (add count of 2 to sus 1)
# P867 (Add count of 3 to sus 1)
# P902 (Add count of 1 to sus 1)
# P845 (add count of 3 to sus 2)
# HR 194 (Add count of 1 to new cat 7)
# HR204 (Add count of 3 to sus 2)
# HR131 (add count of 3 to sus 4)
# HR 175 (add count of 3 to sus 4)
#HR 171 (add count of 1 to sus 3)
# P805 add count of 3 to sus 7
#P829 add count of 1 to sus 7
#P890 add count of 1 to sus 1




# Remove identifiable information columns: all 14 and associated variable
sus_complete <- sus %>%
  select(-starts_with("sus14"))

# Internal data 
sus_internal <- sus %>% 
  select(id, starts_with("sus14"))
```


## LEC 
### LEC Select Variable and Recode 

```{r lec }
pcl <- tpw_raw %>%
  select(id, starts_with("pcl"), starts_with("p_cl")) %>%
  # Happened and Witnessed first developed period 
  mutate(pcl1_hapWit_dev = combine_columns(., c("pcl1a_1", "pcl1a_2", "pcl1a_3", "pcl1a_4", "pcl1a_77"), sep = ";") )%>%
  mutate(pcl1_hapWit_dev = str_extract(pcl1_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl1_hapWit_dev, .after = "pcl1a_77") %>%
  mutate(pcl2_hapWit_dev = combine_columns(., c("pcl2a_1", "pcl2a_2", "pcl2a_3", "pcl2a_4", "pcl2a_77"), sep = ";") )%>%
  mutate(pcl2_hapWit_dev = str_extract(pcl2_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl2_hapWit_dev, .after = "pcl2a_77") %>%
  mutate(pcl3_hapWit_dev = combine_columns(., c("pcl3a_1", "pcl3a_2", "pcl3a_3", "pcl3a_4", "pcl3a_77"), sep = ";") )%>%
  mutate(pcl3_hapWit_dev = str_extract(pcl3_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl3_hapWit_dev, .after = "pcl3a_77") %>%
  mutate(pcl4_hapWit_dev = combine_columns(., c("pcl4a_1", "pcl4a_2", "pcl4a_3", "pcl4a_4", "pcl4a_77"), sep = ";") )%>%
  mutate(pcl4_hapWit_dev = str_extract(pcl4_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl4_hapWit_dev, .after = "pcl4a_77") %>%
  mutate(pcl5_hapWit_dev = combine_columns(., c("pcl5a_1", "pcl5a_2", "pcl5a_3", "pcl5a_4", "pcl5a_77"), sep = ";") )%>%
  mutate(pcl5_hapWit_dev = str_extract(pcl5_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl5_hapWit_dev, .after = "pcl5a_77") %>%
  mutate(pcl6_hapWit_dev = combine_columns(., c("pcl6a_1", "pcl6a_2", "pcl6a_3", "pcl6a_4", "pcl6a_77"), sep = ";") )%>%
  mutate(pcl6_hapWit_dev = str_extract(pcl6_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl6_hapWit_dev, .after = "pcl6a_77") %>%
  mutate(pcl7_hapWit_dev = combine_columns(., c("pcl7a_1", "pcl7a_2", "pcl7a_3", "pcl7a_4", "pcl7a_77"), sep = ";") )%>%
  mutate(pcl7_hapWit_dev = str_extract(pcl7_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl7_hapWit_dev, .after = "pcl7a_77") %>%
  mutate(pcl8_hapWit_dev = combine_columns(., c("pcl8a_1", "pcl8a_2", "pcl8a_3", "pcl8a_4", "pcl8a_77"), sep = ";") )%>%
  mutate(pcl8_hapWit_dev = str_extract(pcl8_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl8_hapWit_dev, .after = "pcl8a_77") %>%
  mutate(pcl9_hapWit_dev = combine_columns(., c("pcl9a_1", "pcl9a_2", "pcl9a_3", "pcl9a_4", "pcl9a_77"), sep = ";") )%>%
  mutate(pcl9_hapWit_dev = str_extract(pcl9_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl9_hapWit_dev, .after = "pcl9a_77") %>%
  mutate(pcl10_hapWit_dev = combine_columns(., c("pcl10a_1", "pcl10a_2", "pcl10a_3", "pcl10a_4", "pcl10a_77"), sep = ";") )%>%
  mutate(pcl10_hapWit_dev = str_extract(pcl10_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl10_hapWit_dev, .after = "pcl10a_77") %>%
  mutate(pcl11_hapWit_dev = combine_columns(., c("pcl11a_1", "pcl11a_2", "pcl11a_3", "pcl11a_4", "pcl11a_77"), sep = ";") )%>%
  mutate(pcl11_hapWit_dev = str_extract(pcl11_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl11_hapWit_dev, .after = "pcl11a_77") %>%
  mutate(pcl12_hapWit_dev = combine_columns(., c("pcl12a_1", "pcl12a_2", "pcl12a_3", "pcl12a_4", "pcl12a_77"), sep = ";") )%>%
  mutate(pcl12_hapWit_dev = str_extract(pcl12_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl12_hapWit_dev, .after = "pcl12a_77") %>%
  mutate(pcl13_hapWit_dev = combine_columns(., c("pcl13a_1", "pcl13a_2", "pcl13a_3", "pcl13a_4", "pcl13a_77"), sep = ";") )%>%
  mutate(pcl13_hapWit_dev = str_extract(pcl13_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl13_hapWit_dev, .after = "pcl13a_77") %>%
  mutate(pcl14_hapWit_dev = combine_columns(., c("pcl14a_1", "pcl14a_2", "pcl14a_3", "pcl14a_4", "pcl14a_77"), sep = ";") )%>%
  mutate(pcl14_hapWit_dev = str_extract(pcl14_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl14_hapWit_dev, .after = "pcl14a_77") %>%
  mutate(pcl15_hapWit_dev = combine_columns(., c("pcl15a_1", "pcl15a_2", "pcl15a_3", "pcl15a_4", "pcl15a_77"), sep = ";") )%>%
  mutate(pcl15_hapWit_dev = str_extract(pcl15_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl15_hapWit_dev, .after = "pcl15a_77") %>%
  mutate(pcl16_hapWit_dev = combine_columns(., c("pcl16a_1", "pcl16a_2", "pcl16a_3", "pcl16a_4", "pcl16a_77"), sep = ";") )%>%
  mutate(pcl16_hapWit_dev = str_extract(pcl16_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl16_hapWit_dev, .after = "pcl16a_77") %>%
  mutate(pcl17_hapWit_dev = combine_columns(., c("pcl17a_1", "pcl17a_2", "pcl17a_3", "pcl17a_4", "pcl17a_77"), sep = ";") )%>%
  mutate(pcl17_hapWit_dev = str_extract(pcl17_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl17_hapWit_dev, .after = "pcl17a_77") %>%
  mutate(pcl18_hapWit_dev = combine_columns(., c("pcl18a_1", "pcl18a_2", "pcl18a_3", "pcl18a_4", "pcl18a_77"), sep = ";") )%>%
  mutate(pcl18_hapWit_dev = str_extract(pcl18_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl18_hapWit_dev, .after = "pcl18a_77") %>%
  mutate(pcl19_hapWit_dev = combine_columns(., c("pcl19a_1", "pcl19a_2", "pcl19a_3", "pcl19a_4", "pcl19a_77"), sep = ";") )%>%
  mutate(pcl19_hapWit_dev = str_extract(pcl19_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl19_hapWit_dev, .after = "pcl19a_77") %>%
  
  
  #===========================Developmental Period for "Happened to me" only ============================
  # please note this is developmental period for "Happen to me" is not accurate. Because we asked TC "how old were you when this occurred" ( they don't have a chance to specify weather this was witnessed or actually happened to them. The following code created first development period for happened to me only, i.e.: if someone selected both happen to me and witness, and they indicated it's during 0-5 years old, the only happen to me development period would be 0-5, but we don't know for sure weather that happened to them or they witnessed during this first dev period. 
  mutate(
    pcl1_devperiod = factor(
      case_when(
        !is.na(pcl1a_1) & pcl1_1 == "Happened to me" ~ "0-5",
        is.na(pcl1a_1) & !is.na(pcl1a_2) & pcl1_1 == "Happened to me" ~ "6-11",
        is.na(pcl1a_1) & is.na(pcl1a_2) & !is.na(pcl1_3) & pcl1_1 == "Happened to me" ~ "12-19",
        is.na(pcl1a_1) & is.na(pcl1a_2) & is.na(pcl1a_3) & !is.na(pcl1a_4) & pcl1_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl2_devperiod = factor(
      case_when(
        !is.na(pcl2a_1) & pcl2_1 == "Happened to me" ~ "0-5",
        is.na(pcl2a_1) & !is.na(pcl2a_2) & pcl2_1 == "Happened to me" ~ "6-11",
        is.na(pcl2a_1) & is.na(pcl2a_2) & !is.na(pcl2_3) & pcl2_1 == "Happened to me" ~ "12-19",
        is.na(pcl2a_1) & is.na(pcl2a_2) & is.na(pcl2a_3) & !is.na(pcl2a_4) & pcl2_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl3_devperiod = factor(
      case_when(
        !is.na(pcl3a_1) & pcl3_1 == "Happened to me" ~ "0-5",
        is.na(pcl3a_1) & !is.na(pcl3a_2) & pcl3_1 == "Happened to me" ~ "6-11",
        is.na(pcl3a_1) & is.na(pcl3a_2) & !is.na(pcl3_3) & pcl3_1 == "Happened to me" ~ "12-19",
        is.na(pcl3a_1) & is.na(pcl3a_2) & is.na(pcl3a_3) & !is.na(pcl3a_4) & pcl3_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl4_devperiod = factor(
      case_when(
        !is.na(pcl4a_1) & pcl4_1 == "Happened to me" ~ "0-5",
        is.na(pcl4a_1) & !is.na(pcl4a_2) & pcl4_1 == "Happened to me" ~ "6-11",
        is.na(pcl4a_1) & is.na(pcl4a_2) & !is.na(pcl4_3) & pcl4_1 == "Happened to me" ~ "12-19",
        is.na(pcl4a_1) & is.na(pcl4a_2) & is.na(pcl4a_3) & !is.na(pcl4a_4) & pcl4_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl5_devperiod = factor(
      case_when(
        !is.na(pcl5a_1) & pcl5_1 == "Happened to me" ~ "0-5",
        is.na(pcl5a_1) & !is.na(pcl5a_2) & pcl5_1 == "Happened to me" ~ "6-11",
        is.na(pcl5a_1) & is.na(pcl5a_2) & !is.na(pcl5_3) & pcl5_1 == "Happened to me" ~ "12-19",
        is.na(pcl5a_1) & is.na(pcl5a_2) & is.na(pcl5a_3) & !is.na(pcl5a_4) & pcl5_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl6_devperiod = factor(
      case_when(
        !is.na(pcl6a_1) & pcl6_1 == "Happened to me" ~ "0-5",
        is.na(pcl6a_1) & !is.na(pcl6a_2) & pcl6_1 == "Happened to me" ~ "6-11",
        is.na(pcl6a_1) & is.na(pcl6a_2) & !is.na(pcl6_3) & pcl6_1 == "Happened to me" ~ "12-19",
        is.na(pcl6a_1) & is.na(pcl6a_2) & is.na(pcl6a_3) & !is.na(pcl6a_4) & pcl6_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl7_devperiod = factor(
      case_when(
        !is.na(pcl7a_1) & pcl7_1 == "Happened to me" ~ "0-5",
        is.na(pcl7a_1) & !is.na(pcl7a_2) & pcl7_1 == "Happened to me" ~ "6-11",
        is.na(pcl7a_1) & is.na(pcl7a_2) & !is.na(pcl7_3) & pcl7_1 == "Happened to me" ~ "12-19",
        is.na(pcl7a_1) & is.na(pcl7a_2) & is.na(pcl7a_3) & !is.na(pcl7a_4) & pcl7_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl8_devperiod = factor(
      case_when(
        !is.na(pcl8a_1) & pcl8_1 == "Happened to me" ~ "0-5",
        is.na(pcl8a_1) & !is.na(pcl8a_2) & pcl8_1 == "Happened to me" ~ "6-11",
        is.na(pcl8a_1) & is.na(pcl8a_2) & !is.na(pcl8_3) & pcl8_1 == "Happened to me" ~ "12-19",
        is.na(pcl8a_1) & is.na(pcl8a_2) & is.na(pcl8a_3) & !is.na(pcl8a_4) & pcl8_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl9_devperiod = factor(
      case_when(
        !is.na(pcl9a_1) & pcl9_1 == "Happened to me" ~ "0-5",
        is.na(pcl9a_1) & !is.na(pcl9a_2) & pcl9_1 == "Happened to me" ~ "6-11",
        is.na(pcl9a_1) & is.na(pcl9a_2) & !is.na(pcl9_3) & pcl9_1 == "Happened to me" ~ "12-19",
        is.na(pcl9a_1) & is.na(pcl9a_2) & is.na(pcl9a_3) & !is.na(pcl9a_4) & pcl9_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl10_devperiod = factor(
      case_when(
        !is.na(pcl10a_1) & pcl10_1 == "Happened to me" ~ "0-5",
        is.na(pcl10a_1) & !is.na(pcl10a_2) & pcl10_1 == "Happened to me" ~ "6-11",
        is.na(pcl10a_1) & is.na(pcl10a_2) & !is.na(pcl10_3) & pcl10_1 == "Happened to me" ~ "12-19",
        is.na(pcl10a_1) & is.na(pcl10a_2) & is.na(pcl10a_3) & !is.na(pcl10a_4) & pcl10_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl11_devperiod = factor(
      case_when(
        !is.na(pcl11a_1) & pcl11_1 == "Happened to me" ~ "0-5",
        is.na(pcl11a_1) & !is.na(pcl11a_2) & pcl11_1 == "Happened to me" ~ "6-11",
        is.na(pcl11a_1) & is.na(pcl11a_2) & !is.na(pcl11_3) & pcl11_1 == "Happened to me" ~ "12-19",
        is.na(pcl11a_1) & is.na(pcl11a_2) & is.na(pcl11a_3) & !is.na(pcl11a_4) & pcl11_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl12_devperiod = factor(
      case_when(
        !is.na(pcl12a_1) & pcl12_1 == "Happened to me" ~ "0-5",
        is.na(pcl12a_1) & !is.na(pcl12a_2) & pcl12_1 == "Happened to me" ~ "6-11",
        is.na(pcl12a_1) & is.na(pcl12a_2) & !is.na(pcl12_3) & pcl12_1 == "Happened to me" ~ "12-19",
        is.na(pcl12a_1) & is.na(pcl12a_2) & is.na(pcl12a_3) & !is.na(pcl12a_4) & pcl12_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl13_devperiod = factor(
      case_when(
        !is.na(pcl13a_1) & pcl13_1 == "Happened to me" ~ "0-5",
        is.na(pcl13a_1) & !is.na(pcl13a_2) & pcl13_1 == "Happened to me" ~ "6-11",
        is.na(pcl13a_1) & is.na(pcl13a_2) & !is.na(pcl13_3) & pcl13_1 == "Happened to me" ~ "12-19",
        is.na(pcl13a_1) & is.na(pcl13a_2) & is.na(pcl13a_3) & !is.na(pcl13a_4) & pcl13_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl14_devperiod = factor(
      case_when(
        !is.na(pcl14a_1) & pcl14_1 == "Happened to me" ~ "0-5",
        is.na(pcl14a_1) & !is.na(pcl14a_2) & pcl14_1 == "Happened to me" ~ "6-11",
        is.na(pcl14a_1) & is.na(pcl14a_2) & !is.na(pcl14_3) & pcl14_1 == "Happened to me" ~ "12-19",
        is.na(pcl14a_1) & is.na(pcl14a_2) & is.na(pcl14a_3) & !is.na(pcl14a_4) & pcl14_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl15_devperiod = factor(
      case_when(
        !is.na(pcl15a_1) & pcl15_1 == "Happened to me" ~ "0-5",
        is.na(pcl15a_1) & !is.na(pcl15a_2) & pcl15_1 == "Happened to me" ~ "6-11",
        is.na(pcl15a_1) & is.na(pcl15a_2) & !is.na(pcl15_3) & pcl15_1 == "Happened to me" ~ "12-19",
        is.na(pcl15a_1) & is.na(pcl15a_2) & is.na(pcl15a_3) & !is.na(pcl15a_4) & pcl15_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl16_devperiod = factor(
      case_when(
        !is.na(pcl16a_1) & pcl16_1 == "Happened to me" ~ "0-5",
        is.na(pcl16a_1) & !is.na(pcl16a_2) & pcl16_1 == "Happened to me" ~ "6-11",
        is.na(pcl16a_1) & is.na(pcl16a_2) & !is.na(pcl16_3) & pcl16_1 == "Happened to me" ~ "12-19",
        is.na(pcl16a_1) & is.na(pcl16a_2) & is.na(pcl16a_3) & !is.na(pcl16a_4) & pcl16_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl17_devperiod = factor(
      case_when(
        !is.na(pcl17a_1) & pcl17_1 == "Happened to me" ~ "0-5",
        is.na(pcl17a_1) & !is.na(pcl17a_2) & pcl17_1 == "Happened to me" ~ "6-11",
        is.na(pcl17a_1) & is.na(pcl17a_2) & !is.na(pcl17_3) & pcl17_1 == "Happened to me" ~ "12-19",
        is.na(pcl17a_1) & is.na(pcl17a_2) & is.na(pcl17a_3) & !is.na(pcl17a_4) & pcl17_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl18_devperiod = factor(
      case_when(
        !is.na(pcl18a_1) & pcl18_1 == "Happened to me" ~ "0-5",
        is.na(pcl18a_1) & !is.na(pcl18a_2) & pcl18_1 == "Happened to me" ~ "6-11",
        is.na(pcl18a_1) & is.na(pcl18a_2) & !is.na(pcl18_3) & pcl18_1 == "Happened to me" ~ "12-19",
        is.na(pcl18a_1) & is.na(pcl18a_2) & is.na(pcl18a_3) & !is.na(pcl18a_4) & pcl18_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl19_devperiod = factor(
      case_when(
        !is.na(pcl19a_1) & pcl19_1 == "Happened to me" ~ "0-5",
        is.na(pcl19a_1) & !is.na(pcl19a_2) & pcl19_1 == "Happened to me" ~ "6-11",
        is.na(pcl19a_1) & is.na(pcl19a_2) & !is.na(pcl19_3) & pcl19_1 == "Happened to me" ~ "12-19",
        is.na(pcl19a_1) & is.na(pcl19a_2) & is.na(pcl19a_3) & !is.na(pcl19a_4) & pcl19_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    )
  )





pcl <- pcl %>%
  # Correct column names
  
  rename(pcl2b4 = pcl2b4_3325) %>%
  rename(pcl3b4 = pcl2b4_3367) %>%
  rename(pcl3b4_3_text = pcl2b4_3_text) %>%
  rename(pcl2b4_3_text = pcl2b4_6_text) %>%
  
  rename(pcl2b3 = p_cl2b3) %>%
  relocate(pcl2b3, .after = pcl2b2_6_text) %>%
  rename(pcl2b3_6_text = p_cl2b3_6_text) %>%
  relocate(pcl2b3_6_text, .after = pcl2b3) %>%
  # pcl13
  rename(pcl13b4 = pcl13b4_3787) %>%
  rename(pcl13b4_3_text = pcl13b4_3_text_3788) %>%
  # pcl14
  rename(pcl14b4 = pcl13b4_3829) %>%
  rename(pcl14b4_3_text = pcl13b4_3_text_3830) %>%
  # pcl15
  rename(pcl15b4 = pcl13b4_3871) %>%
  rename(pcl15b4_3_text = pcl13b4_3_text_3872) %>%
  
  mutate(
    # Re-coding 
    across(
      .cols = c(matches("^pcl\\d+_\\d+")),
      .fns = ~case_when(
        .x == "Happened to me" ~ "1",
        .x == "Witnessed it" ~ "1",
        .x == "Learned about it" ~ "1",
        ## Because Not Happen will be in its own column, so coded as 1 to indicate it not happened
        .x == "No (did not happen)" ~ "1",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
    .cols = c(matches("^pcl\\d+a_\\d+")),
      .fns = ~case_when(
         .x == "Ages 0-5" ~ "1",
         .x == "Ages 6-11" ~ "1",
         .x == "Ages 12-19" ~ "1",
         .x == "Adulthood" ~ "1",
         .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(matches("^pcl\\d+_hapWit_dev")),
      .fns = ~case_when(
        .x == "Ages 0-5" ~ "1",
         .x == "Ages 6-11" ~ "2",
         .x == "Ages 12-19" ~ "3",
         .x == "Adulthood" ~ "4",
         .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(matches("^pcl\\d+b\\d+")),
      .fns = ~ case_when(
        .x == "None - did not experience" ~ "0", 
        .x == "1 time ever" ~ "1",
        .x == "2 or more times: Specify" ~ "2",
        .x == "2 or more times" ~ "2",
        .x == "1-2 month" ~ "3",
        .x == "1-2 times per week" ~ "4",
        .x == "2-3 times each week" ~ "5",
        .x == "Almost daily" ~ "6",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(matches("devperiod$")),
      .fns = ~ case_when(
        .x == "0-5" ~ "1", 
        .x == "6-11" ~ "2",
        .x == "12-19" ~ "3",
        .x == "adulthood" ~ "4",
        TRUE ~ .x
    )
  )
  )%>%
  #rename column names to reflect what happened to this situation.
  rename_with(
    .fn = ~ gsub("pcl(\\d+)_1", "pcl\\1_happen", .),
    .cols = matches("pcl\\d+_1")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)_2", "pcl\\1_witness", .),
    .cols = matches("pcl\\d+_2")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)_3", "pcl\\1_learn", .),
    .cols = matches("pcl\\d+_3")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)_4", "pcl\\1_no", .),
    .cols = matches("pcl\\d+_4")
  ) %>%
  # rename column names to reflect when was this situation developed 
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_1", "pcl\\1_hapWit_ages_0_5", .),
    .cols = matches("pcl\\d+a_1")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_2", "pcl\\1_hapWit_ages_6_11", .),
    .cols = matches("pcl\\d+a_2")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_3", "pcl\\1_hapWit_ages_12_19", .),
    .cols = matches("pcl\\d+a_3")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_4", "pcl\\1_hapWit_adulthood", .),
    .cols = matches("pcl\\d+a_4")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_77", "pcl\\1_hapWit_ages_77", .),
    .cols = matches("pcl\\d+a_77")
  ) %>%
    #rename column names to reflect frequency of each development period.
   ## each b1 thorough c variables to have labels
   ## b1 = freq0-5
   ## b2 = freq6-11
   ## b3 = freq12-19
   ## b4 = freqadult
   ## all text just add _txt to the above
  rename_with(
    .fn = ~ gsub("pcl(\\d+)b1", "pcl\\1_freq0-5", .),
    .cols = matches("pcl\\d+b1$")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)b2", "pcl\\1_freq6-11", .),
    .cols = matches("pcl(\\d+)b2")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)b3", "pcl\\1_freq12-19", .),
    .cols = matches("pcl(\\d+)b3")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)b4", "pcl\\1_freqadult", .),
    .cols = matches("pcl(\\d+)b4")
  ) %>%
   rename_with(
    .fn = ~ gsub("b1", "_freq0-5", .),
    .cols = matches("pcl\\d+b1_\\d+_text")
  ) %>%
 rename_with(
    .fn = ~ gsub("b2", "freq6-11", .),
    .cols = matches("pcl\\d+b2_\\d+_text")
  ) %>%
  rename_with(
    .fn = ~ gsub("b3", "freq12-19", .),
    .cols = matches("pcl\\d+b3_\\d+_text")
  ) %>%   
  rename_with(
    .fn = ~ gsub("b4t", "freqadult", .),
    .cols = matches("pcl\\d+b4_\\d+_text")
  ) %>%
  
  # combine multiple choice question columns 
  
  # PCL1
  mutate(pcl1_relation = combine_columns(., c("pcl1c1_1", "pcl1c1_2", "pcl1c1_3", "pcl1c1_9999", 
                                              "pcl1c1_77", "pcl1c2_1", "pcl1c2_2", "pcl1c2_3", "pcl1c2_9999", 
                                              "pcl1c2_77", "pcl1c3_1", "pcl1c3_2", "pcl1c3_3", "pcl1c3_9999", 
                                              "pcl1c3_77", "pcl1c4_1", "pcl1c4_2", "pcl1c4_3", "pcl1c4_9999", 
                                              "pcl1c4_77", "pcl1d_1", "pcl1d_2", "pcl1d_3", "pcl1d_77"), sep = ";") )%>%
  relocate(pcl1_relation, .after = "pcl1_freqadult_3_text") %>%
  select(-c("pcl1c1_1", "pcl1c1_2", "pcl1c1_3", "pcl1c1_9999", "pcl1c1_77",
            "pcl1c2_1", "pcl1c2_2", "pcl1c2_3", "pcl1c2_9999", "pcl1c2_77",
            "pcl1c3_1", "pcl1c3_2", "pcl1c3_3", "pcl1c3_9999", "pcl1c3_77",
            "pcl1c4_1", "pcl1c4_2", "pcl1c4_3", "pcl1c4_9999", "pcl1c4_77",
            "pcl1d_1", "pcl1d_2", "pcl1d_3", "pcl1d_77")) %>%
  # PCL2
  mutate(pcl2_relation = combine_columns(., c("pcl2c1_1", "pcl2c1_2", "pcl2c1_3", "pcl2c1_9999", 
                                              "pcl2c1_77", "pcl2c2_1", "pcl2c2_2", "pcl2c2_3", "pcl2c2_9999", 
                                              "pcl2c2_77", "pcl2c3_1", "pcl2c3_2", "pcl2c3_3", "pcl2c3_9999", 
                                              "pcl2c3_77", "pcl2c4_1", "pcl2c4_2", "pcl2c4_3", "pcl2c4_9999", 
                                              "pcl2c4_77", "pcl2d_1", "pcl2d_2", "pcl2d_3", "pcl2d_77"), sep = ";") )%>%
  relocate(pcl2_relation, .after = "pcl2_freqadult_3_text") %>%
  select(-c("pcl2c1_1", "pcl2c1_2", "pcl2c1_3", "pcl2c1_9999", "pcl2c1_77",
            "pcl2c2_1", "pcl2c2_2", "pcl2c2_3", "pcl2c2_9999", "pcl2c2_77",
            "pcl2c3_1", "pcl2c3_2", "pcl2c3_3", "pcl2c3_9999", "pcl2c3_77",
            "pcl2c4_1", "pcl2c4_2", "pcl2c4_3", "pcl2c4_9999", "pcl2c4_77",
            "pcl2d_1", "pcl2d_2", "pcl2d_3", "pcl2d_77")) %>%
  # PCL3
  mutate(pcl3_relation = combine_columns(., c("pcl3c1_1", "pcl3c1_2", "pcl3c1_3", "pcl3c1_9999", 
                                              "pcl3c1_77", "pcl3c2_1", "pcl3c2_2", "pcl3c2_3", "pcl3c2_9999", 
                                              "pcl3c2_77", "pcl3c3_1", "pcl3c3_2", "pcl3c3_3", "pcl3c3_9999", 
                                              "pcl3c3_77", "pcl3c4_1", "pcl3c4_2", "pcl3c4_3", "pcl3c4_9999", 
                                              "pcl3c4_77", "pcl3d_1", "pcl3d_2", "pcl3d_3", "pcl3d_77"), sep = ";") )%>%
  relocate(pcl3_relation, .after = "pcl3_freqadult_3_text") %>%
  select(-c("pcl3c1_1", "pcl3c1_2", "pcl3c1_3", "pcl3c1_9999", "pcl3c1_77",
            "pcl3c2_1", "pcl3c2_2", "pcl3c2_3", "pcl3c2_9999", "pcl3c2_77",
            "pcl3c3_1", "pcl3c3_2", "pcl3c3_3", "pcl3c3_9999", "pcl3c3_77",
            "pcl3c4_1", "pcl3c4_2", "pcl3c4_3", "pcl3c4_9999", "pcl3c4_77",
            "pcl3d_1", "pcl3d_2", "pcl3d_3", "pcl3d_77")) %>%
  # PCL4
  mutate(pcl4_relation = combine_columns(., c("pcl4c1_1", "pcl4c1_2", "pcl4c1_3", "pcl4c1_9999", 
                                              "pcl4c1_77","pcl4c2_1", "pcl4c2_2", "pcl4c2_3", "pcl4c2_9999", 
                                              "pcl4c2_77","pcl4c3_1", "pcl4c3_2", "pcl4c3_3", "pcl4c3_9999", 
                                              "pcl4c3_77","pcl4c4_1", "pcl4c4_2", "pcl4c4_3", "pcl4c4_9999", 
                                              "pcl4c4_77","pcl4d_1", "pcl4d_2", "pcl4d_3", "pcl4d_77"), sep = ";") )%>%
  relocate(pcl4_relation, .after = "pcl4_freqadult_3_text") %>%
  select(-c("pcl4c1_1", "pcl4c1_2", "pcl4c1_3", "pcl4c1_9999", "pcl4c1_77",
            "pcl4c2_1", "pcl4c2_2", "pcl4c2_3", "pcl4c2_9999", "pcl4c2_77",
            "pcl4c3_1", "pcl4c3_2", "pcl4c3_3", "pcl4c3_9999", "pcl4c3_77",
            "pcl4c4_1", "pcl4c4_2", "pcl4c4_3", "pcl4c4_9999", "pcl4c4_77",
            "pcl4d_1", "pcl4d_2", "pcl4d_3", "pcl4d_77")) %>%  
  # PCL5
  mutate(pcl5_relation = combine_columns(., c("pcl5c1_1", "pcl5c1_2", "pcl5c1_3", "pcl5c1_9999", 
                                              "pcl5c1_77","pcl5c2_1", "pcl5c2_2", "pcl5c2_3", "pcl5c2_9999", 
                                              "pcl5c2_77","pcl5c3_1", "pcl5c3_2", "pcl5c3_3", "pcl5c3_9999", 
                                              "pcl5c3_77","pcl5c4_1", "pcl5c4_2", "pcl5c4_3", "pcl5c4_9999", 
                                              "pcl5c4_77","pcl5d_1", "pcl5d_2", "pcl5d_3", "pcl5d_77"), sep = ";") )%>%
  relocate(pcl5_relation, .after = "pcl5_freqadult_3_text") %>%
  select(-c("pcl5c1_1", "pcl5c1_2", "pcl5c1_3", "pcl5c1_9999", "pcl5c1_77",
            "pcl5c2_1", "pcl5c2_2", "pcl5c2_3", "pcl5c2_9999", "pcl5c2_77",
            "pcl5c3_1", "pcl5c3_2", "pcl5c3_3", "pcl5c3_9999", "pcl5c3_77",
            "pcl5c4_1", "pcl5c4_2", "pcl5c4_3", "pcl5c4_9999", "pcl5c4_77",
            "pcl5d_1", "pcl5d_2", "pcl5d_3", "pcl5d_77")) %>%  
    # PCL6
  mutate(pcl6_relation = combine_columns(., c("pcl6c1_1", "pcl6c1_2", "pcl6c1_3", "pcl6c1_9999", 
                                              "pcl6c1_77","pcl6c2_1", "pcl6c2_2", "pcl6c2_3", "pcl6c2_9999", 
                                              "pcl6c2_77","pcl6c3_1", "pcl6c3_2", "pcl6c3_3", "pcl6c3_9999", 
                                              "pcl6c3_77","pcl6c4_1", "pcl6c4_2", "pcl6c4_3", "pcl6c4_9999", 
                                              "pcl6c4_77","pcl6d_1", "pcl6d_2", "pcl6d_3", "pcl6d_77"), sep = ";") )%>%
  relocate(pcl6_relation, .after = "pcl6_freqadult_3_text") %>%
  select(-c("pcl6c1_1", "pcl6c1_2", "pcl6c1_3", "pcl6c1_9999", "pcl6c1_77",
            "pcl6c2_1", "pcl6c2_2", "pcl6c2_3", "pcl6c2_9999", "pcl6c2_77",
            "pcl6c3_1", "pcl6c3_2", "pcl6c3_3", "pcl6c3_9999", "pcl6c3_77",
            "pcl6c4_1", "pcl6c4_2", "pcl6c4_3", "pcl6c4_9999", "pcl6c4_77",
            "pcl6d_1", "pcl6d_2", "pcl6d_3", "pcl6d_77")) %>%  
    # PCL7
  mutate(pcl7_relation = combine_columns(., c("pcl7c1_1", "pcl7c1_2", "pcl7c1_3", "pcl7c1_9999", 
                                              "pcl7c1_77","pcl7c2_1", "pcl7c2_2", "pcl7c2_3", "pcl7c2_9999", 
                                              "pcl7c2_77","pcl7c3_1", "pcl7c3_2", "pcl7c3_3", "pcl7c3_9999", 
                                              "pcl7c3_77","pcl7c4_1", "pcl7c4_2", "pcl7c4_3", "pcl7c4_9999", 
                                              "pcl7c4_77","pcl7d_1", "pcl7d_2", "pcl7d_3", "pcl7d_77"), sep = ";") )%>%
  relocate(pcl7_relation, .after = "pcl7_freqadult_3_text") %>%
  select(-c("pcl7c1_1", "pcl7c1_2", "pcl7c1_3", "pcl7c1_9999", "pcl7c1_77",
            "pcl7c2_1", "pcl7c2_2", "pcl7c2_3", "pcl7c2_9999", "pcl7c2_77",
            "pcl7c3_1", "pcl7c3_2", "pcl7c3_3", "pcl7c3_9999", "pcl7c3_77",
            "pcl7c4_1", "pcl7c4_2", "pcl7c4_3", "pcl7c4_9999", "pcl7c4_77",
            "pcl7d_1", "pcl7d_2", "pcl7d_3", "pcl7d_77")) %>% 
    # PCL8
  mutate(pcl8_relation = combine_columns(., c("pcl8c1_1", "pcl8c1_2", "pcl8c1_3", "pcl8c1_9999", 
                                              "pcl8c1_77","pcl8c2_1", "pcl8c2_2", "pcl8c2_3", "pcl8c2_9999", 
                                              "pcl8c2_77","pcl8c3_1", "pcl8c3_2", "pcl8c3_3", "pcl8c3_9999", 
                                               "pcl8c3_77","pcl8c4_1", "pcl8c4_2", "pcl8c4_3", "pcl8c4_9999", 
                                               "pcl8c4_77","pcl8d_1", "pcl8d_2", "pcl8d_3", "pcl8d_77"), sep = ";") )%>%
  relocate(pcl8_relation, .after = "pcl8_freqadult_3_text") %>%
  select(-c("pcl8c1_1", "pcl8c1_2", "pcl8c1_3", "pcl8c1_9999", "pcl8c1_77",
            "pcl8c2_1", "pcl8c2_2", "pcl8c2_3", "pcl8c2_9999", "pcl8c2_77",
            "pcl8c3_1", "pcl8c3_2", "pcl8c3_3", "pcl8c3_9999", "pcl8c3_77",
            "pcl8c4_1", "pcl8c4_2", "pcl8c4_3", "pcl8c4_9999", "pcl8c4_77",
            "pcl8d_1", "pcl8d_2", "pcl8d_3", "pcl8d_77")) %>%  
    # PCL9
  mutate(pcl9_relation = combine_columns(., c("pcl9c1_1", "pcl9c1_2", "pcl9c1_3", "pcl9c1_9999", 
                                              "pcl9c1_77","pcl9c2_1", "pcl9c2_2", "pcl9c2_3", "pcl9c2_9999", 
                                              "pcl9c2_77","pcl9c3_1", "pcl9c3_2", "pcl9c3_3", "pcl9c3_9999", 
"pcl9c3_77","pcl9c4_1", "pcl9c4_2", "pcl9c4_3", "pcl9c4_9999", 
"pcl9c4_77","pcl9d_1", "pcl9d_2", "pcl9d_3", "pcl9d_77"), sep = ";") )%>%
  relocate(pcl9_relation, .after = "pcl9_freqadult_3_text") %>%
  select(-c("pcl9c1_1", "pcl9c1_2", "pcl9c1_3", "pcl9c1_9999", "pcl9c1_77",
            "pcl9c2_1", "pcl9c2_2", "pcl9c2_3", "pcl9c2_9999", "pcl9c2_77",
            "pcl9c3_1", "pcl9c3_2", "pcl9c3_3", "pcl9c3_9999", "pcl9c3_77",
            "pcl9c4_1", "pcl9c4_2", "pcl9c4_3", "pcl9c4_9999", "pcl9c4_77",
            "pcl9d_1", "pcl9d_2", "pcl9d_3", "pcl9d_77")) %>%  
    # PCL10
  mutate(pcl10_relation = combine_columns(., c("pcl10c1_1", "pcl10c1_2", "pcl10c1_3", "pcl10c1_9999", 
                                               "pcl10c1_77","pcl10c2_1", "pcl10c2_2", "pcl10c2_3", 
                                               "pcl10c2_9999", "pcl10c2_77","pcl10c3_1", "pcl10c3_2", "pcl10c3_3", "pcl10c3_9999", 
"pcl10c3_77","pcl10c4_1", "pcl10c4_2", "pcl10c4_3", "pcl10c4_9999", 
"pcl10c4_77","pcl10d_1", "pcl10d_2", "pcl10d_3", "pcl10d_77"), sep = ";") )%>%
  relocate(pcl10_relation, .after = "pcl10_freqadult_3_text") %>%
  select(-c("pcl10c1_1", "pcl10c1_2", "pcl10c1_3", "pcl10c1_9999", "pcl10c1_77",
            "pcl10c2_1", "pcl10c2_2", "pcl10c2_3", "pcl10c2_9999", "pcl10c2_77",
            "pcl10c3_1", "pcl10c3_2", "pcl10c3_3", "pcl10c3_9999", "pcl10c3_77",
            "pcl10c4_1", "pcl10c4_2", "pcl10c4_3", "pcl10c4_9999", "pcl10c4_77",
            "pcl10d_1", "pcl10d_2", "pcl10d_3", "pcl10d_77")) %>%
    # PCL11
  mutate(pcl11_relation = combine_columns(., c("pcl11c_1", "pcl11c_2", "pcl11c_3", "pcl11c_9999", 
                                               "pcl11c_77","pcl11c2_1", "pcl11c2_2", "pcl11c2_3", "pcl11c2_9999", 
                                               "pcl11c2_77","pcl11c3_1", "pcl11c3_2", "pcl11c3_3", "pcl11c3_9999", 
"pcl11c3_77","pcl11c4_1", "pcl11c4_2", "pcl11c4_3", "pcl11c4_9999", 
"pcl11c4_77","pcl11d_1", "pcl11d_2", "pcl11d_3", "pcl11d_77"), sep = ";") )%>%
  relocate(pcl11_relation, .after = "pcl11_freqadult_3_text") %>%
  select(-c("pcl11c_1", "pcl11c_2", "pcl11c_3", "pcl11c_9999", "pcl11c_77",
            "pcl11c2_1", "pcl11c2_2", "pcl11c2_3", "pcl11c2_9999", "pcl11c2_77",
            "pcl11c3_1", "pcl11c3_2", "pcl11c3_3", "pcl11c3_9999", "pcl11c3_77",
            "pcl11c4_1", "pcl11c4_2", "pcl11c4_3", "pcl11c4_9999", "pcl11c4_77",
            "pcl11d_1", "pcl11d_2", "pcl11d_3", "pcl11d_77")) %>%
    # PCL12
  mutate(pcl12_relation = combine_columns(., c("pcl12c1_1", "pcl12c1_2", "pcl12c1_3", "pcl12c1_9999", 
                                               "pcl12c1_77","pcl12c2_1", "pcl12c2_2", "pcl12c2_3", "pcl12c2_9999", 
                                               "pcl12c2_77","pcl12c3_1", "pcl12c3_2", "pcl12c3_3", "pcl12c3_9999", 
                                               "pcl12c3_77","pcl12c4_1", "pcl12c4_2", "pcl12c4_3", "pcl12c4_9999", 
                                               "pcl12c4_77","pcl12d_1", "pcl12d_2", "pcl12d_3", "pcl12d_77"), sep = ";") )%>%
  relocate(pcl12_relation, .after = "pcl12_freqadult_3_text") %>%
  select(-c("pcl12c1_1", "pcl12c1_2", "pcl12c1_3", "pcl12c1_9999", "pcl12c1_77",
            "pcl12c2_1", "pcl12c2_2", "pcl12c2_3", "pcl12c2_9999", "pcl12c2_77",
            "pcl12c3_1", "pcl12c3_2", "pcl12c3_3", "pcl12c3_9999", "pcl12c3_77",
            "pcl12c4_1", "pcl12c4_2", "pcl12c4_3", "pcl12c4_9999", "pcl12c4_77",
            "pcl12d_1", "pcl12d_2", "pcl12d_3", "pcl12d_77")) %>%
      # PCL13
  mutate(pcl13_relation = combine_columns(., c("pcl13c1_1", "pcl13c1_2", "pcl13c1_3", "pcl13c1_9999", 
                                               "pcl13c1_77","pcl13c2_1", "pcl13c2_2", "pcl13c2_3", "pcl13c2_9999", 
                                               "pcl13c2_77","pcl13c3_1", "pcl13c3_2", "pcl13c3_3", "pcl13c3_9999", 
                                               "pcl13c3_77","pcl13c4_1", "pcl13c4_2", "pcl13c4_3", "pcl13c4_9999", 
                                               "pcl13c4_77","pcl13d_1", "pcl13d_2", "pcl13d_3", "pcl13d_77"), sep = ";") )%>%
  relocate(pcl13_relation, .after = "pcl13_freqadult_3_text") %>%
  select(-c("pcl13c1_1", "pcl13c1_2", "pcl13c1_3", "pcl13c1_9999", "pcl13c1_77",
            "pcl13c2_1", "pcl13c2_2", "pcl13c2_3", "pcl13c2_9999", "pcl13c2_77",
            "pcl13c3_1", "pcl13c3_2", "pcl13c3_3", "pcl13c3_9999", "pcl13c3_77",
            "pcl13c4_1", "pcl13c4_2", "pcl13c4_3", "pcl13c4_9999", "pcl13c4_77",
            "pcl13d_1", "pcl13d_2", "pcl13d_3", "pcl13d_77")) %>%
      # PCL14
  mutate(pcl14_relation = combine_columns(., c("pcl14c1_1", "pcl14c1_2", "pcl14c1_3", "pcl14c1_9999", 
                                               "pcl14c1_77","pcl14c2_1", "pcl14c2_2", "pcl14c2_3", "pcl14c2_9999", 
                                               "pcl14c2_77","pcl14c3_1", "pcl14c3_2", "pcl14c3_3", "pcl14c3_9999", 
                                               "pcl14c3_77","pcl14c4_1", "pcl14c4_2", "pcl14c4_3", "pcl14c4_9999", 
                                               "pcl14c4_77","pcl14d_1", "pcl14d_2", "pcl14d_3", "pcl14d_77"), sep = ";") )%>%
  relocate(pcl14_relation, .after = "pcl14_freqadult_3_text") %>%
  select(-c("pcl14c1_1", "pcl14c1_2", "pcl14c1_3", "pcl14c1_9999", "pcl14c1_77",
            "pcl14c2_1", "pcl14c2_2", "pcl14c2_3", "pcl14c2_9999", "pcl14c2_77",
            "pcl14c3_1", "pcl14c3_2", "pcl14c3_3", "pcl14c3_9999", "pcl14c3_77",
            "pcl14c4_1", "pcl14c4_2", "pcl14c4_3", "pcl14c4_9999", "pcl14c4_77",
            "pcl14d_1", "pcl14d_2", "pcl14d_3", "pcl14d_77")) %>%
      # PCL15
  mutate(pcl15_relation = combine_columns(., c("pcl15c1_1", "pcl15c1_2", "pcl15c1_3", "pcl15c1_9999", 
                                               "pcl15c1_77","pcl15c2_1", "pcl15c2_2", "pcl15c2_3", "pcl15c2_9999", 
                                               "pcl15c2_77","pcl15c3_1", "pcl15c3_2", "pcl15c3_3", "pcl15c3_9999", 
                                               "pcl15c3_77","pcl15c4_1", "pcl15c4_2", "pcl15c4_3", "pcl15c4_9999", 
                                               "pcl15c4_77","pcl15d_1", "pcl15d_2", "pcl15d_3", "pcl15d_77"), sep = ";") )%>%
  relocate(pcl15_relation, .after = "pcl15_freqadult_3_text") %>%
  select(-c("pcl15c1_1", "pcl15c1_2", "pcl15c1_3", "pcl15c1_9999", "pcl15c1_77",
            "pcl15c2_1", "pcl15c2_2", "pcl15c2_3", "pcl15c2_9999", "pcl15c2_77",
            "pcl15c3_1", "pcl15c3_2", "pcl15c3_3", "pcl15c3_9999", "pcl15c3_77",
            "pcl15c4_1", "pcl15c4_2", "pcl15c4_3", "pcl15c4_9999", "pcl15c4_77",
            "pcl15d_1", "pcl15d_2", "pcl15d_3", "pcl15d_77")) %>% 
    # PCL16
  mutate(pcl16_relation = combine_columns(., c("pcl16c1_1", "pcl16c1_2", "pcl16c1_3", "pcl16c1_9999", 
                                               "pcl16c1_77","pcl16c2_1", "pcl16c2_2", "pcl16c2_3", "pcl16c2_9999", 
                                               "pcl16c2_77","pcl16c3_1", "pcl16c3_2", "pcl16c3_3", 
                                               "pcl16c3_9999", "pcl16c3_77","pcl16c4_1", "pcl16c4_2", "pcl16c4_3", 
                                               "pcl16c4_9999", "pcl16c4_77","pcl16d_1", "pcl16d_2", "pcl16d_3", "pcl16d_77"), sep = ";") )%>%
  relocate(pcl16_relation, .after = "pcl16_freqadult_3_text") %>%
  select(-c("pcl16c1_1", "pcl16c1_2", "pcl16c1_3", "pcl16c1_9999", "pcl16c1_77",
            "pcl16c2_1", "pcl16c2_2", "pcl16c2_3", "pcl16c2_9999", "pcl16c2_77",
            "pcl16c3_1", "pcl16c3_2", "pcl16c3_3", "pcl16c3_9999", "pcl16c3_77",
            "pcl16c4_1", "pcl16c4_2", "pcl16c4_3", "pcl16c4_9999", "pcl16c4_77",
            "pcl16d_1", "pcl16d_2", "pcl16d_3", "pcl16d_77")) %>% 
      # PCL17
  mutate(pcl17_relation = combine_columns(., c("pcl17c1_1", "pcl17c1_2", "pcl17c1_3", "pcl17c1_9999", 
                                               "pcl17c1_77","pcl17c2_1", "pcl17c2_2", "pcl17c2_3", "pcl17c2_9999", 
                                               "pcl17c2_77","pcl17c3_1", "pcl17c3_2", "pcl17c3_3", "pcl17c3_9999", 
                                               "pcl17c3_77","pcl17c4_1", "pcl17c4_2", "pcl17c4_3", "pcl17c4_9999", 
                                               "pcl17c4_77","pcl17d_1", "pcl17d_2", "pcl17d_3", "pcl17d_77"), sep = ";") )%>%
  relocate(pcl17_relation, .after = "pcl17_freqadult_3_text") %>%
  select(-c("pcl17c1_1", "pcl17c1_2", "pcl17c1_3", "pcl17c1_9999", "pcl17c1_77",
            "pcl17c2_1", "pcl17c2_2", "pcl17c2_3", "pcl17c2_9999", "pcl17c2_77",
            "pcl17c3_1", "pcl17c3_2", "pcl17c3_3", "pcl17c3_9999", "pcl17c3_77",
            "pcl17c4_1", "pcl17c4_2", "pcl17c4_3", "pcl17c4_9999", "pcl17c4_77",
            "pcl17d_1", "pcl17d_2", "pcl17d_3", "pcl17d_77")) %>%
      # PCL18
  mutate(pcl18_relation = combine_columns(., c("pcl18c1_1", "pcl18c1_2", "pcl18c1_3", "pcl18c1_9999", 
                                               "pcl18c1_77","pcl18c2_1", "pcl18c2_2", "pcl18c2_3", "pcl18c2_9999", 
                                               "pcl18c2_77","pcl18c3_1", "pcl18c3_2", "pcl18c3_3", "pcl18c3_9999", 
                                               "pcl18c3_77","pcl18c4_1", "pcl18c4_2", "pcl18c4_3", "pcl18c4_9999", 
                                               "pcl18c4_77","pcl18d_1", "pcl18d_2", "pcl18d_3", "pcl18d_77"), sep = ";") )%>%
  mutate(pcl18c2 = combine_columns(., c(), sep = ";") )%>%
  mutate(pcl18c3 = combine_columns(., c(), sep = ";") )%>%
  mutate(pcl18c4 = combine_columns(., c(), sep = ";") )%>%
  mutate(pcl18d = combine_columns(., c(), sep = ";") )%>%
  relocate(pcl18_relation, .after = "pcl18_freqadult_3_text") %>%
  select(-c("pcl18c1_1", "pcl18c1_2", "pcl18c1_3", "pcl18c1_9999", "pcl18c1_77",
            "pcl18c2_1", "pcl18c2_2", "pcl18c2_3", "pcl18c2_9999", "pcl18c2_77",
            "pcl18c3_1", "pcl18c3_2", "pcl18c3_3", "pcl18c3_9999", "pcl18c3_77",
            "pcl18c4_1", "pcl18c4_2", "pcl18c4_3", "pcl18c4_9999", "pcl18c4_77",
            "pcl18d_1", "pcl18d_2", "pcl18d_3", "pcl18d_77")) %>%  
      # PCL19
  mutate(pcl19_relation = combine_columns(., c("pcl19c1_1", "pcl19c1_2", "pcl19c1_3", 
                                               "pcl19c1_9999", "pcl19c1_77","pcl19c2_1", "pcl19c2_2", "pcl19c2_3", "pcl19c2_9999", 
                                               "pcl19c2_77","pcl19c3_1", "pcl19c3_2", "pcl19c3_3", "pcl19c3_9999", 
                                               "pcl19c3_77","pcl19c4_1", "pcl19c4_2", "pcl19c4_3", "pcl19c4_9999", 
                                               "pcl19c4_77","pcl19d_1", "pcl19d_2", "pcl19d_3", "pcl19d_77"), sep = ";") )%>%
  relocate(pcl19_relation, .after = "pcl19_freqadult_3_text") %>%
  select(-c("pcl19c1_1", "pcl19c1_2", "pcl19c1_3", "pcl19c1_9999", "pcl19c1_77",
            "pcl19c2_1", "pcl19c2_2", "pcl19c2_3", "pcl19c2_9999", "pcl19c2_77",
            "pcl19c3_1", "pcl19c3_2", "pcl19c3_3", "pcl19c3_9999", "pcl19c3_77",
            "pcl19c4_1", "pcl19c4_2", "pcl19c4_3", "pcl19c4_9999", "pcl19c4_77",
            "pcl19d_1", "pcl19d_2", "pcl19d_3", "pcl19d_77")) %>%
  rename_with(
              .fn = ~ gsub("\\d+_text", "text", .),
              .cols = ends_with("text") 
  ) 

```

```{r}
# pcl <- pcl %>%
#   mutate(pcl1_happen = case_when(
#     pcl1_77 == -77 ~ "-77",
#     is.na(pcl1_happen) & is.na(pcl1_77) ~ "0",
#     TRUE ~ pcl1_happen
#   ),
#   pcl2_happen = case_when(
#     pcl2_77 == -77 ~ "-77",
#     is.na(pcl2_happen) & is.na(pcl2_77) ~ "0",
#     TRUE ~ pcl2_happen
#   ),
#   pcl3_happen = case_when(
#     pcl3_77 == -77 ~ "-77",
#     is.na(pcl3_happen) & is.na(pcl3_77) ~ "0",
#     TRUE ~ pcl3_happen
#   ),
#   pcl4_happen = case_when(
#     pcl4_77 == -77 ~ "-77",
#     is.na(pcl4_happen) & is.na(pcl4_77) ~ "0",
#     TRUE ~ pcl4_happen
#   ),
#   pcl5_happen = case_when(
#     pcl5_77 == -77 ~ "-77",
#     is.na(pcl5_happen) & is.na(pcl5_77) ~ "0",
#     TRUE ~ pcl5_happen
#   ),
#   pcl6_happen = case_when(
#     pcl6_77 == -77 ~ "-77",
#     is.na(pcl6_happen) & is.na(pcl6_77) ~ "0",
#     TRUE ~ pcl6_happen
#   ),
#   pcl7_happen = case_when(
#     pcl7_77 == -77 ~ "-77",
#     is.na(pcl7_happen) & is.na(pcl7_77) ~ "0",
#     TRUE ~ pcl7_happen
#   ),
#   pcl8_happen = case_when(
#     pcl8_77 == -77 ~ "-77",
#     is.na(pcl8_happen) & is.na(pcl8_77) ~ "0",
#     TRUE ~ pcl8_happen
#   ),
#   pcl9_happen = case_when(
#     pcl9_77 == -77 ~ "-77",
#     is.na(pcl9_happen) & is.na(pcl9_77) ~ "0",
#     TRUE ~ pcl9_happen
#   ),
#   pcl10_happen = case_when(
#     pcl10_77 == -77 ~ "-77",
#     is.na(pcl10_happen) & is.na(pcl10_77) ~ "0",
#     TRUE ~ pcl10_happen
#   ),
#   pcl11_happen = case_when(
#     pcl11_77 == -77 ~ "-77",
#     is.na(pcl11_happen) & is.na(pcl11_77) ~ "0",
#     TRUE ~ pcl11_happen
#   ),
#   pcl12_happen = case_when(
#     pcl12_77 == -77 ~ "-77",
#     is.na(pcl12_happen) & is.na(pcl12_77) ~ "0",
#     TRUE ~ pcl12_happen
#   ),
#   pcl13_happen = case_when(
#     pcl13_77 == -77 ~ "-77",
#     is.na(pcl13_happen) & is.na(pcl13_77) ~ "0",
#     TRUE ~ pcl13_happen
#   ),
#   pcl14_happen = case_when(
#     pcl14_77 == -77 ~ "-77",
#     is.na(pcl14_happen) & is.na(pcl14_77) ~ "0",
#     TRUE ~ pcl14_happen
#   ),
#   pcl15_happen = case_when(
#     pcl15_77 == -77 ~ "-77",
#     is.na(pcl15_happen) & is.na(pcl15_77) ~ "0",
#     TRUE ~ pcl15_happen
#   ),
#   pcl16_happen = case_when(
#     pcl16_77 == -77 ~ "-77",
#     is.na(pcl16_happen) & is.na(pcl16_77) ~ "0",
#     TRUE ~ pcl16_happen
#   ),
#   pcl17_happen = case_when(
#     pcl17_77 == -77 ~ "-77",
#     is.na(pcl17_happen) & is.na(pcl17_77) ~ "0",
#     TRUE ~ pcl17_happen
#   ),
#   pcl18_happen = case_when(
#     pcl18_77 == -77 ~ "-77",
#     is.na(pcl18_happen) & is.na(pcl18_77) ~ "0",
#     TRUE ~ pcl18_happen
#   ),
#   pcl19_happen = case_when(
#     pcl19_77 == -77 ~ "-77",
#     is.na(pcl19_happen) & is.na(pcl19_77) ~ "0",
#     TRUE ~ pcl19_happen
#   )
#   )
# 
# 
# 

```

### LEC Missing 
```{r LEC_missing }
# Fixed some NAs 
columns_happen <- paste0("pcl", 1:19, "_happen")
for (column in columns_happen) {
  pcl <- pcl %>%
    mutate({{column}} := case_when(
      get(paste0("pcl",gsub("[^0-9]", "", column), "_77")) == "-77" ~ "-77",
      is.na(get(column)) & is.na(get(paste0("pcl",gsub("[^0-9]", "", column), "_77"))) ~ "0",
      TRUE ~ get(column)
    ))
}

columns_witness <- paste0("pcl", 1:19, "_witness")
for (column in columns_witness) {
  pcl <- pcl %>%
    mutate({{column}} := case_when(
      get(paste0("pcl",gsub("[^0-9]", "", column), "_77")) == "-77" ~ "-77",
      is.na(get(column)) & is.na(get(paste0("pcl",gsub("[^0-9]", "", column), "_77"))) ~ "0",
      TRUE ~ get(column)
    ))
}

columns_learn <- paste0("pcl", 1:19, "_learn")
for (column in columns_learn) {
  pcl <- pcl %>%
    mutate({{column}} := case_when(
      get(paste0("pcl",gsub("[^0-9]", "", column), "_77")) == "-77" ~ "-77",
      is.na(get(column)) & is.na(get(paste0("pcl",gsub("[^0-9]", "", column), "_77"))) ~ "0",
      TRUE ~ get(column)
    ))
}

columns_no <- paste0("pcl", 1:19, "_no")
for (column in columns_no) {
  pcl <- pcl %>%
    mutate({{column}} := case_when(
      get(paste0("pcl",gsub("[^0-9]", "", column), "_77")) == "-77" ~ "-77",
      is.na(get(column)) & is.na(get(paste0("pcl",gsub("[^0-9]", "", column), "_77"))) ~ "0",
      TRUE ~ get(column)
    ))
}

###################################################################################
columns_hapWit_ages_0_5 <- paste0("pcl", 1:19, "_hapWit_ages_0_5")
for (column in columns_hapWit_ages_0_5) {
  pcl <- pcl %>%
    mutate({{column}} := case_when(
      get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_77")) == "-77" ~ "-77",
      is.na(get(column)) & is.na(get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_77"))) ~ "0",
      TRUE ~ get(column)
    ))
}


columns_hapWit_ages_6_11 <- paste0("pcl", 1:19, "_hapWit_ages_6_11")
for (column in columns_hapWit_ages_6_11) {
  pcl <- pcl %>%
    mutate({{column}} := case_when(
      get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_77")) == "-77" ~ "-77",
      is.na(get(column)) & is.na(get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_77"))) ~ "0",
      TRUE ~ get(column)
    ))
}

columns_hapWit_ages_12_19 <- paste0("pcl", 1:19, "_hapWit_ages_12_19")
for (column in columns_hapWit_ages_12_19) {
  pcl <- pcl %>%
    mutate({{column}} := case_when(
      get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_77")) == "-77" ~ "-77",
      is.na(get(column)) & is.na(get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_77"))) ~ "0",
      TRUE ~ get(column)
    ))
}

columns_hapWit_adulthood <- paste0("pcl", 1:19, "_hapWit_adulthood")
for (column in columns_hapWit_adulthood) {
  pcl <- pcl %>%
    mutate({{column}} := case_when(
      get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_77")) == "-77" ~ "-77",
      is.na(get(column)) & is.na(get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_77"))) ~ "0",
      TRUE ~ get(column)
    ))
}
###################################################################################
columns_hapWit_dev <- paste0("pcl", 1:19, "_hapWit_dev")
for (column in columns_hapWit_dev) {
  pcl <- pcl %>%
    mutate({{column}} := case_when(
      get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_77")) == "-77" ~ "-77",
      is.na(get(column)) ~ "0",
      TRUE ~ get(column)
    ))
}


# Frequence ##################################################################################

columns_freq0_5 <- paste0("pcl", 1:19, "_freq0-5")
for (column in columns_freq0_5) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(                         
        # if _hapWit_ages_0_5 is 0 then _freq0-5 should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_0_5")) == "0" ~ "-55",
        # if _hapWit_ages_0_5 is -77 then _freq0-5 should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_0_5")) == "-77" ~ "-55",
        # if _freq0-5 are still NA then _freq0-5 should be truly missing 
        is.na(get(column)) ~ "-99",
        TRUE ~ get(column)
      ))
}
columns_freq0_5_text <- paste0("pcl", 1:19, "_freq0-5_text")
for (column in columns_freq0_5_text) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(    
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq0-5")) != "2" ~ "-55",
        # if _freq0-5 is -55 then _freq0-5_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq0-5")) == "-55" ~ "-55",
        # if _freq0-5 is -77 then _freq0-5_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq0-5")) == "-77" ~ "-55",
        # if _freq0-5 is -99 then _freq0-5_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq0-5")) == "-99" ~ "-55",
        TRUE ~ get(column)
      ))
}

columns_freq6_11 <- paste0("pcl", 1:19, "_freq6-11")
for (column in columns_freq6_11) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(                         
        # if _hapWit_ages_6_11 is 0 then _freq6-11 should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_6_11")) == "0" ~ "-55",
        # if _hapWit_ages_6_11 is -77 then _freq6-11 should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_6_11")) == "-77" ~ "-55",
        # if _freq6-11 are still NA then _freq6-11 should be truly missing 
        is.na(get(column)) ~ "-99",
        TRUE ~ get(column)
      ))
}
columns_freq6_11_text <- paste0("pcl", 1:19, "_freq6-11_text")
for (column in columns_freq6_11_text) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(    
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq6-11")) != "2" ~ "-55",
        # if _freq6-11 is -55 then _freq0-5_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq6-11")) == "-55" ~ "-55",
        # if _freq6-11 is -77 then _freq0-5_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq6-11")) == "-77" ~ "-55",
        # if _freq6-11 is -99 then _freq0-5_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq6-11")) == "-99" ~ "-55",
        TRUE ~ get(column)
      ))
}


columns_freq12_19 <- paste0("pcl", 1:19, "_freq12-19")
for (column in columns_freq12_19) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(                         
        # if _hapWit_ages_12_19 is 0 then _freq12-19 should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_12_19")) == "0" ~ "-55",
        # if _hapWit_ages_12_19 is -77 then _freq12-19 should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_ages_12_19")) == "-77" ~ "-55",
        # if _freq12-19 are still NA then _freq12-19 should be truly missing 
        is.na(get(column)) ~ "-99",
        TRUE ~ get(column)
      ))
}
columns_freq12_19_text <- paste0("pcl", 1:19, "_freq12-19_text")
for (column in columns_freq12_19_text) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(    
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq12-19")) != "2" ~ "-55",
        # if _freq12-19 is -55 then _freq12-19_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq12-19")) == "-55" ~ "-55",
        # if _freq12-19 is -77 then _freq12-19_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq12-19")) == "-77" ~ "-55",
        # if _freq12-19 is -99 then _freq12-19_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freq12-19")) == "-99" ~ "-55",
        TRUE ~ get(column)
      ))
}

columns_freqadult <- paste0("pcl", 1:19, "_freqadult")
for (column in columns_freqadult) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(                         
        # if _hapWit_adulthood is 0 then _freqadult should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_adulthood")) == "0" ~ "-55",
        # if _hapWit_adulthood is -77 then _freqadult should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_hapWit_adulthood")) == "-77" ~ "-55",
        # if _freqadult are still NA then _freqadult should be truly missing 
        is.na(get(column)) ~ "-99",
        TRUE ~ get(column)
      ))
}
columns_freqadult_text <- paste0("pcl", 1:19, "_freqadult_text")
for (column in columns_freqadult_text) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(   
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freqadult")) != "2" ~ "-55",
        # if_freqadult is -55 then _freqadult_text_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freqadult")) == "-55" ~ "-55",
        # if _freqadult is -77 then _freqadult_text_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freqadult")) == "-77" ~ "-55",
        # _freqadult is -99 then _freqadult_text_text should be -55 
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_freqadult")) == "-99" ~ "-55",
        TRUE ~ get(column)
      ))
}

# relation  ##################################################################################
columns_relation <- paste0("pcl", 1:19, "_relation")
for (column in columns_relation) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(                         
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_witness")) == "0" & get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_learn")) == "0" ~ "-55",
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_witness")) %in% c("-77","-55", "-99") & get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_learn")) %in% c("-77","-55", "-99") ~ "-55",
        # if _relation are still NA then _relation should be truly missing 
        is.na(get(column)) ~ "-99",
        TRUE ~ get(column)
      ))
}

# ##################################################################################
# Maria please double check this one
# when pcl1_happen is 0 then pcl1_devperiod is -55? 
columns_devperiod <- paste0("pcl", 1:19, "_devperiod")
for (column in columns_devperiod) {
    pcl <- pcl %>%
      mutate({{column}} := case_when(                         
        get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_happen")) == "0" ~ "-55",
        #get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_witness")) %in% c("-77","-55", "-99") & get(paste0("pcl", gsub("pcl(\\d+).*", "\\1", column), "_learn")) %in% c("-77","-55", "-99") ~ "-55",
        # if _relation are still NA then _relation should be truly missing 
        is.na(get(column)) ~ "-99",
        TRUE ~ get(column)
      ))
}




pcl <- pcl %>%
  mutate_at(vars(matches("pcl\\d+_hapWit_dev")), ~ifelse(is.na(.), 0, .)) %>%
  select(-c(matches("pcl\\d+_77"), matches("pcl\\d+_hapWit_ages_77")))



### missing 
pcl_miss_happen <- pcl %>%
  mutate(across(matches("_happen$"), as.numeric)) %>%
  select(id, matches("_happen$"))%>%
  pct_miss_fun(
    id = c("id"),
    n_items = 19
  )

pcl_miss_happen %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'pcl Missing Data for _happen ',
    subtitle = 'by Participant'
  )
# missing remove for when calculating total_happen
pcl_happen_remove <- pcl_miss_happen %>% filter(miss_pct >= 20) 



pcl_miss_witness <- pcl %>%
  mutate(across(matches("_witness$"), as.numeric)) %>%
  select(id, matches("_witness$"))%>%
  pct_miss_fun(
    id = c("id"),
    n_items = 19
  )

pcl_miss_witness %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'pcl Missing Data for _witness ',
    subtitle = 'by Participant'
  )
# missing remove for when calculating total_witness
pcl_witness_remove <- pcl_miss_witness %>% filter(miss_pct >= 20) 

```

### LEC Calculation
```{r}
pcl_calc <- pcl %>%
  mutate(across(ends_with("_happen"), as.numeric)) %>%
  mutate(across(ends_with("_witness"), as.numeric)) %>%
  mutate(pcl_total_happen = rowSums(select(., ends_with("_happen")), na.rm = T)) %>%
  mutate(pcl_total_witness = rowSums(select(., ends_with("_witness")), na.rm = T)) 


pcl_calc <- pcl %>%
  select(id, ends_with("_happen"), ends_with("_witness")) %>%
  mutate(across(-id, as.numeric)) %>%
  
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  ) %>%
  mutate(pcl_total_happen = rowSums(select(., ends_with("_happen")), na.rm = T)) %>%
  mutate(pcl_total_witness = rowSums(select(., ends_with("_witness")), na.rm = T))%>%
  # apply missing rule 
  mutate_at(vars(pcl_total_happen), ~ ifelse(id %in% c(pcl_happen_remove$id), -99, .))%>%
  mutate_at(vars(pcl_total_happen), ~ ifelse(id %in% c(pcl_witness_remove$id), -99, .))



pcl_complete <- pcl_calc %>%
  select(id, pcl_total_happen, pcl_total_witness) %>%
  merge(pcl, by = "id") %>%
  # Dropping this variable for archive. 
  select(-c(pcl1b:pcl19b_text, pcl18c2:pcl18d, matches("pcl\\d+_77"), matches("pcl\\d+_hapWit_ages_77"))) %>%
  select(-c(pcl_total_happen, pcl_total_witness), everything(), pcl_total_happen, pcl_total_witness) %>%
  rename_with(~ paste0("lec", str_replace(., "^pcl", "")), starts_with("pcl")) 
  
pcl_internal_old_variable <- pcl %>%
  select(id, pcl1b:pcl19b_text)

```

## Merge
Merge together all measures 
```{r merge}
# This file contain all data including correct missing code for missing values (-77, -99, -55 etc.). 
# This file also contain all the computed variables. 
tpw_archive_calc <- tpw_archive_id %>%
  left_join(bsi_complete, by = "id") %>%
  left_join(cesd_complete, by = "id") %>%
  left_join(ciq_complete, by = "id") %>%
  left_join(dast_complete, by = "id") %>%
  left_join(cts_complete, by = "id") %>%
  left_join(bcap_complete, by = "id") %>%
  left_join(dyadc_complete, by = "id") %>%
  left_join(arq_complete, by = "id") %>%
  left_join(prss_complete, by = "id") %>%
  left_join(ssq_complete, by = "id") %>%
  left_join(elf_complete, by = "id") %>%
  left_join(ell_complete, by = "id") %>%
  left_join(mhc_complete, by = "id") %>%
  left_join(flo_complete, by = "id") %>%
  left_join(itq_complete, by = "id") %>%
  left_join(ibq_complete, by = "id") %>%
  left_join(cint_socio_complete, by="id") %>%
  left_join(cint_ladder_complete, by="id") %>%
  left_join(cint_relation_complete, by="id") %>%
  left_join(cint_substance_complete, by="id") %>%
  left_join(cint_covid_complete, by="id") %>%
  left_join(socinf_sub_complete, by="id") %>%
  left_join(socinf_gen_complete, by="id") %>%
  left_join(cts_pc_complete, by = "id") %>%
  left_join(pct_complete, by = "id") %>%
  left_join(sus_complete, by = "id") %>%
  left_join(sex_complete, by="id") %>%
  left_join(pcl_complete, by = "id") %>%
  mutate_if(is.numeric, round, digits=2) %>%
  rename(family = id)


# internal data 
tpw_internal <- tpw_archive_id %>% 
  left_join(sus_internal, by = "id") %>%
  left_join(pcl_internal_old_variable, by = "id") 
```

```{r output}
# write.csv(tpw_archive, here("do_not_push", "tpw_archive.csv"))
write.csv(tpw_archive_calc, here("do_not_push", "tpw_archive_calc.csv"))
write.csv(tpw_internal, here("do_not_push", "tpw_internal.csv"))
```
