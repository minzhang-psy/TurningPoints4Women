---
title: "Telephone Assessment Data Cleanning Script"
author: "Min Zhang"
date: ""
output: html_document
---

```{r setup, include=FALSE}
# loading Library 
library(tidyverse)
library(dplyr)
library(here)
library(lubridate)
# import raw survey items
# this is input file "tpw_measure.csv" 
# update this before archival
tpw_raw <- read.csv(here("do_not_push", "tpw_measure.csv")) %>%
  select(-X) %>%
  filter(start_date != "Start Date")

source(here("functions", "codebook_fun.R"))

# Scientific Notation 
options(scipen = 2)

tpw_archive_id <- tpw_raw %>%
  select(id)
```

## Min's TODO/Note 
add prompt for each measure in codebook.
check missing rules in codebook 

cleanning todo: 
check pct_miss_fun have right numbers 
check all pct_miss_fun has   mutate(across(-c(id), as.numeric))%>%.  # done checking through cintsubstance 
check multiple choices questions shouldn't be changed to as.numeric 

Missing data rule should apply to all missing numbers 
note if a question was skipped for incarerated TC. 

convert text to number 
reverse score column 
create sub-scale 
-use his out put file 
-sum/avg 
! data order: original items; reverse coded items; total/subscales

question: for NA/None answer option, should I recode them to -55 (e.g. ibq9/ cint63)
There are answer options which are excluded from analysis, it will be NA, is there ways that we can identify NA is actually shows because they choose NA answer options (SOCINF General)

question about missing value, I feel like there are item shouldn't be counted when calculate the missing percentage, ie: there are columns for text entry when TC choose other, if TC choose other answer option, this shouldn't be counted when count missing percentage? 
cint_socio won't have any data after applying missing data 

which( colnames(df)=="b" )
# Find NA values in the data frame
na_positions <- which(is.na(df), arr.ind = TRUE)

Min: need work on Missing data and calculation for measure after sex history 

## BSI
### BSI Select Variables and Recode 
```{r bsi}
# Select bsi questions and recede
bsi <-
  tpw_raw %>%
  select(
    id,
    matches(
      '^bsi'
    ),
    -bsi20, 
    -bsi21,
    -bsi22
  ) %>%
  mutate(across(-id, as.factor)) %>%
    mutate(
      across(
        .cols = c(bsi1:bsi19),
        .fns = ~case_when(
         .x == "Not at all" ~ "0",
         .x == "A little bit" ~ "1",
         .x == "Moderately" ~ "2",
         .x == "Quite a bit" ~ "3",
         .x == "Very much" ~ "4",
         .x == "Decline to Answer" ~ "-77",
         TRUE ~ .x
        )
      )
    ) 
  
```

### BSI Missing Data 
There are missing data in BSI, but missing rule does not applied. 
```{r bsi_missing }
# correct missing value: Not Applicable = -55 = The subject was never asked a question for some reason (conditional question)
bsi <- bsi %>% 
  mutate(
    bsi4 = case_when(
      # for incarcerated TC, bsi4 wasn't shown 
      id %in% c("HR211", "HR181", "P819") & is.na(bsi4) ~ "-55",
      TRUE ~ bsi4
    )
  )
  
bsi %>%
  mutate(across(-c(id), as.numeric))%>%
  pct_miss_fun(
    id = 'id',
    n_items = 19
  )%>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'BSI Missing Data',
    subtitle = 'By Participant')
```

### BSI Calculations & Subscale
```{r bsi_calculations}
# Below is the code that treats -77, -55 values as NA
bsi_calc <-
  bsi %>%
  mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x == -77 ~ NA_real_,
        .x == -55 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# BSI Composite & Subscale Score Creation 
bsi_complete <-
  bsi_calc %>%
  composite_total_avg_fun(
    id = 'id',
    max_value = 4,
    n_items = 19
  ) %>%
  distinct(
    across(
      .cols = everything()
    )
  ) %>%
  subscale_create(
    total_only = TRUE,
    scale1 = c('bsi2', 'bsi3', 'bsi10',
               'bsi11', 'bsi12', 'bsi13', 'bsi15'),
    scale2 = c('bsi1', 'bsi5', 'bsi9',
               'bsi16', 'bsi17', 'bsi18'),
    scale3 = c('bsi4', 'bsi6', 'bsi7',
               'bsi8', 'bsi14', 'bsi19')
  ) %>%
  rename(
    bsi_total = sum_values,
    bsi_avg = mean_values,
    bsi_soma = total1,
    bsi_anx = total2,
    bsi_dep = total3
  ) %>%
  select(-bsi_avg)

bsi_complete <- bsi_complete %>%
  select(id, bsi_total, bsi_soma, bsi_anx, bsi_dep) %>%
  merge(bsi, by="id") %>%
  relocate(bsi_total:bsi_dep, .after = "bsi19")
```


## CESD 
### CESD Select Variables and Recode 
```{r cesd creation, warning = FALSE, message = FALSE}
cesd <-
tpw_raw %>%
  select(
    id,
    matches(
      '^c\\d'
    )
  ) %>%
mutate(
    across(
      .cols = c(c1:c20),
      .fns = ~case_when(
        .x == "Rarely or none of the time (0-1 day)" ~ "0",
        .x == "Some or a little of the time (1-2 days)" ~ "1",
        .x == "Occasionally or a moderate amount of time (3-4 days)" ~ "2",
        .x == "Most or all of the time (5-7 days)" ~ "3",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(c21:c24),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(c4, c8, c12, c16),
      .fns = ~case_when(
        .x == "0" ~ "3",
        .x == "1" ~ "2",
        .x == "2" ~ "1",
        .x == "3" ~ "0",
        .x == "-77" ~ "-77",
      TRUE ~ .x
      ),
      .names = '{.col}_r'
      )
)

```

### CESD Missing Data
There are missing data in CESD but the missing rule is not applied due to being below the threshold.
```{r CESD_missing }
# correct missing value: Not Applicable = -55 = The subject was never asked a question for some reason (conditional question)
# if response is No to item c21, then TC moved on to item c24
cesd <- cesd %>%
  mutate(c22 = ifelse((c21 == 0 |c21 ==  "-77"), "-55", c22),
         c23 = ifelse((c21 == 0 |c21 ==  "-77"), "-55", c23),
         # for incarcerated TC, c21-c24 wasn't shown 
         c21 = case_when( id %in% c("HR211", "HR181", "P819") & is.na(c21) ~ "-55",TRUE ~ c21),
         c22 = case_when( id %in% c("HR211", "HR181", "P819") & is.na(c22) ~ "-55",TRUE ~ c22),
         c23 = case_when( id %in% c("HR211", "HR181", "P819") & is.na(c23) ~ "-55",TRUE ~ c23),
         c24 = case_when( id %in% c("HR211", "HR181", "P819") & is.na(c24) ~ "-55",TRUE ~ c24)
      )


cesd_missing <- cesd %>%
  mutate(across(-c(id), as.numeric))%>%
  select(id,
         c1:c24, # reverse scored are not included so that missing percent only involves original items (each item only represented one time)
         ) %>% 
  pct_miss_fun(
    id = 'id',
    n_items = 24
  ) 
  
cesd_missing  %>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'CESD Missing Data',
    subtitle = 'By Participant')
```


### CESD Calculations & Subscale
```{r cesd_calculatio}

# Below is the code that treats negative values (-77, -55) as NA
cesd_calc <-
  cesd %>%
  mutate(across(-id, as.numeric)) %>%
    mutate(
      across(
        .cols = -id,
        .fns = ~case_when(
          .x < 0 ~ NA_real_,
          TRUE ~ .x
        )
      )
    )

# CESD Composite & Subscale Score Creation 
cesd_complete <-
  cesd_calc %>%
  composite_total_avg_fun(
    id = c('id',
           'c4',
           'c8',
           'c12', 
           'c16', # c4,c8,c12, c16 was removed because we are using reverse score instead 
           'c21', # C21 - c24 removed because they are address suicidality 
           'c22',
           'c23',
           'c24'), 
    n_items = 20
  ) %>%
  subscale_create(
    total_only = FALSE,
    scale1 = c('c1', 'c2', 'c3', 'c4_r', 'c5',  
               'c6', 'c7', 'c8_r', 'c9', 'c10', 'c11',
               'c12_r', 'c13', 'c14', 'c15', 'c16_r', 'c17',
               'c18', 'c19', 'c20'),
    scale1_nitems = 20,
    scale2 = c('c1'),  # These are irrelevent, and removed below 
    scale2_nitems = 1
  ) %>%
  rename(
    cesd_total = sum_values,
    cesd_avg = mean_values,
    
    cesd_dep_symp = total1,  
    cesd_dep_symp_avg = avg1
  ) %>%
  distinct(
    across(
      .cols = everything()
    )
  )%>%
  select(-cesd_avg, -total2, -avg2) %>%
  relocate(id, .before = c1) %>%
  relocate(c4, .after = c3) %>%
  relocate(c8, .after = c7) %>%
  relocate(c12, .after = c11) %>%
  relocate(c16, .after = c15) %>%
  relocate(c21:c24, .after = c20) 
  

# Merge _calc and _complete 
cesd_complete <- cesd_complete %>%
  select(id, cesd_total:cesd_dep_symp_avg) %>%
  merge(cesd, by = "id") %>% 
  relocate(cesd_total:cesd_dep_symp_avg, .after = c16_r)
```


## CIQ
### CIQ Select Variables and Recode 
```{r ciq}
## items originally labelled as "bsiXX" as this was administered together with the BSI due to it being a related construct
ciq <- 
	tpw_raw %>%
	select(
	  id,
	  bsi20,
	  bsi21,
	  bsi22
	) %>% 
  rename(
    ciq1 = bsi20,
    ciq2 = bsi21,
    ciq3 = bsi22
  ) %>%
  mutate(
    across(
        .cols = c(ciq1, ciq2, ciq3),
        .fns = ~case_when(
          .x == "1 = not true of me at all" ~ "1",
          .x == "2" ~ "2",
          .x == "3" ~ "3",
          .x == "4" ~ "4",
          .x == "5" ~ "5",
          .x == "6" ~ "6",
          .x == "7 = very true of me" ~ "7",
          .x == "Decline to Answer" ~ "-77",
          TRUE ~ .x
        )
      ),
	  ciq3_r = case_when(
          ciq3 == "1" ~ "7",
          ciq3 == "2" ~ "6",
          ciq3 == "3" ~ "5",
          ciq3 == "4" ~ "4",
          ciq3 == "5" ~ "3",
          ciq3 == "6" ~ "2",
          ciq3 == "7" ~ "1",
          ciq3 == "-77" ~ "-77",
          TRUE ~ ciq3
        )
    ) %>%
    relocate(
      ciq3_r, .before = ciq3
    )
```



### CIQ Missing Data 
No missing data found in the CIQ measure. 
```{r, warning = FALSE, message = FALSE}
ciq %>%
    mutate(across(-id, as.numeric)) %>%
  select(id,
         ciq1:ciq3_r) %>%
  pct_miss_fun(
    id = 'id',
    n_items = 3
  )%>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'CIQ Missing Data',
    subtitle = 'By Participant')

```


### CIQ Calculations & Subscale
```{r ciq_calculations}
# Below is the code that treat -77 as NA
ciq_calc <-
  ciq %>%
  mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )


# CIQ Psychological Impacts Subscale Score Creation 

ciq_calc <- ciq_calc %>%
  mutate(ciq_psych_total = rowMeans(select(., starts_with("ciq"), -ciq3), na.rm = TRUE), ## average vs sum based on other publications; no missing data
         ciq_psych_total = round(ciq_psych_total, 2))

# Reorder the columns and make complete data set
ciq_complete <- ciq_calc %>%
  select(id, ciq_psych_total) %>%
  merge(ciq, by="id") %>%
  relocate(ciq_psych_total, .after = "ciq3")

```

## DAST
### DAST Select Variables and Recode 
```{r dast}
# Select bis questions and recede
dast <-
  tpw_raw %>%
  select(
    id,
    matches('^d\\d')
    ) %>%
  mutate(
    across(
      .cols = c(d00:d20),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
        across(
      .cols = c(d4, d5),
      .fns = ~case_when(
        .x == "1" ~ "0",
        .x == "0" ~ "1",
        .x == "-77" ~ "-77",
        TRUE ~ .x
      ),
      .names = '{.col}_r'
    )
  ) %>%
  rename( dast_screen =d00)

```

### DAST Missing Data 
There are missing data in DAST and missing rule applied. 
```{r dast_missing }
# correct missing value: Not Applicable = -55 = The subject was never asked a question for some reason (conditional question)
# if dast_screen is No-1, rest column should be NA(-55)
# if D1A is No-0, or Decline to Answer(-77), d2a should be NA(-55)
# if 2b is No-0 or Decline to Answer (-77), rest column should be NA(-55)


# correct missing value: Not Applicable = -55 = The subject was never asked a question for some reason (conditional question)
dast <- dast %>% 
  #TODO:Maria please double check the skip rule that is correct
  # for incarcerated TC, entire dast survey wasn't shown
  # MIN this is correct, the incarcerated TX could not answer this questionnaires
  mutate_at(vars(dast_screen:d20,d4_r, d5_r), ~case_when(id %in% c("HR211", "HR181", "P819") & is.na(.) ~ "-55", TRUE ~ .)) %>%
  # Skip rule: if dast_screen == 1 (TC is pregnant) the rest survey are skipped
  mutate_at(vars(d1a:d20,d4_r, d5_r), ~case_when(dast_screen == 1 ~ "-55", TRUE ~ . )) %>%
  # Skip rule: if d1a == 0 or -77 , d2a is skipped
  # mutate(d2a = case_when(d1a == 0 | d1a == "-77" ~ "-55", TRUE ~ d2a)) %>%
  # Skip rule: if d1a == 1 (d2a is answered (1,0,-77)) d2b should be skipped 
  # mutate(d2b = case_when(d1a == 1 ~ "-55", TRUE ~ d2b)) %>%
  # Skip rule: if d2b == 0 or -77, rest question were skipped 
  mutate_at(vars(d3:d20,d4_r, d5_r), ~case_when(d2b == 0 | d2b == "-77" ~ "-55", TRUE ~ . )) 

# Combine d2a and d2b answer options to d2
dast$d2 <- apply(dast[, c("d2a", "d2b")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Organize column order 
dast <- dast %>%
  relocate(d2, .after = d1a) %>%
  select(-c(d2a, d2b)) %>%
  mutate(
    across(
      .cols = d2,
      .fns = ~case_when(
        .x == "-55;-55" ~ "-55",
        TRUE ~ .x
      )
    )
  ) 

dast %>%
    mutate(across(-id, as.numeric)) %>%
  select(-dast_screen,
         -d4,
         -d5) %>%
  pct_miss_fun(
    id = 'id',
    n_items = 20
  ) %>% 
  gt::gt() %>% 
  gt::tab_header(
    title = 'DAST Missing Data',
    subtitle = 'By Participant'
  )
```

### DAST Calculations & Subscale
```{r dast_calculations}
# Below is the code that treat negative values (-77, -55) as NA
# Apply NA rule
dast_calc <-
  dast %>% 
  mutate(across(-id, as.numeric)) %>%
  select(-dast_screen,
         -d4,
         -d5) %>%
  pct_miss_fun(
    id = 'id',
    n_items = 21
  ) %>%
  full_join(dast, by = 'id') %>% 
  mutate(across(-id, as.numeric))%>%
    filter(
    is.na(miss_pct) |
      miss_pct < 20
         ) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

### DAST Composite & Subscale Score Creation 
# TODO:Maria, Can you please check if the total is calculated right? double check d4, d5 
dast_complete <-
  dast_calc %>%
  select(-missing_n,
         -miss_pct) %>%
  index_total_fun(
    id = c('id',
           'dast_screen',
           'd4',
           'd5')
  ) %>%
  rename(
    dast_total = sum_values 
  )
```

### DAST recode total 
```{r dast recode }
# re-code total score 
# RECODE AWH8DAST (0 = 0) (1 THRU 5 = 1) (6 THRU 10 = 2) (11 THRU 15 = 3) (16 THRU 20 = 4) INTO AWHPDASC
# VALUE LABELS AWHPDASC
# 0 'None'
# 1 'Low'
# 2 'Intermediate (likely meets DSM criteria)'
# 3 'Substantial'
# 4 'Severe'.

dast_complete <- dast_complete %>%
  mutate(dast_total_r = case_when(
    dast_total == 0 ~ 0,
    dast_total %in% 1:5 ~ 1,
    dast_total %in% 6:10 ~ 2,
    dast_total %in% 11:15 ~ 3,
    dast_total %in% 16:20 ~ 4,
    TRUE ~ NA_integer_
  ))
```

## CTS - Partner
### CTS Select Variables and Recode 
```{r cts}
# Select cts questions and recede
cts <-
  tpw_raw %>%
  select(
    id,
    matches(
      '^ct'
    ),
    -cts_parent_screen # removed because part of the CTS parent-child
  ) %>%
  mutate(across(-id, as.factor)) %>%
  mutate(
    across(
      .cols = c(ct1:ct20),
      .fns = ~case_when(
        # Keeping "this has never happened" as 8 to fit with historical longitudinal data
        .x == "Once in the past year" ~ "1",
        .x == "Twice in the past year" ~ "2",
        .x == "3-5 times in the past year" ~ "3",
        .x == "6-10 times in the past year" ~ "4",
        .x == "11-20 times in the past year" ~ "5",
        .x == "More than 20 times in the past year" ~ "6",
        .x == "Not in the past year, but it did happen before" ~ "7",
        .x == "This has never happened" ~ "8",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .col = cts_screen,
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0", 
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
      )
  ) 

```

### CTS Missing Data 
There are missing data in CTS and missing rule applied. 
```{r cts_missing}
cts <- cts %>%
  # if answered no for screening question, the entire survey is skipped.
  mutate_at(vars(ct1:ct20), ~case_when(cts_screen == 0  ~ "-55", TRUE ~ . )) %>%
  # participants who were incarcerated at the time of participation were not administered this survey
  mutate_at(vars(cts_screen, ct1:ct20), ~ ifelse(id %in% c("HR211", "HR181", "P819"), "-55", .))

cts %>%
  mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = c('id', 'cts_screen'),
    n_items = 20
  ) %>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'CTS2S Missing Data',
    subtitle = 'By Participant'
  )
```

### CTS Calculations & Subscale 
```{r cts_calculations }
cts_calc <-
  cts %>%
  pct_miss_fun(
    id = c('id', 'cts_screen'),
    n_items = 20
  ) %>%
  full_join(cts,
            by = 'id') %>%
  mutate(across(-id, as.numeric)) %>%
  filter(
    is.na(miss_pct) |
      miss_pct < 20
         ) %>%
  mutate(
    across(
      .cols = c(ct1:ct20),
      .fns = ~case_when(
        .x == -77 ~ NA_real_,
        .x == -55 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

cts_calc <- 
  cts_calc %>% 
  mutate(
    across(
      .cols = c(ct1, ct2, ct7, ct8),
      .fns = ~case_when(
        .x == 1 ~ 1,
        .x == 2 ~ 2,
        .x == 3 ~ 4,
        .x == 4 ~ 8,
        .x == 5 ~ 15.5, # midpoint between 11-20
        .x == 6 ~ 20,
        .x == 7 ~ 0,
        .x == 8 ~ 0,
        TRUE ~ NA_real_
      ),
      .names = '{col}_midpoint'
    )
  )




cts_complete <-
  cts_calc %>%
  select(
    -missing_n,
    -miss_pct
  ) %>%
    mutate(
      across(
          .cols = c(ct1:ct20),
          .fns = ~case_when(
            .x %in% c(1, 2, 3, 4, 5, 6) ~ 1,
            .x %in% c(7, 8) ~ 0,
            TRUE ~ NA_real_
          ),
          .names = '{col}_dum'
        )
    )

# ind = 
# part = 
cts_complete <-
  cts_complete %>%
    subscale_create(
      total_only = TRUE,
      scale1 = c('ct3_dum', 'ct13_dum'),
      scale2 = c('ct4_dum', 'ct14_dum'),
      scale3 = c('ct5_dum', 'ct15_dum'),
      scale4 = c('ct6_dum', 'ct16_dum'),
      scale5 = c('ct9_dum', 'ct11_dum'),
      scale6 = c('ct10_dum', 'ct12_dum'),
      scale7 = c('ct17_dum', 'ct19_dum'),
      scale8 = c('ct18_dum', 'ct20_dum'),
      scale9 = c('ct1_midpoint', 'ct7_midpoint'),
      scale10 = c('ct2_midpoint', 'ct8_midpoint')
    ) %>%
    rename(
      # past year severity only
      cts_psy_agg_ind_sev = total1,
      cts_psy_agg_part_sev = total2,
      cts_injury_ind_sev = total3,
      cts_injury_part_sev = total4,
      cts_assault_ind_sev = total5,
      cts_assault_part_sev = total6,
      cts_sex_ind_sev = total7,
      cts_sex_part_sev = total8,
      cts_negotiate_ind = total9,
      cts_negotiate_part = total10
    )

cts_complete <-
  cts_complete %>%
    mutate(
      cts_psy_agg_ind_prev = if_else(cts_psy_agg_ind_sev == 0, 0, 1),
      cts_psy_agg_part_prev = if_else(cts_psy_agg_part_sev == 0, 0, 1),
      cts_injury_ind_prev = if_else(cts_injury_ind_sev == 0, 0, 1),
      cts_injury_part_prev = if_else(cts_injury_part_sev == 0, 0, 1),
      cts_assault_ind_prev = if_else(cts_assault_ind_sev == 0, 0, 1),
      cts_assault_part_prev = if_else(cts_assault_part_sev == 0, 0, 1),
      cts_sex_ind_prev = if_else(cts_sex_ind_sev == 0, 0, 1),
      cts_sex_part_prev = if_else(cts_sex_part_sev == 0, 0, 1),
      cts_psy_agg_mutual = case_when(
        (cts_psy_agg_ind_prev == 1 &
          cts_psy_agg_part_prev == 1) ~ 3,
        (cts_psy_agg_ind_prev == 0 &
           cts_psy_agg_part_prev == 1) ~ 1,
        (cts_psy_agg_ind_prev == 1 &
           cts_psy_agg_part_prev == 0) ~ 2,
        (cts_psy_agg_ind_prev == 0 &
           cts_psy_agg_part_prev == 0) ~ -99
      ),
      cts_injury_mutual = case_when(
        (cts_injury_ind_prev == 1 &
           cts_injury_part_prev == 1) ~ 3,
        (cts_injury_ind_prev == 0 &
           cts_injury_part_prev == 1) ~ 1,
        (cts_injury_ind_prev == 1 &
           cts_injury_part_prev == 0) ~ 2,
        (cts_injury_ind_prev == 0 &
           cts_injury_part_prev == 0) ~ -99
      ),
      cts_assault_mutual = case_when(
        (cts_assault_ind_prev == 1 &
           cts_assault_part_prev == 1) ~ 3,
        (cts_assault_ind_prev == 0 &
           cts_assault_part_prev == 1) ~ 1,
        (cts_assault_ind_prev == 1 &
           cts_assault_part_prev == 0) ~ 2,
        (cts_assault_ind_prev == 0 &
           cts_assault_part_prev == 0) ~ -99
      ),
      cts_sex_mutual = case_when(
        (cts_sex_ind_prev == 1 &
           cts_sex_part_prev == 1) ~ 3,
        (cts_sex_ind_prev == 0 &
           cts_sex_part_prev == 1) ~ 1,
        (cts_sex_ind_prev == 1 &
           cts_sex_part_prev == 0) ~ 2,
        (cts_sex_ind_prev == 0 &
           cts_sex_part_prev == 0) ~ -99
      )
    )
# Dropping dummy-coded variables for archive
# pulling in original items with missing data code
cts_complete <- cts_complete %>%
  select(-ct1_dum:-ct20_dum) %>%
  select(id, ct1_midpoint:cts_sex_mutual) %>%
  merge(cts, by="id") %>%
  # reorder dataset 
  relocate(ct1_midpoint:cts_sex_mutual, .after = "ct20") %>%
  # add in -99 for midpoint ranges that cannot be computed due to -55 codes
   mutate(
    ct1_midpoint = if_else(is.na(ct1_midpoint), -99, ct1_midpoint),
    ct2_midpoint = if_else(is.na(ct2_midpoint), -99, ct2_midpoint),
    ct7_midpoint = if_else(is.na(ct7_midpoint), -99, ct7_midpoint),
    ct8_midpoint = if_else(is.na(ct8_midpoint), -99, ct8_midpoint)
  )
  
  

```
## BCAP
### BCAP Select Variables and Recode
```{r bcap}
# Select bcap questions and recede
bcap <-
  tpw_raw %>%
  select(id, matches('^q\\d'), -q1461) %>%
 mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x == "Agree" ~ 1,
        .x == "Disagree" ~ 0,
        .x == "Decline to Answer" ~ -77
        # TRUE ~ NA_real_
      )
    ),
    across(
      .cols = c(q1, q2, q23, q29),
      .fns = ~case_when(
        .x == 1 ~ 0,
        .x == 0 ~ 1,
        TRUE ~ .x
      ),
      .names = '{.col}_r'
    )
  )
```

### BCAP Missing Data 
There are missing data in BCAP and missing rule not applied. 
```{r bcap_missing}
bcap %>%
  select(-c(q1,q2,q23,q29)) %>%
    mutate(across(-id, as.numeric)) %>%
    pct_miss_fun(
      id = 'id', 
      n_items = 34 
    ) %>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'BCAP Missing Data',
    subtitle = 'By Participant'
  )
```

### BCAP Calculations & Subscale
```{r bcap_calculations}
bcap_calc <-
  bcap %>%
    pct_miss_fun(
      id = 'id',
      n_items = 34
    ) %>%
    full_join(bcap,
              by = 'id') %>%
    filter(
      is.na(miss_pct) |
        miss_pct < 20
      ) %>%
  mutate(
    across(
      .cols = c(-id, -miss_pct, -missing_n),
      .fns = ~case_when(
        .x == -77 ~ NA_real_,
        .x == -55 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

bcap_complete <-
  bcap_calc %>%
  select(
    -missing_n,
    -miss_pct
         ) %>% 
    # index_total_fun(
    #   id = 'id'
    # ) %>%
  subscale_create(
  total_only = TRUE,
  scale1 = c('q1_r', 'q23_r', 'q29_r',
             'q3', 'q25', 'q33',
             'q5', 'q12', 'q22', 'q31',
             'q6', 'q13', 'q17',
             'q7', 'q14', 'q20', 'q32',
             'q8', 'q11', 'q16', 'q19', 'q27',
             'q10', 'q30'),
  scale2 = c('q1_r', 'q23_r', 'q29_r'),
  scale3 = c('q3', 'q25', 'q33'),
  scale4 = c('q5', 'q12', 'q22', 'q31'),
  scale5 = c('q6', 'q13', 'q17'),
  scale6 = c('q7', 'q14', 'q20', 'q32'),
  scale7 = c('q8', 'q11', 'q16', 'q19', 'q27'),
  scale8 = c('q10', 'q30'),
  scale9 = c('q4', 'q9', 'q15', 'q21', 'q26', 'q34'),
  scale10 = c('q2_r', 'q18', 'q28')
  ) %>% 
    rename(
    bcap_risk = total1,
    bcap_happy = total2,
    bcap_feel_pers = total3,
    bcap_lonely = total4,
    bcap_fam_conf = total5,
    bcap_rigid = total6,
    bcap_distress = total7,
    bcap_poverty = total8,
    bcap_lie = total9,
    bcap_random = total10
    )

```

## DAS 
### DAS Select Variables and Recode 
```{r dyadc}
# Referred to as dyadc in coding, but this is the DAS. 
dyadc <-
  tpw_raw %>% 
  select(
    id,
    dyadc_screener,
    matches(
      '^e\\d'
      )
    ) %>%
  #mutate(across(-id, as.factor)) %>%
  mutate(
    across(
      .cols = c(dyadc_screener),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(e1:e15),
      .fns = ~case_when(
        .x == "Always Disagree" ~ "0",
        .x == "Almost always Disagree" ~ "1", 
        .x == "Almost Always Disagree" ~ "1", # Need both because one survey including this title case
        .x == "Frequently Disagree" ~ "2",
        .x == "Occasionally Disagree" ~ "3",
        .x == "Almost always Agree" ~ "4",
        .x == "Always Agree" ~ "5",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~.x
      )
    ),
    across(
      .cols = c(e16, e17, e20:e22), 
      .fns = ~case_when(
        .x == "All the time" ~ "0",
        .x == "Most of the time" ~ "1",
        .x == "More often than not" ~ "2",
        .x == "Occasionally" ~ "3",
        .x == "Rarely" ~ "4",
        .x == "Never" ~ '5',
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(e18,e19), 
      .fns = ~case_when(
        .x == "All the time" ~ "5",
        .x == "Most of the time" ~ "4",
        .x == "More often than not" ~ "3",
        .x == "Occasionally" ~ "2",
        .x == "Rarely" ~ "1",
        .x == "Never" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(e23:e24),
      .fns = ~case_when(
        .x == "Never" ~ "0",
        .x == "Rarely" ~ "1",
        .x == "Occasionally" ~ "2",
        .x == "Almost every day" ~ "3",
        .x == "Every day" ~ "4",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(e25:e28),
      .fns = ~case_when(
        .x == "Never" ~ '0',
        .x == "Less than once a month" ~ "1",
        .x == "Once or twice a month" ~ "2",
        .x == "Once or twice a week" ~ "3",
        .x == "Once a day" ~ "4",
        .x == "More often" ~ "5",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(e29, e30),
      .fns = ~case_when(
        .x == "Yes" ~ "0",
        .x == "No" ~ "1",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    e31 = case_when(
      e31 == "0 - Extremely Unhappy" ~ "0",
      e31 == "1 - Fairly Unhappy" ~ "1",
      e31 == "2 - A little Unhappy" ~ "2",
      e31 == "3 - Happy" ~ "3",
      e31 == "4 - Very Happy" ~ "4",
      e31 == "5 - Extremely Happy" ~ "5",
      e31 == "6 - Perfect" ~ "6",
      e31 == "Decline to Answer" ~ "-77",
        TRUE ~ e31
    ),
    e32 = case_when(
      e32 == "5 - I want desperately for my relationship to succeed, and would go to almost any length to see that it does." ~ "5",
      e32 == "4 - I want very much for my relationship to succeed, and will do all I can to see that it does." ~ "4",
      e32 == "3 - I want very much for my relationship to succeed, and will do my fair share to see that it does." ~ "3",
      e32 == "2 - It would be nice if my relationship succeeded, but I can’t do much more than I’m doing now to help it succeed." ~ "2",
      e32 == "1 - It would be nice if it succeeded, but I refuse to do any more than I am doing now to keep the relationship going." ~ "1",
      e32 ==  "0 - My relationship can never succeed, and there is no more that I can do to keep the relationship going." ~ "0",
      e32 == "Decline to Answer" ~ "-77",
      TRUE ~ e32
    )
  )

```

### DAS Missing Data
There are missing data in DAS and missing rule applied through the unique "COUNT" code below. 
```{r dyadc_missing}
dyadc <- dyadc %>%
  # if answered no for screening question, the entire survey is skipped.
  mutate_at(vars(e1:e32), ~case_when(dyadc_screener == 0  ~ "-55", TRUE ~ . )) %>%
    # Incarcerated TC weren't administered for this survey
  mutate_at(vars(dyadc_screener, e1:e32), ~ ifelse(id %in% c("HR211", "HR181", "P819"), "-55", .)) 

dyadc %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = c('id', 'dyadc_screener'),
    n_items = 32
  ) %>%
  gt::gt() %>% 
  gt::tab_header(
    title = 'DYADC Missing Data',
    subtitle = 'By Participant'
  )
```

### DAS Calculations & Subscale
```{r dyadc_calculations}
# recode to das prefix

dyadc_calc <- dyadc %>%
  rename_with(~sub("^e", "das", .), starts_with("e"))


## create variables to check for missing data thresholds to be used in subscale creation
## these will not be archived, only used for creation of other data

dyadc_calc <- dyadc_calc %>%
  mutate(
    COUNTA = ifelse(dyadc_screener == 1, 
                    rowSums(as.matrix(dyadc_calc[, c("das1", "das2", "das3", "das5", "das7", "das8", "das9", "das10", "das11", "das12", "das13", "das14", "das15")]) == -77),
                    NA),
    COUNTB = ifelse(dyadc_screener == 1, 
                    rowSums(as.matrix(dyadc_calc[, c("das4", "das6", "das29", "das30")]) == -77),
                    NA),
    COUNTB1 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, c("das29", "das30")]) == -77),
                     NA),
    COUNTB5 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, c("das4", "das6")]) == -77),
                     NA),
    COUNTC = ifelse(dyadc_screener == 1, 
                    rowSums(as.matrix(dyadc_calc[, c("das16", "das17", "das18", "das19", "das20", "das21", "das22", "das23", "das31", "das32")]) == -77),
                    NA),
    COUNTC4 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, "das23"]) == -77),
                     NA),
    COUNTC5 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, c("das16", "das17", "das18", "das19", "das20", "das21", "das22", "das32")]) == -77),
                     NA),
    COUNTC6 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, "das31"]) == -77),
                     NA),
    COUNTD = ifelse(dyadc_screener == 1, 
                    rowSums(as.matrix(dyadc_calc[, c("das24", "das25", "das26", "das27", "das28")]) == -77),
                    NA),
    COUNTD4 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, "das24"]) == -77),
                     NA),
    COUNTD5 = ifelse(dyadc_screener == 1, 
                     rowSums(as.matrix(dyadc_calc[, c("das25", "das26", "das27", "das28")]) == -77),
                     NA)
  )


## creating subscales here 

## Total = all 32 items

## Dyadic Consensus - 1, 2, 3, 5, 7, 8, 9, 10, 11, 12, 13, 14, 15 (65 points possible)

## Affectional Expression - 4, 6, 29, 30 (12 points possible)

## Dyadic Satisfaction - 16, 17, 18, 19, 20, 21, 22, 23, 31, 32 (50 points possible)

## Dyadic Cohesion - 24, 25, 26, 27, 28 (24 points possible) 

dyadc_complete <- dyadc_calc %>%
  rowwise() %>%
 mutate_at(vars(dyadc_screener :COUNTD5), as.numeric) %>%
    mutate(
    das1 = replace(das1, das1 %in% c(-55, -77), NA_real_),
    das2 = replace(das2, das2 %in% c(-55, -77), NA_real_),
    das3 = replace(das3, das3 %in% c(-55, -77), NA_real_),
    das4 = replace(das4, das4 %in% c(-55, -77), NA_real_),
    das5 = replace(das5, das5 %in% c(-55, -77), NA_real_),
    das6 = replace(das6, das6 %in% c(-55, -77), NA_real_),
    das7 = replace(das7, das7 %in% c(-55, -77), NA_real_),
    das8 = replace(das8, das8 %in% c(-55, -77), NA_real_),
    das9 = replace(das9, das9 %in% c(-55, -77), NA_real_),
    das10 = replace(das10, das10 %in% c(-55, -77), NA_real_),
    das11 = replace(das11, das11 %in% c(-55, -77), NA_real_),
    das12 = replace(das12, das12 %in% c(-55, -77), NA_real_),
    das13 = replace(das13, das13 %in% c(-55, -77), NA_real_),
    das14 = replace(das14, das14 %in% c(-55, -77), NA_real_),
    das15 = replace(das15, das15 %in% c(-55, -77), NA_real_),
    das16 = replace(das16, das16 %in% c(-55, -77), NA_real_),
    das17 = replace(das17, das17 %in% c(-55, -77), NA_real_),
    das18 = replace(das18, das18 %in% c(-55, -77), NA_real_),
    das19 = replace(das19, das19 %in% c(-55, -77), NA_real_),
    das20 = replace(das20, das20 %in% c(-55, -77), NA_real_),
    das21 = replace(das21, das21 %in% c(-55, -77), NA_real_),
    das22 = replace(das22, das22 %in% c(-55, -77), NA_real_),
    das23 = replace(das23, das23 %in% c(-55, -77), NA_real_),
    das24 = replace(das24, das24 %in% c(-55, -77), NA_real_),
    das25 = replace(das25, das25 %in% c(-55, -77), NA_real_),
    das26 = replace(das26, das26 %in% c(-55, -77), NA_real_),
    das27 = replace(das27, das27 %in% c(-55, -77), NA_real_),
    das28 = replace(das28, das28 %in% c(-55, -77), NA_real_),
    das29 = replace(das29, das29 %in% c(-55, -77), NA_real_),
    das30 = replace(das30, das30 %in% c(-55, -77), NA_real_),
    das31 = replace(das31, das31 %in% c(-55, -77), NA_real_),
    das32 = replace(das32, das32 %in% c(-55, -77), NA_real_)
  ) %>%
  mutate(
    dyadc_con = das1+ das2+ das3+ das5+ das7+ das8+ das10+ das11+ das12+ das13+ das14+ das15,
    dyadc_aff_exp = case_when(
      COUNTB == 0 ~ das4 + das6 + das29 + das30,
      COUNTB == 1 & COUNTB1 == 1 ~ (das4 + das6 + das29 + das30) / 11 * 12,
      COUNTB == 1 & COUNTB5 == 1 ~ (das4 + das6 + das29 + das30) / 7 * 12,
      TRUE ~ NA_real_  # Add a default condition, return NA if none of the conditions are met
    ),
    dyadc_satis = case_when(
      COUNTC == 0 ~ das16 + das17 + das18 + das19 + das20 + das21 + das22 + das23 + das31 + das32,
      COUNTC == 1 & COUNTC4 == 1 ~ (das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 46 * 50,
      COUNTC == 1 & COUNTC5 == 1 ~(das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 45 * 50,
      COUNTC == 1 & COUNTC6 == 1 ~ (das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 44 * 50,
      COUNTC == 2 & COUNTC4 == 1 & COUNTC5 == 1 ~ (das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 41 * 50,
      COUNTC == 2 & COUNTC5 == 2 ~(das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 40 * 50,
      COUNTC == 2 & COUNTC5 == 1 & COUNTC6 == 1 ~ (das16+ das17+ das18+ das19+ das20+ das21+ das22+ das23+ das31+ das32) / 39 * 50,
      TRUE ~ NA_real_
    ),
    dyadc_cohes = case_when(
      COUNTD == 0 ~ das24 + das25+  das26 + das27 + das28,
      COUNTD == 1 & COUNTD4 == 1 ~ (das24 + das25+  das26 + das27 + das28) /20 * 24,
      COUNTD == 1 & COUNTD5 == 1 ~ (das24 + das25+  das26 + das27 + das28) /19 * 24,
      TRUE ~ NA_real_
    ),
  ) %>%
  mutate(dyadc_con = round(dyadc_con * 100)/100, 
         dyadc_aff_exp = round(dyadc_aff_exp * 100) / 100,
         dyadc_satis = round(dyadc_satis * 100) / 100,
         dyadc_cohes = round(dyadc_cohes * 100) / 100,
         dyadc_total = dyadc_con + dyadc_aff_exp + dyadc_satis + dyadc_cohes) %>%
  select(-starts_with("COUNT")) %>% # dropping count variables
  # add appropriate missing values back in
  # if answered no for screening question, the entire survey is skipped.
  # Incarcerated TC weren't administered for this survey
   mutate(dyadc_screener = ifelse(id %in% c("HR211", "HR181", "P819"), "-55", as.character(dyadc_screener)),
         across(starts_with("das"), ~case_when(dyadc_screener == 0 ~ "-55", TRUE ~ as.character(.))),
         dyadc_con = ifelse(is.na(dyadc_con), -99, dyadc_con),
         dyadc_aff_exp = ifelse(is.na(dyadc_aff_exp), -99, dyadc_aff_exp),
         dyadc_satis = ifelse(is.na(dyadc_satis), -99, dyadc_satis),
         dyadc_cohes = ifelse(is.na(dyadc_cohes), -99, dyadc_cohes),
         dyadc_total = ifelse(is.na(dyadc_total), -99, dyadc_total),
        across(where(is.character), ~replace(., is.na(.) | . == "", -77))) %>%
   mutate_at(vars(-id), as.numeric)


# DAS compute variable that will include in the archive 
dyadc_complete <- dyadc_complete %>%
  select(id, dyadc_con, dyadc_aff_exp, dyadc_satis, dyadc_cohes, dyadc_total)  

# DAS finalized data 
dyadc_complete <- dyadc %>%
  select(id, starts_with("e")) %>%
  rename_with(~sub("^e", "das", .), starts_with("e"))%>%
  merge(dyadc_complete, by = "id")
```

## ARQ
### ARQ Select Variables and Recode
```{r arq}
# Select ARQ questions and recode
arq <- tpw_raw %>%
  select(id, rq1:rqd) %>%
  mutate(
    across(
      .cols = -c(id, rq1),
      .fns = ~case_when(
        .x == "1- Disagree Strongly" ~ 1,
        .x == 2 ~ 2,
        .x == 3 ~ 3,
        .x == "4- Neutral/Mixed" ~ 4,
        .x == 5 ~ 5,
        .x == 6 ~ 6,
        .x == "7- Agree Strongly" ~ 7,
        .x == "Decline to Answer" ~ -77,
        TRUE ~ NA_real_
      )
    ),
    rq1 = case_when(
      rq1 == "A" ~ "Secure",
      rq1 == "B" ~ "Disorganized/Fearful",
      rq1 == "C" ~ "Ambivalent/Anxious-Preoccupied",
      rq1 == "D" ~ "Avoidant-Dismissive",
      TRUE ~ rq1  # Keep other values unchanged
    ),
    rq1 = factor(rq1, levels = c("Secure", "Disorganized/Fearful", "Ambivalent/Anxious-Preoccupied", "Avoidant-Dismissive"))
  )

  
```

### ARQ Missing Data 
There are missing data in ARQ and missing rule applied.
```{r arq_missing}
arq %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = c("id","rq1"), # does not include rq1, no missing data 
    n_items = 5
  )%>%
  gt::gt() %>%
  gt::tab_header(
    title = "ARQ Missing Data",
    subtitle = "By Participant"
  )
```

### ARQ Calculation & Subscale
```{r arq_calculations}
# Below is the code that treats -77, -55 values as NA

arq_calc <- arq %>%
  pct_miss_fun(
    id = c("id","rq1"),  
    n_items = 4
  )%>%
  full_join(arq, by = "id") %>%
  filter(
    is.na(miss_pct) |
      miss_pct < 20
  )%>%
  mutate(
    across(
    .cols = c(rqa:rqd),
    .fns = ~ case_when(
      .x < 0 ~ NA_real_,
      TRUE ~ .x
    )
    
    )
  )


# compute subscales
arq_complete <- arq_calc %>%
  select(
    -missing_n,
    -miss_pct
  ) %>%
  rowwise() %>%
  mutate(
    arq_group = ifelse(all(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)), "-55",
      case_when(
        rqa == max(rqa, rqb, rqc, rqd) & sum(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)) == 1 ~ "Secure",
        rqb == max(rqa, rqb, rqc, rqd) & sum(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)) == 1 ~ "Disorganized/Fearful",
        rqc == max(rqa, rqb, rqc, rqd) & sum(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)) == 1 ~ "Ambivalent/Anxious-Preoccupied",
        rqd == max(rqa, rqb, rqc, rqd) & sum(c(rqa, rqb, rqc, rqd) == max(rqa, rqb, rqc, rqd)) == 1 ~ "Avoidant-Dismissive",
        TRUE ~ NA_character_
      )
    )
  ) %>%
  mutate(
      arq_group = factor(replace_na(arq_group, "-99"), levels = c("-99", "Secure", "Disorganized/Fearful", "Ambivalent/Anxious-Preoccupied", "Avoidant-Dismissive")),
    arq_model_self_attach_anxiety = (rqa + rqd) - (rqc + rqb),
    arq_model_other_attach_avoid = (rqa + rqc) - (rqd + rqb)
  ) 

# -99 when there is a tie, because missing due to not being able to determine a top score for arq_group
# more positive scores indicate more positive models, and more negative scores indicate more negative models
```


## PRSS
### PRSS Select Variables and Recode
```{r prss}
prss <- tpw_raw %>%
  select(
    id,
    ps9:ps13
  ) %>%
  mutate(
    across(
      .cols = -c(id),
      .fns = ~case_when(
        .x == "None of the time" ~ 0,
        .x == "A little of the time" ~ 1,
        .x == "Some of the time" ~ 2,
        .x == "Much of the time" ~ 3,
        .x == "Most of the time" ~ 4,
        .x == "Decline to Answer" ~ -77
      )
    )
    )
```

### PRSS Missing Data 
There are missing data in PRSS and missing rule applied.
```{r prss_missing}
prss <- prss %>%
  # we have missing due to partial finish
  mutate(across(-id, ~ifelse(id == "HR173", -99, .)))
  

prss_miss <- prss %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 5
  )

prss_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'PRSS Missing Data',
    subtitle = 'By Participant'
  )
```

### PRSS Calculation & Subscales 
```{r prss_calculation}
# apply missing rule
prss_calc <- prss %>%
  pct_miss_fun(
    id = c("id"), 
    n_items = 5
  )%>%
  full_join(prss, by = "id") %>%
  filter(
    is.na(miss_pct) |
      miss_pct < 33
  )%>%
  mutate(
    across(
    .cols = c(ps9:ps13),
    .fns = ~ case_when(
      .x < 0 ~ NA_real_,
      TRUE ~ .x
    )
    
    )
  )



prss_complete <-
  prss_calc %>%
  composite_total_avg_fun(
    id = 'id',
    max_value = 5,
    n_items = 5
  ) %>%
  distinct(
    across(
      .cols = everything()
    )
  ) %>%
  rename(
    prss_total = sum_values,
    prss_avg = mean_values
  ) %>%
  mutate(
    across(
      c(
        prss_total,
        prss_avg
      )
    )
  ) %>%
  select(-miss_pct, - missing_n)
```
##SSQ
### SSQ Select Variables and Recode
```{r ssq}
ssq <- tpw_raw %>%
  select(
  id,
  ps1:ps8
) %>%
  mutate(across(-id, as.factor)) %>%
  mutate(
    across(
      .cols = c(ps1:ps8),
      .fns = ~case_when(
        .x == "None of the time" ~ 0,
        .x == "A little of the time" ~ 1,
        .x == "Some of the time" ~ 2,
        .x == "Much of the time" ~ 3,
        .x == "Most of the time" ~ 4,
        .x == "Decline to Answer"~ -77,
        TRUE ~ NA_real_
      )
    )
  ) 
```

### SSQ Missing Data
Missing Rule applied. 
```{r ssq_missing}
ssq <- ssq %>%
  # missing due to partial finished.
  mutate(across(-id, ~ifelse(id == "HR173", -99, .)))



ssq_miss <- ssq %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 8
  )

ssq_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = "SSQ Missing Data",
    subtitle = "By Participant"
  )

ssq_remove <- ssq_miss %>% filter(miss_pct > 30) %>% pull(id)
```

### SSQ Calculation & Subscale
```{r ssq_calculation}
ssq_calc <-
  ssq %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

ssq_complete <-
  ssq_calc %>%
  subscale_create(
    total_only = TRUE,
    scale1 = c("ps1", "ps2", "ps3", "ps4"),
    scale1_nitems = 4,
    scale2 = c("ps1", "ps2", "ps3", "ps4",
               "ps5", "ps6", "ps7", "ps8"),
    scale2_nitems = 8
  ) %>%
  rename(
    ssq_abuse_shame = total1,
    ssq_total = total2
  ) %>%
  mutate(
    across(
      -c(id
      ),
      ~case_when(
        id %in% ssq_remove ~ NA_real_,
        TRUE ~ .x
      )
    ),
    ssq_total_cutoff = case_when(
      ssq_total >= 16 ~ "high shame",
      ssq_total <= 15 ~ "low shame"
    )
  )
```

## EDS-F (Friend)
### EDS-F Select Variables and Recode

```{r eds df, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
# TODO: Min remove after maria confirm how to score
# reverse scoring
eds <-
  tpw_raw %>%
  select(
    id,
    matches(
      "^elf"
    )
  )
# composite_total_avg_fun(
#   id = c(
#     'id', "elf1_c", "elf2_c", "elf3_c", "elf7_c",
#     "elf12_c", "elf13_c", "elf15_c", "elf17_c", "elf18_c",
#     "elf19_c", "elf23_c", "elf26_c", "elf28_c", "elf30_c",
#     "elf34_c", "elf35_c", "elf36_c", "elf37_c"
#   ),
#   max_value = 4,
#   n_items = 21
# ) %>%
# distinct(
#   across(
#     .cols = everything()
#   )
# ) %>%
# rename(
#   elf_total = sum_values,
#   elf_avg = mean_values)

```

```{r}
# TODO: Maria, the scoring doc on dropbox have different scoring system
elf <-
  tpw_raw %>%
  select(
    id,
    matches(
      "^elf"
    )
  ) %>%
  mutate(
    across(
      -c(id, elf23),
      ~case_when(
        .x == "All" ~ "4",
        .x == "Most" ~ "3",
        .x == "Some" ~ "2",
        .x == "Very Few" ~ "1",
        .x == "None" ~ "0",
        .x == "Does not apply" ~ "-55",   #TODO: Min, this should be -55 it is the same as NA.I've updated but you need to update missing data section  
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    elf23 = case_when(
      elf23 == "Only threatened to hit" ~ "1",
      elf23 == "Tried but didn't succeed" ~ "2",
      elf23 == "Actually hit" ~ "3",
      elf23 == "Decline to Answer" ~"-77",
      TRUE ~ elf23
    )
  )
```

### EDS-F Missing Data 
```{r eds-f_missing}
elf <- elf %>%
  # partially finished TC who did not complete this questionnaire
  mutate(across(-id, ~ifelse(id == "HR173", -99, .))) %>%
  mutate_at(vars(elf23), ~case_when(elf20 < 1 & elf21 < 1 & elf22 < 1 ~ "-55", TRUE ~.))
  
elf_miss <- elf %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 39
  )

elf_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = "EDS Missing Data",
    subtitle = "By Participant"
  )

elf_remove <- elf_miss %>% filter(miss_pct >= 20) %>% pull(id)
```


### EDS-F Calculation & Subscale
```{r eds-f_calculation}

## Min can you remove any computation of scales for the EDS-F measure?
## Please save this in a separate file for our internal work
## there should be no distributions in the codebook then; no alpha either; you can remove these notes once you clean it up
elf_calc <-
  elf %>%
  mutate(
    across(
      .cols = -c(
        id
      ),
      .fns = ~case_when(
        .x < 0 ~ NA,
        TRUE ~ .x
      )
    )
  ) %>%
  mutate(across(-id, as.numeric))
  
elf_complete <-
  elf_calc %>%
  composite_total_avg_fun(
    id = c('id', "elf1", "elf2", "elf3", "elf7",
      "elf12", "elf13", "elf15", "elf17", "elf18",
      "elf19", "elf23", "elf26", "elf28", "elf30",
      "elf34", "elf35", "elf36", "elf37"), 
    max_value = 4,
    n_items = 21
  ) %>%
  distinct(
    across(
      .cols = everything()
    )
  ) %>%
  rename(
    elf_total = sum_values,
    elf_avg = mean_values #TODO: Maria do we need average for this measure 
  ) %>%
  mutate(
    mutate(
      across(
        -c(id
        ),
        ~case_when(
          id %in% elf_remove ~ NA_real_,
          TRUE ~ .x
        )
      )
    )
  ) %>%
  relocate(elf1:elf3, .before = "elf4") %>%
  relocate(elf7, .before = "elf8") %>%
  relocate(elf12:elf13, .before = "elf14") %>%
  relocate(elf15, .before = "elf16") %>%
  relocate(elf17:elf19, .before = "elf20") %>%
  relocate(elf23, .before = "elf24") %>%
  relocate(elf26, .before = "elf27") %>%
  relocate(elf28, .before = "elf29") %>%
  relocate(elf30, .before = "elf31") %>%
  relocate(elf34:elf37, .before = "elf38")

```

## ELL (Self-Report)
### ELL Select Variables and Recode
```{r ell}
ell <-
  tpw_raw %>%
  select(
    id, ell1:ell39a
  )  %>%
  rename(
    ell35a  = x35a
  )  %>% 
  mutate(
    across(
      matches("a$"),
      ~case_when(
        .x == "Once a month" ~ "1",  #4
        .x == "Once every 2-3 weeks" ~ "2",  #
        .x == "Once a week" ~ "3",
        .x == "2-3 times a week" ~ "4",
        .x == "Once a day" ~ "5",
        .x == "2-3 times a day" ~ "6",   
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    ell23 = case_when(
      ell23 == "Actually hit" ~ "3",
      ell23 == "Tried but didn't succeed" ~"2",
      ell23 == "Only threatened to hit" ~ "1",
      ell23 == "Decline to Answer" ~ "-77",
      TRUE ~ ell23
    )
    ) %>%
  mutate(across(-id, as.numeric))



```

### ELL Missing Data 
```{r ell_missing}
ell <- ell %>%
  # partial finished TC
  mutate(across(-id, ~ifelse(id == "HR173", -99, .))) %>%
   # Incarcerated TC weren't administered for this survey
  mutate_at(vars(ell1:ell39a), ~ ifelse(id %in% c("HR211", "HR181", "P819"), -55, .)) %>%
  # if ell20, ell21, ell22 are all less than 0 then then ell23 wasn't shown
  mutate(ell23 = case_when(ell20 <= 0 & ell21 <=0 & ell22 <=0 ~ -55, TRUE ~ ell23)) 
  

  # if ellX is below 10, then ellXa should be -55 (will need remove ell23a, because we don't have that question)
for (i in 1:39) {
    ell_col <- paste0("ell", i)
    ella_col <- paste0("ell", i, "a")
    
    # Check if the "ellX" column is between 0 and 10 (excluding 10)
    ell_col_values <- ell[[ell_col]]
    set_to_55 <- ell_col_values >= 0 & ell_col_values < 10
    
    # Check if the "ellX" column is -77
    set_to_77 <- ell_col_values == -77
    
    # Set the "ellXa" column to -55 or -77 
    ell[[ella_col]][set_to_55] <- -55
    ell[[ella_col]][set_to_77] <- -77
}



# ELL Count Missing Data
# most participants will respond to the first part of each item
# don't respond to anything on the scale
# TODO: Maria: we are only counting the ellx questions. (ellxa qusetions are not included.)
## Min, I do want to retain the other questions, but we aren't using them for any ssubscale or total scale computation right now.
ell_miss <- ell %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = c("id", matches("a$")),
    n_items = 39
  )


ell_miss %>%
  gt::gt() %>%
  gt::tab_header(title = 'Missing Data',
                 subtitle = 'By Each Participant')

ell_count_remove <- ell_miss %>% filter(miss_pct >= 20) %>% pull(id)
```

### ELL Calculation & Subscale 

```{r ell_calculation}
## Min for this variable I want us to save the censorsed data only for internal uses so you can pull that script. 
## next I want you to sum for the following items, removing item #23 from these scales
# total score of all items (38 items in total but not #23)
# total index offenses (9 items el 4 el 5; ell10 ; ell 16; ell 25; ell 29; ell 32; ell 38; ell 39)
# total index of minor offenses (29 items but not 23; 1, 2, 3, 6, 7, 8, 9, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 24, 26, 27, 28, 30, 31, 33, 34, 35, 36, 37) 


# '{.col}_c' delinquency behavior coded count (if delinquecy reported then coded as 1)
# "{.col}_r" re-code with cap at 7
ell <- ell %>%
  # TODO: Maria, this section need special attention
#  select(-ell23a) %>%
  mutate(
    # Create ell count columns 
    across(
      .cols = matches("\\d$"),
      .fns = ~case_when(
        .x == 0 ~ 0,
        .x > 0 ~ 1, # everyone reported delinquency behavior coded as 1
        TRUE ~ .x
      ),
      .names = '{.col}_c'
      ),
# TODO :Maria:JP also covert number larger than 4 to 4 in this code, but the SPSS Syntax cap at 7 which is what I used below. If this is correct, please delete this comment. 
    across(
      .cols = matches("\\d$"),   # TODO: Maria, JP used column end with a to create this recoded column, but based on spss I think it should be column without a, this is what I used for this code. Please confirm this is correct. 
      .names = "{.col}_r"
    ),
    across(
      c(
        matches("_r$")
      ),
      ~case_when(
        .x >= 7 ~ 7, # cap at 7
        TRUE ~ .x
      )
    )
  )


ell_calc <-
  ell %>%
  mutate(
    across(
      .cols = -c(
        id
      ),
      .fns = ~case_when(
        .x < 0 ~ NA,
        TRUE ~ .x
      )
    )
  )

# TODO: Min, you can remove code pertaining the the physical aggression; you can also save the other code in our internal file with a note that the general delinquency needs to be z scored to deal with different reporting waves across the study (12 vs 6 month recall) before using in conjunction with other waves
ell_complete <-
  ell_calc %>%
  subscale_create(
    total_only = TRUE,
    scale1 = c(
      "ell4a", "ell5a", "ell6a", "ell8a", "ell9a",
      "ell10a", "ell11a", "ell14a", "ell16a", "ell20a",
      "ell21a", "ell22a", "ell24a", "ell25a", "ell27a", "ell29a",
      "ell31a", "ell32a", "ell33a", "ell38a", "ell39a"
    ),
    scale2 = c(
      "ell4_r", "ell5_r",
       "ell6_r", "ell8_r", "ell9_r",
       "ell10_r", "ell11_r", "ell14_r", "ell16_r", "ell20_r",
       "ell21_r", "ell22_r", "ell24_r", "ell25_r", "ell27_r", "ell29_r",
       "ell31_r", "ell32_r", "ell33_r", "ell38_r", "ell39_r"
    )
  ) %>%
  rename(
    ell_raw_total = total1,
    ell_censor_total = total2
  )


ell_count_complete <-
  ell_complete %>%
  composite_total_avg_fun(
    id = c(
      'id', "ell1", "ell2", "ell3", "ell7",
      "ell12", "ell13", "ell15", "ell17", "ell18",
      "ell19", "ell23", "ell26", "ell28", "ell30",
      "ell34", "ell35", "ell36", "ell37"
    ),
    max_value = 1,
    n_items = 21
  ) %>%
  distinct(
    across(
      .cols = everything()
    )
  ) %>%
  rename(
    ell_count_total = sum_values,
    ell_count_avg = mean_values
  ) %>%
  mutate(
    across(
      -c(id
      ),
      ~case_when(
        id %in% ell_count_remove ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

ell_count_complete <- ell_count_complete%>%
  select(
    order(names(.))
  ) %>%
  relocate(ell1a:ell2_r, .after = "ell1_r") %>%
  relocate(ell3a:ell7_r, .after = "ell3_r") %>%
  relocate(ell7a:ell9a, .after = "ell7_r") %>%
  relocate(id, .before = "ell1") %>% 
  relocate(ell_censor_total:ell_raw_total, .after = "ell39a")
```

## MHC-SF
### MHC-SF Select Variables and Recode
```{r mhc-sf}
mhc <-
  tpw_raw %>%
  select(
    id,
    matches(
      "^h"
    )
  ) %>%
  mutate(across(-id)) %>%
  mutate(
    across(
      .cols = c(h1:h14),
      .fns = ~case_when(
        .x == "Never" ~ "0",
        .x == "Once or Twice" ~ "1",
        .x == "About Once A week" ~ "2",
        .x == "About 2 or 3 Times a Week" ~ "3",
        .x == "Almost Every Day" ~ "4",
        .x == "Every Day" ~ "5",
        .x == "Decline to Answer"~ "-77",
        TRUE ~ .x
      )
    )
  ) 

```

### MHC-SF Missing Data
There are missing data. The missing data rule applies for two participants for the swb subscale. 
## MIN #TODO the missing data rule is > 33% for scales of 3-6 (scale 2)
```{r mhc-sf_missing}
mhc_miss <- mhc %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 14
  )

mhc_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'Missing Data',
    subtitle = 'By Each Participant'
  )


mhc_remove <- mhc_miss %>% filter(miss_pct >= 14) %>% pull(id)
```

### MHC-SF Calculation & Subscale
```{r mhc-sf_calc}
mhc_calc <-
  mhc %>%
  mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x == -77 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

## MIN we can drop averages -- we only need sum scores
# can we just keep the final three columns for diagnosis -- those in character format?
mhc_complete <-
  mhc_calc %>%
  composite_total_avg_fun(
    id = 'id',
    max_value = 5,
    n_items = 14
  ) %>%
  distinct(
    across(
      .cols = everything()
    )
  ) %>%
  subscale_create(
    total_only = FALSE,
    scale1 = c("h1", "h2", "h3"),
    scale1_nitems = 3,
    scale2 = c("h4", "h5", "h6", "h7", "h8"),
    scale2_nitems = 5,
    scale3 = c("h9", "h10", "h11", "h12", "h13", "h14"),
    scale3_nitems = 6
  ) %>%
  rename(
    mhc_total = sum_values,
    mhc_avg = mean_values,
    mhc_pa = total1,
    mhc_pa_avg = avg1,
    mhc_swb = total2,
    mhc_swb_avg = avg2,
    mhc_pwb = total3,
    mhc_pwb_avg = avg3
  ) %>%
  mutate(
    across(
      c(
        mhc_total,
        mhc_avg,
        mhc_pa,
        mhc_pa_avg,
        mhc_swb,
        mhc_swb_avg,
        mhc_pwb,
        mhc_pwb_avg
      ),
      ~case_when(
       # MIN apply to only scale 2
       id %in% mhc_remove ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# TODO: Maria, this changes some value to NA, pleae confirm this is how you want them to be 
## MIN, is there a way to mutate and create new variables that are converted; I want to retain all originla values
## MIN # TODO: I also want to have these have a prefix "mhc" instead of "h"
## let's chat about this tomorrow; I think I want to remove all diagnoses from the codebook but let's retain this code elsewhere for our "internal purposes"
## MARIA to do -- add note about diagnoses in codebook
mhc_complete <- mhc_complete %>%
  pivot_longer(
    h4:h14,
    names_to = "pre_flourish",
    values_to = "flourish_feel"
  ) %>%
  mutate(
    flourish = case_when(
      flourish_feel %in% c(4, 5) ~ 1,
      !flourish_feel %in% c(4, 5) ~ 0,
      TRUE ~ 0
    ),
    languish = case_when(
      flourish_feel %in% c(0, 1) ~ 1,
      !flourish_feel %in% c(0, 1) ~ 0,
      TRUE ~ 0
    )
  ) %>%
  group_by(id) %>%
  mutate(
    six_or_over = sum(flourish, na.rm = TRUE),
    neg_six_or_more = sum(languish, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(
    flourish_diagnosis = case_when(
      (h1 %in% c(4, 5) & six_or_over >= 6) |
        (h2 %in% c(4, 5) & six_or_over >= 6) |
        (h3 %in% c(4, 5) & six_or_over >= 6)
      ~ "flourish",
      TRUE ~ "not_flourish"
    ),
    languish_diagnosis = case_when(
      (h1 %in% c(0, 1) & neg_six_or_more >= 6) |
        (h2 %in% c(0, 1) & neg_six_or_more >= 6) |
        (h3 %in% c(0, 1) & neg_six_or_more >= 6)
      ~ "languish",
      TRUE ~ "not_languish"
    )
  ) %>%
  pivot_wider(
    names_from = pre_flourish,
    values_from = flourish_feel
  ) %>%
  distinct(
    id,
    .keep_all = TRUE
  ) %>%
  mutate(
    final_diagnosis = case_when(
      (flourish_diagnosis == "flourish" &
         languish_diagnosis == "not_languish") ~ "flourish",
      (flourish_diagnosis == "not_flourish" &
         languish_diagnosis == "languish") ~ "languish",
      (flourish_diagnosis == "not_flourish" &
         languish_diagnosis == "not_languish") ~ "moderately mentally healthy"
    )
  ) %>%
  relocate(h4:h14, .after = "h3")
```

## Flourishing Index (FI)
### FI Select Variable and Recode 
```{r fi}
flo <- tpw_raw %>%
  select(
    id,
    i1:i12
  ) %>%
    mutate(
    across(
      .cols = c(i1:i12),
      .fns = ~case_when(
        .x == "0 - Not Satisfied at all" ~ "0",
        .x == "0 - Strongly Disagree" ~ "0",
        .x == "0 - Worry all of the time" ~ "0",
        .x == "0 - Poor" ~ "0",
        .x == "0 - Not at all worthwhile" ~ "0",
        .x == "0 - Not true of me" ~ "0",
        .x == "0 - Extremely Unhappy" ~ "0",
        .x == "1" ~ "1",
        .x == "2" ~ "2",
        .x == "3" ~ "3",
        .x == "4" ~ "4",
        .x == "5" ~ "5",
        .x == "6"~ "6",
        .x == "7"~ "7",
        .x == "8"~ "8",
        .x == "9"~ "9",
        .x == "10 - Completely Satisfied"~ "10", 
        .x == "10 - Extremely Happy"~ "10", 
        .x == "10 - Excellent"~ "10",
        .x == "10 - Completely Worthwhile" ~ "10",
        .x == "10 - Strongly Agree" ~ "10", 
        .x == "10 - Completely true of me" ~ "10", 
        .x == "10 - Do not ever worry" ~ "10", 
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    )
  ) 
```

### FI Missing Data 
There are missing data in FI and missing rule applied for one participant 
```{r}
flo <- flo %>%
  # We don't know why these variable were missing for this TC
  mutate_at(vars(i8, i10, i12), ~case_when(id %in% c("P847") & is.na(.) ~ "-99", TRUE ~ .)) 
  
flo_miss <- flo %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 12
  )

flo_miss %>%
  gt::gt() %>%
  gt::tab_header(title = 'Missing Data',
                 subtitle = 'By Each Participant')

flo_remove <- flo_miss %>% filter(miss_pct >= 25) %>% pull(id)
```

### FI Calculation & Subscale 
```{r}
flo_calc <-
  flo %>%
  mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# ibq_complete <-
#   ibq_calc %>%
#   mutate(ibq_total = rowSums(select(., ibq1:ibq7), na.rm = T)) %>%
#    mutate(
#     across(
#       -c(id
#       ),
#      ~case_when(
#        id %in% flo_remove ~ NA,
#          TRUE ~ .x
#        )
#     )
#   )

# MIN we also need a "secure flourish" and averae of items i11 and i12
# total score should only contain 1-10

flo_complete <-
  flo_calc %>%
  composite_total_avg_fun(
    id = 'id',
    max_value = 10,
    n_items = 10 # changed from 12 to 10
  ) %>%
  distinct(
    across(
      .cols = everything() # it should be across only i1:i10
    )
  ) %>%
  select(
    -sum_values
  ) %>%
  rename(flo_total = mean_values) %>% # Min I changed to average_values as it should be an average not sum Min's note mean_value solved. TODO: will need to checkin with Maria about the -99 below 
  # replacing total score with -99 because due to 25% missing data this score isn't valid (follows missing data rule)
  #mutate(flo_average = ifelse(id == "P847" & (flo_average == 78), -99, flo_average)) %>%
  # changing prefix to align "i" to "flo"
  rename(flo1 = i1,
         flo2 = i2,
         flo3 = i3,
         flo4 = i4,
         flo5 = i5,
         flo6 = i6,
         flo7 = i7,
         flo8 = i8,
         flo9 = i9,
         flo10 = i10,
         flo11 = i11,
         flo12 = i12) %>%
  # relocate id to front of dataframe
  select(id, everything())

flo_complete <- flo %>%
  merge(flo_complete, by = "id") %>%
  # Remove column that contains NA not actual NA code 
  select(-matches("flo\\d")) %>%
  # changing prefix to align "i" to "flo"
  rename_with(~str_replace(., "^i", "flo"), matches("^i\\d"))
  
  
  

```

##ITQ
### ITQ Select Vartiable and Recode 
```{r itq}
itq <- tpw_raw %>% 
  select(
    id,
    matches(
      "^itq"
    )
  )  %>%
    mutate(
    across(
      .cols = c(itq1:itq9),
      .fns = ~case_when(
        .x == "Not at all" ~ "0",
        .x == "A little bit" ~ "1",
        .x == "Moderately" ~ "2",
        .x == "Quite a bit" ~ "3",
        .x == "Extremely" ~ "4",
        .x == "Decline to Answer" ~ "-55",
        TRUE ~ .x
      )
    )
  ) 
```

### ITQ Missing Data 
There are missing data and missing rule applied. 
```{r itq_missing}
itq <- itq %>%
  # partial finished TC
  mutate(across(-id, ~ifelse(id == "HR173", -99, .))) 

itq_miss <- itq %>%
    mutate(across(-id, as.numeric)) %>%
  pct_miss_fun(
    id = "id",
    n_items = 9
  )

itq_miss %>%
  gt::gt() %>%
  gt::tab_header(title = 'Missing Data',
                 subtitle = 'By Each Participant')
#Maria check
itq_remove <- itq_miss %>% filter(miss_pct >= 20) %>% pull(id)
```

### ITQ Calculation & Subscale 
```{r itq_calc}
itq_calc <- itq %>% 
    mutate(across(-id, as.numeric)) %>%
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

itq_calc <- itq_calc %>%
  mutate(
    itq_re_dx = case_when(
      (itq1 >= 1 | itq2 >= 1) ~ "diagnosis_met",
      (itq1 < 1  & itq2 < 1) ~ "diagnosis_not_met",
      TRUE ~ "conditions_not_met"
    ),
    itq_av_dx = case_when(
      (itq3 >= 1 | itq4 >= 1)  ~ "diagnosis_met",
      (itq3 < 1 & itq4 < 1)  ~ "diagnosis_not_met",
      TRUE ~ "conditions_not_met"
    ),
    itq_th_dx = case_when(
      (itq5 >= 1 | itq6 >= 1) ~ "diagnosis_met",
      (itq5 < 1 & itq6 < 1) ~ "diagnosis_not_met",
      TRUE ~ "conditions_not_met"
    ),
    itq_fi_dx = case_when(
      (itq7 >= 1 | itq8 >= 1 | itq9 >= 1) ~ "diagnosis_met",
      (itq7 < 1 & itq8 < 1 & itq9 < 1) ~ "diagnosis_not_met",
      TRUE ~ "conditions_not_met"
    ),
    itq_pstd_dx = case_when(
      (itq_re_dx == "diagnosis_met" &
         itq_av_dx == "diagnosis_met" &
         itq_th_dx == "diagnosis_met" &
         itq_fi_dx == "diagnosis_met") ~ "diagnosis_met",
      TRUE ~ "diagnosis_not_met"
    )
  )

itq_complete <-
  itq_calc %>%
  subscale_create(
    total_only = TRUE,
    scale1 = c("itq1", "itq2"),
    scale2 = c("itq3", "itq4"),
    scale3 = c("itq5", "itq6")
  ) %>%
  rename(
    itq_re_total = total1,
    itq_av_total = total2,
    itq_th_total = total3
  ) %>%
  mutate(
    itq_ptsd_total = (itq_re_total + itq_av_total + itq_th_total),
    across(
      -c(id
      ),
     ~case_when(
       id %in% itq_remove ~ NA,
         TRUE ~ .x
       )
    )
  )
```


## IBQ
### IBQ Select Variables and Recode
```{r ibq}
ibq <-
  tpw_raw %>%
  select(
    id,
    matches(
      '^ibq'
    )
  ) %>%
  mutate(across(-id, as.factor),
      across(
         .cols = c(ibq1:ibq9),
        .fns = ~case_when(
         .x == "Yes" ~ "1",
         .x == "No" ~ "0",
         .x == "Decline to Answer" ~ "-77",
         TRUE ~ .x
        )
      ),
    across(
      .cols = c(ibq10_1:ibq10_9),
      .fns = ~if_else(!is.na(.x), "1", "0")), 
    ibq10_77 = case_when(
        ibq10_77 == "Decline to Answer" ~ "-77",
        TRUE ~ "0"
    )) %>%
  mutate(ibq10_9 = ifelse(tolower(ibq10_9_text) %in% c("none", "no institutions selected"), "0", ibq10_9)
) %>%
  mutate(ibq9 = ifelse(ibq9 %in% c("N/A"), "-55", ibq9)) %>% #TODO need confirm with Maria
  mutate(across(ibq10_1:ibq10_9, as.numeric))%>%
  mutate(ibq10 = rowSums(select(., ibq10_1:ibq10_9), na.rm = TRUE))%>% # ibq 10, how many they select
  mutate(ibq10 = as.character(ibq10))%>% 
  mutate_at(vars(ibq10), ~case_when(ibq10_77 <0  ~ ibq10_77, TRUE ~ . )) %>%
  rename(ibq10_school = ibq10_1) %>%
  rename(ibq10_juvenile_justice = ibq10_2) %>%
  rename(ibq10_Legal_System = ibq10_3) %>%
  rename(ibq10_Police = ibq10_4) %>%
  rename(ibq10_Medical = ibq10_5) %>%
  rename(ibq10_Church = ibq10_6) %>%
  rename(ibq10_Foster_Care = ibq10_7) %>%
  rename(ibq10_Child_Welfare = ibq10_8) %>%
  rename(ibq10_other = ibq10_9) %>%
  rename(ibq10_other_text = ibq10_9_text) %>%
  relocate(ibq10, .after = ibq9) %>%
  relocate(ibq10_other_text, .after = ibq10_other)

```

### IBQ Missing Data 
There are missing data, and missing rule applied. 
```{r ibq_missing }
# correct missing value: Not Applicable = -55 = The subject was never asked a question for some reason (conditional question)
ibq <- ibq %>%
  # partial finished TC
  mutate(across(-c(id,ibq10_other_text), ~ifelse(id == "HR173", "-99", .))) 

ibq_miss <- ibq %>%
  mutate(across(-c(id,ibq10_other_text), as.numeric))%>%
  pct_miss_fun(
    id = c("id", "ibq10_school", "ibq10_juvenile_justice", "ibq10_Legal_System", "ibq10_Police", "ibq10_Medical", "ibq10_Church", "ibq10_Foster_Care", "ibq10_Child_Welfare","ibq10_other","ibq10_other_text", "ibq10_77"),
    n_items = 10
  )

ibq_miss %>% 
  gt::gt() %>% 
  gt::tab_header(
    title = 'IBQ Missing Data',
    subtitle = 'By Participant')

ibq_remove <- ibq_miss %>% filter(miss_pct >= 20) %>% pull(id)
```

### IBQ Calculations & Subscale
```{r ibq_calculations}
# Below is the code that treats -77, -55 values as NA
ibq_calc <-
  ibq %>%
  mutate(across(-c(id,ibq10_other_text), as.numeric)) %>%
  mutate(
    across(
      .cols = -c(id,ibq10_other_text),
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# IBQ Composite & Subscale Score Creation 
ibq_complete <-
  ibq_calc %>%
  mutate(ibq_total = rowSums(select(., ibq1:ibq7), na.rm = T)) %>%
   mutate(
    across(
      -c(id
      ),
     ~case_when(
       id %in% ibq_remove ~ NA,
         TRUE ~ .x
       )
    )
  )
```

## Sex History Survey
### SEX Select Variables and Recode
```{r sex}
sex <- tpw_raw%>% 
  select(
    id,
    s_pregnancy_screen:s48
  )%>%
  mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        # s_pregnancy_screen
        # sex_current_engage ~ s3
        # sex_current_live ~ s4
        # sex_current_marry ~s6
        # sex_other_safesex ~ s13
        # sex_std ~ s22
        # sex_check_out ~ s23
        # sex_bloodtest_hiv ~ s26
        # sex_sex_relation_justmet ~ s35
        # sex_sex_relation_w_injects ~ s38
        # sex_intercourse_male_partner ~ s39
        # sex_intercourse_male_nocondom ~ s40
        # sex_intercourse_female_partner ~ s44
        # sex_oralsex_female_partner ~ s45
        .x == "Yes" ~"1",
        .x == "No" ~"0",
        
        # sex_might_be_preg ~ s28
        .x == "1. Yes" ~ "1",
        .x == "2. No" ~ "0",
        .x == "4. I became pregnant prior to this last 6 months and knew that I was pregnant prior to this 6 month period" ~ "2",
        
        # sex_current_date ~ s1
        .x =="1          Yes" ~ "1", # space needed
        .x =="2 No" ~ "0",
        
        #sex_part_gender_id ~ s1a
        .x == "Cisgender female or woman" ~ "1",
        .x == "Female/Woman" ~"3",
        .x == "Cisgender male or man" ~ "2",
        .x == "Male/Man" ~ "4",
        .x == "Trans female/woman" ~ "7",
        .x == "Trans male/man" ~ "8",
        .x == "Non-binary"~ "5",
        .x == "Prefer to self-identify" ~ "6", 
        
        # sex_pressure_stress ~s9
        .x == "a great deal" ~ "5",
        .x == "quite a lot" ~ "4",
        .x == "some" ~"3",
        .x == "not much" ~ "2",
        .x == "very little" ~ "1",
        
        #sex_id_feeling ~ s10
        .x == "1 - heterosexual (attracted to the opposite sex)" ~ "1",
        .x == "2 - gay or lesbian (attracted to the same sex)" ~ "2",
        .x == "3 - bi-sexual (attracted to both males and females)" ~ "3",
        .x == "4 - Other: Please describe" ~"4",
        
        # sex_talk_safesex ~ s11
        # sex_talk_safesex_other_person ~ s16
        .x == "1 - Never" ~ "0",
        .x == "1 - never" ~ "0",
        .x == "2 - Rarely" ~ "1",
        .x == "2 - rarely" ~ "1",
        .x == "3 - Sometimes" ~ "2",
        .x == "3 - sometimes" ~ "2",
        .x == "4 - Often" ~ "3",
        .x == "4 - often" ~ "3",
        .x == "5 - Very Often" ~ "4",
        .x == "5 - very often" ~ "4",

        # sex_talk_comfort ~ s12
        # sex_talk_comfort_other_person ~ s17
        # sex_birthcontrol_sex_with ~ s18
        # sex_safesex_sex_with ~ s19
         .x == "very comfortable" ~ "5",
         .x == "1 - very comfortable" ~ "5",
         .x == "somewhat comfortable" ~ "4",
         .x == "2 - somewhat comfortable" ~ "4",
         .x == "neutral" ~ "3",
         .x == "3 - neutral" ~ "3",
         .x == "somewhat uncomfortable" ~ "2",
         .x == "4 - somewhat uncomfortable" ~ "2",
         .x == "very uncomfortable" ~ "1",
         .x == "5 - very uncomfortable" ~ "1",
        
        # sex_other_person_safesex ~ s14
        .x == "1 - friend" ~ "2",
        .x == "2 - romantic partner" ~ "6",
        .x == "3 - sister or brother" ~ "7",
        .x == "4 - other relative" ~ "4",
        .x == "5 - counselor, teacher, doctor" ~ "1",
        .x == "6 - parent/parent figure" ~ "5",
        .x == "7 - other (please describe:)" ~ "3",

        # sex_confident_condom ~ s20
        .x == "1 - Very Confident" ~ "3",
        .x == "2 - Somewhat Confident" ~ "2",
        .x == "3 - A little Confident" ~ "1",
        .x == "4 - Not at all Confident" ~ "0",
        
        # sex_further_sexually ~ s21
        # sex_safesex_prev_std ~ s33
        # sex_alcohol_sex_relation ~ s36
        # sex_cannabis_drugs_sex_relation ~ s37
        .x == "1 - Always or almost always" ~ "4",
        .x == "1.\tAlways or almost always" ~ "4",
        .x == "2 - Often" ~ "3",
        .x == "2.\tOften" ~ "3",
        .x == "3.\tAbout half the time" ~ "2",
        .x == "3 - About half the time" ~ "2",
        .x == "4 - Occasionally" ~ "1",
        .x == "4.\tOccasionally" ~ "1",
        .x == "5 - Never or almost never" ~ "0",
        .x == "5.\tNever or almost never" ~ "0",

        
        # sex_std_happen ~ s24
        .x == "Yes, I had a Sexually Transmitted Disease -STD  (positive diagnosis)" ~ "1",
        .x == "I did not have an STD (negative diagnosis)" ~ "0",
        .x == "I don't know yet; still waiting for the results" ~ "2", 
        
        # s25
        .x == "a. Genital herpes" ~ "1",
        .x == "b. Genital warts" ~ "2",
        .x == "c. AIDS/HIV" ~ "3",
        .x == "d. Hepatitis B" ~ "4",
        .x == "e.   Gonorrhea (clap)" ~ "5",
        .x == "f.    Syphilis" ~ "6",
        .x == "g.   Chlamydia" ~ "7",
        .x == "h.   Other: Specify" ~ "8",
        .x == "i. Don't Remember" ~ "9",
        
        # sex_preg_what_happen ~ s29
        .x == "1 - Went to doctor, Positive diagnosis" ~ "1",
        .x == "2 - Went to doctor, Negative diagnosis" ~ "2",
        .x == "3 - Went to doctor, Don't know" ~ "3",
        .x == "4 - Took a home test, positive" ~ "4",
        .x == "5 - Took a home test, negative" ~ "5",
        .x == "6 - Took a home test, don't know" ~ "6",
        .x == "7 - Did nothing, negative (period started)" ~ "7",
        .x == "8 - Did nothing, don't know" ~ "8",
        
        # s32
        .x == "1.\tMale, same age or younger" ~ "1",
        .x == "2.\tMale, 1-2 years older" ~ "2",
        .x == "3.\tMale, more than 2 years older" ~ "3",
        .x == "4.\tFemale, same age or younger" ~ "4",
        .x == "5.\tFemale, 1-2 years older" ~ "5",
        .x == "6. Female, more than 2 years older" ~ "6",
        .x == "7. Non-binary and/or Other Gender, same age or younger" ~ "7",
        .x == "8. 7. Non-binary and/or Other Gender, 1-2 years older" ~ "8",
        .x == "9. 7. Non-binary and/or Other Gender, more than 2 years older" ~ "9",
        .x == "" ~ "10",
        # sex_percent_sex_relation_safesex_prev_std ~ s34
        .x == "1  \tNever               \t0%" ~ "0",
        .x == "2  \tRarely             \t1 - 15%" ~ "1",
        .x == "3  \tOccasionally    \t15 - 40%" ~ "2",
        .x == "4  \tAbout half the time\t40 - 60%" ~ "3",
        .x == "5  \tUsually             \t60 - 85%" ~ "4",
        .x == "6  \tMost of the time   \t85 -99%" ~ "5",
        .x == "7  \tEvery single time  \t100%" ~ "6",
        # sex_percent_w_male_use_birthcontrol ~ s43
        .x == "Don't know" ~ "-66",
        .x == "10       Not using birth control because I am currently pregnant" ~ "7",
        # sex_oralsex_dentaldam_female_partner ~ s46
        .x == "Yes, had oral sex without a dental dam" ~ "1",
        .x == "No, oral sex and always used dental dam (stop here, you are finished)" ~ "0",
        
        .x == "Decline to Answer" ~ "-77",
        .x == "decline to answer" ~ "-77",
        .x == "Decline to answer" ~ "-77",
        .x == "6 - Decline to Answer" ~ "-77",
        .x == "6 - decline to answer" ~ "-77",
        .x == "6 - Decline to answer" ~ "-77",
        .x == "5 - decline to answer" ~ "-77",
        .x == "5 - Decline to answer" ~ "-77",
        .x == "3. Decline to answer" ~ "-77",
        .x == "9 - Decline to answer" ~ "-77",
        .x == "10. Decline to answer" ~ "-77",
         
        TRUE ~ .x
      )
    )
  )


# Combine sex25 answer options to sex25 but retain these variables to make dichotomous
sex$s25 <- apply(sex[, c("s25_1","s25_2","s25_3","s25_4","s25_5","s25_6","s25_7","s25_8","s25_9","s25_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sex32 answer options to sex32 but retain these variables to make dichotomous
sex$s32 <- apply(sex[, c("s32_1","s32_2","s32_3","s32_4","s32_5","s32_6","s32_7","s32_8","s32_9","s32_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

## renaming the multiple choice variables to be dichotomous (s25)
sex <- sex %>%
  mutate(
    s25_genitalherpes = case_when(
      s25_1 %in% c("1", "-77") ~ as.integer(s25_1),
      TRUE ~ 0
    ),
    s25_genitalWarts = case_when(
      s25_2 %in% c("2", "-77") ~ ifelse(s25_2 == "2", 1, -77),
      TRUE ~ 0
    ),
    s25_aidsHIV = case_when(
      s25_3 %in% c("3", "-77") ~ ifelse(s25_3 == "3", 1, -77),
      TRUE ~ 0
    ),
    s25_hepB = case_when(
      s25_4 %in% c("4", "-77") ~ ifelse(s25_4 == "4", 1, -77),
      TRUE ~ 0
    ),
    s25_gon = case_when(
      s25_5 %in% c("5", "-77") ~ ifelse(s25_5 == "5", 1, -77),
      TRUE ~ 0
    ),
    s25_syph = case_when(
      s25_6 %in% c("6", "-77") ~ ifelse(s25_6 == "6", 1, -77),
      TRUE ~ 0
    ),
    s25_chlam = case_when(
      s25_7 %in% c("7", "-77") ~ ifelse(s25_7 == "7", 1, -77),
      TRUE ~ 0
    ),
    s25_other = case_when(
      s25_8 %in% c("8", "-77") ~ ifelse(s25_8 == "8", 1, -77),
      TRUE ~ 0
    ) 
  ) %>%
  select(-s25_1, -s25_2, -s25_3, -s25_4, -s25_5, -s25_6, -s25_7, -s25_8, -s25_9, -s25_77) # no values in _77 or _9 so removing

## renaming the multiple choice variables to be dichotomous (s32)

sex <- sex %>%
  mutate(
    s32_maleSame = case_when(
      s32_1 %in% c("1", "-77") ~ as.integer(s32_1),
      TRUE ~ 0
    ),
    s32_maleOlder1_2 = case_when(
      s32_2 %in% c("2", "-77") ~ ifelse(s32_2 == "2", 1, -77),
      TRUE ~ 0
    ),
    s32_maleOlder2 = case_when(
      s32_3 %in% c("3", "-77") ~ ifelse(s32_3 == "3", 1, -77),
      TRUE ~ 0
    ),
    s32_femaleSame = case_when(
      s32_4 %in% c("4", "-77") ~ ifelse(s32_4 == "4", 1, -77),
      TRUE ~ 0
    ),
    s32_femaleOlder1_2 = case_when(
      s32_5 %in% c("5", "-77") ~ ifelse(s32_5 == "5", 1, -77),
      TRUE ~ 0
    ),
    s32_femaleOlder2 = case_when(
      s32_6 %in% c("6", "-77") ~ ifelse(s32_6 == "6", 1, -77),
      TRUE ~ 0
    ),
    s32_NBSame = case_when(
      s32_7 %in% c("7", "-77") ~ ifelse(s32_7 == "7", 1, -77),
      TRUE ~ 0
    ),
    s32_NBOlder1_2 = case_when(
      s32_8 %in% c("8", "-77") ~ ifelse(s32_8 == "8", 1, -77),
      TRUE ~ 0
    ),
    s32_NBOlder2 = case_when(
      s32_9 %in% c("9", "-77") ~ ifelse(s32_8 == "9", 1, -77),
      TRUE ~ 0
    ) 
  ) %>%
  select(-s32_1, -s32_2, -s32_3, -s32_4, -s32_5, -s32_6, -s32_7, -s32_8, -s32_9, -s32_77) # removing -77 because no one endorsed


```

There are missing data and missing rule applied 
```{r sex_missing}
sex <- sex %>% 
  # for incarcerated TC, this survey wasn't shown 
   mutate_at(vars(s_pregnancy_screen:s48), ~case_when(id %in% c("HR211", "HR181", "P819") & is.na(.)  ~ "-55", TRUE ~ .)) %>%
   # Skip rule: if s1 select no/Decline (0/-77), then skip s1a:s8
   mutate_at(vars(s1a:s8), ~case_when(s1 != 1 ~ "-55", TRUE ~ . )) %>%
  mutate_at(vars(s2a,s2b,s2c), ~case_when(is.na(.x) ~ "0", TRUE ~ . )) %>%
  # if s1a != 8, s1a_8_text should be -55 
  # mutate_at(vars(s1a_8_text), ~case_when(s1a != 8 ~ "-55", TRUE ~ . )) %>%
   # Skip rule: if s4 select no/Decline (0/-77), then skip s5:s5c
   mutate_at(vars(s5:s5c), ~case_when(s4 != 1 ~ "-55", TRUE ~ . )) %>%
    mutate_at(vars(s5a,s5b,s5c), ~case_when(is.na(.x) ~ "0", TRUE ~ . )) %>%
   # skip rule: if s3 is not Yes-1, s6is skipped  
   mutate_at(vars(s6), ~case_when(s3 == 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s3 is Yes-1 | s6 != 1 , s7 is skipped  
   mutate_at(vars(s7), ~case_when(s3 == 1 | s6 != 1 ~ "-55", TRUE ~ . )) %>%
    # if s10 != 4, s10_4_text should be -55 
  mutate_at(vars(s10_4_text), ~case_when(s10 != 4 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s11 is Never(0) | s11 == -77 , s12 is skipped  
   mutate_at(vars(s12), ~case_when(s11 == 0 | s11 == -77 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s13 is not Yes-1, s14:s17 is skipped  
   mutate_at(vars(s14:s17), ~case_when(s13 != 1 ~ "-55", TRUE ~ . )) %>%
      # if s14 != 3, s14_8_text should be -55 
  mutate_at(vars(s14_8_text), ~case_when(s14 != 3 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s22 is not Yes-1, s23:s25 is skipped  
   mutate_at(vars(s23:s25), ~case_when(s22 != 1 ~ "-55", TRUE ~ . )) %>%
   # skip rule: if s23 is not Yes-1, s24:s25 is skipped 
   mutate_at(vars(s24:s25), ~case_when(s23 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s24 is not Yes-1, s25 is skipped  
   mutate_at(vars(s25), ~case_when(s24 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s26 is not Yes-1, s27 is skipped  
   mutate_at(vars(s27), ~case_when(s26 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s28 is not Yes-1, s29 is skipped  
   mutate_at(vars(s29), ~case_when(s28 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s30 <=0, s31:s35, s39, s40, s43, s44 is skipped  
   mutate_at(vars(s31:s35, s39, s40, s43, s44), ~case_when(s30 <= 0 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s_pregnancy_Screen is not No (0) | s30 <=0, s36:s38 is skipped
   mutate_at(vars(s36:s38), ~case_when(s_pregnancy_screen != 0 | s30 <= 0 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s39 is not Yes-1, s40:s43 is skipped  
   mutate_at(vars(s40:s43), ~case_when(s39 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s40 is not Yes-1, s40:s42 is skipped  
   mutate_at(vars(s40:s42), ~case_when(s40 != 1 ~ "-55", TRUE ~ . )) %>%
    # skip rule: if s40 is not Yes (1) | s30 <=0, s41:s42 is skipped  
   mutate_at(vars(s41:s42), ~case_when(s40 != 1 | s30 <= 0 ~ "-55", TRUE ~ . )) %>%
   # skip rule: if s44 is not Yes (1), s45:s48 is skipped  
   mutate_at(vars(s45:s48), ~case_when(s44 != 1 ~ "-55", TRUE ~ . )) %>%
   # skip rule: if s44 is not Yes (1) | s30 <=0, s45 is skipped  
   mutate_at(vars(s45), ~case_when(s44 != 1 | s30 <= 0 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s45 is not Yes (1), s46:s48 is skipped
   mutate_at(vars(s46:s48), ~case_when(s45 != 1 ~ "-55", TRUE ~ . )) %>%
  # skip rule: if s45 is not Yes (1) | s30 <=0, s45, s47 is skipped  
   mutate_at(vars(s46:s48), ~case_when(s45 != 1 | s30 <= 0 ~ "-55", TRUE ~ . )) %>%
  # catching NAs that weren't caught because s25 was endorsed
  mutate(s25_8_text = ifelse(is.na(s25_8_text) | s25_8_text == "NA", -55, s25_8_text)) %>%
   # skip rule: if s46 is not Yes (1), s47:s48 is skipped  
  mutate_at(vars(s47:s48), ~case_when(s46 != 1 ~ "-55", TRUE ~ . )) %>%
  # p813 for s12 changed to -99 because truly missing. 
  mutate_at(vars(s12), ~case_when(id == "P813" ~ "-55", TRUE ~ . )) %>%
  relocate(s25, .before = s25_8_text) %>%
  relocate(s32, .before = s33) %>%
  relocate(62:69, .after = 37) %>%
  relocate(70:78, .after = 53 ) 




# before next steps, editing dates so only mm/dddd and DD 01 for s2, s5, and s7

## Function to convert character to date with day to 01
# MARIA/Min, thie function does not seems to work, if you run the three line below it changes s2, s5,s7 to NA 
convert_to_date <- function(x) {
  date <- tryCatch({
    parsed_date <- as.Date(as.yearmon(x, "%m/%Y"))
    if (all(is.na(parsed_date))) {
      stop("All formats failed to parse. No formats found.")
    }
    parsed_date  # Remove the floor_date function
  }, error = function(e) NA)
  return(date)
}

# Apply the function to the 's2' and 's5' and 's7' columns
sex$s2 <- convert_to_date(sex$s2)
sex$s5 <- convert_to_date(sex$s5)
sex$s7 <- convert_to_date(sex$s7)


```

### Sex Calculation and Finalize Data (no scales)
```{r sex_calc}
# We do not apply the missing data rule due to how items are used
sex_complete <-sex 
```

## CINT
### CINT-SOCIODEMS Select Variable & Recode
```{r cint_soci}
cint_socio <- tpw_raw %>%
  select(id,cint_pregnancy_screen:cint_income_support, cint_identity, cint_identity_8_text) %>%
  mutate(
    across(
      .cols = c(cint_pregnancy_screen, cint2:cint5),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    cint_0 = case_when(
      cint_0 == "1. 8th grade or less or working towards GED" ~ "1",
      cint_0 == "2. Completed GED/Alternative H.S. diploma" ~ "2",
      cint_0 == "3. Completed some high school, but did not graduate" ~ "3",
      cint_0 == "4. Graduated high school" ~ "4",
      cint_0 == "5. Taking/have taken community college classes or working toward Associates Degree" ~ "5",
      cint_0 == "6. Completed/obtained an Associate's Degree" ~ "6",
      cint_0 == "7. Taking/have taken vocational classes or working toward Vocational Training" ~ "7",
      cint_0 == "8. Completed Vocational Training" ~ "8",
      cint_0 == "9. Taking/have taken 4 yr college classes or working toward 4 year college degree" ~ "9",
      cint_0 == "10. Completed 4 year college degree" ~ "10",
      cint_0 == "11. Taking/have taken graduate classes or working toward post-college degree" ~ "11",
      cint_0 == "12. Completed post-college degree" ~ "12",
      cint_0 == "Decline to Answer" ~ "-77",
      TRUE ~ cint_0
    ),
    cint1_1 = case_when(cint1_1 == "1. Currently Working" ~ "1",),
    cint1_2 = case_when(cint1_2 == "2. Temporarily laid off" ~ "2"),
    cint1_3 = case_when(cint1_3 == "3. On Leave" ~ "3"),
    cint1_4 = case_when(cint1_4 == "4. Unemployed or looking for work" ~ "4"),
    cint1_5 = case_when(cint1_5 == "5. Retired" ~ "5"),
    cint1_6 = case_when(cint1_6 == "6. Disabled, permanently or temporarily" ~ "6"),
    cint1_7 = case_when(cint1_7 == "7. Student" ~ "7"),
    cint1_8 = case_when(cint1_8 == "8. Something else, please briefly describe" ~ "8"),
    cint1_77 = case_when(cint1_77 == "Decline to Answer" ~ "-77"),
    cint18 = case_when(
      cint18 == "1. Always or almost always" ~ "1",
      cint18 == "2. Often" ~ "2",
      cint18 == "3. About half the time" ~ "3",
      cint18 == "4. Occasionally" ~ "4",
      cint18 == "5. Never or almost never" ~ "5",
      cint18 == "8. N/A, no bills to pay" ~ "6",
      cint18 == "Decline to Answer" ~ "-77",
      TRUE ~ cint18
    ),
    cint19 = case_when(
      cint19 == "1. Always or almost always" ~ "1",
      cint19 == "2. Often" ~ "2",
      cint19 == "3. About half the time" ~ "3",
      cint19 == "4. Occasionally" ~ "4",
      cint19 == "5. Never or almost never" ~ "5",
      cint19 == "Decline to Answer" ~ "-77",
      TRUE ~ cint19
    ),
    cint_identity = case_when(
      cint_identity == "Cisgender female or woman" ~ "1",
      cint_identity == "Cisgender male or man" ~ "2",
      cint_identity == "Female/Woman" ~ "3",
      cint_identity == "Male/Man" ~ "4",
      cint_identity == "Trans female/woman" ~ "5",
      cint_identity == "Trans male/man" ~ "6",
      cint_identity == "Non-binary" ~ "7",
      cint_identity == "Prefer to self-identify" ~ "8",
      cint_identity == "Decline to Answer" ~ "-77",
      TRUE ~ cint_identity
    )
    )

# Combine cint1 responses to cint1 
cint_socio$cint1 <- apply(cint_socio[, c("cint1_1", "cint1_2", "cint1_3", "cint1_4", "cint1_5", "cint1_6", "cint1_7", "cint1_8", "cint1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

#Although these were created from the above 9 variables, each participant only selected no more than two choices, so we recoded according to choice 1 and choice 2
# Maria this create warning, I wasn't sure if this matters
cint_socio <- cint_socio %>%
  separate(cint1, into = c("cint1_choice1", "cint1_choice2"), sep = ";", remove = FALSE) %>%
  mutate(
    cint1_choice1 = as.numeric(cint1_choice1),
    cint1_choice2 = as.numeric(cint1_choice2),
    cint1_choice1 = coalesce(cint1_choice1, -55),
    cint1_choice2 = coalesce(cint1_choice2, -55)
  ) %>%
  select(-cint1)

# Organize column order 
cint_socio <- cint_socio %>%
  relocate(cint1_choice1, cint1_choice2, .after = cint_0)

```

### CINT-SOCIODEMS Missing
```{r cint_soci_missing}
cint_socio <- cint_socio %>%
  # if cint1_1 is not selected cint2 will not be asked 
   mutate(cint2 = case_when(is.na(cint1_1) ~ "-55", TRUE ~ cint2)) %>%
  # if cint1_2 is not selected cint3 will not be asked 
   mutate(cint3 = case_when(is.na(cint1_2) ~ "-55", TRUE ~ cint3)) %>%
  # if cint1_3 is not selected cint4 will not be asked 
   mutate(cint4 = case_when(is.na(cint1_3) ~ "-55", TRUE ~ cint4)) %>%
  # if cint1_4 is not selected cint5 will not be asked 
   mutate(cint5 = case_when(is.na(cint1_4) ~ "-55", TRUE ~ cint5)) %>%
  # if they did not select others (cint1_8, and cint_identity_8), the _text column should be -55
  mutate(cint1_8_text = case_when(is.na(cint1_8) ~ "-55", TRUE ~ cint1_8_text)) %>%
  mutate(cint_identity_8_text = case_when(is.na(cint_identity_8_text) ~ "-55", TRUE ~ cint_identity_8_text)) %>%
  # cint_income & cint_income_support: this was request to answer, so if it's NA, it should be TC refuse to answer 
  mutate(cint_income = case_when(is.na(cint_income) ~ "-55", TRUE ~ cint_income)) %>%
  mutate(cint_income_support = case_when(is.na(cint_income_support) ~ "-55", TRUE ~ cint_income_support)) %>%
  select(-c("cint1_1", "cint1_2", "cint1_3", "cint1_4", "cint1_5", "cint1_6", "cint1_7", "cint1_8", "cint1_77"))



cint_socio_complete <-
  cint_socio %>%
  select(-cint_identity_8_text) # no participant selected other not listed gender identity


## we do not apply missing data rules because not a standardized questionnaire
# cint_socio_miss <- cint_socio %>%
#   mutate(across(-c(id, matches("_8_text$")), as.numeric))%>%
#   pct_miss_fun(
#     id = c("id", "cint1_8_text", "cint_identity_8_text"),
#     n_items = 12
#   )
# 
# 
# cint_socio_miss %>% 
#   gt::gt() %>% 
#   gt::tab_header(
#     title = 'CINT-SOCIODEMS Missing Data',
#     subtitle = 'By Participant')
# 
# 
# cint_socio_complete <-
#   cint_socio %>%
#   #Below is the code that treats -77, -55 values as NA
#   mutate(
#     across(
#       .cols = -c(id,matches("_8_text$")),
#       .fns = ~case_when(
#         .x < 0 ~ NA_real_,
#         TRUE ~ .x
#       )
#     )
#   )
```

### CINT-Ladder Select Variable & Recode
```{r cint-ladder}
cint_ladder <- tpw_raw %>%
  select(id, cint_ladder1, cint_ladder2) %>% 
  mutate(
    across(
      .cols = -id,
      .fns = ~case_when(
        is.na(.x) ~ "-77",
        TRUE ~ .x
        )
      )
  )

# correct data type 
cint_ladder_complete <- cint_ladder %>%
  mutate(across(-c(id), as.numeric))
```

### CINT-Ladder Missing 
```{r cint-ladder-missing}
## we do not apply missing data rules because not a standardized questionnaire
# cint_ladder_missing <- cint_ladder %>%
#   mutate(across(-c(id), as.numeric)) %>%
#   pct_miss_fun(
#     id = c("id"),
#     n_items = 2
#   )
# 
# 
# cint_ladder_missing %>% gt::gt() %>% 
#   gt::tab_header(
#     title = 'CINT-LADDDER Missing Data',
#     subtitle = 'By Participant')
# 
# 
# # Below is the code that treats -77, -55 values as NA
# cint_ladder_complete <-
#   cint_ladder %>%
#   mutate(across(-c(id), as.numeric)) %>%
#   mutate(
#     across(
#       .cols = -c(id),
#       .fns = ~case_when(
#         .x < 0 ~ NA_real_,
#         TRUE ~ .x
#       )
#     )
#   ) 
```

### CINT-Romantic and friend relationships Select Variable & Recode
```{r}
cint_relation <- tpw_raw %>%
  select(id, cint20:cint37) %>%
  mutate(
    cintq3 = case_when(
        cintq3 == "1. Married" ~ "1",
        cintq3 == "2. Living together" ~ "2",
        cintq3 == "3. Dating or seeing each other, but not living together. This includes casual dating." ~ "3",
        cintq3 == "4. Married, but separated" ~ "4",
        cintq3 == "5. Decline to Answer" ~ "-77",
        TRUE ~ cintq3
      ),
    cint26 = case_when(
      cint26 == "1 - Not at all close" ~ "1",
      cint26 == "10 - Extremely Close" ~ "10",
      cint26 == "Decline to Answer" ~ "-77",
      TRUE ~ cint26
    ),
    cint27 = case_when(
      cint27 == "1 - Not at all well" ~ "1",
      cint27 == "10 - Very Well" ~ "10",
      cint27 == "Decline to Answer" ~ "-77",
      TRUE ~ cint27
    ),
    across(
      .cols = c(cint28, cint29, cint37),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Don't Know" ~ "-66",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
     cint30 = case_when(
      # Updated from original study coding to match our guideline which start from 0
      cint30 == "1. Never" ~ "0",
      cint30 == "2. Drank alcohol only a few times during the year" ~ "1",
      cint30 == "3. Drinks regularly for a few weeks or more, then doesn't for a few weeks or more or drinks, then stops drinking (ex: became clean and sober)" ~ "2",
      cint30 == "4. Drinks about once a month" ~ "3",
      cint30 == "5. Drinks on weekends or mostly on weekends" ~ "4",
      cint30 == "6. Drinks daily or almost daily" ~ "5",
      cint30 == "7. Other: (Specify)" ~ "6",
      cint30 == "8. Don't know" ~ "-66",
      cint30 == "Decline to Answer" ~ "-77",
      TRUE ~ cint30
    ),
     cint31 = case_when(
      # Updated from original study coding to match our guideline which start from 0
      cint31 == "1. Never" ~ "0",
      cint31 == "2. Smoked only a few times during the year" ~ "1",
      cint31 == "3. Smokes regularly for a few weeks or more, then doesn't for a few weeks or more or used, then stopped (ex: became clean and sober)" ~ "2",
      cint31 == "4. Smokes about once a month" ~ "3",
      cint31 == "5. Smokes on weekends or mostly on weekends or a few times a week" ~ "4",
      cint31 == "6. Smokes daily or almost daily" ~ "5",
      cint31 == "7. Other: (Specify)" ~ "6",
      cint31 == "8. Don't know" ~ "-66",
      cint31 == "Decline to Answer" ~ "-77",
      TRUE ~ cint31
    ),
     cint32 = case_when(
      # Updated from original study coding to match our guideline which start from 0
      cint32 == "1. Never" ~ "0",
      cint32 == "2. Used hard drugs a limited number of times" ~ "1",
      cint32 == "3. Uses drugs regularly for a few weeks or more, then don't for a few weeks or more, or used, then stopped (ex: became clean and sober)" ~ "2",
      cint32 == "4. Uses drugs about once a month" ~ "3",
      cint32 == "5. Uses hard drugs on weekends or mostly on weekends or a few times a week" ~ "4",
      cint32 == "6. Uses hard drugs daily or almost daily" ~ "5",
      cint32 == "7. Other: (Specify)" ~ "6",
      cint32 == "8. Don't know" ~ "-66",
      cint32 == "Decline to Answer" ~ "-77",
      TRUE ~ cint32
    ),
    cint33 = case_when(
      cint33 == "1. Any grade up to the 12th grade, but not having a High School Diploma/GED" ~ "1",
      cint33 == "2. GED or Equivalency" ~ "2",
      cint33 == "3. High School Diploma" ~ "3",
      cint33 == "4. Attended Community College but no A.A.(Associates) degree" ~ "4",
      cint33 == "5. Community College degree, (A.A.)" ~ "5",
      cint33 == "6. Attended 4 year University or College, but no degree" ~ "6",
      cint33 == "7. B.A., B.S., BSN degree" ~ "7",
      cint33 == "8. Graduate degree (MA, MS, PhD)" ~ "8",
      cint33 == "9. Other (Technical, Vocational school)" ~ "9",
      cint33 == "10. Don't know" ~ "-66",
      cint33 == "Decline to Answer" ~ "-77",
      TRUE ~ cint33
    ),
     cint34 = case_when(
      cint34 == "1 (Not at all Supportive)" ~ "1",
      cint34 == "10 (Very Supportive)" ~ "10",
      cint34 == "Decline to Answer" ~ "-77",
      TRUE ~ cint34
    ),
    cint35 = case_when(
      cint35 == "1. None" ~ "0",
      cint35 == "2. One" ~ "1",
      cint35 == "3. Two or three" ~ "2",
      cint35 == "4. Four or more" ~ "3",
      cint35 == "Decline to Answer" ~ "-77",
      TRUE ~ cint35
    ),
    cint36 = case_when(
      # Updated from original study coding to match our guideline which start from 0
      cint36 == "1. Never" ~ "0",
      cint36 == "2. Less than once a week" ~ "1",
      cint36 == "3. One" ~ "2",
      cint36 == "4. Two or three" ~ "3",
      cint36 == "5. Four or five" ~ "4",
      cint36 == "6. Six or seven" ~ "5",
      cint36 == "7. N/A, current living situation/setting provides no opportunity for socialization ( if says she is in a locked setting)" ~ "6",
      cint36 == "Decline to Answer" ~ "-77",
      TRUE ~ cint36
    )
    )
```

### CINT-Romantic & F Missing
```{r cint_relation_missing}
cint_relation <- cint_relation %>%
  # if cint20 <1 cintq2:cint35 was be asked 
   mutate_at(vars(cintq2:cint34), ~case_when(cint20 < 1 ~ "-55", TRUE ~ .)) %>%
  # if cint35 is none/1 or -77 cint36:cint37 was be asked 
   mutate_at(vars(cint36:cint37), ~case_when(cint35 == 1 |  cint35 == "-77" ~ "-55", TRUE ~ .)) %>% 
   mutate_at(vars(cint30_7_text), ~case_when(cint30 != 7 ~ "-55", TRUE ~ .)) %>% 
   mutate_at(vars(cint31_7_text), ~case_when(cint31 != 7 ~ "-55", TRUE ~ .)) %>% 
   mutate_at(vars(cint32_7_text), ~case_when(cint32 != 6 ~ "-55", TRUE ~ .))

# Correct data type and create _complet df 
cint_relation_complete <- cint_relation %>%
  mutate(across(-c(id, matches("text$")), as.numeric))

## we do not apply missing data rules because not a standardized questionnaire
# cint_relation_miss <- cint_relation %>%
#   mutate(across(-c(id, matches("_7_text$")), as.numeric))%>%
#   pct_miss_fun(
#     id = c("id", matches("_7_text$")),
#     n_items = 15
#   )
# 
# cint_relation_miss%>% gt::gt() %>% 
#   gt::tab_header(
#     title = 'CINT- Ramantic and Friend Relationship Missing Data',
#     subtitle = 'By Participant')
# 
# 
# 
# # Below is the code that treats -77, -55 values as NA
# cint_relation_complete <-
#   cint_relation %>%
#   mutate(across(-c(id, matches("_7_text$")), as.numeric)) %>%
#   mutate(
#     across(
#       .cols = -c(id, matches("_7_text$")),
#       .fns = ~case_when(
#         .x < 0 ~ NA_real_,
#         TRUE ~ .x
#       )
#     )
#   ) 
```

### CINT-Substance Use Select Variable & Recode
```{r}
cint_substance <- tpw_raw %>%
  select(id, cint_pregnancy_screen, cint39:cint84_77) %>%
    mutate(
    across(
      .cols = c(cint_pregnancy_screen,cint39, cint41, cint43, cint45, cint50, cint54, cint56, cint58, cint60, cint64, cint65, cint66, cint68, cint70, cint72, cint74, cint76, cint78, cint80, cint82),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
        across(
      .cols = c(cint63),
      .fns = ~case_when(
        .x == "1. Yes" ~ "1",
        .x == "2. No" ~ "0",
        .x == "3. NA -- not in school and not employed in last 6 months" ~ "-55", # this is for cint63
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(cint46),
      .fns = ~case_when(
        .x == "1. Not at all" ~ "0",
        .x == "2. A little drunk" ~ "1",
        .x == "3. Quite drunk" ~ "2",
        .x == "4. Very drunk" ~ "3",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(cint47),
      .fns = ~case_when(
        .x == "1. Drank alcohol only a few times during the past 6 months (up to 5 times)" ~ "1",
        .x == "2. Drink regularly for a few weeks or more, then don't for a few weeks or more or drank for a period and then stopped altogether" ~ "2",
        .x == "3. Drink about once a month" ~ "3",
        .x == "4. Drink on weekends or mostly weekends or a few times a week" ~ "4",
        .x == "5. Drink daily or almost daily" ~ "5",
        .x == "6. Other: Specify" ~ "6",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(cint61),
      .fns = ~case_when(
        .x == "1. A little high" ~ "1",
        .x == "2. Quite high" ~ "2",
        .x == "3. Very high" ~ "3",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(cint62),
      .fns = ~case_when(
        .x == "1. Smoked only a few times during the past 6 months" ~ "1",
        .x == "2. Smoked regularly for a few weeks or more, then didn't for a few weeks or more or smoked for some time and then stopped" ~ "2",
        .x == "3. Smoked about once a month" ~ "3",
        .x == "4. Smoked on weekends or mostly weekends or a few times a week" ~ "4",
        .x == "5. Smoked daily or almost daily" ~ "5",
        .x == "6. Other" ~ "6",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    cint84_1 = case_when(cint84_1 == "1. Stranger" ~ "1", TRUE ~ cint84_1),
    cint84_2 = case_when(cint84_2 == "2. Acquaintance" ~ "2",TRUE ~ cint84_2),
    cint84_3 = case_when(cint84_3 == "3. Friend" ~ "3", TRUE ~ cint84_3),
    cint84_4 = case_when(cint84_4 == "4. Family member" ~ "4", TRUE ~ cint84_4),
    cint84_5 = case_when(cint84_5 == "5. Romantic partner" ~ "5", TRUE ~ cint84_5),
    cint84_6 = case_when(cint84_6 == "6. Other" ~ "6", TRUE ~ cint84_6),
    cint84_77 = case_when(cint84_77 == "Decline to Answer" ~ "-77", TRUE ~ cint84_77)
)

# Combine cint1 answer options to cint1 due to skip rule 
cint_substance$cint84 <- apply(cint_substance[, c("cint84_1", "cint84_2", "cint84_3", "cint84_4", "cint84_5", "cint84_6", "cint84_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

```

### CINT-Substance Missing
```{r cint_subs_missing}
cint_substance <- cint_substance %>%
       # Incarcerated TC weren't administered this survey
  mutate_at(vars(cint39:cint84), ~ ifelse(id %in% c("HR211", "HR181", "P819"), -55, .)) %>%
  # if cint_pregnancy_screen is yes/1, cint40:cint43 were not asked 
   mutate_at(vars(cint39:cint84), ~case_when(cint_pregnancy_screen == 1 ~ "-55", TRUE ~ .)) %>%
  # if cint39 is 0/No or -77 cint40:cint42 were not asked 
   mutate_at(vars(cint40:cint42), ~case_when(cint39 == 0 |  cint39 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint41 is 0/No or -77 cint42 were not asked 
   mutate_at(vars(cint42), ~case_when(cint41 == 0 |  cint41 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint43 is 0/No or -77, cint44:cint57 were not asked
  mutate_at(vars(cint44:cint57), ~case_when(cint43 == 0 |  cint43 == "-77" ~ "-55", TRUE ~ .)) %>%
  mutate_at(vars(cint47_6_text), ~case_when(cint47 != 6 ~ "-55", TRUE ~ .)) %>%
  # if cint54 is 0/No or -77, cint55:cint57 were not asked
  mutate_at(vars(cint55:cint57), ~case_when(cint54 == 0 |  cint54 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint56 is 0/No or -77, cint57 were not asked
  mutate_at(vars(cint57), ~case_when(cint56 == 0 |  cint56 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint58 is 0/No or -77, cint57:cint65 were not asked
  mutate_at(vars(cint57:cint65), ~case_when(cint58 == 0 |  cint58 == "-77" |cint58 == "-55"~ "-55", TRUE ~ .)) %>%
  # if cint66 is 0/No or -77, cint67 were not asked
  mutate_at(vars(cint67), ~case_when(cint66 == 0 |  cint66 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint68 is 0/No or -77, cint69 were not asked
  mutate_at(vars(cint69), ~case_when(cint68 == 0 |  cint68 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint70 is 0/No or -77, cint71 were not asked
  mutate_at(vars(cint71), ~case_when(cint70 == 0 |  cint70 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint72 is 0/No or -77, cint73 were not asked
  mutate_at(vars(cint73), ~case_when(cint72 == 0 |  cint72 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint74 is 0/No or -77, cint75 were not asked
  mutate_at(vars(cint75), ~case_when(cint74 == 0 |  cint74 == "-77" ~ "-55", TRUE ~ .)) %>%
   # if cint76 is 0/No or -77, cint77 were not asked
  mutate_at(vars(cint77), ~case_when(cint76 == 0 |  cint76 == "-77" ~ "-55", TRUE ~ .)) %>%
   # if cint78 is 0/No or -77, cint79 were not asked
  mutate_at(vars(cint79), ~case_when(cint78 == 0 |  cint78 == "-77" ~ "-55", TRUE ~ .)) %>%
  # if cint 82 is not Yes, CINT 83, and cint 84 was skiped 
  mutate_at(vars(cint83:cint84), ~case_when(cint82 != 1 ~ "-55", TRUE ~ .)) %>%
  # if cint80 is 0/No or -77, cint81:cint84_77 were not asked
  mutate_at(vars(cint81:cint84), ~case_when(cint80 == 0 |  cint80 == "-77" ~ "-55", TRUE ~ .)) %>% 
  # cint40 could choose not to answer 
  mutate(cint40 = ifelse(is.na(cint40), -77, cint40))%>%
  # cint44 could choose not to answer 
  mutate(cint44 = ifelse(is.na(cint44), -77, cint44))%>%
  # cint53 could choose not to answer 
  mutate(cint53 = ifelse(is.na(cint53), -77, cint53))%>%
  # cint83 could choose not to answer 
  mutate(cint83 = ifelse(is.na(cint83), -77, cint83))%>%
  mutate_at(vars(cint47_6_text), ~case_when(cint47 != 7 ~ "-55", TRUE ~ .)) %>% 
  mutate_at(vars(cint62_6_text), ~case_when(cint62 != 7 ~ "-55", TRUE ~ .)) %>%
 select(-c(cint84_1:cint84_77))

cint_substance_complete <- cint_substance %>%
  # we don't need cint_pregnancy_screen because it's already included in the sociodems
  select(-cint_pregnancy_screen)

# Maira/Min: issue below was solved, it becauese we missed a skip rule, Maria, after you checked, you can remove these two line. 
# HR166 has cint84 missing; checked this and we are using code of -99   

## we do not apply missing data rules because not a standardized questionnaire
# cint_substance_miss <- cint_substance %>%
#   mutate(across(-c(id, matches("_6_text$")), as.numeric))%>%
#   pct_miss_fun(
#     id = c("id", matches("_6_text$")),
#     n_items = 47
#   )
# 
# cint_substance_miss%>% gt::gt() %>% 
#   gt::tab_header(
#     title = 'CINT- Subtance use Missing Data',
#     subtitle = 'By Participant')
# 
# 
# 
# # Below is the code that treats -77, -55 values as NA
# cint_substance_complete <-
#   cint_substance %>%
# mutate(across(-c(id, matches("_6_text$"), cint84), as.numeric)) %>% # cint84 is multiple choice
#   mutate(
#     across(
#       .cols = -c(id, matches("_6_text$")),
#       .fns = ~case_when(
#         .x < 0 ~ NA,
#         TRUE ~ .x
#       )
#     ),
#     across(
#       .cols = matches("_6_text$"),
#       .fns = ~case_when(
#         .x == -55 ~ NA,
#         TRUE ~ .x
#       )
#     )
#   ) 
```

### CINT-COVID Select Variables and Recode 
```{r}

## Note made during cleaning process on 12/2023 -- there are no psychometrics or optimal scoring methods published. Please reach out to Dr. Damion Grasso dgrasso@uchc.edu with questions if you wish to use. 
 
cint_covid <- tpw_raw %>%
  select(id, starts_with("cintc")) %>%
    mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes (Me)" ~ "1",
        .x == "Yes (Person in home)" ~"2",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    )
  )


# Combine multiple choice columns into one for each question
for (i in 1:14) {
  # Define the columns to be combined for the current group
  group_columns <- paste0("cintc", i, "_", c(1, 2, 3, 77))
  # Apply the function to concatenate non-NA values for each row
  cint_covid[, paste0("cintc", i)] <- apply(cint_covid[, c(group_columns, paste0("cintc", i))], 1, function(x) paste(x[!is.na(x)], collapse = ";"))
}


cint_covid <- cint_covid %>%
  select(id, cintc1:cintc14)

# Replace all empty cells with -55 in the entire data frame
# cint_covid <- cint_covid %>%
#   replace(cint_covid, is.na(cint_covid) | cint_covid == "", -55)
cint_covid <- cint_covid %>%
  mutate_all(~ ifelse(is.na(.x) | .x == "", -55, .x))

## there will also be -77s

## now I am divided these into endorsing the item for participant's self or another person in the participant's home (other suffix)

# Function to process each cintc variable
process_cintc <- function(data, var_name) {
  data %>%
    mutate(
      !!paste0(var_name, "_self") := ifelse(grepl("1;2|1", !!sym(var_name)), 1, 
                                             ifelse(grepl("0", !!sym(var_name)), 0,
                                                      ifelse(!!sym(var_name) == -77, -77, -55))),
      !!paste0(var_name, "_other") := ifelse(grepl("1;2|2", !!sym(var_name)), 1, 
                                              ifelse(grepl("0", !!sym(var_name)), 0,
                                                       ifelse(!!sym(var_name) == -77, -77, -55)))
    ) %>%
    select(-{{ var_name }})
}

# Apply the function to each cintc variable using purrr::reduce
cint_covid <- purrr::reduce(paste0("cintc", 1:14), process_cintc, .init = cint_covid)

cint_covid_complete <- cint_covid
```

### CINT-COVID Missing 
```{r}
# We are NOT applying missing data rule given guidance from author of scale
```

## SOCINF Substances 
### SOCINF Substances Select Variable and recode 
```{r socinf_sub}
socinf_sub<- tpw_raw %>%
  select(id, starts_with("soc"), -socinf_screen) %>%
  rename(socinf_relationship_screener = socinf_screen_2) %>%
    mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        
        .x == "Never" ~ "0",
        .x == "Hardly ever" ~ "1",
        .x == "Hardly Ever" ~ "1",
        .x == "Sometimes" ~ "2",
        .x == "Often" ~ "3",
        
        .x == "Not at all" ~ "0",
        .x == "A little" ~ "1",
        .x == "Somewhat" ~ "2",
        .x == "A lot" ~ "3",
        
        .x == "Decline to Answer" ~ "-77",
        .x == "N/A" ~ "-55",
        TRUE ~ .x
      )
    )
  )
```

### SOCINF Substances Missing 
```{r socinf_sub_missing}
socinf_sub <- socinf_sub%>%
  # if socinf_relationship_screener is NO/0 (no partner), SOC1:SOC2d; soc4a:soc4h; socb1:socb2e; socb4a:socb4k; socc1; socc2a:socc2e; socc4a:socc4k; socd1 were not asked
  mutate_at(vars(soc1:soc2d, soc4a:soc4h, socb1:socb2e, socb4a:socb4k, socc1, socc2a:socc2e, socc4a:socc4k,socd1, socd2a:socd2d, socd4a:socd4k), ~case_when(socinf_relationship_screener == 0 ~ "-55", TRUE ~ .)) %>%
  # if soc1 is Yes/1, soc2a:soc2d were not asked
  mutate_at(vars(soc2a:soc2d), ~case_when(soc1 == 0 | soc1 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socinf_preg_screener is NO/0, SOC3 is not asked 
  mutate_at(vars(soc3, socb3, socc3, socd3), ~case_when(socinf_preg_screener == 1 ~ "-55", TRUE ~ .)) %>%
  # if SOC3 is NO/0, -77, soc4a:soc4h were not asked
  mutate_at(vars(soc4a: soc4h), ~case_when(soc3 == 0 |soc3 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socb1 is NO/0, -77 socb2a:socb2e were not asked
  mutate_at(vars(socb2a:socb2e), ~case_when(socb1 == 0 |socb1 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socb3 is No/0, -77, socb4a:socb4k were not asked 
  mutate_at(vars(socb4a:socb4k), ~case_when(socb3 == 0 |socb3 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socc1 is NO/0, -77, socc2a:socc2e were not asked
  mutate_at(vars(socc2a:socc2e), ~case_when(socc1 == 0 |socc1 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socc3 is NO/0, -77 socc4a:socc4k were not asked 
  mutate_at(vars(socc4a:socc4k), ~case_when(socc3 == 0 |socc3 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socd1 is NO/0, -77, socd2a:socd2d were not asked
  mutate_at(vars(socd2a:socd2e), ~case_when(socd1 == 0 |socd1 < 0 ~ "-55", TRUE ~ .)) %>%
  # if socd3 is NO/0, -77, socd4a:socd4k were not asked
  mutate_at(vars(socd4a:socd4k), ~case_when(socd3 == 0 |socd3 < 0 ~ "-55", TRUE ~ .)) %>%
  # Incarcerated participants weren't administered for this survey
  mutate_at(vars(socinf_preg_screener:socd4k), ~case_when(id %in% c("HR211", "HR181", "P819") & is.na(.) ~ "-55", TRUE ~ .)) # they will therefore not have screener questions asked

socinf_sub_miss <- socinf_sub %>%
  pct_miss_fun(
    id = "id",
    n_items = 49
  )

socinf_sub_miss %>% 
  gt::gt() %>% 
  gt::tab_header(
    title = 'socinf_sub Missing Data',
    subtitle = 'By Participant')


```

### SOCINF Substances Calculations
```{r socinf_sub_calc}
# No calculations are needed 
# We do not apply missing data procedures

socinf_sub_complete <- socinf_sub %>%
  mutate(across(-id, as.numeric)) 
```


## SOCINF General 
### SOCINF General Select Variable and Recode 
```{r socinf_gen}
socinf_gen<- tpw_raw %>%
  select(id, socinf_screen,starts_with("sg")) %>%
  rename(socinf_general_screener = socinf_screen) %>%
    mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        
        .x == "Never or almost never true" ~ "0",
        .x == "Hardly ever true" ~ "1",
        .x == "Sometimes true" ~ "2",
        .x == "Often true" ~ "3",
        .x == "Always or almost always true" ~ "4",
        
        .x == "Not at all against" ~ "0", 
        .x == "A little against" ~ "1",
        .x == "Somewhat against" ~ "2",
        .x == "Very much against" ~ "3", 
        
        .x == "Decline to Answer" ~ "-77",
        .x == "Decline to answer" ~ "-77", # needed for anomaly
        .x == "NA" ~ "-55", 
        .x == "N/A" ~ "-55",
        TRUE ~ .x
      )
    )
  )
  
```

### SOCINF General Missing
```{r socinf_gen_missing}
# We do not apply missing data rules
# No scales or subscales 

socinf_gen <- socinf_gen%>%
  # if socinf_general_screener is NO/0, the entire questionnaire was not administered. 
  mutate_at(vars(sg1:sg13d), ~case_when(socinf_general_screener == 0 ~ "-55", TRUE ~ .)) %>%
  # Incarcerated participants weren't administered for this survey
  mutate_at(vars(sg1:sg13d, socinf_general_screener), ~case_when(id %in% c("HR211", "HR181", "P819") ~ "-55", TRUE ~ .)) %>%
  mutate_at(vars(sg1:sg13d), ~case_when(is.na(.) ~ "-55", TRUE ~ .))

socinf_gen_miss <- socinf_gen %>%
  mutate(across(-c(id), as.numeric))%>%
  pct_miss_fun(
    id = c("id"),
    n_items = 17
  )


socinf_gen_miss %>% 
  gt::gt() %>% 
  gt::tab_header(
    title = 'SOCINF General Missing Data',
    subtitle = 'By Participant')


```


```{r socinf_gen_calc}
# We do not apply missing data procedures
socinf_gen_complete <- socinf_gen %>%
   mutate(across(-c(id), as.numeric))
```


## CTS Parent Child 
### CTS-PC Select Variable and Recode 
```{r cts_pc}
cts_pc <- tpw_raw %>%
  select(id, cts_parent_screen:a23) %>%
  mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        
        .x == "None - has never happened" ~ "0",
        .x == "None" ~ "0",
        .x == "Once" ~ "1",
        .x == "Twice" ~ "2",
        .x == "3-5 times" ~ "3",
        .x == "6-10 times" ~ "4",
        .x == "11-20 times" ~ "5", 
        .x == "More than 20 times" ~ "6",
        .x == "Not in the past year, but it happened before" ~ "7", 
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    )
  )
  
```

### CTS-PC Missing
```{r}
cts_pc <- cts_pc%>%
  # if cts_parent_screen is NO/0, the entire questionnaire was not administered. 
  mutate_at(vars(a1:a23), ~case_when(cts_parent_screen == 0 ~ "-55", TRUE ~ .)) %>%
  mutate(
    across(
      .cols = -c(id, cts_parent_screen),
      .fns = ~case_when(
        .x == "3" ~ "4",
        .x == "4" ~ "8",
        .x == "5" ~ "15",
        .x == "6" ~ "25",
        .x == "7" ~ "-2",
      TRUE ~ .x
      ),
      .names = '{.col}_r'
      ))

cts_pc_miss <- cts_pc %>%
  mutate(across(-c(id), as.numeric))%>%
  pct_miss_fun(
    id = c("id", -matches("\\d$")),
    n_items = 46 # updated to reflect the coding
  )

cts_pc_miss %>% 
  gt::gt() %>% 
  gt::tab_header(
    title = 'CTS PC Missing Data',
    subtitle = 'By Participant')

cts_pc_remove <- cts_pc_miss %>% filter(miss_pct >= 20) %>% pull(id)
```

### CTS_PC Calculations 
```{r cts-pc calculation & sbuscale}

cts_pc_calc <-
  cts_pc %>%
    mutate(across(-c(id), as.numeric)) %>%
  mutate(
    across(
      .cols = -c(id),
      .fns = ~case_when(
        .x < -10 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

cts_pc_complete <-
  cts_pc_calc %>%
  # NVD items: 1,2,5,12
  mutate(
  # Raw Scoring for Nonviolent Discipline - Past Year (Chronicity)
         cts_pc_NVDP = rowSums(select(., 'a1_r', 'a2_r', 'a5_r', 'a12_r') * (select(., 'a1_r', 'a2_r', 'a5_r', 'a12_r') > 0), na.rm = TRUE),
  # Count of Nonviolent Discipline Responses 
        cts_pc_NVDC = rowSums(select(., a1_r, a2_r, a5_r, a12_r) > 0, na.rm = TRUE),
  # # Raw Scoring for Nonviolent Discipline Past Year - Mean (Chronicity)
        cts_pc_NVDM = ifelse(cts_pc_NVDC == 0 & cts_pc_NVDP == 0, 0, round(cts_pc_NVDP / cts_pc_NVDC, 2)),
  # Raw Scoring for Nonviolent Discipline Past Year (Prevalence) 
         cts_pc_NVDPP= rowSums(select(., 'a1_r', 'a2_r', 'a5_r', 'a12_r') > 0, na.rm = T), 
  # Raw Scoring for Nonviolent Discipline - Lifetime (Greater than past year Prevalence)
         cts_pc_NVDL = rowSums(select(., 'a1_r', 'a2_r', 'a5_r', 'a12_r') == -2, na.rm = T),  
  # Raw Scoring for Nonviolent Discipline (Ever Prevalence)
         cts_pc_NVDEP = cts_pc_NVDL + cts_pc_NVDPP 
) %>% 
  # PSA items: 6,8,9,10,14
    # Raw Scoring for Psychological Aggression - Past Year (Chronicity)
    mutate(
      cts_pc_PSAP = rowSums(select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') * (select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') > 0), na.rm = TRUE),
  # Count of Psychological Aggression Responses
      cts_pc_PSAC = rowSums(select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') > 0, na.rm = TRUE),
  # Raw Scoring for Psychological Aggression Past Year - Mean (Chronicity)
     cts_pc_PSAM = ifelse(cts_pc_PSAC == 0 & cts_pc_PSAP == 0, 0, round(cts_pc_PSAP / cts_pc_PSAC, 2)),
  #  Raw Scoring for Psychological Aggression - Past Year (Prevalence)
      cts_pc_PSAPP = rowSums(select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') > 0, na.rm = T),
  # Raw Scoring for Psychological Aggression Discipline - Lifetime (Ever Prevalence greater than past year)
      cts_pc_PSAL = rowSums(select(., 'a6_r', 'a8_r', 'a9_r', 'a10_r', 'a14_r') == -2, na.rm = T),
  # Raw Scoring for Psychological Aggression (Ever Prevalance)
      cts_pc_PSAEP = cts_pc_PSAL + cts_pc_PSAPP
    ) %>%
  # PHA Items: 3,4,7,11,13
  mutate(
  # Raw Scoring for Physical Assault - Past Year (Chronicity)
    cts_pc_PHAP = rowSums(select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') * (select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') > 0), na.rm = TRUE),
  # Count of Physical Assault Responses
    cts_pc_PHAC = rowSums(select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') > 0, na.rm = TRUE),
  # Raw Scoring for Physical Assault Past Year - Mean (Chronicity)
    cts_pc_PHAM = ifelse(cts_pc_PHAC == 0 & cts_pc_PHAP == 0, 0, round(cts_pc_PHAP / cts_pc_PHAC, 2)),
  # Raw Scoring for Physical Assault - Past Year (Prevalence)
    cts_pc_PHAPP =  rowSums(select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') > 0, na.rm = T),
  # Raw Scoring for Physical Assault - Lifetime (Ever Prevalence greater than 1 year)
    cts_pc_PHAL = rowSums(select(., 'a3_r', 'a4_r', 'a7_r', 'a11_r', 'a13_r') == -2, na.rm = T),
  # Raw Scoring for Physical Assault (Ever Prevalence)
    cts_pc_PHAEP = cts_pc_PHAL + cts_pc_PHAPP
  ) %>%
  # WKD Items: 16, 17, 18
  # It is correct for 15_r to be checked but not included in computations
  mutate(
    # Raw Scoring for Weekly Discipline - Past Week (Chronicity)
    cts_pc_WKDP = if_else(!is.na(a15_r) & !is.na(a16_r) & !is.na(a17_r) & !is.na(a18_r), 0, NA),
    cts_pc_WKDP = cts_pc_WKDP + ifelse(a16_r > 0, a16_r, 0) + ifelse(a17_r > 0, a17_r, 0) + ifelse(a18_r > 0, a18_r, 0),
    # Count of Weekly Discipline Responses
    cts_pc_WKDC = if_else(!is.na(a15_r) & !is.na(a16_r) & !is.na(a17_r) & !is.na(a18_r), 0, NA),
    cts_pc_WKDC = cts_pc_WKDC + ifelse(!is.na(a16_r), 1, 0) + ifelse(!is.na(a17_r), 1, 0) + ifelse(!is.na(a18_r), 1, 0),
    # Raw Scoring for Weekly Discipline Past Week - Mean (Chronicity)
    cts_pc_WKDM = ifelse(cts_pc_WKDC == 0 & cts_pc_WKDP == 0, 0, round(cts_pc_WKDP / cts_pc_WKDC, 2)),
    # Raw Scoring for Weekly Discipline - Past Week (Prevalence)
    cts_pc_WKDPP = rowSums(select(., 'a16_r', 'a17_r', 'a18_r') > 0, na.rm = T)
  )%>%
    # NEG Items: 19 20 21 22 23
  mutate(
    # Raw Scoring for Neglect - Past Year (Chronicity)
    cts_pc_NEGP = rowSums(select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') * (select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') > 0), na.rm = TRUE),
    # Count of Neglect Responses
    cts_pc_NEGC = rowSums(select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') > 0, na.rm = TRUE),
    # Raw Scoring for Neglect Past Year - Mean (Chronicity)
    cts_pc_NEGM = ifelse(cts_pc_NEGC == 0 & cts_pc_NEGP == 0, 0, round(cts_pc_NEGP / cts_pc_NEGC, 2)),
    # Raw Scoring for Neglect - Past Year (Prevalence)
    cts_pc_NEGPP = rowSums(select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') > 0, na.rm = T),
    # Raw Scoring for Neglect - Lifetime (Ever Prevalence)
    cts_pc_NEGL = rowSums(select(., 'a19_r', 'a20_r', 'a21_r', 'a22_r', 'a23_r') == -2, na.rm = T),
    # Raw Scoring for Neglect (Ever Prevalance)
    cts_pc_NEGEP = cts_pc_NEGL + cts_pc_NEGPP)


# finalize to add back in appropriate missing values
cts_pc_complete <- cts_pc_complete %>%
  rename_all(tolower) %>%
  mutate(across(c(a1:a23, a1_r:a23_r), ~ifelse(cts_parent_screen == 0, -55, ifelse(is.na(.), -77, as.numeric(.))))) %>%
  mutate(across(c(cts_pc_nvdp:cts_pc_negep), ~ifelse(cts_parent_screen == 0, -99, ifelse(is.na(.), -77, as.numeric(.)))))

```

## PCT - Pregnancy and Childbirth Trauma
### PCT Select Variable and Recode
```{r pct}
pct <- tpw_raw %>%
  select(id, p00a, starts_with("pct")) %>%
  mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    )
  )
```

### PCT Missing 
```{r pct_missing}
pct <- pct %>%  
  # if p00a is NO/0 or -77, the entire questionnaire was not administered because participant had no prior pregnancies
  mutate_at(vars(pct0), ~case_when(p00a == 0 | p00a == NA ~ "-55", TRUE ~ .)) %>%
  mutate_at(vars(pct1:pct3e), ~case_when(pct0 == "-55" ~ "-55", TRUE ~ .)) %>%
  # if pct1 is NO/0 or -77, the entire questionnaire was not administered because participant endorsed no prior traumatic pregnancies or childbirth experiences
   mutate_at(vars(pct2a:pct3e), ~case_when(pct1 == "0" ~ "-55", TRUE ~ .)) %>%
  # dropping pct2e and pct3e as all contain identifying child name and sometimes DOB; dropping pct0 as no new information from screener p00a; was only skip rule question
  select(-pct2e, -pct3e, -pct0) 



pct_miss <- pct %>%
  mutate(across(-c(id), as.numeric)) %>%
  pct_miss_fun(
    id = c("id"),
    n_items = 10
  )

pct_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'PCT Missing Data',
    subtitle = 'by Participant'
  )
# primarily missing due to not having prior pregnancy (p00a) or due to not having a traumatic childbirth (pct1)
pct_remove <- pct_miss %>% filter(miss_pct >= 20) %>% filter(id != "P836") %>% pull(id)
# above we retain P836 because they are only missing items from one subscale
```

PCT Calculation & Subscale 
```{r pct_calc}
# Below is the code that treats -77, -55 values as NA
pct_calc <-
  pct %>%
  mutate(across(-c(id), as.numeric)) %>%
  mutate(
    across(
      .cols = -c(id),
      .fns = ~case_when(
        .x < 0 ~ NA_real_,
        TRUE ~ .x
      )
    )
  )

# pct Composite & Subscale Score Creation 

pct_complete <- pct_calc %>%
  mutate(
    pct_preg_total = rowSums(select(., pct2a:pct2d), na.rm = TRUE),
    pct_childbirth_total = rowSums(select(., pct3a:pct3d), na.rm = TRUE)
  ) %>%
  # making those with missing data have appropriate missing data codes
  mutate(
    pct_preg_total = ifelse(p00a == 0, "-99", ifelse(is.na(pct_preg_total), "-99", as.character(pct_preg_total))),
  pct_childbirth_total = ifelse(p00a == 0, "-99", ifelse(is.na(pct_childbirth_total), "-99", as.character(pct_childbirth_total)))
  ) %>%
  # Adding back in -55 and -77
  mutate_at(vars(pct1:pct3d), ~ifelse(p00a == 0, "-55", as.character(.))) %>%
  mutate_at(vars(pct2a:pct3d), ~ifelse(pct1 == 0, "-55", as.character(.))) %>%
  mutate(
    pct3a = ifelse(id == "P836" & is.na(pct3a), -77, pct3a),
    pct3b = ifelse(id == "P836" & is.na(pct3b), -77, pct3b),
    pct3c = ifelse(id == "P836" & is.na(pct3c), -77, pct3c),
    pct3d = ifelse(id == "P836" & is.na(pct3d), -77, pct3d))
  

```

## Service Utilization Survey
### SUS Select Variable and Recode 
```{r sus}
sus <- tpw_raw %>%
  select(id, starts_with("sus")) %>%
  mutate(
    across(
      .cols = everything(),
      .fns = ~case_when(
        .x == "Yes" ~ "1",
        .x == "No" ~ "0",
        
        .x == "1. Hearing" ~ "1",
        .x == "2. Continuance" ~ "2",
        .x == "3. Court Monitoring" ~ "3",
        
        .x == "1. Yes, available and accessed" ~ "1",
        .x == "2. No, available but did not access" ~ "2",
        .x == "3. No, attempted to access but experienced a barrier" ~ "3",
        .x == "4. No, was not aware service was available" ~ "4",
        
        .x == "1. Physical" ~ "1",
        .x == "2. Mental/Psychological" ~ "2",
        .x == "3. Substance Use" ~ "3",
        
        .x == "Don't Know" ~ "-66",
        .x == "Decline to Answer" ~ "-77",
        .x == "5. Decline to answer" ~ "-77",
        TRUE ~ .x
      )
    )
  ) 


# Combine sus11b answer options to sus11b 
sus$sus11b <- apply(sus[, c("sus11b_1","sus11b_2","sus11b_3","sus11b_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus12b answer options to sus12b 
sus$sus12b <- apply(sus[, c("sus12b_1","sus12b_2","sus12b_3","sus12b_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14a answer options to sus14a 
sus$sus14a <- apply(sus[, c("sus14a_1","sus14a_2","sus14a_3","sus14a_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14b2 answer options to sus14b1 (this was labled wrong in Qualtric, it should be sus14b1) 
sus$sus14b1 <- apply(sus[, c("sus14b2_1","sus14b2_2","sus14b2_3","sus14b2_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14c1 answer options to sus14c1
sus$sus14c1 <- apply(sus[, c("sus14c1_1","sus14c1_2","sus14c1_3","sus14c1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14d1 answer options to sus14d1
sus$sus14d1 <- apply(sus[, c("sus14d1_1","sus14d1_2","sus14d1_3","sus14d1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14e1 answer options to sus14e1
sus$sus14e1 <- apply(sus[, c("sus14e1_1","sus14e1_2","sus14e1_3","sus14e1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14f1 answer options to sus14f1
sus$sus14f1 <- apply(sus[, c("sus14f1_1","sus14f1_2","sus14f1_3","sus14f1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14g1 answer options to sus14g1
sus$sus14g1 <- apply(sus[, c("sus14g1_1","sus14g1_2","sus14g1_3","sus14g1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14h1 answer options to sus14h1
sus$sus14h1 <- apply(sus[, c("sus14h1_1","sus14h1_2","sus14h1_3","sus14h1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14i1 answer options to sus14i1
sus$sus14i1 <- apply(sus[, c("sus14i1_1","sus14i1_2","sus14i1_3","sus14i1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14j1 answer options to sus14j1
sus$sus14j1 <- apply(sus[, c("sus14j1_1","sus14j1_2","sus14j1_3","sus14j1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14k1 answer options to sus14k1
sus$sus14k1 <- apply(sus[, c("sus14k1_1","sus14k1_2","sus14k1_3","sus14k1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14l1 answer options to sus14l1
sus$sus14l1 <- apply(sus[, c("sus14l1_1","sus14l1_2","sus14l1_3","sus14l1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14m1 answer options to sus14m1
sus$sus14m1 <- apply(sus[, c("sus14m1_1","sus14m1_2","sus14m1_3","sus14m1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14n1 answer options to sus14n1
sus$sus14n1 <- apply(sus[, c("sus14n1_1","sus14n1_2","sus14n1_3","sus14n1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus14o1 answer options to sus14o1
sus$sus14o1 <- apply(sus[, c("sus14o1_1","sus14o1_2","sus14o1_3","sus14o1_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))

# Combine sus26b answer options to sus26b
sus$sus26b <- apply(sus[, c("sus26b_1","sus26b_2","sus26b_3","sus26b_77")], 1, function(x) paste(x[!is.na(x)], collapse = ";"))




sus <- sus %>%
  relocate(sus11b, .after = "sus11a") %>%
  relocate(sus12b, .after = "sus12a") %>%
  relocate(sus14a, .after = "sus14") %>%
  relocate(sus14b1, .after = "sus14b") %>%
  relocate(sus14c1, .after = "sus14c") %>%
  relocate(sus14d1, .after = "sus14d") %>%
  relocate(sus14e1, .after = "sus14e") %>%
  relocate(sus14f1, .after = "sus14f") %>%
  relocate(sus14g1, .after = "sus14g") %>%
  relocate(sus14h1, .after = "sus14h") %>%
  relocate(sus14i1, .after = "sus14i") %>%
  relocate(sus14j1, .after = "sus14j") %>%
  relocate(sus14k1, .after = "sus14k") %>%
  relocate(sus14l1, .after = "sus14l") %>%
  relocate(sus14m1, .after = "sus14m") %>%
  relocate(sus14n1, .after = "sus14n") %>% 
  relocate(sus14o1, .after = "sus14o") %>%
  relocate(sus26b, .after = "sus26a") 
  
  
```

### SUS Missing
```{r sus_missing}
sus <- sus %>% 
  # sus-start; sus1:sus9 will not display if sus screen is not yes/1
  mutate_at(vars(sus_start, sus1:sus6, sus7:sus9), ~case_when(sus_screen != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus-start is 0/NA, sus1:sus7 were not asked.
  mutate_at(vars(sus1:sus7), ~case_when(sus_start == 0  ~ "-55", TRUE ~ .)) %>%
  
  # if sus6> 0, sus6a was not asked. 
  mutate_at(vars(sus6a), ~case_when(sus6 <=0 ~ "-55", TRUE ~ .)) %>%
  # if sus6> 1, sus6b was not asked. 
  mutate_at(vars(sus6b), ~case_when(sus6 <=1 ~ "-55", TRUE ~ .)) %>%
  # if sus6> 2, sus6c was not asked. 
  mutate_at(vars(sus6c), ~case_when(sus6 <=2 ~ "-55", TRUE ~ .)) %>%
  
  # if sus8 is not yes/1, sus9:sus10j weren't asked 
  mutate_at(vars(sus9:sus10j), ~case_when(sus8 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 0, sus10a is not asked 
  mutate_at(vars(sus10a), ~case_when(sus9 <= 0 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 1, sus10b is not asked 
  mutate_at(vars(sus10b), ~case_when(sus9 <= 1 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 2, sus10c is not asked 
  mutate_at(vars(sus10c), ~case_when(sus9 <= 2 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 3, sus10d is not asked 
  mutate_at(vars(sus10d), ~case_when(sus9 <= 3 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 4, sus10e is not asked 
  mutate_at(vars(sus10e), ~case_when(sus9 <= 4 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 5, sus10f is not asked 
  mutate_at(vars(sus10f), ~case_when(sus9 <= 5 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 6, sus10g is not asked 
  mutate_at(vars(sus10g), ~case_when(sus9 <= 6 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 7, sus10h is not asked 
  mutate_at(vars(sus10h), ~case_when(sus9 <= 7 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 8, sus10i is not asked 
  mutate_at(vars(sus10i), ~case_when(sus9 <= 8 ~ "-55", TRUE ~ .)) %>%
  # if sus9 is <= 9, sus10j is not asked 
  mutate_at(vars(sus10j), ~case_when(sus9 <= 9 ~ "-55", TRUE ~ .)) %>%
  # if sus11 is 2/4/5..  sus11a:sus11c weren't asked 
  mutate_at(vars(sus11a:sus11c), ~case_when(sus11 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus11 is 3..  sus11a:sus11b weren't asked 
  mutate_at(vars(sus11a:sus11c), ~case_when(sus11 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus11 is not 3, sus11c was not asked
  mutate_at(vars(sus11c), ~case_when(sus11 != 3 ~ "-55", TRUE ~ .)) %>%
  # if sus12 is 2,4,5, sus12a:sus12c were not asked
  mutate_at(vars(sus12a:sus12c), ~case_when(sus12 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus12 is 3..  sus12a:sus12b weren't asked 
  mutate_at(vars(sus12a:sus12b_77), ~case_when(sus12 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus12 is not 3, sus12c was not asked
  mutate_at(vars(sus12c), ~case_when(sus12 != 3 ~ "-55", TRUE ~ .)) %>%
  #mutate(across(c(sus13a, sus13), as.numeric), TRUE ~ NA_real_) %>%
  # if sus13a is NA then it's TC decline to answer and should be -77
  mutate(across(
      .cols = sus13a,
      .fns = ~case_when(is.na(.x) ~ "-77", TRUE ~ .x)
  ))%>%
  # if sus13 is 2,4,5, sus13a:sus14o2 were not asked
  mutate_at(vars(sus13a:sus14o2), ~case_when(sus13 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus13 is 3..  sus13a weren't asked 
  mutate_at(vars(sus13a), ~case_when(sus13 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus13 is not 3, sus13b was not asked
  mutate_at(vars(sus13b), ~case_when(sus13 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus13a is <=0 and sus13 != 1, sus14:sus14a1 were not asked 
  mutate_at(vars(sus14:sus14a1), ~case_when(sus13a <=0 | sus13 != 1 ~ "-55", TRUE ~ .)) %>% 
  # if sus13a is <=1 and sus13 != 1, sus14b:sus14b2  were not asked 
  mutate_at(vars(sus14b:sus14b2), ~case_when(sus13a <=1 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # TODO: Maria, sus14b2_1:sus14b2_77 is for question 14b1, do you want me correct this?
  # if sus13a is <=2 and sus13 != 1, sus14c:sus14c2 were not asked 
  mutate_at(vars(sus14c:sus14c2), ~case_when(sus13a <=2 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=3 and sus13 != 1, sus14d:sus14d2  were not asked 
  mutate_at(vars(sus14d:sus14d2), ~case_when(sus13a <=3 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=4 and sus13 != 1, sus14e:sus14e2  were not asked
  mutate_at(vars(sus14e:sus14e2), ~case_when(sus13a <=4 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=5 and sus13 != 1, sus14f:sus14f2  were not asked
  mutate_at(vars(sus14f:sus14f2), ~case_when(sus13a <=5 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=6 and sus13 != 1, sus14g:sus14g2  were not asked
  mutate_at(vars(sus14g:sus14g2), ~case_when(sus13a <=6 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=7 and sus13 != 1, sus14h:sus14h2  were not asked
  mutate_at(vars(sus14h:sus14h2), ~case_when(sus13a <=7 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=8 and sus13 != 1, sus14i:sus14i2  were not asked
  mutate_at(vars(sus14i:sus14i2), ~case_when(sus13a <=8 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=9 and sus13 != 1, sus14j:sus14j2  were not asked
  mutate_at(vars(sus14j:sus14j2), ~case_when(sus13a <=9 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=10 and sus13 != 1, sus14k:sus14k2  were not asked 
  #TODO: I can't figure out why from k : o doesn't work
  mutate_at(vars(sus14k:sus14k2), ~case_when(sus13a <=10 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=11 and sus13 != 1, sus14l:sus14l2  were not asked 
  mutate_at(vars(sus14l:sus14l2), ~case_when(sus13a <=11 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=12 and sus13 != 1, sus14m:sus14m2  were not asked 
  mutate_at(vars(sus14m:sus14m2), ~case_when(sus13a <=12 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=13 and sus13 != 1, sus14n:sus14n2  were not asked 
  mutate_at(vars(sus14n:sus14n2), ~case_when(sus13a <=13 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%
  # if sus13a is <=14 and sus13 != 1, sus14o:sus14o2  were not asked 
  mutate_at(vars(sus14o:sus14o2), ~case_when(sus13a <=14 | sus13 != 1 ~ "-55", TRUE ~ .)) %>%

  # if sus15 is 2,4,5, sus15a:sus15b were not asked
  mutate_at(vars(sus15a:sus15), ~case_when(sus15 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus15 is 3..  sus15a weren't asked 
  mutate_at(vars(sus15a), ~case_when(sus15 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus15 is not 3, sus15b was not asked
  mutate_at(vars(sus15b), ~case_when(sus15 != 3 ~ "-55", TRUE ~ .)) %>%
  
  # if sus16 is 2,4,5, sus16a:sus16b were not asked
  mutate_at(vars(sus16a:sus16b), ~case_when(sus16 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus16 is 3..  sus16a weren't asked 
  mutate_at(vars(sus16a), ~case_when(sus16 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus16 is not 3, sus16b was not asked
  mutate_at(vars(sus16b), ~case_when(sus16 != 3 ~ "-55", TRUE ~ .)) %>%
  
  # if sus17 is 2,4,5, sus17a:sus17b were not asked
  mutate_at(vars(sus17a:sus17b), ~case_when(sus17 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus17 is 3..  sus17a weren't asked 
  mutate_at(vars(sus17a), ~case_when(sus17 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus17 is not 3, sus17b was not asked
  mutate_at(vars(sus17b), ~case_when(sus17 != 3 ~ "-55", TRUE ~ .)) %>%
 
  # if sus19 is 2,4,5, sus19a:sus19b were not asked
  mutate_at(vars(sus19a:sus19b), ~case_when(sus19 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus19 is 3..  sus19a weren't asked 
  mutate_at(vars(sus19a), ~case_when(sus19 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus19 is not 3, sus19b was not asked
  mutate_at(vars(sus19b), ~case_when(sus19 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus20 is 2,4,5, sus20a:sus20b were not asked
  mutate_at(vars(sus20a:sus20b), ~case_when(sus20 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus20 is 3..  sus20a weren't asked 
  mutate_at(vars(sus20a), ~case_when(sus20 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus20 is not 3, sus20b was not asked
  mutate_at(vars(sus20b), ~case_when(sus20 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus21 is 2,4,5, sus21a:sus21b were not asked
  mutate_at(vars(sus21a:sus21b), ~case_when(sus21 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus21 is 3..  sus21a weren't asked 
  mutate_at(vars(sus21a), ~case_when(sus21 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus21 is not 3, sus20b was not asked
  mutate_at(vars(sus21b), ~case_when(sus21 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus22 is 2,4,5, sus22a:sus22b were not asked
  mutate_at(vars(sus22a:sus22b), ~case_when(sus22 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus22 is 3..  sus22a weren't asked 
  mutate_at(vars(sus22a), ~case_when(sus22 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus22 is not 3, sus20b was not asked
  mutate_at(vars(sus22b), ~case_when(sus22 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus23 is 2,4,5, sus23a:sus23b were not asked
  mutate_at(vars(sus23a:sus23b), ~case_when(sus23 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus23 is 3..  sus23a weren't asked 
  mutate_at(vars(sus23a), ~case_when(sus23 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus23 is not 3, sus23b was not asked
  mutate_at(vars(sus23b), ~case_when(sus23 != 3 ~ "-55", TRUE ~ .)) %>%
  
  # if sus24 is 2,4,5, sus24a:sus24b were not asked
  mutate_at(vars(sus24a:sus24b), ~case_when(sus24 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus24 is 3..  sus24a weren't asked 
  mutate_at(vars(sus24a), ~case_when(sus24 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus24 is not 3, sus24b was not asked
  mutate_at(vars(sus24b), ~case_when(sus24 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus25 is 2,4,5, sus25a:sus25b were not asked
  mutate_at(vars(sus25a:sus25b), ~case_when(sus25 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus25 is 3..  sus25a weren't asked 
  mutate_at(vars(sus25a), ~case_when(sus25 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus25 is not 3, sus25b was not asked
  mutate_at(vars(sus25b), ~case_when(sus25 != 3 ~ "-55", TRUE ~ .)) %>%

  # if sus26 is 2,4,5, sus26a:sus26c were not asked
  mutate_at(vars(sus26a:sus26c), ~case_when(sus26 %in%c(2,4,-77) ~ "-55", TRUE ~ .)) %>%
  # if sus26 is 3..  sus26a:sus26b weren't asked 
  mutate_at(vars(sus26a:sus26b_77), ~case_when(sus26 == 3 ~ "-55", TRUE ~ .)) %>%
  # if sus26 is not 3, sus26b was not asked
  mutate_at(vars(sus26b_77), ~case_when(sus26 != 3 ~ "-55", TRUE ~ .)) %>%
    # we have missing due to partial finish
  mutate(across(-id, ~ifelse(id == "HR173", -99, .))) %>%
  select(-c("sus11b_1","sus11b_2","sus11b_3","sus11b_77")) %>%
  select(-c("sus12b_1","sus12b_2","sus12b_3","sus12b_77")) %>%
  select(-c("sus14a_1","sus14a_2","sus14a_3","sus14a_77")) %>%
  select(-c("sus14b2_1","sus14b2_2","sus14b2_3","sus14b2_77")) %>%
  select(-c("sus14c1_1","sus14c1_2","sus14c1_3","sus14c1_77")) %>%
  select(-c("sus14d1_1","sus14d1_2","sus14d1_3","sus14d1_77")) %>%
  select(-c("sus14e1_1","sus14e1_2","sus14e1_3","sus14e1_77")) %>%
  select(-c("sus14f1_1","sus14f1_2","sus14f1_3","sus14f1_77")) %>%
  select(-c("sus14g1_1","sus14g1_2","sus14g1_3","sus14g1_77")) %>%
  select(-c("sus14h1_1","sus14h1_2","sus14h1_3","sus14h1_77")) %>%
  select(-c("sus14i1_1","sus14i1_2","sus14i1_3","sus14i1_77")) %>%
  select(-c("sus14j1_1","sus14j1_2","sus14j1_3","sus14j1_77")) %>%
  select(-c("sus14k1_1","sus14k1_2","sus14k1_3","sus14k1_77")) %>%
  select(-c("sus14l1_1","sus14l1_2","sus14l1_3","sus14l1_77")) %>%
  select(-c("sus14m1_1","sus14m1_2","sus14m1_3","sus14m1_77")) %>%
  select(-c("sus14n1_1","sus14n1_2","sus14n1_3","sus14n1_77")) %>%
  select(-c("sus14o1_1","sus14o1_2","sus14o1_3","sus14o1_77")) %>%
  select(-c("sus26b_1","sus26b_2","sus26b_3","sus26b_77"))

## Now we will drop columns that have no data (only -55)
# Check if every value in each column is equal to -55 or -99 or -77 or some combo thereof
columns_to_drop <- names(sus)[sapply(sus, function(col) 
  all(col %in% c("-55", "-99", "-77")) || 
  all(col == "-55") || 
  all(col == "-99") || 
  all(col == "-77") || 
  (all(col %in% c("-55", "-99")) && any(col %in% "-77")) || 
  (all(col %in% c("-55", "-77")) && any(col %in% "-99")) || 
  (all(col %in% c("-99", "-77")) && any(col %in% "-55"))
)]


# Drop the columns where every value is -55 or -99 or -77 or combo
# this should drop 10 empty comlumns
sus <- sus[, !names(sus) %in% columns_to_drop]

## Min there are still NA values and empty values in the dataset we need to check
## Note for Maria -- need to remove and recode 6a,6b, and 6c
## Maria export to csv and double code with Kaylee
## notes here
# P865 (add count of 2 to sus1)
# P856 (add count of 3 to sus 4)
# P887 (add count of 1 to sus 1)
# P849 (add count of 3 to sus 1)
# P854 (add count of 1 to new sus 7 variable should reflect contact for child in my care, not my own child another persons DHS coase)
# P882 (add count of 2 to sus 1)
# P867 (Add count of 3 to sus 1)
# P902 (Add count of 1 to sus 1)
# P845 (add count of 3 to sus 2)
# HR 194 (Add count of 1 to new cat 7)
# HR204 (Add count of 3 to sus 2)
# HR131 (add count of 3 to sus 4)
# HR 175 (add count of 3 to sus 4)
#HR 171 (add count of 1 to sus 3)
# P805 add count of 3 to sus 7
#P829 add count of 1 to sus 7
#P890 add count of 1 to sus 1
sus_miss <- sus %>%
    mutate(across(-c(id), as.numeric))%>%
  pct_miss_fun(
    id = c("id", -matches("\\d$")),
    n_items = 24
  )

## MIN we need to remove all 14 and associated variable from the archive file; we can create an internal archive file where we retain them, see notes in spreadsheet
```


## PCL 
### PCL Select Variable and Recode 

```{r plc }
pcl <- tpw_raw %>%
  select(id, starts_with("pcl")) %>% 
  # Happened and Witnessed first developed period 
  mutate(pcl1_hapWit_dev = combine_columns(., c("pcl1a_1", "pcl1a_2", "pcl1a_3", "pcl1a_4", "pcl1a_77"), sep = ";") )%>%
  mutate(pcl1_hapWit_dev = str_extract(pcl1_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl1_hapWit_dev, .after = "pcl1a_77") %>%
  mutate(pcl2_hapWit_dev = combine_columns(., c("pcl2a_1", "pcl2a_2", "pcl2a_3", "pcl2a_4", "pcl2a_77"), sep = ";") )%>%
  mutate(pcl2_hapWit_dev = str_extract(pcl2_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl2_hapWit_dev, .after = "pcl2a_77") %>%
  mutate(pcl3_hapWit_dev = combine_columns(., c("pcl3a_1", "pcl3a_2", "pcl3a_3", "pcl3a_4", "pcl3a_77"), sep = ";") )%>%
  mutate(pcl3_hapWit_dev = str_extract(pcl3_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl3_hapWit_dev, .after = "pcl3a_77") %>%
  mutate(pcl4_hapWit_dev = combine_columns(., c("pcl4a_1", "pcl4a_2", "pcl4a_3", "pcl4a_4", "pcl4a_77"), sep = ";") )%>%
  mutate(pcl4_hapWit_dev = str_extract(pcl4_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl4_hapWit_dev, .after = "pcl4a_77") %>%
  mutate(pcl5_hapWit_dev = combine_columns(., c("pcl5a_1", "pcl5a_2", "pcl5a_3", "pcl5a_4", "pcl5a_77"), sep = ";") )%>%
  mutate(pcl5_hapWit_dev = str_extract(pcl5_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl5_hapWit_dev, .after = "pcl5a_77") %>%
  mutate(pcl6_hapWit_dev = combine_columns(., c("pcl6a_1", "pcl6a_2", "pcl6a_3", "pcl6a_4", "pcl6a_77"), sep = ";") )%>%
  mutate(pcl6_hapWit_dev = str_extract(pcl6_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl6_hapWit_dev, .after = "pcl6a_77") %>%
  mutate(pcl7_hapWit_dev = combine_columns(., c("pcl7a_1", "pcl7a_2", "pcl7a_3", "pcl7a_4", "pcl7a_77"), sep = ";") )%>%
  mutate(pcl7_hapWit_dev = str_extract(pcl7_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl7_hapWit_dev, .after = "pcl7a_77") %>%
  mutate(pcl8_hapWit_dev = combine_columns(., c("pcl8a_1", "pcl8a_2", "pcl8a_3", "pcl8a_4", "pcl8a_77"), sep = ";") )%>%
  mutate(pcl8_hapWit_dev = str_extract(pcl8_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl8_hapWit_dev, .after = "pcl8a_77") %>%
  mutate(pcl9_hapWit_dev = combine_columns(., c("pcl9a_1", "pcl9a_2", "pcl9a_3", "pcl9a_4", "pcl9a_77"), sep = ";") )%>%
  mutate(pcl9_hapWit_dev = str_extract(pcl9_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl9_hapWit_dev, .after = "pcl9a_77") %>%
  mutate(pcl10_hapWit_dev = combine_columns(., c("pcl10a_1", "pcl10a_2", "pcl10a_3", "pcl10a_4", "pcl10a_77"), sep = ";") )%>%
  mutate(pcl10_hapWit_dev = str_extract(pcl10_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl10_hapWit_dev, .after = "pcl10a_77") %>%
  mutate(pcl11_hapWit_dev = combine_columns(., c("pcl11a_1", "pcl11a_2", "pcl11a_3", "pcl11a_4", "pcl11a_77"), sep = ";") )%>%
  mutate(pcl11_hapWit_dev = str_extract(pcl11_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl11_hapWit_dev, .after = "pcl11a_77") %>%
  mutate(pcl12_hapWit_dev = combine_columns(., c("pcl12a_1", "pcl12a_2", "pcl12a_3", "pcl12a_4", "pcl12a_77"), sep = ";") )%>%
  mutate(pcl12_hapWit_dev = str_extract(pcl12_hapWit_dev, "^[^;]+")) %>%
  relocate(pcl12_hapWit_dev, .after = "pcl12a_77") %>%
  
  ## MIN check why does the above code end at 12 instead of going to 19?
  
  #===========================Developmental Period for "Happened to me" only ============================
  # please note this is developmental period for "Happen to me" is not accurate. Because we asked TC "how old were you when this occurred" ( they don't have a chance to specify weather this was witnessed or actually happened to them. The following code created first development period for happened to me only, i.e.: if someone selected both happen to me and witness, and they indicated it's during 0-5 years old, the only happen to me development period would be 0-5, but we don't know for sure weather that happened to them or they witnessed during this first dev period. 

## Min do you suggest we remove this then given the above? Call me tomorrow if we need to talk
  mutate(
    pcl1_devperiod = factor(
      case_when(
        !is.na(pcl1a_1) & pcl1_1 == "Happened to me" ~ "0-5",
        is.na(pcl1a_1) & !is.na(pcl1a_2) & pcl1_1 == "Happened to me" ~ "6-11",
        is.na(pcl1a_1) & is.na(pcl1a_2) & !is.na(pcl1_3) & pcl1_1 == "Happened to me" ~ "12-19",
        is.na(pcl1a_1) & is.na(pcl1a_2) & is.na(pcl1a_3) & !is.na(pcl1a_4) & pcl1_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl2_devperiod = factor(
      case_when(
        !is.na(pcl2a_1) & pcl2_1 == "Happened to me" ~ "0-5",
        is.na(pcl2a_1) & !is.na(pcl2a_2) & pcl2_1 == "Happened to me" ~ "6-11",
        is.na(pcl2a_1) & is.na(pcl2a_2) & !is.na(pcl2_3) & pcl2_1 == "Happened to me" ~ "12-19",
        is.na(pcl2a_1) & is.na(pcl2a_2) & is.na(pcl2a_3) & !is.na(pcl2a_4) & pcl2_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl3_devperiod = factor(
      case_when(
        !is.na(pcl3a_1) & pcl3_1 == "Happened to me" ~ "0-5",
        is.na(pcl3a_1) & !is.na(pcl3a_2) & pcl3_1 == "Happened to me" ~ "6-11",
        is.na(pcl3a_1) & is.na(pcl3a_2) & !is.na(pcl3_3) & pcl3_1 == "Happened to me" ~ "12-19",
        is.na(pcl3a_1) & is.na(pcl3a_2) & is.na(pcl3a_3) & !is.na(pcl3a_4) & pcl3_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl4_devperiod = factor(
      case_when(
        !is.na(pcl4a_1) & pcl4_1 == "Happened to me" ~ "0-5",
        is.na(pcl4a_1) & !is.na(pcl4a_2) & pcl4_1 == "Happened to me" ~ "6-11",
        is.na(pcl4a_1) & is.na(pcl4a_2) & !is.na(pcl4_3) & pcl4_1 == "Happened to me" ~ "12-19",
        is.na(pcl4a_1) & is.na(pcl4a_2) & is.na(pcl4a_3) & !is.na(pcl4a_4) & pcl4_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl5_devperiod = factor(
      case_when(
        !is.na(pcl5a_1) & pcl5_1 == "Happened to me" ~ "0-5",
        is.na(pcl5a_1) & !is.na(pcl5a_2) & pcl5_1 == "Happened to me" ~ "6-11",
        is.na(pcl5a_1) & is.na(pcl5a_2) & !is.na(pcl5_3) & pcl5_1 == "Happened to me" ~ "12-19",
        is.na(pcl5a_1) & is.na(pcl5a_2) & is.na(pcl5a_3) & !is.na(pcl5a_4) & pcl5_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl6_devperiod = factor(
      case_when(
        !is.na(pcl6a_1) & pcl6_1 == "Happened to me" ~ "0-5",
        is.na(pcl6a_1) & !is.na(pcl6a_2) & pcl6_1 == "Happened to me" ~ "6-11",
        is.na(pcl6a_1) & is.na(pcl6a_2) & !is.na(pcl6_3) & pcl6_1 == "Happened to me" ~ "12-19",
        is.na(pcl6a_1) & is.na(pcl6a_2) & is.na(pcl6a_3) & !is.na(pcl6a_4) & pcl6_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl7_devperiod = factor(
      case_when(
        !is.na(pcl7a_1) & pcl7_1 == "Happened to me" ~ "0-5",
        is.na(pcl7a_1) & !is.na(pcl7a_2) & pcl7_1 == "Happened to me" ~ "6-11",
        is.na(pcl7a_1) & is.na(pcl7a_2) & !is.na(pcl7_3) & pcl7_1 == "Happened to me" ~ "12-19",
        is.na(pcl7a_1) & is.na(pcl7a_2) & is.na(pcl7a_3) & !is.na(pcl7a_4) & pcl7_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl8_devperiod = factor(
      case_when(
        !is.na(pcl8a_1) & pcl8_1 == "Happened to me" ~ "0-5",
        is.na(pcl8a_1) & !is.na(pcl8a_2) & pcl8_1 == "Happened to me" ~ "6-11",
        is.na(pcl8a_1) & is.na(pcl8a_2) & !is.na(pcl8_3) & pcl8_1 == "Happened to me" ~ "12-19",
        is.na(pcl8a_1) & is.na(pcl8a_2) & is.na(pcl8a_3) & !is.na(pcl8a_4) & pcl8_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl9_devperiod = factor(
      case_when(
        !is.na(pcl9a_1) & pcl9_1 == "Happened to me" ~ "0-5",
        is.na(pcl9a_1) & !is.na(pcl9a_2) & pcl9_1 == "Happened to me" ~ "6-11",
        is.na(pcl9a_1) & is.na(pcl9a_2) & !is.na(pcl9_3) & pcl9_1 == "Happened to me" ~ "12-19",
        is.na(pcl9a_1) & is.na(pcl9a_2) & is.na(pcl9a_3) & !is.na(pcl9a_4) & pcl9_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl10_devperiod = factor(
      case_when(
        !is.na(pcl10a_1) & pcl10_1 == "Happened to me" ~ "0-5",
        is.na(pcl10a_1) & !is.na(pcl10a_2) & pcl10_1 == "Happened to me" ~ "6-11",
        is.na(pcl10a_1) & is.na(pcl10a_2) & !is.na(pcl10_3) & pcl10_1 == "Happened to me" ~ "12-19",
        is.na(pcl10a_1) & is.na(pcl10a_2) & is.na(pcl10a_3) & !is.na(pcl10a_4) & pcl10_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl11_devperiod = factor(
      case_when(
        !is.na(pcl11a_1) & pcl11_1 == "Happened to me" ~ "0-5",
        is.na(pcl11a_1) & !is.na(pcl11a_2) & pcl11_1 == "Happened to me" ~ "6-11",
        is.na(pcl11a_1) & is.na(pcl11a_2) & !is.na(pcl11_3) & pcl11_1 == "Happened to me" ~ "12-19",
        is.na(pcl11a_1) & is.na(pcl11a_2) & is.na(pcl11a_3) & !is.na(pcl11a_4) & pcl11_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl12_devperiod = factor(
      case_when(
        !is.na(pcl12a_1) & pcl12_1 == "Happened to me" ~ "0-5",
        is.na(pcl12a_1) & !is.na(pcl12a_2) & pcl12_1 == "Happened to me" ~ "6-11",
        is.na(pcl12a_1) & is.na(pcl12a_2) & !is.na(pcl12_3) & pcl12_1 == "Happened to me" ~ "12-19",
        is.na(pcl12a_1) & is.na(pcl12a_2) & is.na(pcl12a_3) & !is.na(pcl12a_4) & pcl12_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl13_devperiod = factor(
      case_when(
        !is.na(pcl13a_1) & pcl13_1 == "Happened to me" ~ "0-5",
        is.na(pcl13a_1) & !is.na(pcl13a_2) & pcl13_1 == "Happened to me" ~ "6-11",
        is.na(pcl13a_1) & is.na(pcl13a_2) & !is.na(pcl13_3) & pcl13_1 == "Happened to me" ~ "12-19",
        is.na(pcl13a_1) & is.na(pcl13a_2) & is.na(pcl13a_3) & !is.na(pcl13a_4) & pcl13_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl14_devperiod = factor(
      case_when(
        !is.na(pcl14a_1) & pcl14_1 == "Happened to me" ~ "0-5",
        is.na(pcl14a_1) & !is.na(pcl14a_2) & pcl14_1 == "Happened to me" ~ "6-11",
        is.na(pcl14a_1) & is.na(pcl14a_2) & !is.na(pcl14_3) & pcl14_1 == "Happened to me" ~ "12-19",
        is.na(pcl14a_1) & is.na(pcl14a_2) & is.na(pcl14a_3) & !is.na(pcl14a_4) & pcl14_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl15_devperiod = factor(
      case_when(
        !is.na(pcl15a_1) & pcl15_1 == "Happened to me" ~ "0-5",
        is.na(pcl15a_1) & !is.na(pcl15a_2) & pcl15_1 == "Happened to me" ~ "6-11",
        is.na(pcl15a_1) & is.na(pcl15a_2) & !is.na(pcl15_3) & pcl15_1 == "Happened to me" ~ "12-19",
        is.na(pcl15a_1) & is.na(pcl15a_2) & is.na(pcl15a_3) & !is.na(pcl15a_4) & pcl15_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl16_devperiod = factor(
      case_when(
        !is.na(pcl16a_1) & pcl16_1 == "Happened to me" ~ "0-5",
        is.na(pcl16a_1) & !is.na(pcl16a_2) & pcl16_1 == "Happened to me" ~ "6-11",
        is.na(pcl16a_1) & is.na(pcl16a_2) & !is.na(pcl16_3) & pcl16_1 == "Happened to me" ~ "12-19",
        is.na(pcl16a_1) & is.na(pcl16a_2) & is.na(pcl16a_3) & !is.na(pcl16a_4) & pcl16_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl17_devperiod = factor(
      case_when(
        !is.na(pcl17a_1) & pcl17_1 == "Happened to me" ~ "0-5",
        is.na(pcl17a_1) & !is.na(pcl17a_2) & pcl17_1 == "Happened to me" ~ "6-11",
        is.na(pcl17a_1) & is.na(pcl17a_2) & !is.na(pcl17_3) & pcl17_1 == "Happened to me" ~ "12-19",
        is.na(pcl17a_1) & is.na(pcl17a_2) & is.na(pcl17a_3) & !is.na(pcl17a_4) & pcl17_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl18_devperiod = factor(
      case_when(
        !is.na(pcl18a_1) & pcl18_1 == "Happened to me" ~ "0-5",
        is.na(pcl18a_1) & !is.na(pcl18a_2) & pcl18_1 == "Happened to me" ~ "6-11",
        is.na(pcl18a_1) & is.na(pcl18a_2) & !is.na(pcl18_3) & pcl18_1 == "Happened to me" ~ "12-19",
        is.na(pcl18a_1) & is.na(pcl18a_2) & is.na(pcl18a_3) & !is.na(pcl18a_4) & pcl18_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    ),
    pcl19_devperiod = factor(
      case_when(
        !is.na(pcl19a_1) & pcl19_1 == "Happened to me" ~ "0-5",
        is.na(pcl19a_1) & !is.na(pcl19a_2) & pcl19_1 == "Happened to me" ~ "6-11",
        is.na(pcl19a_1) & is.na(pcl19a_2) & !is.na(pcl19_3) & pcl19_1 == "Happened to me" ~ "12-19",
        is.na(pcl19a_1) & is.na(pcl19a_2) & is.na(pcl19a_3) & !is.na(pcl19a_4) & pcl19_1 == "Happened to me" ~ "adulthood",
        TRUE ~ NA_character_
      ),
      levels = c("0-5", "6-11", "12-19", "adulthood")
    )
  )





pcl <- pcl %>%
  mutate(
    # Re-coding 
    across(
      .cols = c(matches("^pcl\\d+_\\d+")),
      .fns = ~case_when(
        .x == "Happened to me" ~ "1",
        .x == "Witnessed it" ~ "1",
        .x == "Learned about it" ~ "1",
        ## Because Not Happen will be in its own column, so coded as 1 to indicate it not happened
        .x == "No (did not happen)" ~ "1",
        .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
    .cols = c(matches("^pcl\\d+a_\\d+")),
      .fns = ~case_when(
         .x == "Ages 0-5" ~ "1",
         .x == "Ages 6-11" ~ "1",
         .x == "Ages 12-19" ~ "1",
         .x == "Adulthood" ~ "1",
         .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(matches("^pcl\\d+_hapWit_dev")),
      .fns = ~case_when(
        .x == "Ages 0-5" ~ "1",
         .x == "Ages 6-11" ~ "2",
         .x == "Ages 12-19" ~ "3",
         .x == "Adulthood" ~ "4",
         .x == "Decline to Answer" ~ "-77",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(matches("^pcl\\d+b\\d+")),
      .fns = ~ case_when(
        .x == "None - did not experience" ~ "0", 
        .x == "1 time ever" ~ "1",
        .x == "2 or more times: Specify" ~ "2",
        .x == "1-2 month" ~ "3",
        .x == "1-2 times per week" ~ "4",
        .x == "2-3 times each week" ~ "5",
        .x == "Almost daily" ~ "6",
        .x == "Decline to Answer" ~ "7",
        TRUE ~ .x
      )
    ),
    across(
      .cols = c(matches("devperiod$")),
      .fns = ~ case_when(
        .x == "0-5" ~ "0", 
        .x == "6-11" ~ "1",
        .x == "12-19" ~ "2",
        .x == "adulthood" ~ "3",
        TRUE ~ .x
    )
  )
  )%>%
  #rename column names to reflect what happened to this situation.
  rename_with(
    .fn = ~ gsub("pcl(\\d+)_1", "pcl\\1_happen", .),
    .cols = matches("pcl\\d+_1")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)_2", "pcl\\1_witness", .),
    .cols = matches("pcl\\d+_2")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)_3", "pcl\\1_learn", .),
    .cols = matches("pcl\\d+_3")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)_4", "pcl\\1_no", .),
    .cols = matches("pcl\\d+_4")
  ) %>%
  # rename column names to reflect when was this situation developed 
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_1", "pcl\\1_hapWit_ages_0_5", .),
    .cols = matches("pcl\\d+a_1")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_2", "pcl\\1_hapWit_ages_6_11", .),
    .cols = matches("pcl\\d+a_2")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_3", "pcl\\1_hapWit_ages_12_19", .),
    .cols = matches("pcl\\d+a_3")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_4", "pcl\\1_hapWit_adulthood", .),
    .cols = matches("pcl\\d+a_4")
  ) %>%
  rename_with(
    .fn = ~ gsub("pcl(\\d+)a_77", "pcl\\1_hapWit_ages_77", .),
    .cols = matches("pcl\\d+a_77")
  ) %>%
  # combine multiple choice question columns 
  # PCL1
  mutate(pcl1c1 = combine_columns(., c("pcl1c1_1", "pcl1c1_2", "pcl1c1_3", "pcl1c1_9999", "pcl1c1_77"), sep = ";") )%>%
  mutate(pcl1c2 = combine_columns(., c("pcl1c2_1", "pcl1c2_2", "pcl1c2_3", "pcl1c2_9999", "pcl1c2_77"), sep = ";") )%>%
  mutate(pcl1c3 = combine_columns(., c("pcl1c3_1", "pcl1c3_2", "pcl1c3_3", "pcl1c3_9999", "pcl1c3_77"), sep = ";") )%>%
  mutate(pcl1c4 = combine_columns(., c("pcl1c4_1", "pcl1c4_2", "pcl1c4_3", "pcl1c4_9999", "pcl1c4_77"), sep = ";") )%>%
  mutate(pcl1d = combine_columns(., c("pcl1d_1", "pcl1d_2", "pcl1d_3", "pcl1d_77"), sep = ";") )%>%
  relocate(pcl1c1, .after = "pcl1c1_77") %>%
  relocate(pcl1c2, .after = "pcl1c2_77") %>%
  relocate(pcl1c3, .after = "pcl1c3_77") %>%
  relocate(pcl1c4, .after = "pcl1c4_77") %>%
  relocate(pcl1d, .after = "pcl1d_77") %>%
  select(-c("pcl1c1_1", "pcl1c1_2", "pcl1c1_3", "pcl1c1_9999", "pcl1c1_77",
            "pcl1c2_1", "pcl1c2_2", "pcl1c2_3", "pcl1c2_9999", "pcl1c2_77",
            "pcl1c3_1", "pcl1c3_2", "pcl1c3_3", "pcl1c3_9999", "pcl1c3_77",
            "pcl1c4_1", "pcl1c4_2", "pcl1c4_3", "pcl1c4_9999", "pcl1c4_77",
            "pcl1d_1", "pcl1d_2", "pcl1d_3", "pcl1c1_77")) %>%
  # PCL2
  mutate(pcl2c1 = combine_columns(., c("pcl2c1_1", "pcl2c1_2", "pcl2c1_3", "pcl2c1_9999", "pcl2c1_77"), sep = ";") )%>%
  mutate(pcl2c2 = combine_columns(., c("pcl2c2_1", "pcl2c2_2", "pcl2c2_3", "pcl2c2_9999", "pcl2c2_77"), sep = ";") )%>%
  mutate(pcl2c3 = combine_columns(., c("pcl2c3_1", "pcl2c3_2", "pcl2c3_3", "pcl2c3_9999", "pcl2c3_77"), sep = ";") )%>%
  mutate(pcl2c4 = combine_columns(., c("pcl2c4_1", "pcl2c4_2", "pcl2c4_3", "pcl2c4_9999", "pcl2c4_77"), sep = ";") )%>%
  mutate(pcl2d = combine_columns(., c("pcl2d_1", "pcl2d_2", "pcl2d_3", "pcl2d_77"), sep = ";") )%>%
  relocate(pcl2c1, .after = "pcl2c1_77") %>%
  relocate(pcl2c2, .after = "pcl2c2_77") %>%
  relocate(pcl2c3, .after = "pcl2c3_77") %>%
  relocate(pcl2c4, .after = "pcl2c4_77") %>%
  relocate(pcl2d, .after = "pcl2d_77") %>%
  select(-c("pcl2c1_1", "pcl2c1_2", "pcl2c1_3", "pcl2c1_9999", "pcl2c1_77",
            "pcl2c2_1", "pcl2c2_2", "pcl2c2_3", "pcl2c2_9999", "pcl2c2_77",
            "pcl2c3_1", "pcl2c3_2", "pcl2c3_3", "pcl2c3_9999", "pcl2c3_77",
            "pcl2c4_1", "pcl2c4_2", "pcl2c4_3", "pcl2c4_9999", "pcl2c4_77",
            "pcl2d_1", "pcl2d_2", "pcl2d_3", "pcl2d_77")) %>%
  # PCL3
  mutate(pcl3c1 = combine_columns(., c("pcl3c1_1", "pcl3c1_2", "pcl3c1_3", "pcl3c1_9999", "pcl3c1_77"), sep = ";") )%>%
  mutate(pcl3c2 = combine_columns(., c("pcl3c2_1", "pcl3c2_2", "pcl3c2_3", "pcl3c2_9999", "pcl3c2_77"), sep = ";") )%>%
  mutate(pcl3c3 = combine_columns(., c("pcl3c3_1", "pcl3c3_2", "pcl3c3_3", "pcl3c3_9999", "pcl3c3_77"), sep = ";") )%>%
  mutate(pcl3c4 = combine_columns(., c("pcl3c4_1", "pcl3c4_2", "pcl3c4_3", "pcl3c4_9999", "pcl3c4_77"), sep = ";") )%>%
  mutate(pcl3d = combine_columns(., c("pcl3d_1", "pcl3d_2", "pcl3d_3", "pcl3d_77"), sep = ";") )%>%
  relocate(pcl3c1, .after = "pcl3c1_77") %>%
  relocate(pcl3c2, .after = "pcl3c2_77") %>%
  relocate(pcl3c3, .after = "pcl3c3_77") %>%
  relocate(pcl3c4, .after = "pcl3c4_77") %>%
  relocate(pcl3d, .after = "pcl3d_77") %>%
  select(-c("pcl3c1_1", "pcl3c1_2", "pcl3c1_3", "pcl3c1_9999", "pcl3c1_77",
            "pcl3c2_1", "pcl3c2_2", "pcl3c2_3", "pcl3c2_9999", "pcl3c2_77",
            "pcl3c3_1", "pcl3c3_2", "pcl3c3_3", "pcl3c3_9999", "pcl3c3_77",
            "pcl3c4_1", "pcl3c4_2", "pcl3c4_3", "pcl3c4_9999", "pcl3c4_77",
            "pcl3d_1", "pcl3d_2", "pcl3d_3", "pcl3d_77")) %>%
  # PCL4
  mutate(pcl4c1 = combine_columns(., c("pcl4c1_1", "pcl4c1_2", "pcl4c1_3", "pcl4c1_9999", "pcl4c1_77"), sep = ";") )%>%
  mutate(pcl4c2 = combine_columns(., c("pcl4c2_1", "pcl4c2_2", "pcl4c2_3", "pcl4c2_9999", "pcl4c2_77"), sep = ";") )%>%
  mutate(pcl4c3 = combine_columns(., c("pcl4c3_1", "pcl4c3_2", "pcl4c3_3", "pcl4c3_9999", "pcl4c3_77"), sep = ";") )%>%
  mutate(pcl4c4 = combine_columns(., c("pcl4c4_1", "pcl4c4_2", "pcl4c4_3", "pcl4c4_9999", "pcl4c4_77"), sep = ";") )%>%
  mutate(pcl4d = combine_columns(., c("pcl4d_1", "pcl4d_2", "pcl4d_3", "pcl4d_77"), sep = ";") )%>%
  relocate(pcl4c1, .after = "pcl4c1_77") %>%
  relocate(pcl4c2, .after = "pcl4c2_77") %>%
  relocate(pcl4c3, .after = "pcl4c3_77") %>%
  relocate(pcl4c4, .after = "pcl4c4_77") %>%
  relocate(pcl4d, .after = "pcl4d_77") %>%
  select(-c("pcl4c1_1", "pcl4c1_2", "pcl4c1_3", "pcl4c1_9999", "pcl4c1_77",
            "pcl4c2_1", "pcl4c2_2", "pcl4c2_3", "pcl4c2_9999", "pcl4c2_77",
            "pcl4c3_1", "pcl4c3_2", "pcl4c3_3", "pcl4c3_9999", "pcl4c3_77",
            "pcl4c4_1", "pcl4c4_2", "pcl4c4_3", "pcl4c4_9999", "pcl4c4_77",
            "pcl4d_1", "pcl4d_2", "pcl4d_3", "pcl4d_77")) %>%  
  # PCL5
  mutate(pcl5c1 = combine_columns(., c("pcl5c1_1", "pcl5c1_2", "pcl5c1_3", "pcl5c1_9999", "pcl5c1_77"), sep = ";") )%>%
  mutate(pcl5c2 = combine_columns(., c("pcl5c2_1", "pcl5c2_2", "pcl5c2_3", "pcl5c2_9999", "pcl5c2_77"), sep = ";") )%>%
  mutate(pcl5c3 = combine_columns(., c("pcl5c3_1", "pcl5c3_2", "pcl5c3_3", "pcl5c3_9999", "pcl5c3_77"), sep = ";") )%>%
  mutate(pcl5c4 = combine_columns(., c("pcl5c4_1", "pcl5c4_2", "pcl5c4_3", "pcl5c4_9999", "pcl5c4_77"), sep = ";") )%>%
  mutate(pcl5d = combine_columns(., c("pcl5d_1", "pcl5d_2", "pcl5d_3", "pcl5d_77"), sep = ";") )%>%
  relocate(pcl5c1, .after = "pcl5c1_77") %>%
  relocate(pcl5c2, .after = "pcl5c2_77") %>%
  relocate(pcl5c3, .after = "pcl5c3_77") %>%
  relocate(pcl5c4, .after = "pcl5c4_77") %>%
  relocate(pcl5d, .after = "pcl5d_77") %>%
  select(-c("pcl5c1_1", "pcl5c1_2", "pcl5c1_3", "pcl5c1_9999", "pcl5c1_77",
            "pcl5c2_1", "pcl5c2_2", "pcl5c2_3", "pcl5c2_9999", "pcl5c2_77",
            "pcl5c3_1", "pcl5c3_2", "pcl5c3_3", "pcl5c3_9999", "pcl5c3_77",
            "pcl5c4_1", "pcl5c4_2", "pcl5c4_3", "pcl5c4_9999", "pcl5c4_77",
            "pcl5d_1", "pcl5d_2", "pcl5d_3", "pcl5d_77")) %>%  
    # PCL6
  mutate(pcl6c1 = combine_columns(., c("pcl6c1_1", "pcl6c1_2", "pcl6c1_3", "pcl6c1_9999", "pcl6c1_77"), sep = ";") )%>%
  mutate(pcl6c2 = combine_columns(., c("pcl6c2_1", "pcl6c2_2", "pcl6c2_3", "pcl6c2_9999", "pcl6c2_77"), sep = ";") )%>%
  mutate(pcl6c3 = combine_columns(., c("pcl6c3_1", "pcl6c3_2", "pcl6c3_3", "pcl6c3_9999", "pcl6c3_77"), sep = ";") )%>%
  mutate(pcl6c4 = combine_columns(., c("pcl6c4_1", "pcl6c4_2", "pcl6c4_3", "pcl6c4_9999", "pcl6c4_77"), sep = ";") )%>%
  mutate(pcl6d = combine_columns(., c("pcl6d_1", "pcl6d_2", "pcl6d_3", "pcl6d_77"), sep = ";") )%>%
  relocate(pcl6c1, .after = "pcl6c1_77") %>%
  relocate(pcl6c2, .after = "pcl6c2_77") %>%
  relocate(pcl6c3, .after = "pcl6c3_77") %>%
  relocate(pcl6c4, .after = "pcl6c4_77") %>%
  relocate(pcl6d, .after = "pcl6d_77") %>%
  select(-c("pcl6c1_1", "pcl6c1_2", "pcl6c1_3", "pcl6c1_9999", "pcl6c1_77",
            "pcl6c2_1", "pcl6c2_2", "pcl6c2_3", "pcl6c2_9999", "pcl6c2_77",
            "pcl6c3_1", "pcl6c3_2", "pcl6c3_3", "pcl6c3_9999", "pcl6c3_77",
            "pcl6c4_1", "pcl6c4_2", "pcl6c4_3", "pcl6c4_9999", "pcl6c4_77",
            "pcl6d_1", "pcl6d_2", "pcl6d_3", "pcl6d_77")) %>%  
    # PCL7
  mutate(pcl7c1 = combine_columns(., c("pcl7c1_1", "pcl7c1_2", "pcl7c1_3", "pcl7c1_9999", "pcl7c1_77"), sep = ";") )%>%
  mutate(pcl7c2 = combine_columns(., c("pcl7c2_1", "pcl7c2_2", "pcl7c2_3", "pcl7c2_9999", "pcl7c2_77"), sep = ";") )%>%
  mutate(pcl7c3 = combine_columns(., c("pcl7c3_1", "pcl7c3_2", "pcl7c3_3", "pcl7c3_9999", "pcl7c3_77"), sep = ";") )%>%
  mutate(pcl7c4 = combine_columns(., c("pcl7c4_1", "pcl7c4_2", "pcl7c4_3", "pcl7c4_9999", "pcl7c4_77"), sep = ";") )%>%
  mutate(pcl7d = combine_columns(., c("pcl7d_1", "pcl7d_2", "pcl7d_3", "pcl7d_77"), sep = ";") )%>%
  relocate(pcl7c1, .after = "pcl7c1_77") %>%
  relocate(pcl7c2, .after = "pcl7c2_77") %>%
  relocate(pcl7c3, .after = "pcl7c3_77") %>%
  relocate(pcl7c4, .after = "pcl7c4_77") %>%
  relocate(pcl7d, .after = "pcl7d_77") %>%
  select(-c("pcl7c1_1", "pcl7c1_2", "pcl7c1_3", "pcl7c1_9999", "pcl7c1_77",
            "pcl7c2_1", "pcl7c2_2", "pcl7c2_3", "pcl7c2_9999", "pcl7c2_77",
            "pcl7c3_1", "pcl7c3_2", "pcl7c3_3", "pcl7c3_9999", "pcl7c3_77",
            "pcl7c4_1", "pcl7c4_2", "pcl7c4_3", "pcl7c4_9999", "pcl7c4_77",
            "pcl7d_1", "pcl7d_2", "pcl7d_3", "pcl7d_77")) %>% 
    # PCL8
  mutate(pcl8c1 = combine_columns(., c("pcl8c1_1", "pcl8c1_2", "pcl8c1_3", "pcl8c1_9999", "pcl8c1_77"), sep = ";") )%>%
  mutate(pcl8c2 = combine_columns(., c("pcl8c2_1", "pcl8c2_2", "pcl8c2_3", "pcl8c2_9999", "pcl8c2_77"), sep = ";") )%>%
  mutate(pcl8c3 = combine_columns(., c("pcl8c3_1", "pcl8c3_2", "pcl8c3_3", "pcl8c3_9999", "pcl8c3_77"), sep = ";") )%>%
  mutate(pcl8c4 = combine_columns(., c("pcl8c4_1", "pcl8c4_2", "pcl8c4_3", "pcl8c4_9999", "pcl8c4_77"), sep = ";") )%>%
  mutate(pcl8d = combine_columns(., c("pcl8d_1", "pcl8d_2", "pcl8d_3", "pcl8d_77"), sep = ";") )%>%
  relocate(pcl8c1, .after = "pcl8c1_77") %>%
  relocate(pcl8c2, .after = "pcl8c2_77") %>%
  relocate(pcl8c3, .after = "pcl8c3_77") %>%
  relocate(pcl8c4, .after = "pcl8c4_77") %>%
  relocate(pcl8d, .after = "pcl8d_77") %>%
  select(-c("pcl8c1_1", "pcl8c1_2", "pcl8c1_3", "pcl8c1_9999", "pcl8c1_77",
            "pcl8c2_1", "pcl8c2_2", "pcl8c2_3", "pcl8c2_9999", "pcl8c2_77",
            "pcl8c3_1", "pcl8c3_2", "pcl8c3_3", "pcl8c3_9999", "pcl8c3_77",
            "pcl8c4_1", "pcl8c4_2", "pcl8c4_3", "pcl8c4_9999", "pcl8c4_77",
            "pcl8d_1", "pcl8d_2", "pcl8d_3", "pcl8d_77")) %>%  
    # PCL9
  mutate(pcl9c1 = combine_columns(., c("pcl9c1_1", "pcl9c1_2", "pcl9c1_3", "pcl9c1_9999", "pcl9c1_77"), sep = ";") )%>%
  mutate(pcl9c2 = combine_columns(., c("pcl9c2_1", "pcl9c2_2", "pcl9c2_3", "pcl9c2_9999", "pcl9c2_77"), sep = ";") )%>%
  mutate(pcl9c3 = combine_columns(., c("pcl9c3_1", "pcl9c3_2", "pcl9c3_3", "pcl9c3_9999", "pcl9c3_77"), sep = ";") )%>%
  mutate(pcl9c4 = combine_columns(., c("pcl9c4_1", "pcl9c4_2", "pcl9c4_3", "pcl9c4_9999", "pcl9c4_77"), sep = ";") )%>%
  mutate(pcl9d = combine_columns(., c("pcl9d_1", "pcl9d_2", "pcl9d_3", "pcl9d_77"), sep = ";") )%>%
  relocate(pcl9c1, .after = "pcl9c1_77") %>%
  relocate(pcl9c2, .after = "pcl9c2_77") %>%
  relocate(pcl9c3, .after = "pcl9c3_77") %>%
  relocate(pcl9c4, .after = "pcl9c4_77") %>%
  relocate(pcl9d, .after = "pcl9d_77") %>%
  select(-c("pcl9c1_1", "pcl9c1_2", "pcl9c1_3", "pcl9c1_9999", "pcl9c1_77",
            "pcl9c2_1", "pcl9c2_2", "pcl9c2_3", "pcl9c2_9999", "pcl9c2_77",
            "pcl9c3_1", "pcl9c3_2", "pcl9c3_3", "pcl9c3_9999", "pcl9c3_77",
            "pcl9c4_1", "pcl9c4_2", "pcl9c4_3", "pcl9c4_9999", "pcl9c4_77",
            "pcl9d_1", "pcl9d_2", "pcl9d_3", "pcl9d_77")) %>%  
    # PCL10
  mutate(pcl10c1 = combine_columns(., c("pcl10c1_1", "pcl10c1_2", "pcl10c1_3", "pcl10c1_9999", "pcl10c1_77"), sep = ";") )%>%
  mutate(pcl10c2 = combine_columns(., c("pcl10c2_1", "pcl10c2_2", "pcl10c2_3", "pcl10c2_9999", "pcl10c2_77"), sep = ";") )%>%
  mutate(pcl10c3 = combine_columns(., c("pcl10c3_1", "pcl10c3_2", "pcl10c3_3", "pcl10c3_9999", "pcl10c3_77"), sep = ";") )%>%
  mutate(pcl10c4 = combine_columns(., c("pcl10c4_1", "pcl10c4_2", "pcl10c4_3", "pcl10c4_9999", "pcl10c4_77"), sep = ";") )%>%
  mutate(pcl10d = combine_columns(., c("pcl10d_1", "pcl10d_2", "pcl10d_3", "pcl10d_77"), sep = ";") )%>%
  relocate(pcl10c1, .after = "pcl10c1_77") %>%
  relocate(pcl10c2, .after = "pcl10c2_77") %>%
  relocate(pcl10c3, .after = "pcl10c3_77") %>%
  relocate(pcl10c4, .after = "pcl10c4_77") %>%
  relocate(pcl10d, .after = "pcl10d_77") %>%
  select(-c("pcl10c1_1", "pcl10c1_2", "pcl10c1_3", "pcl10c1_9999", "pcl10c1_77",
            "pcl10c2_1", "pcl10c2_2", "pcl10c2_3", "pcl10c2_9999", "pcl10c2_77",
            "pcl10c3_1", "pcl10c3_2", "pcl10c3_3", "pcl10c3_9999", "pcl10c3_77",
            "pcl10c4_1", "pcl10c4_2", "pcl10c4_3", "pcl10c4_9999", "pcl10c4_77",
            "pcl10d_1", "pcl10d_2", "pcl10d_3", "pcl10d_77")) %>%
    # PCL11
  mutate(pcl11c1 = combine_columns(., c("pcl11c_1", "pcl11c_2", "pcl11c_3", "pcl11c_9999", "pcl11c_77"), sep = ";") )%>%
  mutate(pcl11c2 = combine_columns(., c("pcl11c2_1", "pcl11c2_2", "pcl11c2_3", "pcl11c2_9999", "pcl11c2_77"), sep = ";") )%>%
  mutate(pcl11c3 = combine_columns(., c("pcl11c3_1", "pcl11c3_2", "pcl11c3_3", "pcl11c3_9999", "pcl11c3_77"), sep = ";") )%>%
  mutate(pcl11c4 = combine_columns(., c("pcl11c4_1", "pcl11c4_2", "pcl11c4_3", "pcl11c4_9999", "pcl11c4_77"), sep = ";") )%>%
  mutate(pcl11d = combine_columns(., c("pcl11d_1", "pcl11d_2", "pcl11d_3", "pcl11d_77"), sep = ";") )%>%
  relocate(pcl11c1, .after = "pcl11c_77") %>%
  relocate(pcl11c2, .after = "pcl11c2_77") %>%
  relocate(pcl11c3, .after = "pcl11c3_77") %>%
  relocate(pcl11c4, .after = "pcl11c4_77") %>%
  relocate(pcl11d, .after = "pcl11d_77") %>%
  select(-c("pcl11c_1", "pcl11c_2", "pcl11c_3", "pcl11c_9999", "pcl11c_77",
            "pcl11c2_1", "pcl11c2_2", "pcl11c2_3", "pcl11c2_9999", "pcl11c2_77",
            "pcl11c3_1", "pcl11c3_2", "pcl11c3_3", "pcl11c3_9999", "pcl11c3_77",
            "pcl11c4_1", "pcl11c4_2", "pcl11c4_3", "pcl11c4_9999", "pcl11c4_77",
            "pcl11d_1", "pcl11d_2", "pcl11d_3", "pcl11d_77")) %>%
    # PCL12
  mutate(pcl12c1 = combine_columns(., c("pcl12c1_1", "pcl12c1_2", "pcl12c1_3", "pcl12c1_9999", "pcl12c1_77"), sep = ";") )%>%
  mutate(pcl12c2 = combine_columns(., c("pcl12c2_1", "pcl12c2_2", "pcl12c2_3", "pcl12c2_9999", "pcl12c2_77"), sep = ";") )%>%
  mutate(pcl12c3 = combine_columns(., c("pcl12c3_1", "pcl12c3_2", "pcl12c3_3", "pcl12c3_9999", "pcl12c3_77"), sep = ";") )%>%
  mutate(pcl12c4 = combine_columns(., c("pcl12c4_1", "pcl12c4_2", "pcl12c4_3", "pcl12c4_9999", "pcl12c4_77"), sep = ";") )%>%
  mutate(pcl12d = combine_columns(., c("pcl12d_1", "pcl12d_2", "pcl12d_3", "pcl12d_77"), sep = ";") )%>%
  relocate(pcl12c1, .after = "pcl12c1_77") %>%
  relocate(pcl12c2, .after = "pcl12c2_77") %>%
  relocate(pcl12c3, .after = "pcl12c3_77") %>%
  relocate(pcl12c4, .after = "pcl12c4_77") %>%
  relocate(pcl12d, .after = "pcl12d_77") %>%
  select(-c("pcl12c1_1", "pcl12c1_2", "pcl12c1_3", "pcl12c1_9999", "pcl12c1_77",
            "pcl12c2_1", "pcl12c2_2", "pcl12c2_3", "pcl12c2_9999", "pcl12c2_77",
            "pcl12c3_1", "pcl12c3_2", "pcl12c3_3", "pcl12c3_9999", "pcl12c3_77",
            "pcl12c4_1", "pcl12c4_2", "pcl12c4_3", "pcl12c4_9999", "pcl12c4_77",
            "pcl12d_1", "pcl12d_2", "pcl12d_3", "pcl12d_77")) %>%
      # PCL13
  mutate(pcl13c1 = combine_columns(., c("pcl13c1_1", "pcl13c1_2", "pcl13c1_3", "pcl13c1_9999", "pcl13c1_77"), sep = ";") )%>%
  mutate(pcl13c2 = combine_columns(., c("pcl13c2_1", "pcl13c2_2", "pcl13c2_3", "pcl13c2_9999", "pcl13c2_77"), sep = ";") )%>%
  mutate(pcl13c3 = combine_columns(., c("pcl13c3_1", "pcl13c3_2", "pcl13c3_3", "pcl13c3_9999", "pcl13c3_77"), sep = ";") )%>%
  mutate(pcl13c4 = combine_columns(., c("pcl13c4_1", "pcl13c4_2", "pcl13c4_3", "pcl13c4_9999", "pcl13c4_77"), sep = ";") )%>%
  mutate(pcl13d = combine_columns(., c("pcl13d_1", "pcl13d_2", "pcl13d_3", "pcl13d_77"), sep = ";") )%>%
  relocate(pcl13c1, .after = "pcl13c1_77") %>%
  relocate(pcl13c2, .after = "pcl13c2_77") %>%
  relocate(pcl13c3, .after = "pcl13c3_77") %>%
  relocate(pcl13c4, .after = "pcl13c4_77") %>%
  relocate(pcl13d, .after = "pcl13d_77") %>%
  select(-c("pcl13c1_1", "pcl13c1_2", "pcl13c1_3", "pcl13c1_9999", "pcl13c1_77",
            "pcl13c2_1", "pcl13c2_2", "pcl13c2_3", "pcl13c2_9999", "pcl13c2_77",
            "pcl13c3_1", "pcl13c3_2", "pcl13c3_3", "pcl13c3_9999", "pcl13c3_77",
            "pcl13c4_1", "pcl13c4_2", "pcl13c4_3", "pcl13c4_9999", "pcl13c4_77",
            "pcl13d_1", "pcl13d_2", "pcl13d_3", "pcl13d_77")) %>%
      # PCL14
  mutate(pcl14c1 = combine_columns(., c("pcl14c1_1", "pcl14c1_2", "pcl14c1_3", "pcl14c1_9999", "pcl14c1_77"), sep = ";") )%>%
  mutate(pcl14c2 = combine_columns(., c("pcl14c2_1", "pcl14c2_2", "pcl14c2_3", "pcl14c2_9999", "pcl14c2_77"), sep = ";") )%>%
  mutate(pcl14c3 = combine_columns(., c("pcl14c3_1", "pcl14c3_2", "pcl14c3_3", "pcl14c3_9999", "pcl14c3_77"), sep = ";") )%>%
  mutate(pcl14c4 = combine_columns(., c("pcl14c4_1", "pcl14c4_2", "pcl14c4_3", "pcl14c4_9999", "pcl14c4_77"), sep = ";") )%>%
  mutate(pcl14d = combine_columns(., c("pcl14d_1", "pcl14d_2", "pcl14d_3", "pcl14d_77"), sep = ";") )%>%
  relocate(pcl14c1, .after = "pcl14c1_77") %>%
  relocate(pcl14c2, .after = "pcl14c2_77") %>%
  relocate(pcl14c3, .after = "pcl14c3_77") %>%
  relocate(pcl14c4, .after = "pcl14c4_77") %>%
  relocate(pcl14d, .after = "pcl14d_77") %>%
  select(-c("pcl14c1_1", "pcl14c1_2", "pcl14c1_3", "pcl14c1_9999", "pcl14c1_77",
            "pcl14c2_1", "pcl14c2_2", "pcl14c2_3", "pcl14c2_9999", "pcl14c2_77",
            "pcl14c3_1", "pcl14c3_2", "pcl14c3_3", "pcl14c3_9999", "pcl14c3_77",
            "pcl14c4_1", "pcl14c4_2", "pcl14c4_3", "pcl14c4_9999", "pcl14c4_77",
            "pcl14d_1", "pcl14d_2", "pcl14d_3", "pcl14d_77")) %>%
      # PCL15
  mutate(pcl15c1 = combine_columns(., c("pcl15c1_1", "pcl15c1_2", "pcl15c1_3", "pcl15c1_9999", "pcl15c1_77"), sep = ";") )%>%
  mutate(pcl15c2 = combine_columns(., c("pcl15c2_1", "pcl15c2_2", "pcl15c2_3", "pcl15c2_9999", "pcl15c2_77"), sep = ";") )%>%
  mutate(pcl15c3 = combine_columns(., c("pcl15c3_1", "pcl15c3_2", "pcl15c3_3", "pcl15c3_9999", "pcl15c3_77"), sep = ";") )%>%
  mutate(pcl15c4 = combine_columns(., c("pcl15c4_1", "pcl15c4_2", "pcl15c4_3", "pcl15c4_9999", "pcl15c4_77"), sep = ";") )%>%
  mutate(pcl15d = combine_columns(., c("pcl15d_1", "pcl15d_2", "pcl15d_3", "pcl15d_77"), sep = ";") )%>%
  relocate(pcl15c1, .after = "pcl15c1_77") %>%
  relocate(pcl15c2, .after = "pcl15c2_77") %>%
  relocate(pcl15c3, .after = "pcl15c3_77") %>%
  relocate(pcl15c4, .after = "pcl15c4_77") %>%
  relocate(pcl15d, .after = "pcl15d_77") %>%
  select(-c("pcl15c1_1", "pcl15c1_2", "pcl15c1_3", "pcl15c1_9999", "pcl15c1_77",
            "pcl15c2_1", "pcl15c2_2", "pcl15c2_3", "pcl15c2_9999", "pcl15c2_77",
            "pcl15c3_1", "pcl15c3_2", "pcl15c3_3", "pcl15c3_9999", "pcl15c3_77",
            "pcl15c4_1", "pcl15c4_2", "pcl15c4_3", "pcl15c4_9999", "pcl15c4_77",
            "pcl15d_1", "pcl15d_2", "pcl15d_3", "pcl15d_77")) %>% 
    # PCL16
  mutate(pcl16c1 = combine_columns(., c("pcl16c1_1", "pcl16c1_2", "pcl16c1_3", "pcl16c1_9999", "pcl16c1_77"), sep = ";") )%>%
  mutate(pcl16c2 = combine_columns(., c("pcl16c2_1", "pcl16c2_2", "pcl16c2_3", "pcl16c2_9999", "pcl16c2_77"), sep = ";") )%>%
  mutate(pcl16c3 = combine_columns(., c("pcl16c3_1", "pcl16c3_2", "pcl16c3_3", "pcl16c3_9999", "pcl16c3_77"), sep = ";") )%>%
  mutate(pcl16c4 = combine_columns(., c("pcl16c4_1", "pcl16c4_2", "pcl16c4_3", "pcl16c4_9999", "pcl16c4_77"), sep = ";") )%>%
  mutate(pcl16d = combine_columns(., c("pcl16d_1", "pcl16d_2", "pcl16d_3", "pcl16d_77"), sep = ";") )%>%
  relocate(pcl16c1, .after = "pcl16c1_77") %>%
  relocate(pcl16c2, .after = "pcl16c2_77") %>%
  relocate(pcl16c3, .after = "pcl16c3_77") %>%
  relocate(pcl16c4, .after = "pcl16c4_77") %>%
  relocate(pcl16d, .after = "pcl16d_77") %>%
  select(-c("pcl16c1_1", "pcl16c1_2", "pcl16c1_3", "pcl16c1_9999", "pcl16c1_77",
            "pcl16c2_1", "pcl16c2_2", "pcl16c2_3", "pcl16c2_9999", "pcl16c2_77",
            "pcl16c3_1", "pcl16c3_2", "pcl16c3_3", "pcl16c3_9999", "pcl16c3_77",
            "pcl16c4_1", "pcl16c4_2", "pcl16c4_3", "pcl16c4_9999", "pcl16c4_77",
            "pcl16d_1", "pcl16d_2", "pcl16d_3", "pcl16d_77")) %>% 
      # PCL17
  mutate(pcl17c1 = combine_columns(., c("pcl17c1_1", "pcl17c1_2", "pcl17c1_3", "pcl17c1_9999", "pcl17c1_77"), sep = ";") )%>%
  mutate(pcl17c2 = combine_columns(., c("pcl17c2_1", "pcl17c2_2", "pcl17c2_3", "pcl17c2_9999", "pcl17c2_77"), sep = ";") )%>%
  mutate(pcl17c3 = combine_columns(., c("pcl17c3_1", "pcl17c3_2", "pcl17c3_3", "pcl17c3_9999", "pcl17c3_77"), sep = ";") )%>%
  mutate(pcl17c4 = combine_columns(., c("pcl17c4_1", "pcl17c4_2", "pcl17c4_3", "pcl17c4_9999", "pcl17c4_77"), sep = ";") )%>%
  mutate(pcl17d = combine_columns(., c("pcl17d_1", "pcl17d_2", "pcl17d_3", "pcl17d_77"), sep = ";") )%>%
  relocate(pcl17c1, .after = "pcl17c1_77") %>%
  relocate(pcl17c2, .after = "pcl17c2_77") %>%
  relocate(pcl17c3, .after = "pcl17c3_77") %>%
  relocate(pcl17c4, .after = "pcl17c4_77") %>%
  relocate(pcl17d, .after = "pcl17d_77") %>%
  select(-c("pcl17c1_1", "pcl17c1_2", "pcl17c1_3", "pcl17c1_9999", "pcl17c1_77",
            "pcl17c2_1", "pcl17c2_2", "pcl17c2_3", "pcl17c2_9999", "pcl17c2_77",
            "pcl17c3_1", "pcl17c3_2", "pcl17c3_3", "pcl17c3_9999", "pcl17c3_77",
            "pcl17c4_1", "pcl17c4_2", "pcl17c4_3", "pcl17c4_9999", "pcl17c4_77",
            "pcl17d_1", "pcl17d_2", "pcl17d_3", "pcl17d_77")) %>%
      # PCL18
  mutate(pcl18c1 = combine_columns(., c("pcl18c1_1", "pcl18c1_2", "pcl18c1_3", "pcl18c1_9999", "pcl18c1_77"), sep = ";") )%>%
  mutate(pcl18c2 = combine_columns(., c("pcl18c2_1", "pcl18c2_2", "pcl18c2_3", "pcl18c2_9999", "pcl18c2_77"), sep = ";") )%>%
  mutate(pcl18c3 = combine_columns(., c("pcl18c3_1", "pcl18c3_2", "pcl18c3_3", "pcl18c3_9999", "pcl18c3_77"), sep = ";") )%>%
  mutate(pcl18c4 = combine_columns(., c("pcl18c4_1", "pcl18c4_2", "pcl18c4_3", "pcl18c4_9999", "pcl18c4_77"), sep = ";") )%>%
  mutate(pcl18d = combine_columns(., c("pcl18d_1", "pcl18d_2", "pcl18d_3", "pcl18d_77"), sep = ";") )%>%
  relocate(pcl18c1, .after = "pcl18c1_77") %>%
  relocate(pcl18c2, .after = "pcl18c2_77") %>%
  relocate(pcl18c3, .after = "pcl18c3_77") %>%
  relocate(pcl18c4, .after = "pcl18c4_77") %>%
  relocate(pcl18d, .after = "pcl18d_77") %>%
  select(-c("pcl18c1_1", "pcl18c1_2", "pcl18c1_3", "pcl18c1_9999", "pcl18c1_77",
            "pcl18c2_1", "pcl18c2_2", "pcl18c2_3", "pcl18c2_9999", "pcl18c2_77",
            "pcl18c3_1", "pcl18c3_2", "pcl18c3_3", "pcl18c3_9999", "pcl18c3_77",
            "pcl18c4_1", "pcl18c4_2", "pcl18c4_3", "pcl18c4_9999", "pcl18c4_77",
            "pcl18d_1", "pcl18d_2", "pcl18d_3", "pcl18d_77")) %>%  
      # PCL19
  mutate(pcl19c1 = combine_columns(., c("pcl19c1_1", "pcl19c1_2", "pcl19c1_3", "pcl19c1_9999", "pcl19c1_77"), sep = ";") )%>%
  mutate(pcl19c2 = combine_columns(., c("pcl19c2_1", "pcl19c2_2", "pcl19c2_3", "pcl19c2_9999", "pcl19c2_77"), sep = ";") )%>%
  mutate(pcl19c3 = combine_columns(., c("pcl19c3_1", "pcl19c3_2", "pcl19c3_3", "pcl19c3_9999", "pcl19c3_77"), sep = ";") )%>%
  mutate(pcl19c4 = combine_columns(., c("pcl19c4_1", "pcl19c4_2", "pcl19c4_3", "pcl19c4_9999", "pcl19c4_77"), sep = ";") )%>%
  mutate(pcl19d = combine_columns(., c("pcl19d_1", "pcl19d_2", "pcl19d_3", "pcl19d_77"), sep = ";") )%>%
  relocate(pcl19c1, .after = "pcl19c1_77") %>%
  relocate(pcl19c2, .after = "pcl19c2_77") %>%
  relocate(pcl19c3, .after = "pcl19c3_77") %>%
  relocate(pcl19c4, .after = "pcl19c4_77") %>%
  relocate(pcl19d, .after = "pcl19d_77") %>%
  select(-c("pcl19c1_1", "pcl19c1_2", "pcl19c1_3", "pcl19c1_9999", "pcl19c1_77",
            "pcl19c2_1", "pcl19c2_2", "pcl19c2_3", "pcl19c2_9999", "pcl19c2_77",
            "pcl19c3_1", "pcl19c3_2", "pcl19c3_3", "pcl19c3_9999", "pcl19c3_77",
            "pcl19c4_1", "pcl19c4_2", "pcl19c4_3", "pcl19c4_9999", "pcl19c4_77",
            "pcl19d_1", "pcl19d_2", "pcl19d_3", "pcl19d_77"))


## Removing any columns in which there are only NAs 
# Assuming 'your_dataset' is the name of your dataframe
## this drop 105 columns that aren't necessary 
pcltest <- pcl %>%
  select(-which(sapply(pcl, function(col) all(is.na(col) | col == "NA"))))

## MIN can you check after column 450 there is data but I can't figure out what the columns are
## we need to check on inputting appropriate missing values

## would like each b1 thorough c variables to have labels
## b1 = freq0-5
## b2 = freq6-11
## b3 = freq12-19
## b4 = freqadult
## all text just add _txt to the above

## then rename cariables
## c1 == relation0-5
## c2 == relation6-11
## c3 == relation12-19
## c4 == relationadult
## d == learned_relation_allAge
## all text just add - txt


```


### PCL Missing 
```{r pcl_missing }
pcl_miss <- pcl %>%
  pct_miss_fun(
    id = c("id", matches("_text$")),
    n_items = 521
  )

pcl_miss %>%
  gt::gt() %>%
  gt::tab_header(
    title = 'PCL Missing Data',
    subtitle = 'by Participant'
  )

pcl_remove <- pcl_miss %>% filter(miss_pct >= 20) %>% pull(id)
```

## Merge
Merge together all measures 
```{r merge}
# This file contain all data including correct missing code for missing values (-77, -99, -55 etc.). 
# This file also contain all the computed variables. 
tpw_archive_calc <- tpw_archive_id %>%
  left_join(bsi_complete, by = "id") %>%
  left_join(cesd_complete, by = "id") %>%
  left_join(ciq_complete, by = "id") %>%
  left_join(dast_complete, by = "id") %>%
  left_join(cts_complete, by = "id") %>%
  left_join(bcap_complete, by = "id") %>%
  left_join(dyadc_complete, by = "id") %>%
  left_join(arq_complete, by = "id") %>%
  left_join(prss_complete, by = "id") %>%
  left_join(ssq_complete, by = "id") %>%
  left_join(elf_complete, by = "id") %>%
  #left_join(ell_count_complete, by = "id") %>%
  left_join(mhc_complete, by = "id") %>%
  left_join(flo_complete, by = "id") %>%
  left_join(itq_complete, by = "id") %>%
  left_join(ibq_complete, by = "id") %>%
  left_join(cint_socio_complete, by="id") %>%
  left_join(cint_ladder_complete, by="id") %>%
  left_join(cint_relation_complete, by="id") %>%
  left_join(cint_substance_complete, by="id") %>%
  left_join(cint_covid_complete, by="id") %>%
  left_join(socinf_sub_complete, by="id") %>%
  left_join(socinf_gen_complete, by="id") %>%
  left_join(cts_pc_complete, by = "id") %>%
  left_join(sex_complete, by="id") %>%
  mutate_if(is.numeric, round, digits=2) %>%
  rename(family = id)

# This will be removed after we finished merge 
# Raw data with missing code are actual missing code (-99, -77 etc) instead of NA, this file doesn't include calculated items
# tpw_archive <- tpw_archive_id %>%
#   left_join(bsi, by = "id") %>%
#   left_join(cesd, by = "id") %>%
#   left_join(ciq, by = "id") %>%
#   left_join(dast, by = "id") %>%
#   left_join(cts, by = "id") %>%
#   left_join(bcap, by = "id") %>%
#   left_join(dyadc, by = "id") %>%
#   left_join(arq, by = "id") %>%
#   left_join(prss, by = "id") %>%
#   left_join(ssq, by = "id") %>%
#   left_join(elf, by = "id") %>%
#   left_join(ell, by = "id") %>%
#   left_join(mhc, by = "id") %>%
#   left_join(flo, by = "id") %>%
#   left_join(itq, by = "id") %>%
#   left_join(ibq, by = "id") %>%
#   left_join(cint_socio, by = "id") %>%
#   left_join(cint_ladder, by = "id") %>%
#   left_join(cint_relation, by = "id") %>%
#   left_join(cint_substance, by = "id") %>%
#   left_join(cint_covid, by="id") %>%
#   left_join(socinf_sub, by = "id") %>%
#   left_join(socinf_gen, by = "id") %>%
#   left_join(cts_pc, by = "id") %>%
#   left_join(sex, by="id") %>%
#   mutate_if(is.numeric, round, digits=2) %>%
#   rename(family = id)
```

```{r output}
# write.csv(tpw_archive, here("do_not_push", "tpw_archive.csv"))
write.csv(tpw_archive_calc, here("do_not_push", "tpw_archive_calc.csv"))
```
